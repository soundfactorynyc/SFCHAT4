<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sound Factory NYC - Fixed Grid System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background: radial-gradient(ellipse at center, #0a0a0a 0%, #000000 70%, #000000 100%);
            color: #fff;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            height: 100vh;
            overflow: hidden;
            position: relative;
            touch-action: none;
            user-select: none;
        }

        /* T/M/B Buttons - Positioned in Building */
        .toggle-buttons {
            position: fixed;
            z-index: 2000;
        }

        .toggle-btn {
            position: fixed;
            width: 50px;
            height: 50px;
            background: #000;
            border: 2px solid #666;
            border-radius: 50%;
            color: #888;
            font-weight: bold;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* T button - Top left side of building */
        .toggle-btn[data-grid="top"] {
            top: 50px;
            left: 20px;
        }

        /* M button - Middle left side of building */
        .toggle-btn[data-grid="middle"] {
            top: 50%;
            left: 20px;
            transform: translateY(-50%);
        }

        /* B button - Bottom left side of building */
        .toggle-btn[data-grid="bottom"] {
            bottom: 50px;
            left: 20px;
        }

        .toggle-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 25px rgba(102, 102, 102, 0.7);
            border-color: #888;
            color: #fff;
        }

        .toggle-btn.active {
            background: #333;
            border-color: #fff;
            color: #fff;
        }

        /* Grid Overlay - With Cutouts for T/M/B buttons */
        .grid-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: none;
            z-index: 1000;
            pointer-events: none;
        }

        .grid-overlay.active {
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: auto;
        }

        /* Cutout areas for T/M/B buttons */
        .grid-overlay::before {
            content: '';
            position: absolute;
            top: 20px;
            left: 20px;
            width: 50px;
            height: 170px; /* 3 buttons + 2 gaps */
            background: transparent;
            pointer-events: none;
        }

        /* Grid Container - Match Building Blueprint Size */
        .grid-container {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            grid-template-rows: repeat(8, 1fr);
            gap: 2px;
            width: 400px;
            height: 520px;
            pointer-events: auto;
        }

        /* Grid Buttons */
        .grid-button {
            background: linear-gradient(135deg, #333, #555);
            border: 2px solid #666;
            border-radius: 8px;
            color: #fff;
            font-weight: bold;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .grid-button:hover {
            background: linear-gradient(135deg, #555, #777);
            border-color: #888;
            transform: scale(1.05);
        }

        .grid-button:active {
            transform: scale(0.95);
        }

        .grid-button.selected {
            background: linear-gradient(135deg, #ff1a78, #ff6b6b) !important;
            border-color: #ff1a78 !important;
            color: #fff !important;
        }

        /* Empty spaces for removed buttons */
        .grid-button.empty {
            background: transparent;
            border: none;
            cursor: default;
            pointer-events: none;
        }

        .grid-button.empty:hover {
            transform: none;
        }

        /* Button numbers */
        .button-number {
            position: absolute;
            top: 4px;
            left: 4px;
            font-size: 10px;
            color: #aaa;
        }

        /* Close button */
        .close-button {
            position: absolute;
            top: 20px;
            right: 20px;
            background: #ff1a78;
            color: #fff;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            z-index: 1001;
            pointer-events: auto;
        }

        /* Character System */
        .character-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 200;
        }

        .person {
            position: absolute;
            width: 24px;
            height: 36px;
            pointer-events: none;
            z-index: 100;
            transition: all 0.1s ease;
        }

        .head {
            position: absolute;
            width: 8px;
            height: 8px;
            background: radial-gradient(circle at 40% 40%, #f4d1ae, #c4936d);
            border-radius: 50%;
            left: 8px;
            top: 2px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.4);
            z-index: 20;
        }

        .torso {
            position: absolute;
            width: 14px;
            height: 11px;
            background: linear-gradient(180deg, #333, #222);
            border-radius: 30% 30% 50% 50%;
            left: 5px;
            top: 9px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.5);
            z-index: 10;
        }

        .arm-left-upper, .arm-right-upper {
            position: absolute;
            width: 3px;
            height: 5px;
            background: linear-gradient(180deg, #333, #2a2a2a);
            border-radius: 1px;
            z-index: 9;
        }

        .arm-left-upper {
            left: 2px;
            top: 10px;
            transform-origin: center top;
        }

        .arm-right-upper {
            right: 2px;
            top: 10px;
            transform-origin: center top;
        }

        .arm-left-lower, .arm-right-lower {
            position: absolute;
            width: 2px;
            height: 5px;
            background: linear-gradient(180deg, #2a2a2a, #222);
            border-radius: 0 0 1px 1px;
        }

        .arm-left-lower {
            left: 0px;
            top: 4px;
            transform-origin: center top;
        }

        .arm-right-lower {
            right: 0px;
            top: 4px;
            transform-origin: center top;
        }

        .leg-left-upper, .leg-right-upper {
            position: absolute;
            width: 3px;
            height: 6px;
            background: linear-gradient(180deg, #222, #1a1a1a);
            border-radius: 1px;
            z-index: 8;
        }

        .leg-left-upper {
            left: 6px;
            top: 19px;
            transform-origin: center top;
        }

        .leg-right-upper {
            right: 6px;
            top: 19px;
            transform-origin: center top;
        }

        .leg-left-lower, .leg-right-lower {
            position: absolute;
            width: 2px;
            height: 6px;
            background: linear-gradient(180deg, #1a1a1a, #111);
            border-radius: 0 0 2px 2px;
        }

        .leg-left-lower {
            left: 0.5px;
            top: 5px;
            transform-origin: center top;
        }

        .leg-right-lower {
            right: 0.5px;
            top: 5px;
            transform-origin: center top;
        }

        .shadow {
            position: absolute;
            width: 18px;
            height: 7px;
            background: radial-gradient(ellipse, rgba(0,0,0,0.5), transparent);
            left: 3px;
            top: 29px;
            border-radius: 50%;
            z-index: -1;
        }

        /* Walking animations */
        .person.walking .arm-left-upper {
            animation: armUpperSwingLeft 0.6s ease-in-out infinite;
        }
        .person.walking .arm-left-lower {
            animation: armLowerSwingLeft 0.6s ease-in-out infinite;
        }
        .person.walking .arm-right-upper {
            animation: armUpperSwingRight 0.6s ease-in-out infinite;
        }
        .person.walking .arm-right-lower {
            animation: armLowerSwingRight 0.6s ease-in-out infinite;
        }
        .person.walking .leg-left-upper {
            animation: legUpperStepLeft 0.6s ease-in-out infinite;
        }
        .person.walking .leg-left-lower {
            animation: legLowerStepLeft 0.6s ease-in-out infinite;
        }
        .person.walking .leg-right-upper {
            animation: legUpperStepRight 0.6s ease-in-out infinite;
        }
        .person.walking .leg-right-lower {
            animation: legLowerStepRight 0.6s ease-in-out infinite;
        }

        @keyframes armUpperSwingLeft {
            0%, 100% { transform: rotate(-25deg); }
            50% { transform: rotate(25deg); }
        }
        @keyframes armLowerSwingLeft {
            0%, 100% { transform: rotate(-10deg); }
            50% { transform: rotate(15deg); }
        }
        @keyframes armUpperSwingRight {
            0%, 100% { transform: rotate(25deg); }
            50% { transform: rotate(-25deg); }
        }
        @keyframes armLowerSwingRight {
            0%, 100% { transform: rotate(15deg); }
            50% { transform: rotate(-10deg); }
        }
        @keyframes legUpperStepLeft {
            0%, 100% { transform: rotate(-15deg); }
            25% { transform: rotate(20deg) translateY(-2px); }
            50% { transform: rotate(-15deg); }
        }
        @keyframes legLowerStepLeft {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(-30deg); }
            50% { transform: rotate(0deg); }
        }
        @keyframes legUpperStepRight {
            0%, 100% { transform: rotate(-15deg); }
            50% { transform: rotate(-15deg); }
            75% { transform: rotate(20deg) translateY(-2px); }
        }
        @keyframes legLowerStepRight {
            0%, 100% { transform: rotate(0deg); }
            50% { transform: rotate(0deg); }
            75% { transform: rotate(-30deg); }
        }

        /* Joystick Controls */
        .controls {
            position: absolute;
            bottom: 40px;
            left: 80px;
            display: flex;
            gap: 15px;
            align-items: center;
            z-index: 1000;
            pointer-events: auto;
        }

        .joystick {
            width: 60px;
            height: 60px;
            background: radial-gradient(circle, rgba(255,255,255,0.1), rgba(255,255,255,0.02));
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            position: relative;
            touch-action: none;
        }

        .joystick-knob {
            width: 20px;
            height: 20px;
            background: radial-gradient(circle, #666, #333);
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 2px 10px rgba(0,0,0,0.5);
            transition: none;
        }

        .mode-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .mode-btn {
            padding: 6px 12px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.3);
            color: #fff;
            border-radius: 15px;
            font-size: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .mode-btn.active {
            background: #ff1a78;
            border-color: #ff1a78;
        }

        /* Floor Wrapper */
        .floor-wrapper {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1;
        }

        .floor-container {
            position: relative;
            width: 100%;
            max-width: 800px;
            height: 100%;
        }

        .floor-svg {
            width: 100%;
            height: 100%;
        }

        /* Mobile responsive */
        @media (max-width: 768px) {
            .toggle-btn {
                width: 40px;
                height: 40px;
                font-size: 12px;
            }
            .grid-container {
                width: 95vw;
                height: 95vh;
                gap: 4px;
            }
            .grid-button {
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <!-- T/M/B Toggle Buttons - Always Visible -->
    <div class="toggle-buttons">
        <button class="toggle-btn" id="topBtn" data-grid="top">T</button>
        <button class="toggle-btn" id="middleBtn" data-grid="middle">M</button>
        <button class="toggle-btn" id="bottomBtn" data-grid="bottom">B</button>
    </div>

    <!-- Grid Overlay -->
    <div class="grid-overlay" id="gridOverlay">
        <div class="grid-container" id="gridContainer">
            <!-- Grid buttons will be generated by JavaScript -->
        </div>
        <button class="close-button" id="closeBtn">CLOSE</button>
    </div>

    <!-- Sound Factory Floor Blueprint -->
    <div class="floor-wrapper">
        <div class="floor-container">
            <svg class="floor-svg" viewBox="0 0 400 520" preserveAspectRatio="xMidYMid meet">
                <defs>
                    <filter id="glow">
                        <feGaussianBlur stdDeviation="2" result="coloredBlur"/>
                        <feMerge>
                            <feMergeNode in="coloredBlur"/>
                            <feMergeNode in="SourceGraphic"/>
                        </feMerge>
                    </filter>
                </defs>
                
                <!-- Floor base -->
                <rect width="400" height="520" fill="#000"/>
                <rect x="5" y="5" width="390" height="510" fill="none" stroke="#333" stroke-width="2"/>
                <rect x="10" y="10" width="380" height="500" fill="#050505"/>
                
                <!-- Stairs (Top) -->
                <g opacity="0.6">
                    <rect x="170" y="20" width="60" height="35" fill="#0a0a0a" stroke="#555" stroke-width="2"/>
                    <path d="M175 25 L225 25 M175 30 L225 30 M175 35 L225 35 M175 40 L225 40 M175 45 L225 45 M175 50 L225 50" stroke="#444"/>
                    <text x="200" y="40" font-family="Arial" font-size="8" fill="#888" text-anchor="middle">STAIRS</text>
                </g>
                
                <!-- Blueprint Style Columns (3x4 grid) -->
                <g>
                    <!-- Row 1 - Blueprint Style Columns -->
                    <rect x="80" y="100" width="30" height="30" fill="#000" stroke="#666" stroke-width="1" rx="2"/>
                    <rect x="185" y="100" width="30" height="30" fill="#000" stroke="#666" stroke-width="1" rx="2"/>
                    <rect x="290" y="100" width="30" height="30" fill="#000" stroke="#666" stroke-width="1" rx="2"/>
                    
                    <!-- Row 2 - Blueprint Style Columns -->
                    <rect x="80" y="200" width="30" height="30" fill="#000" stroke="#666" stroke-width="1" rx="2"/>
                    <rect x="185" y="200" width="30" height="30" fill="#000" stroke="#666" stroke-width="1" rx="2"/>
                    <rect x="290" y="200" width="30" height="30" fill="#000" stroke="#666" stroke-width="1" rx="2"/>
                    
                    <!-- Row 3 - Blueprint Style Columns -->
                    <rect x="80" y="300" width="30" height="30" fill="#000" stroke="#666" stroke-width="1" rx="2"/>
                    <rect x="185" y="300" width="30" height="30" fill="#000" stroke="#666" stroke-width="1" rx="2"/>
                    <rect x="290" y="300" width="30" height="30" fill="#000" stroke="#666" stroke-width="1" rx="2"/>
                    
                    <!-- Row 4 - Blueprint Style Columns -->
                    <rect x="80" y="400" width="30" height="30" fill="#000" stroke="#666" stroke-width="1" rx="2"/>
                    <rect x="185" y="400" width="30" height="30" fill="#000" stroke="#666" stroke-width="1" rx="2"/>
                    <rect x="290" y="400" width="30" height="30" fill="#000" stroke="#666" stroke-width="1" rx="2"/>
                </g>
            
                <!-- Bar (Left) - Blueprint Style -->
                <rect x="20" y="100" width="40" height="330" fill="#000" stroke="#666" stroke-width="1" opacity="0.8"/>
                <text x="40" y="265" font-family="Arial" font-size="9" fill="#888" text-anchor="middle" transform="rotate(-90 40 265)" font-weight="bold">BAR</text>
                <circle cx="30" cy="150" r="1" fill="#fff" opacity="0.4"/>
                <circle cx="50" cy="150" r="1" fill="#fff" opacity="0.4"/>
                <circle cx="30" cy="200" r="1" fill="#fff" opacity="0.4"/>
                <circle cx="50" cy="200" r="1" fill="#fff" opacity="0.4"/>
                <circle cx="30" cy="250" r="1" fill="#fff" opacity="0.4"/>
                <circle cx="50" cy="250" r="1" fill="#fff" opacity="0.4"/>
                <circle cx="30" cy="300" r="1" fill="#fff" opacity="0.4"/>
                <circle cx="50" cy="300" r="1" fill="#fff" opacity="0.4"/>
                <circle cx="30" cy="350" r="1" fill="#fff" opacity="0.4"/>
                <circle cx="50" cy="350" r="1" fill="#fff" opacity="0.4"/>
                
                <!-- Dance floor grid -->
                <g opacity="0.05">
                    <path d="M60 150 L340 150 M60 230 L340 230 M60 310 L340 310 M60 390 L340 390" stroke="#222"/>
                    <path d="M130 80 L130 450 M200 80 L200 450 M270 80 L270 450" stroke="#222"/>
                </g>
                
                <!-- Exit (Bottom) -->
                <g opacity="0.6">
                    <rect x="170" y="475" width="60" height="25" fill="none" stroke="#555" stroke-width="2"/>
                    <text x="200" y="492" font-family="Arial" font-size="8" fill="#888" text-anchor="middle">EXIT</text>
                </g>
                
                <!-- Floor Navigation - Blueprint Style -->
                <g id="floor-nav">
                    <!-- Up Button -->
                    <circle cx="370" cy="200" r="12" fill="#000" stroke="#666" stroke-width="1"/>
                    <text x="370" y="205" font-family="Arial" font-size="10" fill="#888" text-anchor="middle" font-weight="bold">↑</text>
                    
                    <!-- Down Button -->
                    <circle cx="370" cy="320" r="12" fill="#000" stroke="#666" stroke-width="1"/>
                    <text x="370" y="325" font-family="Arial" font-size="10" fill="#888" text-anchor="middle" font-weight="bold">↓</text>
                </g>
                
                <!-- AI Control Panel - Inside Building -->
                <g id="ai-panel">
                    <rect x="300" y="450" width="80" height="40" fill="rgba(0,0,0,0.8)" stroke="#333" stroke-width="1" rx="4"/>
                    <text x="310" y="465" font-family="Arial" font-size="6" fill="#fff">Start AI</text>
                    <text x="310" y="475" font-family="Arial" font-size="6" fill="#fff">Stop AI</text>
                    <text x="350" y="465" font-family="Arial" font-size="6" fill="#fff">CHAOS</text>
                </g>
                
                <!-- Header Inside Building -->
                <g id="header-inside">
                    <rect x="20" y="20" width="360" height="25" fill="rgba(0,0,0,0.8)" stroke="#333" stroke-width="1" rx="4"/>
                    <text x="30" y="35" font-family="Arial" font-size="10" fill="#00ff88" font-weight="bold">SOUND FACTORY</text>
                    <text x="350" y="35" font-family="Arial" font-size="8" fill="#00ff88">Main Floor</text>
                </g>
                
                
                
            </svg>
        </div>
    </div>

    <!-- Character System -->
    <div class="character-overlay">
        <div class="person" id="character">
            <div class="shadow"></div>
            <div class="leg-left-upper">
                <div class="leg-left-lower"></div>
            </div>
            <div class="leg-right-upper">
                <div class="leg-right-lower"></div>
            </div>
            <div class="torso"></div>
            <div class="arm-left-upper">
                <div class="arm-left-lower"></div>
            </div>
            <div class="arm-right-upper">
                <div class="arm-right-lower"></div>
            </div>
            <div class="head"></div>
        </div>
    </div>

    <!-- Joystick Controls -->
    <div class="controls">
        <div class="joystick" id="joystick">
            <div class="joystick-knob" id="knob"></div>
        </div>
    </div>

    <script>
        // Grid System
        class GridSystem {
            constructor() {
                this.activeGrid = null;
                this.removedButtons = [1, 57]; // Buttons to remove
                this.init();
            }

            init() {
                this.createGrid();
                this.bindEvents();
            }

            createGrid() {
                const container = document.getElementById('gridContainer');
                container.innerHTML = '';
                
                // Create 64 buttons (8x8 grid)
                for (let i = 0; i < 64; i++) {
                    const button = document.createElement('button');
                    button.className = 'grid-button';
                    button.id = `btn-${i + 1}`;
                    
                    // Add button number
                    const number = document.createElement('span');
                    number.className = 'button-number';
                    number.textContent = i + 1;
                    button.appendChild(number);
                    
                    // Add special buttons to bottom grid
                    if (this.activeGrid === 'bottom') {
                        if (i === 60) { // Button 61 (index 60)
                            button.innerHTML = `<span>WALK</span>`;
                            button.style.background = 'linear-gradient(135deg, #ff1a78, #ff6b6b)';
                            button.style.color = '#fff';
                        } else if (i === 61) { // Button 62 (index 61)
                            button.innerHTML = `<span>RUN</span>`;
                        } else if (i === 62) { // Button 63 (index 62)
                            button.innerHTML = `<span>BREAK</span>`;
                        } else {
                            button.innerHTML += `<span>BTN ${i + 1}</span>`;
                        }
                    } else {
                        // Add button content
                        button.innerHTML += `<span>BTN ${i + 1}</span>`;
                    }
                    
                    // Mark removed buttons as empty
                    if (this.removedButtons.includes(i + 1)) {
                        button.classList.add('empty');
                        button.innerHTML = ''; // Remove content
                    }
                    
                    // Add click handler for non-empty buttons
                    if (!this.removedButtons.includes(i + 1)) {
                        button.addEventListener('click', () => this.handleButtonClick(i + 1));
                    }
                    
                    container.appendChild(button);
                }
            }

            bindEvents() {
                // T/M/B button events
                document.querySelectorAll('.toggle-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const gridType = e.target.dataset.grid;
                        this.toggleGrid(gridType);
                    });
                });
                
                // Close button
                document.getElementById('closeBtn').addEventListener('click', () => {
                    this.closeGrid();
                });
                
                // Close grid when clicking outside
                document.getElementById('gridOverlay').addEventListener('click', (e) => {
                    if (e.target === document.getElementById('gridOverlay')) {
                        this.closeGrid();
                    }
                });
                
                // Close grid with Escape key
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape' && this.activeGrid) {
                        this.closeGrid();
                    }
                });
            }

            toggleGrid(gridType) {
                if (this.activeGrid === gridType) {
                    this.closeGrid();
                } else {
                    this.openGrid(gridType);
                }
            }

            openGrid(gridType) {
                this.activeGrid = gridType;
                this.createGrid(); // Recreate grid with correct content
                document.getElementById('gridOverlay').classList.add('active');
                
                // Highlight the active button
                document.querySelectorAll('.toggle-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.querySelector(`[data-grid="${gridType}"]`).classList.add('active');
            }

            closeGrid() {
                this.activeGrid = null;
                document.getElementById('gridOverlay').classList.remove('active');
                
                // Remove active state from all buttons
                document.querySelectorAll('.toggle-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
            }

            handleButtonClick(buttonNumber) {
                console.log(`Button ${buttonNumber} clicked`);
                
                // Handle mode buttons in bottom grid
                if (this.activeGrid === 'bottom') {
                    if (buttonNumber === 61) { // WALK button
                        this.toggleModeButton(buttonNumber, 'walking');
                        return;
                    } else if (buttonNumber === 62) { // RUN button
                        this.toggleModeButton(buttonNumber, 'runway');
                        return;
                    } else if (buttonNumber === 63) { // BREAK button
                        this.toggleModeButton(buttonNumber, 'breakdance');
                        return;
                    }
                }
                
                // Add visual feedback for other buttons
                const button = document.getElementById(`btn-${buttonNumber}`);
                if (button) {
                    button.style.background = 'linear-gradient(135deg, #00ff88, #00dd77)';
                    button.style.borderColor = '#00ff88';
                    
                    // Reset after animation
                    setTimeout(() => {
                        button.style.background = 'linear-gradient(135deg, #333, #555)';
                        button.style.borderColor = '#666';
                    }, 200);
                }
            }

            toggleModeButton(buttonNumber, mode) {
                const button = document.getElementById(`btn-${buttonNumber}`);
                const isCurrentlySelected = button.classList.contains('selected');
                
                // Remove selection from all mode buttons
                document.querySelectorAll('.grid-button.selected').forEach(btn => {
                    btn.classList.remove('selected');
                    btn.style.background = 'linear-gradient(135deg, #333, #555)';
                    btn.style.borderColor = '#666';
                });
                
                if (!isCurrentlySelected) {
                    // Select this button
                    button.classList.add('selected');
                    button.style.background = 'linear-gradient(135deg, #ff1a78, #ff6b6b)';
                    button.style.borderColor = '#ff1a78';
                    this.setCharacterMode(mode);
                    console.log(`${mode.toUpperCase()} mode activated`);
                } else {
                    // Deselect this button
                    this.setCharacterMode('idle');
                    console.log('Mode deselected');
                }
            }

            setCharacterMode(mode) {
                const character = document.getElementById('character');
                if (character) {
                    character.classList.remove('walking', 'runway', 'breakdance');
                    if (mode !== 'idle') {
                        character.classList.add(mode);
                    }
                    console.log(`Character mode changed to: ${mode}`);
                    
                    // Update the global currentMode variable
                    window.currentMode = mode;
                    currentMode = mode;
                }
            }
        }

        // Character System
        const character = document.getElementById('character');
        const joystick = document.getElementById('joystick');
        const knob = document.getElementById('knob');
        const modeButtons = document.querySelectorAll('.mode-btn');

        let posX = window.innerWidth / 2;
        let posY = window.innerHeight / 2;
        let velocityX = 0;
        let velocityY = 0;
        let currentMode = 'walking';
        window.currentMode = currentMode;
        let isDragging = false;
        let joystickX = 0;
        let joystickY = 0;

        // Mode switching
        modeButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                modeButtons.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                character.classList.remove('walking', 'runway', 'breakdance');
                currentMode = btn.dataset.mode;
                if (velocityX !== 0 || velocityY !== 0) {
                    character.classList.add(currentMode);
                }
            });
        });

        // Joystick controls
        function handleJoystickStart(e) {
            isDragging = true;
            handleJoystickMove(e);
        }

        function handleJoystickMove(e) {
            if (!isDragging) return;
            const rect = joystick.getBoundingClientRect();
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;
            let clientX, clientY;
            if (e.touches) {
                clientX = e.touches[0].clientX;
                clientY = e.touches[0].clientY;
            } else {
                clientX = e.clientX;
                clientY = e.clientY;
            }
            let deltaX = clientX - centerX;
            let deltaY = clientY - centerY;
            const distance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);
            const maxDistance = rect.width / 2 - 20;
            if (distance > maxDistance) {
                deltaX = (deltaX / distance) * maxDistance;
                deltaY = (deltaY / distance) * maxDistance;
            }
            knob.style.transform = `translate(calc(-50% + ${deltaX}px), calc(-50% + ${deltaY}px))`;
            joystickX = deltaX / maxDistance;
            joystickY = deltaY / maxDistance;
            if (Math.abs(joystickX) > 0.1 || Math.abs(joystickY) > 0.1) {
                if (!character.classList.contains(currentMode)) {
                    character.classList.add(currentMode);
                }
            } else {
                character.classList.remove('walking', 'runway', 'breakdance');
            }
        }

        function handleJoystickEnd() {
            isDragging = false;
            knob.style.transform = 'translate(-50%, -50%)';
            joystickX = 0;
            joystickY = 0;
            character.classList.remove('walking', 'runway', 'breakdance');
        }

        // Touch events
        if (joystick) {
            joystick.addEventListener('touchstart', handleJoystickStart);
            joystick.addEventListener('touchmove', handleJoystickMove);
            joystick.addEventListener('touchend', handleJoystickEnd);
        }

        // Mouse events
        if (joystick) {
            joystick.addEventListener('mousedown', handleJoystickStart);
            document.addEventListener('mousemove', handleJoystickMove);
            document.addEventListener('mouseup', handleJoystickEnd);
        }

        // Animation loop
        function animate() {
            const speed = currentMode === 'runway' ? 3 : currentMode === 'breakdance' ? 2 : 4;
            velocityX = joystickX * speed;
            velocityY = joystickY * speed;
            posX += velocityX;
            posY += velocityY;
            posX = Math.max(20, Math.min(window.innerWidth - 20, posX));
            posY = Math.max(30, Math.min(window.innerHeight - 30, posY));
            character.style.left = posX + 'px';
            character.style.top = posY + 'px';
            if (Math.abs(velocityX) > 0.1 || Math.abs(velocityY) > 0.1) {
                const angle = Math.atan2(velocityY, velocityX) * (180 / Math.PI) + 90;
                if (currentMode !== 'breakdance') {
                    character.style.transform = `translate(-50%, -50%) rotate(${angle}deg)`;
                }
            }
            requestAnimationFrame(animate);
        }
        animate();

        // Initialize Grid System
        new GridSystem();
    </script>
</body>
</html>
