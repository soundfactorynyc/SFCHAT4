<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Instagram Audience Insights Viewer</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 24px; }
    header { display:flex; align-items:center; gap:12px; }
    h1 { margin:0; font-size: 22px; }
    .muted { color:#6b7280; font-size:12px; }
    fieldset { border:1px solid #e5e7eb; padding:16px; border-radius:8px; margin:16px 0; }
    legend { padding:0 8px; color:#374151; }
    table { width:100%; border-collapse: collapse; margin-top: 8px; }
    th, td { border:1px solid #e5e7eb; padding:6px 8px; font-size: 13px; }
    th { background:#f9fafb; text-align:left; }
    button { background:#111827; border:none; color:white; padding:8px 12px; border-radius:6px; cursor:pointer; }
    .row { display:flex; gap:12px; align-items: end; }
    .row > * { flex:1; }
  </style>
</head>
<body>
  <header>
    <h1>Instagram Audience Insights</h1>
    <a href="/site-map.html" class="muted">Site Map</a>
  </header>

  <fieldset>
    <legend>Load JSON</legend>
    <div class="row">
      <div>
        <label>Upload audience_insights.json
          <input id="fileInput" type="file" accept="application/json,.json" />
        </label>
      </div>
      <div>
        <button id="btnDemo">Load Demo From Clipboard</button>
      </div>
    </div>
    <div class="muted">This expects the structure from Instagram export: organic_insights_audience[0].string_map_data</div>
  </fieldset>

  <fieldset>
    <legend>Summary</legend>
    <div id="summary"></div>
  </fieldset>

  <fieldset>
    <legend>Follower % by City</legend>
    <div>
      <button data-export="cities">Export CSV</button>
    </div>
    <table id="tblCities">
      <thead><tr><th>City</th><th>%</th></tr></thead>
      <tbody></tbody>
    </table>
  </fieldset>

  <fieldset>
    <legend>Follower % by Country</legend>
    <div>
      <button data-export="countries">Export CSV</button>
    </div>
    <table id="tblCountries">
      <thead><tr><th>Country</th><th>%</th></tr></thead>
      <tbody></tbody>
    </table>
  </fieldset>

  <fieldset>
    <legend>Age Buckets (All / Men / Women)</legend>
    <div class="row">
      <div style="flex:1">
        <h3>All</h3>
        <table id="tblAgeAll"><thead><tr><th>Age</th><th>%</th></tr></thead><tbody></tbody></table>
      </div>
      <div style="flex:1">
        <h3>Men</h3>
        <table id="tblAgeMen"><thead><tr><th>Age</th><th>%</th></tr></thead><tbody></tbody></table>
      </div>
      <div style="flex:1">
        <h3>Women</h3>
        <table id="tblAgeWomen"><thead><tr><th>Age</th><th>%</th></tr></thead><tbody></tbody></table>
      </div>
    </div>
  </fieldset>

  <fieldset>
    <legend>Gender split & Follows/Unfollows</legend>
    <table id="tblGender"><thead><tr><th>Metric</th><th>Value</th></tr></thead><tbody></tbody></table>
  </fieldset>

  <fieldset>
    <legend>Follower Activity (by day)</legend>
    <div>
      <button data-export="activity">Export CSV</button>
    </div>
    <table id="tblActivity">
      <thead><tr><th>Day</th><th>Activity</th></tr></thead>
      <tbody></tbody>
    </table>
  </fieldset>

  <script>
    const $ = sel => document.querySelector(sel);

    function parsePercentList(value) {
      // Example: "New York: 27.6%, Old Bridge: 0.7%"
      if (!value) return [];
      return value.split(',').map(s => s.trim()).filter(Boolean).map(part => {
        const [label, val] = part.split(':').map(x => x.trim());
        const pct = parseFloat((val||'').replace('%','')) || 0;
        return { label, percent: pct };
      });
    }

    function setRows(tableId, rows) {
      const tbody = document.querySelector(`#${tableId} tbody`);
      tbody.innerHTML = rows.map(r => `<tr><td>${r.label}</td><td>${r.value ?? r.percent + '%'}</td></tr>`).join('');
    }

    function toCSV(rows, headers) {
      const h = headers.join(',');
      const body = rows.map(r => headers.map(k => JSON.stringify(r[k] ?? '')).join(',')).join('\n');
      return h + '\n' + body;
    }

    function downloadCSV(rows, headers, filename) {
      const csv = toCSV(rows, headers);
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      a.click();
      URL.revokeObjectURL(url);
    }

    function populate(data) {
      const rec = (data.organic_insights_audience || [])[0] || {};
      const m = rec.string_map_data || {};
      const asText = key => (m[key]?.value || '').trim();

      // Summary metrics
      const summary = [
        { label: 'Date Range', value: asText('Date Range') },
        { label: 'Followers', value: asText('Followers') },
        { label: 'Followers Delta', value: asText('Followers Delta') },
        { label: 'Follows', value: asText('Follows') },
        { label: 'Unfollows', value: asText('Unfollows') },
        { label: 'Overall followers', value: asText('Overall followers') }
      ];
      setRows('summary', summary.map(s => ({ label: s.label, value: s.value })));

      // Cities & countries
      const cities = parsePercentList(asText('Follower Percentage by City')).map(x => ({ label: x.label, percent: x.percent }));
      const countries = parsePercentList(asText('Follower Percentage by Country')).map(x => ({ label: x.label, percent: x.percent }));
      setRows('tblCities', cities.map(c => ({ label: c.label, value: c.percent + '%' })));
      setRows('tblCountries', countries.map(c => ({ label: c.label, value: c.percent + '%' })));

      // Age buckets
      const ageAll = parsePercentList(asText('Follower Percentage by Age for All Genders')).map(x => ({ label: x.label, percent: x.percent }));
      const ageMen = parsePercentList(asText('Follower Percentage by Age for Men')).map(x => ({ label: x.label, percent: x.percent }));
      const ageWomen = parsePercentList(asText('Follower Percentage by Age for Women')).map(x => ({ label: x.label, percent: x.percent }));
      setRows('tblAgeAll', ageAll.map(a => ({ label: a.label, value: a.percent + '%' })));
      setRows('tblAgeMen', ageMen.map(a => ({ label: a.label, value: a.percent + '%' })));
      setRows('tblAgeWomen', ageWomen.map(a => ({ label: a.label, value: a.percent + '%' })));

      // Gender split
      const gender = [
        { label: 'Total Follower Percentage for Men', value: asText('Total Follower Percentage for Men') },
        { label: 'Total Follower Percentage for Women', value: asText('Total Follower Percentage for Women') }
      ];
      // Add follows/unfollows
      gender.push({ label: 'Follows', value: asText('Follows') });
      gender.push({ label: 'Unfollows', value: asText('Unfollows') });
      setRows('tblGender', gender);

      // Activity by day
      const days = ['Monday','Tuesday','Wednesday','Thursday','Friday','Saturday','Sunday'];
      const activity = days.map(d => ({ label: d, value: asText(`${d} Follower Activity`) }));
      setRows('tblActivity', activity);

      // Hook exports
      document.querySelector('[data-export="cities"]').onclick = () => downloadCSV(cities, ['label','percent'], 'insights-cities.csv');
      document.querySelector('[data-export="countries"]').onclick = () => downloadCSV(countries, ['label','percent'], 'insights-countries.csv');
      document.querySelector('[data-export="activity"]').onclick = () => downloadCSV(activity, ['label','value'], 'insights-activity.csv');
    }

    // Special handler for the Summary table (div instead of table)
    function setRows(divId, rows) {
      const div = document.getElementById(divId);
      div.innerHTML = '<table><thead><tr><th>Metric</th><th>Value</th></tr></thead><tbody>' +
        rows.map(r => `<tr><td>${r.label}</td><td>${r.value}</td></tr>`).join('') + '</tbody></table>';
    }

    document.getElementById('fileInput').addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const text = await file.text();
      const json = JSON.parse(text);
      populate(json);
    });

    document.getElementById('btnDemo').addEventListener('click', async () => {
      try {
        const text = await navigator.clipboard.readText();
        const json = JSON.parse(text);
        populate(json);
      } catch (e) {
        alert('Clipboard does not contain valid JSON.');
      }
    });
  </script>
</body>
</html>
