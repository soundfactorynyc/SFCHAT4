<!-- SOUND FACTORY INTEGRATED CHAT WITH SMS AUTH -->
<!-- Add this to your site's HTML -->

<style>
/* CHAT CONTAINER - ALWAYS AT BOTTOM */
#sf-chat-system {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    height: 70px;
    background: rgba(0, 0, 0, 0.9);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border-top: 2px solid rgba(255, 0, 255, 0.3);
    z-index: 9999;
    transition: all 0.3s cubic-bezier(0.23, 1, 0.32, 1);
}

#sf-chat-system.expanded {
    height: 400px;
    background: rgba(0, 0, 0, 0.95);
    border-top-color: #FF00FF;
    box-shadow: 0 -10px 40px rgba(255, 0, 255, 0.3);
}

/* AUTH MODAL */
.sf-auth-modal {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(0, 0, 0, 0.95);
    border: 2px solid #FF00FF;
    border-radius: 20px;
    padding: 30px;
    z-index: 10000;
    min-width: 350px;
}

.sf-auth-modal.active {
    display: block;
    animation: modal-appear 0.3s ease-out;
}

@keyframes modal-appear {
    from {
        opacity: 0;
        transform: translate(-50%, -50%) scale(0.9);
    }
    to {
        opacity: 1;
        transform: translate(-50%, -50%) scale(1);
    }
}

.sf-auth-title {
    font-size: 1.5rem;
    font-weight: 900;
    background: linear-gradient(135deg, #FF00FF, #00FFFF);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin-bottom: 20px;
    text-align: center;
}

/* PHONE INPUT */
.sf-phone-input {
    width: 100%;
    padding: 12px;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 10px;
    color: white;
    font-size: 16px;
    margin-bottom: 15px;
}

.sf-phone-input:focus {
    outline: none;
    border-color: #FF00FF;
    box-shadow: 0 0 20px rgba(255, 0, 255, 0.3);
}

/* CODE INPUT */
.sf-code-inputs {
    display: flex;
    gap: 10px;
    justify-content: center;
    margin-bottom: 20px;
}

.sf-code-digit {
    width: 50px;
    height: 50px;
    text-align: center;
    font-size: 1.5rem;
    font-weight: 900;
    background: rgba(255, 255, 255, 0.05);
    border: 2px solid rgba(255, 255, 255, 0.2);
    border-radius: 10px;
    color: white;
}

.sf-code-digit:focus {
    outline: none;
    border-color: #00FFFF;
    box-shadow: 0 0 20px rgba(0, 255, 255, 0.5);
}

/* CHAT MESSAGES */
.sf-messages-container {
    height: calc(100% - 140px);
    overflow-y: auto;
    padding: 20px;
    display: none;
}

#sf-chat-system.expanded .sf-messages-container {
    display: block;
}

.sf-message {
    margin-bottom: 15px;
    animation: message-appear 0.3s ease-out;
}

@keyframes message-appear {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.sf-message.user {
    text-align: right;
}

.sf-message-bubble {
    display: inline-block;
    padding: 12px 20px;
    border-radius: 20px;
    max-width: 70%;
    font-weight: 600;
}

.sf-message.user .sf-message-bubble {
    background: linear-gradient(135deg, rgba(255, 0, 255, 0.3), rgba(139, 0, 255, 0.3));
    border: 1px solid #8B00FF;
}

.sf-message.ai .sf-message-bubble {
    background: linear-gradient(135deg, rgba(0, 255, 255, 0.2), rgba(0, 255, 136, 0.2));
    border: 1px solid #00FF88;
}

.sf-message.system .sf-message-bubble {
    background: linear-gradient(135deg, rgba(255, 215, 0, 0.2), rgba(255, 0, 255, 0.2));
    border: 1px solid #FFD700;
}

/* CHAT INPUT BAR */
.sf-chat-bar {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 70px;
    display: flex;
    align-items: center;
    padding: 0 15px;
    gap: 10px;
    background: rgba(0, 0, 0, 0.5);
    border-top: 1px solid rgba(255, 255, 255, 0.1);
}

/* PERSONALITY BUTTONS */
.sf-personality-buttons {
    display: flex;
    gap: 5px;
}

.sf-personality-btn {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    border: 1px solid rgba(255, 255, 255, 0.2);
    background: rgba(255, 255, 255, 0.05);
    color: white;
    font-size: 18px;
    cursor: pointer;
    transition: all 0.2s;
}

.sf-personality-btn:hover {
    transform: scale(1.1);
    border-color: var(--hover-color);
    background: var(--hover-bg);
}

.sf-personality-btn[data-mode="funny"] {
    --hover-color: #FFD700;
    --hover-bg: rgba(255, 215, 0, 0.2);
}

.sf-personality-btn[data-mode="smart"] {
    --hover-color: #00FFFF;
    --hover-bg: rgba(0, 255, 255, 0.2);
}

.sf-personality-btn[data-mode="shady"] {
    --hover-color: #FF00FF;
    --hover-bg: rgba(255, 0, 255, 0.2);
}

.sf-personality-btn[data-mode="demon"] {
    --hover-color: #FF0000;
    --hover-bg: rgba(255, 0, 0, 0.2);
}

/* MAIN INPUT */
.sf-chat-input {
    flex: 1;
    height: 45px;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 25px;
    padding: 0 20px;
    color: white;
    font-size: 14px;
    font-weight: 500;
}

.sf-chat-input:focus {
    outline: none;
    background: rgba(255, 255, 255, 0.08);
    border-color: #FF00FF;
    box-shadow: 0 0 20px rgba(255, 0, 255, 0.2);
}

/* SEND BUTTON */
.sf-send-btn {
    width: 45px;
    height: 45px;
    border-radius: 50%;
    border: none;
    background: linear-gradient(135deg, #FF00FF, #00FFFF);
    color: white;
    font-size: 20px;
    cursor: pointer;
    transition: all 0.2s;
}

.sf-send-btn:hover {
    transform: scale(1.1);
    box-shadow: 0 0 20px rgba(255, 0, 255, 0.5);
}

/* EXPAND BUTTON */
.sf-expand-btn {
    position: absolute;
    top: -30px;
    right: 20px;
    width: 60px;
    height: 30px;
    background: linear-gradient(135deg, #FF00FF, #00FFFF);
    border: none;
    border-radius: 10px 10px 0 0;
    color: white;
    font-weight: 700;
    cursor: pointer;
    font-size: 12px;
}

/* ENERGY INDICATOR */
.sf-energy-indicator {
    position: absolute;
    top: 10px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 12px;
    font-weight: 700;
    padding: 5px 15px;
    background: linear-gradient(135deg, #FF00FF, #00FFFF);
    border-radius: 20px;
    opacity: 0;
    transition: opacity 0.3s;
}

#sf-chat-system.expanded .sf-energy-indicator {
    opacity: 1;
}

/* STATUS DOTS */
.sf-status-dots {
    display: flex;
    gap: 4px;
}

.sf-dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.2);
    transition: all 0.3s;
}

.sf-dot.active {
    background: #00FF88;
    box-shadow: 0 0 8px #00FF88;
    animation: dot-pulse 2s ease-in-out infinite;
}

@keyframes dot-pulse {
    0%, 100% { transform: scale(1); opacity: 0.5; }
    50% { transform: scale(1.2); opacity: 1; }
}
</style>

<!-- CHAT HTML STRUCTURE -->
<div id="sf-chat-system">
    <!-- Expand Button -->
    <button class="sf-expand-btn" onclick="SFChat.toggleExpand()">CHAT</button>
    
    <!-- Energy Indicator -->
    <div class="sf-energy-indicator" id="sf-energy">ENERGY: 1</div>
    
    <!-- Messages Container -->
    <div class="sf-messages-container" id="sf-messages"></div>
    
    <!-- Chat Input Bar -->
    <div class="sf-chat-bar">
        <!-- Status Indicators -->
        <div class="sf-status-dots">
            <div class="sf-dot" id="dot1"></div>
            <div class="sf-dot" id="dot2"></div>
            <div class="sf-dot" id="dot3"></div>
        </div>
        
        <!-- Personality Buttons -->
        <div class="sf-personality-buttons">
            <button class="sf-personality-btn" data-mode="funny" onclick="SFChat.setPersonality('funny')" title="Funny">ðŸ˜‚</button>
            <button class="sf-personality-btn" data-mode="smart" onclick="SFChat.setPersonality('smart')" title="Smart">ðŸ§ </button>
            <button class="sf-personality-btn" data-mode="shady" onclick="SFChat.setPersonality('shady')" title="Shady">ðŸ˜ˆ</button>
            <button class="sf-personality-btn" data-mode="demon" onclick="SFChat.setPersonality('demon')" title="Demon">ðŸ‘¹</button>
        </div>
        
        <!-- Input -->
        <input type="text" 
               class="sf-chat-input" 
               id="sf-input" 
               placeholder="Type your message..."
               onkeypress="if(event.key==='Enter') SFChat.sendMessage()">
        
        <!-- Send Button -->
        <button class="sf-send-btn" onclick="SFChat.sendMessage()">âž¤</button>
    </div>
</div>

<!-- AUTH MODAL -->
<div class="sf-auth-modal" id="sf-auth-modal">
    <h2 class="sf-auth-title">SOUND FACTORY ACCESS</h2>
    
    <!-- Phone Input Step -->
    <div id="sf-phone-step">
        <input type="tel" 
               class="sf-phone-input" 
               id="sf-phone" 
               placeholder="Enter phone number (+1...)"
               value="+1">
        <button class="sf-send-btn" style="width: 100%; border-radius: 10px;" 
                onclick="SFChat.sendCode()">
            SEND CODE
        </button>
    </div>
    
    <!-- Code Verification Step -->
    <div id="sf-code-step" style="display: none;">
        <p style="text-align: center; margin-bottom: 20px; opacity: 0.8;">
            Enter verification code sent to <span id="sf-phone-display"></span>
        </p>
        <div class="sf-code-inputs">
            <input type="text" class="sf-code-digit" maxlength="1" id="code1" onkeyup="SFChat.moveToNext(1)">
            <input type="text" class="sf-code-digit" maxlength="1" id="code2" onkeyup="SFChat.moveToNext(2)">
            <input type="text" class="sf-code-digit" maxlength="1" id="code3" onkeyup="SFChat.moveToNext(3)">
            <input type="text" class="sf-code-digit" maxlength="1" id="code4" onkeyup="SFChat.moveToNext(4)">
            <input type="text" class="sf-code-digit" maxlength="1" id="code5" onkeyup="SFChat.moveToNext(5)">
            <input type="text" class="sf-code-digit" maxlength="1" id="code6" onkeyup="SFChat.moveToNext(6)">
        </div>
        <button class="sf-send-btn" style="width: 100%; border-radius: 10px;" 
                onclick="SFChat.verifyCode()">
            VERIFY
        </button>
    </div>
</div>

<!-- CHAT JAVASCRIPT -->
<script>
const SFChat = {
    // Configuration
    SMS_API: (typeof location !== 'undefined' ? location.origin : ''),
    CHAT_API: (typeof location !== 'undefined' ? location.origin : ''),
    
    // State
    isAuthenticated: false,
    token: null,
    phone: null,
    personality: null,
    energyLevel: 1,
    messages: [],
    expanded: false,
    
    // Initialize
    init() {
        // Check for existing token
        this.token = localStorage.getItem('sf_token');
        this.phone = localStorage.getItem('sf_phone');
        // Restore personality preference
        const savedPersonality = localStorage.getItem('sf_personality');
        if (savedPersonality) {
            this.personality = savedPersonality;
            // Visually mark active personality button after DOM is ready
            requestAnimationFrame(() => {
                document.querySelectorAll('.sf-personality-btn').forEach(btn => {
                    btn.style.transform = (btn.getAttribute('data-mode') === this.personality) ? 'scale(1.2)' : 'scale(1)';
                });
            });
        }
        
        if (this.token) {
            this.isAuthenticated = true;
            this.showChat();
        } else {
            this.showAuth();
        }
        
        // Load messages history
        this.loadMessages();
    },
    
    // Toggle chat expansion
    toggleExpand() {
        this.expanded = !this.expanded;
        const chat = document.getElementById('sf-chat-system');
        if (this.expanded) {
            chat.classList.add('expanded');
            this.activateDots();
        } else {
            chat.classList.remove('expanded');
            this.deactivateDots();
        }
    },
    
    // Show auth modal
    showAuth() {
        document.getElementById('sf-auth-modal').classList.add('active');
    },
    
    // Hide auth modal
    hideAuth() {
        document.getElementById('sf-auth-modal').classList.remove('active');
    },
    
    // Send SMS code
    async sendCode() {
        const phone = document.getElementById('sf-phone').value;
        
        if (!phone || phone.length < 10) {
            alert('Please enter a valid phone number');
            return;
        }
        
        try {
            const response = await fetch(`${this.SMS_API}/.netlify/functions/sms-send-code`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ phone })
            });
            
            const data = await response.json();
            
            if (data.ok) {
                // Show code input
                document.getElementById('sf-phone-step').style.display = 'none';
                document.getElementById('sf-code-step').style.display = 'block';
                document.getElementById('sf-phone-display').textContent = phone;
                this.phone = phone;
                
                // Focus first code input
                document.getElementById('code1').focus();
                
                this.addMessage('system', 'ðŸ“± Verification code sent! Check your phone.');
            } else {
                alert('Failed to send code: ' + (data.error || 'Unknown error'));
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Failed to send code. Please try again.');
        }
    },
    
    // Verify SMS code
    async verifyCode() {
        // Collect all code digits
        let code = '';
        for (let i = 1; i <= 6; i++) {
            code += document.getElementById(`code${i}`).value;
        }
        
        if (code.length !== 6) {
            alert('Please enter the complete 6-digit code');
            return;
        }
        
        try {
            const response = await fetch(`${this.SMS_API}/.netlify/functions/sms-verify-code`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    phone: this.phone,
                    code: code
                })
            });
            
            const data = await response.json();
            
            if (data.ok && data.token) {
                // Save auth
                this.token = data.token;
                this.isAuthenticated = true;
                localStorage.setItem('sf_token', data.token);
                localStorage.setItem('sf_phone', this.phone);
                
                // Hide auth modal
                this.hideAuth();
                
                // Show chat
                this.showChat();
                
                // Welcome message
                this.addMessage('system', 'ðŸŽ‰ Welcome to Sound Factory! You\'re verified!');
                
                // Expand chat
                if (!this.expanded) {
                    this.toggleExpand();
                }
            } else {
                alert('Invalid code. Please try again.');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Verification failed. Please try again.');
        }
    },
    
    // Move to next code input
    moveToNext(current) {
        const input = document.getElementById(`code${current}`);
        if (input.value && current < 6) {
            document.getElementById(`code${current + 1}`).focus();
        }
    },
    
    // Show chat
    showChat() {
        this.hideAuth();
        this.activateDots();
    },
    
    // Set personality
    setPersonality(mode) {
        this.personality = mode;
        localStorage.setItem('sf_personality', mode);
        
        // Visual feedback
        document.querySelectorAll('.sf-personality-btn').forEach(btn => {
            btn.style.transform = 'scale(1)';
        });
        document.querySelector(`[data-mode="${mode}"]`).style.transform = 'scale(1.2)';
        
        // Add message
        const personalities = {
            funny: 'ðŸ˜‚ FUNNY MODE ACTIVATED!',
            smart: 'ðŸ§  INTELLECTUAL MODE ENGAGED!',
            shady: 'ðŸ˜ˆ SHADE MODE ENABLED!',
            demon: 'ðŸ‘¹ DEMON MODE UNLEASHED!'
        };
        
        this.addMessage('system', personalities[mode]);
        
        // Update energy
        this.updateEnergy(this.energyLevel + 1);
    },
    
    // Send message
    async sendMessage() {
        const input = document.getElementById('sf-input');
        const message = input.value.trim();
        
        if (!message) return;
        
        if (!this.isAuthenticated) {
            this.showAuth();
            return;
        }
        
        // Add user message
        this.addMessage('user', message);
        
        // Clear input
        input.value = '';
        
        // Update energy based on typing speed
        this.updateEnergy(this.energyLevel + 0.5);
        
        // Send to API (Netlify function)
        try {
            const response = await fetch(`${this.CHAT_API}/.netlify/functions/chat`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    ...(this.token ? { 'Authorization': `Bearer ${this.token}` } : {})
                },
                body: JSON.stringify({
                    message,
                    personality: this.personality,
                    energyLevel: this.energyLevel
                })
            });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }
            const data = await response.json();
            const reply = data.reply || data.response || 'Okay.';
            this.addMessage('ai', reply);
            
        } catch (error) {
            console.error('Error:', error);
            // Fallback to local reply generator on failure
            this.handleAIResponse(message);
        }
    },
    
    // Handle AI response (simulate for now)
    handleAIResponse(userMessage) {
        const responses = {
            funny: [
                "BRUH that's wilder than my uncle at Thanksgiving! ðŸ˜‚",
                "I'm DECEASED! ðŸ’€ You really said that with your whole chest!",
                "Sir, this is a Wendy's... JK IT'S SOUND FACTORY BABY! ðŸ”¥"
            ],
            smart: [
                "Your linguistic expression reveals fascinating neurological patterns...",
                "The dopaminergic response to your query is statistically significant.",
                "Fascinating. Your statement correlates with quantum entanglement theory."
            ],
            shady: [
                "Oh honey, that's... certainly a choice you made. ðŸ’…",
                "The confidence... we love to see it. Kind of. ðŸ‘€",
                "Not you thinking that was the move... ðŸ™„"
            ],
            demon: [
                "YOUR SOUL TASTES LIKE MEDIOCRITY! ðŸ‘¹",
                "THE VOID ACKNOWLEDGES YOUR POOR DECISIONS! ðŸ”¥",
                "CHAOS ACCEPTS YOUR OFFERING... RELUCTANTLY! ðŸ’€"
            ],
            default: [
                "The vibe is IMMACULATE! ðŸ”¥",
                "Sound Factory energy detected! âš¡",
                "You just unlocked a new dimension! ðŸŒ€"
            ]
        };
        
        const personalityResponses = responses[this.personality] || responses.default;
        const response = personalityResponses[Math.floor(Math.random() * personalityResponses.length)];
        
        this.addMessage('ai', response);
        
        // Random energy boost
        if (Math.random() > 0.7) {
            this.updateEnergy(this.energyLevel + 2);
        }
    },
    
    // Add message to chat
    addMessage(type, content) {
        const container = document.getElementById('sf-messages');
        const messageDiv = document.createElement('div');
        messageDiv.className = `sf-message ${type}`;
        
        const bubble = document.createElement('div');
        bubble.className = 'sf-message-bubble';
        bubble.textContent = content;
        
        messageDiv.appendChild(bubble);
        container.appendChild(messageDiv);
        
        // Scroll to bottom
        container.scrollTop = container.scrollHeight;
        
        // Save to history
        this.messages.push({ type, content, timestamp: Date.now() });
        this.saveMessages();
    },
    
    // Update energy level
    updateEnergy(level) {
        this.energyLevel = Math.min(10, Math.max(1, level));
        document.getElementById('sf-energy').textContent = `ENERGY: ${Math.floor(this.energyLevel)}`;
        
        // Special effects at high energy
        if (this.energyLevel >= 8) {
            document.body.style.animation = 'shake 0.5s';
            setTimeout(() => {
                document.body.style.animation = '';
            }, 500);
        }
        
        // Vibrate at peak
        if (this.energyLevel >= 10 && navigator.vibrate) {
            navigator.vibrate([100, 50, 100, 50, 200]);
        }
    },
    
    // Activate status dots
    activateDots() {
        const dots = ['dot1', 'dot2', 'dot3'];
        dots.forEach((dot, i) => {
            setTimeout(() => {
                document.getElementById(dot).classList.add('active');
            }, i * 100);
        });
    },
    
    // Deactivate status dots
    deactivateDots() {
        const dots = ['dot1', 'dot2', 'dot3'];
        dots.forEach(dot => {
            document.getElementById(dot).classList.remove('active');
        });
    },
    
    // Save messages to localStorage
    saveMessages() {
        localStorage.setItem('sf_messages', JSON.stringify(this.messages.slice(-50)));
    },
    
    // Load messages from localStorage
    loadMessages() {
        const saved = localStorage.getItem('sf_messages');
        if (saved) {
            this.messages = JSON.parse(saved);
            this.messages.forEach(msg => {
                this.addMessage(msg.type, msg.content);
            });
        }
    }
};

// Initialize when page loads
document.addEventListener('DOMContentLoaded', () => {
    SFChat.init();
});

// Add shake animation
const style = document.createElement('style');
style.textContent = `
    @keyframes shake {
        0%, 100% { transform: translateX(0); }
        25% { transform: translateX(-10px); }
        75% { transform: translateX(10px); }
    }
`;
document.head.appendChild(style);
</script>