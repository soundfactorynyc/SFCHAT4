<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Sound Factory - Mobile Pin System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #000;
            color: #fff;
            overflow: hidden;
            height: 100vh;
            position: relative;
        }

        /* Main Floor - Keep your existing background */
        .floor-container {
            width: 100vw;
            height: 100vh;
            background: 
                radial-gradient(ellipse at 20% 30%, rgba(255, 20, 147, 0.1) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 70%, rgba(0, 255, 255, 0.1) 0%, transparent 50%),
                linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 50%, #16213e 100%);
            position: relative;
            overflow: hidden;
            cursor: crosshair;
        }

        /* Grid Pattern Overlay */
        .floor-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: 
                linear-gradient(rgba(255, 215, 0, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 215, 0, 0.03) 1px, transparent 1px);
            background-size: 50px 50px;
            pointer-events: none;
        }

        /* Header - Minimal */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
            padding: 15px 20px;
            z-index: 1000;
            border-bottom: 1px solid rgba(255, 215, 0, 0.2);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
        }

        .logo {
            font-size: 18px;
            font-weight: 800;
            background: linear-gradient(135deg, #FFD700, #FF6B35);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .pin-counter {
            background: rgba(255, 215, 0, 0.2);
            border: 1px solid rgba(255, 215, 0, 0.3);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 13px;
            color: #FFD700;
            font-weight: 600;
        }

        /* Pin Types - Simple Colors */
        .pin {
            position: absolute;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            cursor: pointer;
            transform: translate(-50%, -50%);
            transition: all 0.3s ease;
            z-index: 100;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .pin:hover {
            transform: translate(-50%, -50%) scale(1.3);
        }

        /* Pin Colors */
        .pin.memory { background: #4A90E2; }
        .pin.song { background: #FFD700; }
        .pin.moment { background: #FF6B6B; }
        .pin.dream { background: #2ECC71; }
        .pin.promo { background: #9B59B6; }

        /* Pin Drop Animation */
        .pin.new {
            animation: pinDrop 0.6s ease-out;
        }

        @keyframes pinDrop {
            0% { 
                transform: translate(-50%, -50%) scale(0); 
                opacity: 0; 
            }
            50% { 
                transform: translate(-50%, -50%) scale(1.4); 
                opacity: 1; 
            }
            100% { 
                transform: translate(-50%, -50%) scale(1); 
                opacity: 1; 
            }
        }

        /* Small, Sleek Pin Creation Box */
        .pin-creation-box {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(100%);
            background: rgba(0, 0, 0, 0.95);
            border: 2px solid #FFD700;
            border-radius: 15px;
            padding: 20px;
            max-width: 320px;
            width: 90%;
            z-index: 2000;
            backdrop-filter: blur(10px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .pin-creation-box.show {
            transform: translateX(-50%) translateY(0);
        }

        .creation-header {
            text-align: center;
            margin-bottom: 15px;
        }

        .creation-header h3 {
            color: #FFD700;
            font-size: 16px;
            margin-bottom: 5px;
        }

        .creation-header p {
            color: #aaa;
            font-size: 12px;
        }

        /* Pin Type Selector - Horizontal */
        .pin-type-selector {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            justify-content: center;
        }

        .type-option {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .type-option.selected {
            border-color: #FFD700;
            transform: scale(1.1);
        }

        .type-option.memory { background: #4A90E2; }
        .type-option.song { background: #FFD700; }
        .type-option.moment { background: #FF6B6B; }
        .type-option.dream { background: #2ECC71; }
        .type-option.promo { background: #9B59B6; }

        /* Form Elements */
        .form-group {
            margin-bottom: 12px;
        }

        .form-input {
            width: 100%;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: #fff;
            font-size: 14px;
        }

        .form-input::placeholder {
            color: #666;
        }

        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            border-radius: 8px;
            background: rgba(255, 215, 0, 0.1);
            border: 1px solid rgba(255, 215, 0, 0.3);
        }

        .file-input {
            position: absolute;
            left: -9999px;
        }

        .file-input-label {
            display: block;
            padding: 10px;
            text-align: center;
            color: #FFD700;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .file-input-label:hover {
            background: rgba(255, 215, 0, 0.2);
        }

        /* Emoji/Avatar Selector */
        .emoji-selector {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .emoji-option {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        .emoji-option.selected {
            border-color: #FFD700;
            background: rgba(255, 215, 0, 0.2);
        }

        /* Action Buttons */
        .creation-actions {
            display: flex;
            gap: 10px;
        }

        .btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #FFD700, #FF6B35);
            color: #000;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .btn:hover {
            transform: translateY(-1px);
        }

        /* Pin Popup - Small and Sleek */
        .pin-popup {
            position: fixed;
            background: rgba(0, 0, 0, 0.95);
            border: 2px solid #FFD700;
            border-radius: 12px;
            padding: 15px;
            max-width: 280px;
            width: 90%;
            z-index: 1500;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.5);
            transform: scale(0);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .pin-popup.show {
            transform: scale(1);
        }

        /* Quick Reaction Buttons */
        .reaction-buttons {
            display: flex;
            gap: 6px;
            margin-top: 10px;
            justify-content: center;
        }

        .reaction-btn {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #fff;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .reaction-btn:hover {
            background: rgba(255, 215, 0, 0.3);
            transform: scale(1.1);
        }

        /* Quick Comment Buttons */
        .quick-comments {
            display: flex;
            gap: 6px;
            margin-top: 8px;
            flex-wrap: wrap;
        }

        .quick-comment-btn {
            padding: 4px 8px;
            background: rgba(255, 215, 0, 0.2);
            border: 1px solid rgba(255, 215, 0, 0.3);
            border-radius: 12px;
            color: #FFD700;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .quick-comment-btn:hover {
            background: rgba(255, 215, 0, 0.3);
        }

        /* Pin Rain Animation */
        .pin-rain {
            position: fixed;
            top: -20px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            pointer-events: none;
            z-index: 50;
            animation: pinRain 3s linear forwards;
        }

        @keyframes pinRain {
            0% { 
                transform: translateY(-20px) rotate(0deg); 
                opacity: 1; 
            }
            100% { 
                transform: translateY(100vh) rotate(360deg); 
                opacity: 0; 
            }
        }

        /* Ghost Pin Animation */
        .pin.ghost {
            animation: ghostFade 4s infinite;
        }

        @keyframes ghostFade {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 0.8; }
        }

        /* Pin Fusion Animation */
        .pin.fusion {
            animation: fusionGlow 2s infinite;
            background: linear-gradient(45deg, #FFD700, #FF6B35, #4A90E2, #2ECC71);
            background-size: 400% 400%;
            animation: fusionGlow 2s infinite, gradientShift 3s infinite;
        }

        @keyframes fusionGlow {
            0%, 100% { box-shadow: 0 0 15px rgba(255, 215, 0, 0.6); }
            50% { box-shadow: 0 0 30px rgba(255, 215, 0, 1); }
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Pulse Mode */
        .pin.pulse {
            animation: pulseMode 1.5s infinite;
        }

        @keyframes pulseMode {
            0%, 100% { 
                box-shadow: 0 0 10px rgba(255, 0, 0, 0.5);
                transform: translate(-50%, -50%) scale(1);
            }
            50% { 
                box-shadow: 0 0 25px rgba(255, 0, 0, 0.9);
                transform: translate(-50%, -50%) scale(1.2);
            }
        }

        /* Gold Pin (Pin Hunt) */
        .pin.gold {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            animation: goldFlash 2s infinite;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.8);
        }

        @keyframes goldFlash {
            0%, 100% { 
                box-shadow: 0 0 20px rgba(255, 215, 0, 0.8);
                transform: translate(-50%, -50%) scale(1);
            }
            50% { 
                box-shadow: 0 0 40px rgba(255, 215, 0, 1);
                transform: translate(-50%, -50%) scale(1.3);
            }
        }

        /* Promo Pin Special Styling */
        .pin.promo {
            background: linear-gradient(135deg, #9B59B6, #8E44AD);
            animation: promoGlow 3s infinite;
            box-shadow: 0 0 15px rgba(155, 89, 182, 0.6);
        }

        @keyframes promoGlow {
            0%, 100% { 
                box-shadow: 0 0 15px rgba(155, 89, 182, 0.6);
                transform: translate(-50%, -50%) scale(1);
            }
            50% { 
                box-shadow: 0 0 30px rgba(155, 89, 182, 1);
                transform: translate(-50%, -50%) scale(1.1);
            }
        }

        /* Promo Pin Popup Special */
        .pin-popup.promo {
            border-color: #9B59B6;
            background: rgba(155, 89, 182, 0.1);
        }

        .promo-countdown {
            background: linear-gradient(135deg, #9B59B6, #8E44AD);
            color: #fff;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: bold;
            text-align: center;
            margin-bottom: 10px;
        }

        .promo-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

        .promo-btn {
            flex: 1;
            padding: 8px;
            background: linear-gradient(135deg, #9B59B6, #8E44AD);
            border: none;
            border-radius: 6px;
            color: #fff;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .promo-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(155, 89, 182, 0.4);
        }

        .popup-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .popup-avatar {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: linear-gradient(135deg, #FFD700, #FF6B35);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #000;
            font-size: 12px;
        }

        .popup-info h4 {
            color: #FFD700;
            font-size: 14px;
            margin-bottom: 2px;
        }

        .popup-info .pin-type {
            font-size: 11px;
            color: #aaa;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .popup-content {
            margin-bottom: 10px;
        }

        .popup-caption {
            color: #fff;
            font-size: 13px;
            line-height: 1.4;
            margin-bottom: 8px;
        }

        .popup-image {
            width: 100%;
            height: 120px;
            background: #333;
            border-radius: 6px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
            font-size: 12px;
            background-size: cover;
            background-position: center;
        }

        .popup-actions {
            display: flex;
            gap: 8px;
        }

        .action-btn {
            flex: 1;
            padding: 6px 8px;
            background: rgba(255, 215, 0, 0.2);
            border: 1px solid rgba(255, 215, 0, 0.3);
            border-radius: 6px;
            color: #FFD700;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }

        .action-btn:hover {
            background: rgba(255, 215, 0, 0.3);
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 80px;
            right: 20px;
            background: rgba(0, 0, 0, 0.9);
            border: 1px solid #FFD700;
            border-radius: 8px;
            padding: 12px 15px;
            max-width: 250px;
            z-index: 1500;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification-content {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .notification-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #FFD700;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #000;
            font-weight: bold;
            font-size: 12px;
        }

        .notification-text {
            flex: 1;
            font-size: 13px;
        }

        /* Mobile Optimizations */
        @media (max-width: 768px) {
            .pin-creation-box {
                max-width: 300px;
                padding: 15px;
            }
            
            .pin-type-selector {
                gap: 6px;
            }
            
            .type-option {
                width: 35px;
                height: 35px;
                font-size: 16px;
            }
            
            .pin-popup {
                max-width: 260px;
                padding: 12px;
            }
        }

        /* Accessibility */
        @media (prefers-reduced-motion: reduce) {
            .pin, .pin-popup, .pin-creation-box {
                animation: none;
                transition: none;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="logo">SOUND FACTORY</div>
            <div class="pin-counter" id="pinCounter">5 Pins Left</div>
        </div>
    </header>

    <!-- Main Floor -->
    <div class="floor-container" id="floorContainer">
        <!-- Pins will be dynamically added here -->
    </div>

    <!-- Small, Sleek Pin Creation Box -->
    <div class="pin-creation-box" id="pinCreationBox">
        <div class="creation-header">
            <h3>Drop Your Pin</h3>
            <p>Share your moment</p>
        </div>
        
        <!-- Pin Type Selector -->
        <div class="pin-type-selector">
            <div class="type-option memory selected" data-type="memory" title="Memory">💙</div>
            <div class="type-option song" data-type="song" title="Song">🎵</div>
            <div class="type-option moment" data-type="moment" title="Moment">🔥</div>
            <div class="type-option dream" data-type="dream" title="Dream">💚</div>
            <div class="type-option promo" data-type="promo" title="Promo">💜</div>
        </div>
        
        <!-- Emoji/Avatar Selector -->
        <div class="emoji-selector">
            <div class="emoji-option selected" data-emoji="😎">😎</div>
            <div class="emoji-option" data-emoji="🔥">🔥</div>
            <div class="emoji-option" data-emoji="🎵">🎵</div>
            <div class="emoji-option" data-emoji="💃">💃</div>
            <div class="emoji-option" data-emoji="🌟">🌟</div>
            <div class="emoji-option" data-emoji="🎉">🎉</div>
        </div>
        
        <!-- Form -->
        <div class="form-group">
            <input type="text" class="form-input" id="pinCaption" placeholder="What's happening here? (optional)">
        </div>
        
        <div class="form-group">
            <div class="file-input-wrapper">
                <input type="file" class="file-input" id="pinImage" accept="image/*">
                <label for="pinImage" class="file-input-label">📷 Add Photo</label>
            </div>
        </div>
        
        <!-- Actions -->
        <div class="creation-actions">
            <button class="btn btn-secondary" id="cancelBtn">Cancel</button>
            <button class="btn btn-primary" id="confirmBtn">Drop Pin</button>
        </div>
    </div>

    <!-- Pin Popup Template -->
    <div class="pin-popup" id="pinPopup">
        <div class="popup-header">
            <div class="popup-avatar" id="popupAvatar">😎</div>
            <div class="popup-info">
                <h4 id="popupName">User Name</h4>
                <div class="pin-type" id="popupType">Memory</div>
            </div>
        </div>
        <div class="popup-content">
            <div class="popup-caption" id="popupCaption">This is a sample caption...</div>
            <div class="popup-image" id="popupImage">📷 No Image</div>
        </div>
        <div class="popup-actions">
            <button class="action-btn" id="likeBtn">❤️ Like</button>
            <button class="action-btn" id="shareBtn">📤 Share</button>
            <button class="action-btn" id="saveBtn">💾 Save</button>
        </div>
        
        <!-- Quick Reactions -->
        <div class="reaction-buttons">
            <button class="reaction-btn" data-reaction="🔥">🔥</button>
            <button class="reaction-btn" data-reaction="❤️">❤️</button>
            <button class="reaction-btn" data-reaction="🎶">🎶</button>
            <button class="reaction-btn" data-reaction="😍">😍</button>
            <button class="reaction-btn" data-reaction="💃">💃</button>
        </div>
        
        <!-- Quick Comments -->
        <div class="quick-comments">
            <button class="quick-comment-btn" data-comment="See you there!">See you there!</button>
            <button class="quick-comment-btn" data-comment="Amazing!">Amazing!</button>
            <button class="quick-comment-btn" data-comment="🔥🔥🔥">🔥🔥🔥</button>
            <button class="quick-comment-btn" data-comment="Love this!">Love this!</button>
        </div>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification">
        <div class="notification-content">
            <div class="notification-icon">📍</div>
            <div class="notification-text" id="notificationText">New pin dropped!</div>
        </div>
    </div>

    <script>
        class MobilePinSystem {
            constructor() {
                this.pins = [];
                this.userPins = 0;
                this.maxPins = 5;
                this.selectedPinType = 'memory';
                this.selectedEmoji = '😎';
                this.pendingPosition = null;
                this.currentUser = {
                    name: 'Guest User',
                    avatar: '😎'
                };
                
                // Advanced features
                this.pinRainActive = false;
                this.ghostPins = [];
                this.fusionCheckInterval = null;
                this.pulseMode = false;
                this.goldPins = [];
                this.promoPins = [];
                this.eventCountdowns = new Map();
                
                this.init();
            }
            
            init() {
                this.setupEventListeners();
                this.createSamplePins();
                this.updatePinCounter();
                this.startAdvancedFeatures();
            }
            
            startAdvancedFeatures() {
                // Start pin fusion checking
                this.fusionCheckInterval = setInterval(() => {
                    this.checkForPinFusion();
                }, 2000);
                
                // Start ghost pin system
                this.startGhostPinSystem();
                
                // Start pin hunt (gold pins)
                this.startPinHunt();
                
                // Start promo system
                this.startPromoSystem();
                
                // Simulate DJ drops for pin rain
                this.simulateDJEvents();
            }
            
            setupEventListeners() {
                // Floor click for pin creation
                document.getElementById('floorContainer').addEventListener('click', (e) => {
                    if (e.target.id === 'floorContainer') {
                        this.showPinCreationBox(e.clientX, e.clientY);
                    }
                });
                
                // Pin type selection
                document.querySelectorAll('.type-option').forEach(option => {
                    option.addEventListener('click', () => {
                        document.querySelectorAll('.type-option').forEach(o => o.classList.remove('selected'));
                        option.classList.add('selected');
                        this.selectedPinType = option.dataset.type;
                    });
                });
                
                // Emoji selection
                document.querySelectorAll('.emoji-option').forEach(option => {
                    option.addEventListener('click', () => {
                        document.querySelectorAll('.emoji-option').forEach(o => o.classList.remove('selected'));
                        option.classList.add('selected');
                        this.selectedEmoji = option.dataset.emoji;
                    });
                });
                
                // Modal actions
                document.getElementById('cancelBtn').addEventListener('click', () => {
                    this.hidePinCreationBox();
                });
                
                document.getElementById('confirmBtn').addEventListener('click', () => {
                    this.createPin();
                });
                
                // Popup actions
                document.getElementById('likeBtn').addEventListener('click', () => {
                    this.likePin();
                });
                
                document.getElementById('shareBtn').addEventListener('click', () => {
                    this.sharePin();
                });
                
                document.getElementById('saveBtn').addEventListener('click', () => {
                    this.savePin();
                });
                
                // Close popup when clicking outside
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('.pin-popup') && !e.target.closest('.pin')) {
                        this.hidePinPopup();
                    }
                });
                
                // Reaction buttons
                document.querySelectorAll('.reaction-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        this.addReaction(btn.dataset.reaction);
                    });
                });
                
                // Quick comment buttons
                document.querySelectorAll('.quick-comment-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        this.addQuickComment(btn.dataset.comment);
                    });
                });
            }
            
            showPinCreationBox(x, y) {
                if (this.userPins >= this.maxPins) {
                    this.showNotification('You\'ve reached your pin limit!', 'warning');
                    return;
                }
                
                this.pendingPosition = { x, y };
                const box = document.getElementById('pinCreationBox');
                box.classList.add('show');
                
                // Reset form
                document.getElementById('pinCaption').value = '';
                document.getElementById('pinImage').value = '';
            }
            
            hidePinCreationBox() {
                document.getElementById('pinCreationBox').classList.remove('show');
            }
            
            createPin() {
                const caption = document.getElementById('pinCaption').value;
                const imageFile = document.getElementById('pinImage').files[0];
                
                const pin = {
                    id: Date.now(),
                    type: this.selectedPinType,
                    x: this.pendingPosition.x,
                    y: this.pendingPosition.y,
                    caption: caption || '',
                    image: imageFile ? URL.createObjectURL(imageFile) : null,
                    emoji: this.selectedEmoji,
                    user: this.currentUser,
                    createdAt: new Date(),
                    likes: 0
                };
                
                this.pins.push(pin);
                this.userPins++;
                this.renderPin(pin);
                this.hidePinCreationBox();
                this.updatePinCounter();
                this.showNotification('Pin dropped! 🎉', 'success');
                
                // Add new pin animation
                setTimeout(() => {
                    const pinElement = document.querySelector(`[data-pin-id="${pin.id}"]`);
                    if (pinElement) {
                        pinElement.classList.add('new');
                    }
                }, 100);
            }
            
            renderPin(pin) {
                const pinElement = document.createElement('div');
                pinElement.className = `pin ${pin.type}`;
                pinElement.style.left = pin.x + 'px';
                pinElement.style.top = pin.y + 'px';
                pinElement.dataset.pinId = pin.id;
                pinElement.title = pin.caption || `${pin.type} pin`;
                
                // Add click handler
                pinElement.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.showPinPopup(pin);
                });
                
                document.getElementById('floorContainer').appendChild(pinElement);
            }
            
            showPinPopup(pin) {
                const popup = document.getElementById('pinPopup');
                const avatar = document.getElementById('popupAvatar');
                const name = document.getElementById('popupName');
                const type = document.getElementById('popupType');
                const caption = document.getElementById('popupCaption');
                const image = document.getElementById('popupImage');
                
                avatar.textContent = pin.emoji;
                name.textContent = pin.user.name;
                type.textContent = pin.type.charAt(0).toUpperCase() + pin.type.slice(1);
                caption.textContent = pin.caption || 'No caption';
                
                if (pin.image) {
                    image.style.backgroundImage = `url(${pin.image})`;
                    image.style.backgroundSize = 'cover';
                    image.style.backgroundPosition = 'center';
                    image.textContent = '';
                } else {
                    image.style.backgroundImage = 'none';
                    image.textContent = '📷 No Image';
                }
                
                // Position popup near pin
                const offsetX = pin.x > window.innerWidth / 2 ? -280 : 20;
                const offsetY = pin.y > window.innerHeight / 2 ? -200 : 20;
                
                popup.style.left = (pin.x + offsetX) + 'px';
                popup.style.top = (pin.y + offsetY) + 'px';
                popup.classList.add('show');
                
                // Store current pin for actions
                this.currentPin = pin;
            }
            
            hidePinPopup() {
                document.getElementById('pinPopup').classList.remove('show');
            }
            
            likePin() {
                if (this.currentPin) {
                    this.currentPin.likes++;
                    this.showNotification('Pin liked! ❤️', 'success');
                    this.hidePinPopup();
                }
            }
            
            sharePin() {
                if (this.currentPin) {
                    this.showNotification('Pin shared! 📤', 'success');
                    this.hidePinPopup();
                }
            }
            
            savePin() {
                if (this.currentPin) {
                    this.showNotification('Pin saved! 💾', 'success');
                    this.hidePinPopup();
                }
            }
            
            createSamplePins() {
                const samplePins = [
                    { type: 'memory', x: 200, y: 300, caption: 'Amazing night!', emoji: '😎', user: { name: 'DJ Mike' }},
                    { type: 'song', x: 400, y: 200, caption: 'This track is fire! 🔥', emoji: '🎵', user: { name: 'Sarah' }},
                    { type: 'moment', x: 600, y: 400, caption: 'Best drop ever!', emoji: '🔥', user: { name: 'Alex' }},
                    { type: 'dream', x: 300, y: 500, caption: 'Wish I could DJ here', emoji: '💃', user: { name: 'Chris' }},
                    { type: 'promo', x: 500, y: 150, caption: 'VIP Tables Available!', emoji: '🌟', user: { name: 'Host' }}
                ];
                
                samplePins.forEach((pinData, index) => {
                    const pin = {
                        id: Date.now() + index,
                        ...pinData,
                        user: pinData.user,
                        createdAt: new Date(),
                        likes: Math.floor(Math.random() * 20)
                    };
                    
                    this.pins.push(pin);
                    this.renderPin(pin);
                    
                    // Add drop animation
                    setTimeout(() => {
                        const pinElement = document.querySelector(`[data-pin-id="${pin.id}"]`);
                        if (pinElement) {
                            pinElement.classList.add('new');
                        }
                    }, index * 200);
                });
            }
            
            updatePinCounter() {
                const remaining = this.maxPins - this.userPins;
                document.getElementById('pinCounter').textContent = `${remaining} Pins Left`;
            }
            
            showNotification(message, type = 'info') {
                const notification = document.getElementById('notification');
                const text = document.getElementById('notificationText');
                
                text.textContent = message;
                notification.classList.add('show');
                
                setTimeout(() => {
                    notification.classList.remove('show');
                }, 3000);
            }
            
            // Advanced Features Implementation
            
            // Pin Rain System
            startPinRain(duration = 5000) {
                this.pinRainActive = true;
                const rainInterval = setInterval(() => {
                    if (this.pinRainActive) {
                        this.createRainPin();
                    }
                }, 200);
                
                setTimeout(() => {
                    this.pinRainActive = false;
                    clearInterval(rainInterval);
                }, duration);
            }
            
            createRainPin() {
                const rainPin = document.createElement('div');
                rainPin.className = 'pin-rain';
                rainPin.style.left = Math.random() * window.innerWidth + 'px';
                rainPin.style.background = this.getRandomPinColor();
                
                document.getElementById('floorContainer').appendChild(rainPin);
                
                setTimeout(() => rainPin.remove(), 3000);
            }
            
            getRandomPinColor() {
                const colors = ['#4A90E2', '#FFD700', '#FF6B6B', '#2ECC71', '#9B59B6'];
                return colors[Math.floor(Math.random() * colors.length)];
            }
            
            // Ghost Pin System
            startGhostPinSystem() {
                setInterval(() => {
                    if (this.pins.length > 0 && Math.random() < 0.3) {
                        this.createGhostPin();
                    }
                }, 10000);
            }
            
            createGhostPin() {
                const oldPin = this.pins[Math.floor(Math.random() * this.pins.length)];
                const ghostPin = document.createElement('div');
                ghostPin.className = `pin ${oldPin.type} ghost`;
                ghostPin.style.left = oldPin.x + 'px';
                ghostPin.style.top = oldPin.y + 'px';
                ghostPin.title = `Ghost: ${oldPin.caption}`;
                
                document.getElementById('floorContainer').appendChild(ghostPin);
                
                setTimeout(() => ghostPin.remove(), 8000);
            }
            
            // Pin Fusion System
            checkForPinFusion() {
                const pins = document.querySelectorAll('.pin:not(.fusion)');
                
                pins.forEach((pin1, i) => {
                    pins.forEach((pin2, j) => {
                        if (i >= j) return;
                        
                        const distance = this.calculateDistance(pin1, pin2);
                        if (distance < 30) {
                            this.fusePins(pin1, pin2);
                        }
                    });
                });
            }
            
            calculateDistance(pin1, pin2) {
                const rect1 = pin1.getBoundingClientRect();
                const rect2 = pin2.getBoundingClientRect();
                return Math.sqrt(
                    Math.pow(rect1.left - rect2.left, 2) + 
                    Math.pow(rect1.top - rect2.top, 2)
                );
            }
            
            fusePins(pin1, pin2) {
                const fusionPin = document.createElement('div');
                fusionPin.className = 'pin fusion';
                fusionPin.style.left = pin1.style.left;
                fusionPin.style.top = pin1.style.top;
                fusionPin.title = 'Fused Pin - Multiple stories combined!';
                
                document.getElementById('floorContainer').appendChild(fusionPin);
                
                pin1.remove();
                pin2.remove();
                
                this.showNotification('Pins fused! 🔥', 'success');
            }
            
            // Pulse Mode
            togglePulseMode() {
                this.pulseMode = !this.pulseMode;
                const pins = document.querySelectorAll('.pin');
                pins.forEach(pin => {
                    if (this.pulseMode) {
                        pin.classList.add('pulse');
                    } else {
                        pin.classList.remove('pulse');
                    }
                });
                
                this.showNotification(
                    this.pulseMode ? 'Pulse mode ON! 🔥' : 'Pulse mode OFF', 
                    'info'
                );
            }
            
            // Pin Hunt (Gold Pins)
            startPinHunt() {
                setInterval(() => {
                    if (Math.random() < 0.1) {
                        this.createGoldPin();
                    }
                }, 30000);
            }
            
            createGoldPin() {
                const goldPin = document.createElement('div');
                goldPin.className = 'pin gold';
                goldPin.style.left = Math.random() * (window.innerWidth - 100) + 50 + 'px';
                goldPin.style.top = Math.random() * (window.innerHeight - 200) + 100 + 'px';
                goldPin.title = '🎁 GOLD PIN - Tap for reward!';
                
                goldPin.addEventListener('click', () => {
                    this.claimGoldPin(goldPin);
                });
                
                document.getElementById('floorContainer').appendChild(goldPin);
                this.goldPins.push(goldPin);
                
                this.showNotification('Gold pin appeared! 🎁', 'success');
            }
            
            claimGoldPin(goldPin) {
                const rewards = [
                    'Free drink voucher!',
                    'VIP upgrade!',
                    '20% off next visit!',
                    'Free entry next time!',
                    'Exclusive merch!'
                ];
                
                const reward = rewards[Math.floor(Math.random() * rewards.length)];
                this.showNotification(`Reward: ${reward}`, 'success');
                goldPin.remove();
            }
            
            // Promo System
            startPromoSystem() {
                // Create sample promo pins
                this.createPromoPin({
                    event: 'Sound Factory VIP Night',
                    startTime: new Date(Date.now() + 2 * 60 * 60 * 1000), // 2 hours from now
                    ticketUrl: 'https://soundfactory.nyc/tickets',
                    flyer: 'VIP Night Flyer'
                });
            }
            
            createPromoPin(eventData) {
                const promoPin = document.createElement('div');
                promoPin.className = 'pin promo';
                promoPin.style.left = Math.random() * (window.innerWidth - 100) + 50 + 'px';
                promoPin.style.top = Math.random() * (window.innerHeight - 200) + 100 + 'px';
                promoPin.title = `Promo: ${eventData.event}`;
                promoPin.dataset.event = JSON.stringify(eventData);
                
                promoPin.addEventListener('click', () => {
                    this.showPromoPopup(eventData);
                });
                
                document.getElementById('floorContainer').appendChild(promoPin);
                this.promoPins.push(promoPin);
                
                // Start countdown
                this.startEventCountdown(eventData);
            }
            
            showPromoPopup(eventData) {
                const popup = document.getElementById('pinPopup');
                popup.classList.add('promo');
                
                // Update popup content for promo
                document.getElementById('popupName').textContent = 'Event Host';
                document.getElementById('popupType').textContent = 'Promo';
                document.getElementById('popupCaption').textContent = eventData.event;
                
                // Add countdown
                const countdown = document.createElement('div');
                countdown.className = 'promo-countdown';
                countdown.id = 'promoCountdown';
                popup.appendChild(countdown);
                
                // Add promo actions
                const promoActions = document.createElement('div');
                promoActions.className = 'promo-actions';
                promoActions.innerHTML = `
                    <button class="promo-btn" onclick="window.open('${eventData.ticketUrl}', '_blank')">Get Tickets</button>
                    <button class="promo-btn" onclick="this.shareEvent()">Share Event</button>
                `;
                popup.appendChild(promoActions);
                
                this.showPinPopup({ type: 'promo', x: 0, y: 0 });
            }
            
            startEventCountdown(eventData) {
                const updateCountdown = () => {
                    const now = new Date();
                    const timeLeft = eventData.startTime - now;
                    
                    if (timeLeft > 0) {
                        const hours = Math.floor(timeLeft / (1000 * 60 * 60));
                        const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
                        const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);
                        
                        const countdownElement = document.getElementById('promoCountdown');
                        if (countdownElement) {
                            countdownElement.textContent = `Starts in: ${hours}h ${minutes}m ${seconds}s`;
                        }
                    } else {
                        // Event started
                        this.showNotification('Event has started! 🎉', 'success');
                    }
                };
                
                setInterval(updateCountdown, 1000);
                updateCountdown();
            }
            
            // DJ Events Simulation
            simulateDJEvents() {
                setInterval(() => {
                    if (Math.random() < 0.2) {
                        this.triggerDJDrop();
                    }
                }, 45000); // Every 45 seconds
            }
            
            triggerDJDrop() {
                this.showNotification('🎵 DJ DROP! Pin rain incoming!', 'success');
                this.startPinRain(3000);
                this.togglePulseMode();
                
                setTimeout(() => {
                    this.togglePulseMode();
                }, 5000);
            }
            
            // Engagement Features
            addReaction(reaction) {
                if (this.currentPin) {
                    this.currentPin.reactions = this.currentPin.reactions || [];
                    this.currentPin.reactions.push(reaction);
                    this.showNotification(`Added ${reaction} reaction!`, 'success');
                    this.hidePinPopup();
                }
            }
            
            addQuickComment(comment) {
                if (this.currentPin) {
                    this.currentPin.comments = this.currentPin.comments || [];
                    this.currentPin.comments.push(comment);
                    this.showNotification(`Comment added: "${comment}"`, 'success');
                    this.hidePinPopup();
                }
            }
        }
        
        // Initialize the system
        document.addEventListener('DOMContentLoaded', () => {
            new MobilePinSystem();
        });
        
        // Touch event handling for mobile
        let touchStartY = 0;
        document.addEventListener('touchstart', (e) => {
            touchStartY = e.touches[0].clientY;
        }, { passive: true });
        
        document.addEventListener('touchmove', (e) => {
            const touchY = e.touches[0].clientY;
            const diff = touchStartY - touchY;
            
            if (Math.abs(diff) > 10) {
                e.preventDefault();
            }
        }, { passive: false });
    </script>
</body>
</html>
