<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Sound Factory">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#000000">
    <title>Sound Factory - Future of Nightlife</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #000;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            touch-action: none;
            user-select: none;
            -webkit-user-select: none;
            -webkit-touch-callout: none;
            -webkit-tap-highlight-color: transparent;
            position: fixed;
            width: 100%;
            height: 100%;
            /* iOS Safari fixes */
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: none;
        }

        .floor {
            width: 100vw;
            height: 100vh;
            height: calc(var(--vh, 1vh) * 100);
            background: linear-gradient(180deg, #0a0a0a, #050505);
            position: relative;
        }

        .floor::before {
            content: '';
            position: absolute;
            inset: 0;
            background-image: 
                linear-gradient(rgba(255,255,255,0.02) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255,255,255,0.02) 1px, transparent 1px);
            background-size: 40px 40px;
            pointer-events: none;
        }

        /* Character container - COOLER & SMALLER */
        .person {
            position: fixed;
            width: 20px;
            height: 20px;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
            z-index: 100;
        }

        /* Cool glowing dot avatar */
        .dot {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: radial-gradient(circle at 35% 35%, #fff, #ffd700);
            box-shadow: 
                0 0 20px #ffd700,
                0 0 40px rgba(255, 215, 0, 0.6),
                0 0 60px rgba(255, 215, 0, 0.3),
                0 0 80px rgba(255, 215, 0, 0.1);
            animation: goldenPulse 2s ease-in-out infinite;
        }

        /* Golden pulse animation */
        @keyframes goldenPulse {
            0%, 100% { 
                box-shadow: 
                    0 0 20px #ffd700,
                    0 0 40px rgba(255, 215, 0, 0.6),
                    0 0 60px rgba(255, 215, 0, 0.3),
                    0 0 80px rgba(255, 215, 0, 0.1);
            }
            50% { 
                box-shadow: 
                    0 0 30px #ffd700,
                    0 0 60px rgba(255, 215, 0, 0.8),
                    0 0 90px rgba(255, 215, 0, 0.5),
                    0 0 120px rgba(255, 215, 0, 0.2);
            }
        }

        /* Shadow - smaller and cooler */
        .shadow {
            position: absolute;
            width: 16px;
            height: 6px;
            background: radial-gradient(ellipse, rgba(255, 215, 0, 0.3), transparent);
            left: 2px;
            top: 18px;
            border-radius: 50%;
            z-index: -1;
        }

        /* Cool movement animations for the dot */
        .person.walking .dot {
            animation: goldenPulse 0.6s ease-in-out infinite, walkBounce 0.6s ease-in-out infinite;
        }

        /* Walking bounce animation */
        @keyframes walkBounce {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-2px); }
        }

        /* Normal walk keyframes */
        @keyframes armUpperSwingLeft {
            0%, 100% { transform: rotate(-25deg); }
            50% { transform: rotate(25deg); }
        }
        @keyframes armLowerSwingLeft {
            0%, 100% { transform: rotate(-10deg); }
            50% { transform: rotate(15deg); }
        }
        @keyframes armUpperSwingRight {
            0%, 100% { transform: rotate(25deg); }
            50% { transform: rotate(-25deg); }
        }
        @keyframes armLowerSwingRight {
            0%, 100% { transform: rotate(15deg); }
            50% { transform: rotate(-10deg); }
        }
        @keyframes legUpperStepLeft {
            0%, 100% { transform: rotate(-15deg); }
            25% { transform: rotate(20deg) translateY(-2px); }
            50% { transform: rotate(-15deg); }
        }
        @keyframes legLowerStepLeft {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(-30deg); }
            50% { transform: rotate(0deg); }
        }
        @keyframes legUpperStepRight {
            0%, 100% { transform: rotate(-15deg); }
            50% { transform: rotate(-15deg); }
            75% { transform: rotate(20deg) translateY(-2px); }
        }
        @keyframes legLowerStepRight {
            0%, 100% { transform: rotate(0deg); }
            50% { transform: rotate(0deg); }
            75% { transform: rotate(-30deg); }
        }

        /* Runway keyframes - exaggerated and fierce */
        @keyframes runwayHeadTilt {
            0%, 100% { transform: rotate(-5deg) translateX(2px); }
            50% { transform: rotate(5deg) translateX(-2px); }
        }
        @keyframes runwayTorsoSwivel {
            0%, 100% { transform: rotate(-8deg) scaleX(1.05); }
            50% { transform: rotate(8deg) scaleX(1.05); }
        }
        @keyframes runwayArmLeftUpper {
            0%, 100% { transform: rotate(-60deg) translateX(3px); }
            50% { transform: rotate(45deg) translateX(-2px); }
        }
        @keyframes runwayArmLeftLower {
            0%, 100% { transform: rotate(-45deg); }
            50% { transform: rotate(30deg); }
        }
        @keyframes runwayArmRightUpper {
            0%, 100% { transform: rotate(60deg) translateX(-3px); }
            50% { transform: rotate(-45deg) translateX(2px); }
        }
        @keyframes runwayArmRightLower {
            0%, 100% { transform: rotate(45deg); }
            50% { transform: rotate(-30deg); }
        }
        @keyframes runwayLegLeftUpper {
            0%, 100% { transform: rotate(-10deg) translateX(3px); }
            25% { transform: rotate(35deg) translateY(-3px) translateX(-2px); }
            50% { transform: rotate(-10deg) translateX(3px); }
        }
        @keyframes runwayLegRightUpper {
            0%, 100% { transform: rotate(-10deg) translateX(-3px); }
            50% { transform: rotate(-10deg) translateX(-3px); }
            75% { transform: rotate(35deg) translateY(-3px) translateX(2px); }
        }

        /* Breakdance keyframes */
        @keyframes breakdanceSpin {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            25% { transform: translate(-50%, -50%) rotate(180deg) scale(0.9); }
            50% { transform: translate(-50%, -50%) rotate(360deg) scale(1); }
            75% { transform: translate(-50%, -50%) rotate(540deg) scale(0.9); }
            100% { transform: translate(-50%, -50%) rotate(720deg); }
        }
        @keyframes breakArmLeftUpper {
            0%, 100% { transform: rotate(-90deg) translateX(5px); }
            50% { transform: rotate(90deg) translateX(-5px); }
        }
        @keyframes breakArmRightUpper {
            0%, 100% { transform: rotate(90deg) translateX(-5px); }
            50% { transform: rotate(-90deg) translateX(5px); }
        }
        @keyframes breakLegLeftUpper {
            0%, 100% { transform: rotate(-45deg) translateX(3px); }
            50% { transform: rotate(45deg) translateX(-3px); }
        }
        @keyframes breakLegRightUpper {
            0%, 100% { transform: rotate(45deg) translateX(-3px); }
            50% { transform: rotate(-45deg) translateX(3px); }
        }

        /* Pin Drop Modal */
        .pin-drop-modal {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 215, 0, 0.3);
            border-radius: 16px;
            padding: 20px;
            min-width: 300px;
            z-index: 1000;
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.5),
                0 0 20px rgba(255, 215, 0, 0.1);
        }

        .pin-drop-modal h3 {
            color: #ffd700;
            font-size: 18px;
            font-weight: 700;
            margin: 0 0 15px 0;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .pin-drop-modal input {
            width: 100%;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 215, 0, 0.3);
            border-radius: 8px;
            color: #fff;
            font-size: 14px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }

        .pin-drop-modal input:focus {
            outline: none;
            border-color: #ffd700;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
            background: rgba(255, 255, 255, 0.15);
        }

        .pin-drop-modal input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        .drop-btn {
            width: 100%;
            padding: 12px 20px;
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            border: none;
            border-radius: 8px;
            color: #000;
            font-size: 16px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.3);
        }

        .drop-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 215, 0, 0.5);
            background: linear-gradient(135deg, #ffed4e, #ffd700);
        }

        .drop-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 10px rgba(255, 215, 0, 0.3);
        }

        /* Floor Navigation System */
        .floor-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            transition: transform 0.5s ease;
            will-change: transform;
        }

        .floor {
            width: 100%;
            height: 100%;
            position: relative;
            background: linear-gradient(180deg, #0a0a0a, #050505);
        }

        .floor::before {
            content: '';
            position: absolute;
            inset: 0;
            background-image: 
                linear-gradient(rgba(255,255,255,0.02) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255,255,255,0.02) 1px, transparent 1px);
            background-size: 40px 40px;
            pointer-events: none;
        }

        /* Floor-specific backgrounds */
        .floor-main {
            background: linear-gradient(180deg, #0a0a0a, #050505);
        }

        .floor-vip {
            background: linear-gradient(180deg, #2a1a0a, #1a0a05);
        }

        .floor-basement {
            background: linear-gradient(180deg, #0a0505, #050202);
        }

        /* Rooftop with stars background */
        .floor-rooftop {
            background: linear-gradient(180deg, #0a0a1a, #000011);
            position: relative;
        }

        .floor-rooftop::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: 
                radial-gradient(2px 2px at 20px 30px, #fff, transparent),
                radial-gradient(2px 2px at 40px 70px, #fff, transparent),
                radial-gradient(1px 1px at 90px 40px, #fff, transparent),
                radial-gradient(1px 1px at 130px 80px, #fff, transparent),
                radial-gradient(2px 2px at 160px 30px, #fff, transparent);
            background-repeat: repeat;
            background-size: 200px 100px;
            animation: twinkle 4s ease-in-out infinite;
            pointer-events: none;
        }

        @keyframes twinkle {
            0%, 100% { opacity: 0.8; }
            50% { opacity: 1; }
        }

        /* Crowd density - more people on main floor */
        .crowd-dot {
            position: absolute;
            width: 8px;
            height: 8px;
            background: radial-gradient(circle, #ffd700, #ffed4e);
            border-radius: 50%;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
            animation: crowdMove 3s ease-in-out infinite;
        }

        @keyframes crowdMove {
            0%, 100% { transform: translate(0, 0); }
            25% { transform: translate(5px, -3px); }
            50% { transform: translate(-3px, 5px); }
            75% { transform: translate(3px, -2px); }
        }

        /* VIP floor - exclusive styling */
        .floor-vip .crowd-dot {
            opacity: 0.3;
            animation-duration: 5s;
        }

        /* Audio controls */
        .audio-controls {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1000;
        }

        .audio-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid rgba(255, 215, 0, 0.3);
            color: #ffd700;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 10px;
        }

        .audio-btn:hover {
            background: rgba(255, 215, 0, 0.1);
            transform: scale(1.1);
        }

        /* Gyro controls */
        .gyro-controls {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
        }

        .calibrate-btn {
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 215, 0, 0.3);
            border-radius: 12px;
            padding: 12px 20px;
            color: #ffd700;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .calibrate-btn:hover {
            background: rgba(255, 215, 0, 0.1);
            transform: scale(1.05);
        }

        .calibrate-btn.calibrating {
            background: rgba(255, 215, 0, 0.2);
            animation: pulse 1s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .gyro-status {
            position: fixed;
            bottom: 100px;
            left: 20px;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 215, 0, 0.3);
            border-radius: 8px;
            padding: 8px 12px;
            color: #ffd700;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            z-index: 1000;
        }

        /* Enhanced Live Video Chat System */
        .chat-bubble {
            position: fixed;
            bottom: 200px;
            right: 20px;
            width: 280px;
            height: 200px;
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(25px);
            border: 2px solid rgba(255, 215, 0, 0.6);
            border-radius: 25px;
            padding: 15px;
            z-index: 2000;
            transform: scale(0);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.7);
        }

        .chat-bubble.active {
            transform: scale(1);
        }

        .chat-bubble-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .chat-bubble-title {
            color: #ffd700;
            font-size: 14px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .chat-bubble-close {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: rgba(255, 0, 0, 0.9);
            border: none;
            color: white;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .chat-bubble-close:hover {
            background: rgba(255, 0, 0, 1);
            transform: scale(1.1);
        }

        /* Circular Video Windows */
        .video-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            height: 120px;
        }

        .video-container {
            position: relative;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            overflow: hidden;
            background: #000;
            border: 3px solid rgba(255, 215, 0, 0.4);
            transition: all 0.3s ease;
        }

        .video-container:hover {
            border-color: rgba(255, 215, 0, 0.8);
            transform: scale(1.05);
        }

        .live-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }

        .video-overlay {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(255, 0, 0, 0.9);
            color: white;
            font-size: 8px;
            font-weight: 700;
            padding: 3px 6px;
            border-radius: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
        }

        .video-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
        }

        .video-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 2px solid rgba(255, 215, 0, 0.4);
            background: rgba(0, 0, 0, 0.8);
            color: #ffd700;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .video-btn:hover {
            background: rgba(255, 215, 0, 0.2);
            border-color: rgba(255, 215, 0, 0.8);
            transform: scale(1.1);
        }

        .video-btn.active {
            background: rgba(255, 215, 0, 0.3);
            border-color: rgba(255, 215, 0, 1);
        }

        .video-btn.muted {
            background: rgba(255, 0, 0, 0.3);
            border-color: rgba(255, 0, 0, 0.8);
        }

        /* AR Mode Styles */
        .ar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(2px);
            z-index: 3000;
            display: none;
        }

        .ar-overlay.active {
            display: block;
        }

        .ar-pin {
            position: absolute;
            width: 30px;
            height: 30px;
            background: radial-gradient(circle, #ffd700, #ffed4e);
            border-radius: 50%;
            box-shadow: 0 0 20px #ffd700;
            animation: arPinPulse 2s ease-in-out infinite;
            z-index: 3001;
        }

        @keyframes arPinPulse {
            0%, 100% { transform: scale(1); opacity: 0.8; }
            50% { transform: scale(1.2); opacity: 1; }
        }

        /* Face Filters */
        .face-filter {
            position: absolute;
            pointer-events: none;
            z-index: 3002;
        }

        .vip-crown {
            width: 40px;
            height: 20px;
            background: linear-gradient(45deg, #ffd700, #ffed4e);
            border-radius: 50% 50% 0 0;
            position: relative;
            top: -25px;
            left: -5px;
            box-shadow: 0 0 15px #ffd700;
        }

        .vip-crown::before {
            content: '';
            position: absolute;
            top: -5px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-bottom: 10px solid #ffd700;
        }

        .sunglasses {
            width: 30px;
            height: 15px;
            background: #000;
            border-radius: 50%;
            position: relative;
            top: -10px;
            left: -5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.8);
        }

        .sunglasses::before {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 8px;
            height: 8px;
            background: #fff;
            border-radius: 50%;
        }

        .sunglasses::after {
            content: '';
            position: absolute;
            top: 2px;
            right: 2px;
            width: 8px;
            height: 8px;
            background: #fff;
            border-radius: 50%;
        }

        /* Confetti Animation */
        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            background: #ffd700;
            z-index: 4000;
            animation: confettiFall 3s ease-out forwards;
        }

        @keyframes confettiFall {
            0% {
                transform: translateY(-100vh) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(100vh) rotate(720deg);
                opacity: 0;
            }
        }

        /* Voice Proximity Indicator */
        .voice-proximity {
            position: fixed;
            bottom: 150px;
            left: 20px;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 215, 0, 0.3);
            border-radius: 12px;
            padding: 10px 15px;
            color: #ffd700;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            z-index: 1000;
            display: none;
        }

        .voice-proximity.active {
            display: block;
            animation: voicePulse 1s ease-in-out infinite;
        }

        @keyframes voicePulse {
            0%, 100% { opacity: 0.8; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.05); }
        }

        /* Screen Recording Controls */
        .recording-controls {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }

        .record-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(255, 0, 0, 0.8);
            border: 3px solid #fff;
            color: white;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(255, 0, 0, 0.3);
        }

        .record-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(255, 0, 0, 0.5);
        }

        .record-btn.recording {
            background: rgba(0, 255, 0, 0.8);
            animation: recordPulse 1s ease-in-out infinite;
        }

        @keyframes recordPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .recording-indicator {
            position: fixed;
            top: 80px;
            right: 20px;
            background: rgba(255, 0, 0, 0.9);
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            z-index: 1000;
            display: none;
        }

        .recording-indicator.active {
            display: block;
            animation: recordBlink 1s ease-in-out infinite;
        }

        @keyframes recordBlink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Shake Detection Indicator */
        .shake-indicator {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 215, 0, 0.9);
            color: #000;
            padding: 15px 25px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 2px;
            z-index: 4000;
            animation: shakeBounce 0.5s ease-out;
        }

        @keyframes shakeBounce {
            0% { transform: translate(-50%, -50%) scale(0); opacity: 0; }
            50% { transform: translate(-50%, -50%) scale(1.3); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }

        /* Selfie Pin Styles */
        .selfie-pin {
            position: absolute;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 3px solid #ffd700;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.6);
            z-index: 1001;
        }

        .selfie-pin:hover {
            transform: scale(1.1);
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.8);
        }

        .selfie-pin img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }

        .selfie-pin::after {
            content: 'ðŸ“ž';
            position: absolute;
            bottom: -5px;
            right: -5px;
            width: 20px;
            height: 20px;
            background: rgba(0, 0, 0, 0.8);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            border: 2px solid #ffd700;
        }

        .selfie-pin.online::after {
            background: rgba(0, 255, 0, 0.8);
            animation: onlinePulse 2s ease-in-out infinite;
        }

        @keyframes onlinePulse {
            0%, 100% { transform: scale(1); opacity: 0.8; }
            50% { transform: scale(1.2); opacity: 1; }
        }

        /* Selfie Camera Modal */
        .selfie-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
            z-index: 5000;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .selfie-modal.active {
            display: flex;
        }

        .selfie-camera {
            width: 300px;
            height: 400px;
            border-radius: 20px;
            overflow: hidden;
            position: relative;
            border: 3px solid #ffd700;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        .selfie-preview {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .selfie-controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 15px;
        }

        .selfie-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 3px solid #fff;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .selfie-btn:hover {
            transform: scale(1.1);
            background: rgba(255, 215, 0, 0.8);
        }

        .selfie-btn.capture {
            background: rgba(255, 0, 0, 0.8);
        }

        .selfie-btn.capture:hover {
            background: rgba(255, 0, 0, 1);
        }

        .selfie-close {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255, 0, 0, 0.8);
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Pin Drop with Selfie */
        .pin-drop-with-selfie {
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(25px);
            border: 2px solid rgba(255, 215, 0, 0.6);
            border-radius: 25px;
            padding: 20px;
            position: fixed;
            bottom: 200px;
            left: 50%;
            transform: translateX(-50%);
            width: 300px;
            z-index: 2000;
            display: none;
        }

        .pin-drop-with-selfie.active {
            display: block;
            animation: modalSlideUp 0.3s ease-out;
        }

        @keyframes modalSlideUp {
            0% { transform: translateX(-50%) translateY(100px); opacity: 0; }
            100% { transform: translateX(-50%) translateY(0); opacity: 1; }
        }

        .selfie-prompt {
            text-align: center;
            color: #ffd700;
            margin-bottom: 15px;
        }

        .selfie-prompt h3 {
            margin: 0 0 10px 0;
            font-size: 18px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .selfie-prompt p {
            margin: 0;
            font-size: 12px;
            opacity: 0.8;
        }

        .selfie-options {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .selfie-option-btn {
            padding: 10px 20px;
            border: 2px solid rgba(255, 215, 0, 0.4);
            background: rgba(0, 0, 0, 0.8);
            color: #ffd700;
            border-radius: 20px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.3s ease;
        }

        .selfie-option-btn:hover {
            background: rgba(255, 215, 0, 0.2);
            border-color: rgba(255, 215, 0, 0.8);
        }

        .selfie-option-btn.primary {
            background: rgba(255, 215, 0, 0.3);
            border-color: rgba(255, 215, 0, 0.8);
        }

        /* WebXR AR Mode Styles */
        .ar-xr-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: transparent;
            z-index: 6000;
            display: none;
            pointer-events: none;
        }

        .ar-xr-overlay.active {
            display: block;
        }

        /* 3D Floating Pins */
        .ar-pin-3d {
            position: absolute;
            width: 40px;
            height: 40px;
            background: radial-gradient(circle, #ffd700, #ffed4e);
            border-radius: 50%;
            box-shadow: 
                0 0 20px #ffd700,
                0 0 40px rgba(255, 215, 0, 0.6),
                0 0 60px rgba(255, 215, 0, 0.3);
            animation: arPinFloat 3s ease-in-out infinite;
            z-index: 6001;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .ar-pin-3d:hover {
            transform: scale(1.2);
            box-shadow: 
                0 0 30px #ffd700,
                0 0 60px rgba(255, 215, 0, 0.8),
                0 0 90px rgba(255, 215, 0, 0.5);
        }

        @keyframes arPinFloat {
            0%, 100% { 
                transform: translateY(0px) rotateY(0deg);
                opacity: 0.8;
            }
            50% { 
                transform: translateY(-10px) rotateY(180deg);
                opacity: 1;
            }
        }

        /* 3D Avatar in AR */
        .ar-avatar-3d {
            position: absolute;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 3px solid #ffd700;
            overflow: hidden;
            animation: arAvatarFloat 2s ease-in-out infinite;
            z-index: 6002;
            cursor: pointer;
        }

        .ar-avatar-3d img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }

        @keyframes arAvatarFloat {
            0%, 100% { transform: translateY(0px) scale(1); }
            50% { transform: translateY(-5px) scale(1.05); }
        }

        /* Gold Navigation Arrows */
        .ar-nav-arrow {
            position: absolute;
            width: 0;
            height: 0;
            z-index: 6003;
            animation: arArrowPulse 2s ease-in-out infinite;
        }

        .ar-nav-arrow.up {
            border-left: 15px solid transparent;
            border-right: 15px solid transparent;
            border-bottom: 25px solid #ffd700;
            filter: drop-shadow(0 0 10px #ffd700);
        }

        .ar-nav-arrow.down {
            border-left: 15px solid transparent;
            border-right: 15px solid transparent;
            border-top: 25px solid #ffd700;
            filter: drop-shadow(0 0 10px #ffd700);
        }

        .ar-nav-arrow.left {
            border-top: 15px solid transparent;
            border-bottom: 15px solid transparent;
            border-right: 25px solid #ffd700;
            filter: drop-shadow(0 0 10px #ffd700);
        }

        .ar-nav-arrow.right {
            border-top: 15px solid transparent;
            border-bottom: 15px solid transparent;
            border-left: 25px solid #ffd700;
            filter: drop-shadow(0 0 10px #ffd700);
        }

        @keyframes arArrowPulse {
            0%, 100% { 
                transform: scale(1);
                opacity: 0.8;
            }
            50% { 
                transform: scale(1.2);
                opacity: 1;
            }
        }

        /* VIP Area Glow Through Walls */
        .ar-vip-glow {
            position: absolute;
            border-radius: 20px;
            background: radial-gradient(circle, rgba(255, 215, 0, 0.3), transparent);
            border: 2px solid rgba(255, 215, 0, 0.6);
            animation: arVipGlow 3s ease-in-out infinite;
            z-index: 6004;
            pointer-events: none;
        }

        @keyframes arVipGlow {
            0%, 100% { 
                box-shadow: 0 0 20px rgba(255, 215, 0, 0.4);
                opacity: 0.6;
            }
            50% { 
                box-shadow: 0 0 40px rgba(255, 215, 0, 0.8);
                opacity: 1;
            }
        }

        /* AR Controls */
        .ar-controls {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 15px;
            z-index: 6005;
        }

        .ar-control-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid rgba(255, 215, 0, 0.6);
            color: #ffd700;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .ar-control-btn:hover {
            background: rgba(255, 215, 0, 0.2);
            border-color: rgba(255, 215, 0, 1);
            transform: scale(1.1);
        }

        .ar-control-btn.active {
            background: rgba(255, 215, 0, 0.3);
            border-color: rgba(255, 215, 0, 1);
        }

        /* AR Status Indicator */
        .ar-status {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid rgba(255, 215, 0, 0.3);
            border-radius: 15px;
            padding: 8px 15px;
            color: #ffd700;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            z-index: 6006;
            backdrop-filter: blur(10px);
        }

        .ar-status.tracking {
            border-color: rgba(0, 255, 0, 0.6);
            color: #00ff00;
        }

        .ar-status.lost {
            border-color: rgba(255, 0, 0, 0.6);
            color: #ff0000;
        }

        /* AR Pin Info Bubble */
        .ar-pin-info {
            position: absolute;
            background: rgba(0, 0, 0, 0.9);
            border: 1px solid rgba(255, 215, 0, 0.6);
            border-radius: 10px;
            padding: 8px 12px;
            color: #ffd700;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            z-index: 6007;
            pointer-events: none;
            opacity: 0;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .ar-pin-info.show {
            opacity: 1;
            transform: translateY(-5px);
        }

        /* AR Floor Overlay */
        .ar-floor-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 20%;
            background: linear-gradient(to top, rgba(0, 0, 0, 0.8), transparent);
            z-index: 6008;
            pointer-events: none;
        }

        /* TensorFlow.js Face Detection Styles */
        .face-detection-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 7000;
            pointer-events: none;
        }

        .face-filter-overlay {
            position: absolute;
            pointer-events: none;
            z-index: 7001;
        }

        .vip-crown-filter {
            width: 80px;
            height: 40px;
            background: linear-gradient(45deg, #ffd700, #ffed4e);
            border-radius: 50% 50% 0 0;
            position: relative;
            box-shadow: 0 0 20px #ffd700;
        }

        .vip-crown-filter::before {
            content: '';
            position: absolute;
            top: -8px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 12px solid transparent;
            border-right: 12px solid transparent;
            border-bottom: 15px solid #ffd700;
        }

        .sunglasses-filter {
            width: 60px;
            height: 30px;
            background: #000;
            border-radius: 50%;
            position: relative;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.8);
        }

        .sunglasses-filter::before {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            width: 12px;
            height: 12px;
            background: #fff;
            border-radius: 50%;
        }

        .sunglasses-filter::after {
            content: '';
            position: absolute;
            top: 3px;
            right: 3px;
            width: 12px;
            height: 12px;
            background: #fff;
            border-radius: 50%;
        }

        .fire-effect-filter {
            width: 100px;
            height: 100px;
            background: radial-gradient(circle, #ff4500, #ff6347, #ffa500);
            border-radius: 50%;
            position: relative;
            animation: fireFlicker 0.5s ease-in-out infinite alternate;
            filter: blur(2px);
        }

        @keyframes fireFlicker {
            0% { transform: scale(1) rotate(0deg); opacity: 0.8; }
            100% { transform: scale(1.1) rotate(2deg); opacity: 1; }
        }

        /* Shake Effects Styles */
        .shake-effect-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 8000;
        }

        .champagne-bottle {
            position: absolute;
            width: 40px;
            height: 80px;
            background: linear-gradient(to bottom, #fff, #f0f0f0);
            border-radius: 20px 20px 5px 5px;
            animation: champagnePop 2s ease-out forwards;
        }

        .champagne-bottle::before {
            content: '';
            position: absolute;
            top: -5px;
            left: 50%;
            transform: translateX(-50%);
            width: 15px;
            height: 20px;
            background: #8B4513;
            border-radius: 5px;
        }

        @keyframes champagnePop {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            50% { transform: translateY(-20px) scale(1.2); opacity: 0.8; }
            100% { transform: translateY(-100px) scale(0.5); opacity: 0; }
        }

        .confetti-particle {
            position: absolute;
            width: 8px;
            height: 8px;
            background: #ffd700;
            animation: confettiFall 3s ease-out forwards;
        }

        @keyframes confettiFall {
            0% {
                transform: translateY(-100vh) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(100vh) rotate(720deg);
                opacity: 0;
            }
        }

        /* Proximity Voice Styles */
        .proximity-voice-overlay {
            position: fixed;
            bottom: 100px;
            left: 20px;
            background: rgba(0, 0, 0, 0.9);
            border: 1px solid rgba(255, 215, 0, 0.6);
            border-radius: 15px;
            padding: 10px 15px;
            color: #ffd700;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            z-index: 9000;
            backdrop-filter: blur(20px);
        }

        .voice-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 5px;
        }

        .voice-level {
            width: 100px;
            height: 4px;
            background: rgba(255, 215, 0, 0.3);
            border-radius: 2px;
            overflow: hidden;
        }

        .voice-level-bar {
            height: 100%;
            background: linear-gradient(90deg, #ffd700, #ffed4e);
            border-radius: 2px;
            transition: width 0.1s ease;
        }

        .spatial-audio-indicator {
            position: absolute;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: rgba(255, 215, 0, 0.6);
            animation: spatialPulse 2s ease-in-out infinite;
        }

        @keyframes spatialPulse {
            0%, 100% { transform: scale(1); opacity: 0.6; }
            50% { transform: scale(1.2); opacity: 1; }
        }

        /* Messages Extension Styles */
        .messages-extension {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 10000;
            display: none;
        }

        .messages-extension.active {
            display: block;
        }

        .messages-header {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 60px;
            background: rgba(0, 0, 0, 0.9);
            border-bottom: 1px solid rgba(255, 215, 0, 0.3);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            z-index: 10001;
        }

        .messages-title {
            color: #ffd700;
            font-size: 18px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .messages-close {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255, 0, 0, 0.8);
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Feature Toggles - Preserve Main Design */
        .corner-controls {
            position: fixed;
            top: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            z-index: 10002;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        /* Show controls on mobile only */
        @media (max-width: 768px) {
            .corner-controls {
                opacity: 0.3;
            }
        }

        .corner-controls:hover {
            opacity: 1;
        }

        .corner-controls.has-active {
            opacity: 1;
        }

        .corner-btn {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.6);
            border: 1px solid rgba(255, 215, 0, 0.2);
            color: #ffd700;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            backdrop-filter: blur(8px);
            opacity: 0.7;
        }

        .corner-btn:hover {
            background: rgba(255, 215, 0, 0.15);
            border-color: rgba(255, 215, 0, 0.6);
            transform: scale(1.05);
            opacity: 1;
        }

        .corner-btn.active {
            background: rgba(255, 215, 0, 0.25);
            border-color: rgba(255, 215, 0, 0.8);
            opacity: 1;
            animation: subtlePulse 3s ease-in-out infinite;
        }

        @keyframes subtlePulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }

        /* AR Button - Mobile Only */
        .corner-btn#arModeBtn {
            display: none;
        }

        @media (max-width: 768px) {
            .corner-btn#arModeBtn {
                display: flex;
            }
        }

        /* Shake Feature - Hidden Discovery */
        .shake-hint {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid rgba(255, 215, 0, 0.3);
            border-radius: 20px;
            padding: 8px 12px;
            color: #ffd700;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            opacity: 0;
            transition: opacity 0.5s ease;
            z-index: 10001;
            pointer-events: none;
        }

        .shake-hint.show {
            opacity: 0.8;
            animation: hintFade 4s ease-in-out;
        }

        @keyframes hintFade {
            0%, 100% { opacity: 0; }
            20%, 80% { opacity: 0.8; }
        }

        /* Voice - Opt-in Only */
        .voice-opt-in {
            position: fixed;
            bottom: 80px;
            left: 20px;
            background: rgba(0, 0, 0, 0.9);
            border: 1px solid rgba(255, 215, 0, 0.4);
            border-radius: 15px;
            padding: 12px 16px;
            color: #ffd700;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s ease;
            z-index: 10001;
            max-width: 200px;
        }

        .voice-opt-in.show {
            opacity: 1;
            transform: translateY(0);
        }

        .voice-opt-in-btn {
            background: rgba(255, 215, 0, 0.2);
            border: 1px solid rgba(255, 215, 0, 0.4);
            border-radius: 8px;
            padding: 6px 12px;
            color: #ffd700;
            font-size: 10px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 8px;
            transition: all 0.3s ease;
        }

        .voice-opt-in-btn:hover {
            background: rgba(255, 215, 0, 0.3);
            border-color: rgba(255, 215, 0, 0.6);
        }

        /* Filters - Only in Video Chat */
        .video-chat-filters {
            position: absolute;
            bottom: 10px;
            left: 10px;
            display: flex;
            gap: 8px;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 10003;
        }

        .video-chat-filters.show {
            opacity: 1;
        }

        .filter-btn {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.7);
            border: 1px solid rgba(255, 215, 0, 0.3);
            color: #ffd700;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .filter-btn:hover {
            background: rgba(255, 215, 0, 0.2);
            border-color: rgba(255, 215, 0, 0.6);
        }

        .filter-btn.active {
            background: rgba(255, 215, 0, 0.3);
            border-color: rgba(255, 215, 0, 0.8);
        }

        /* Features hide in corner */
        .ar-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 40px;
            height: 40px;
            opacity: 0.7;
        }

        /* Main site unchanged */
        .floor-view {
            /* Stays exactly the same */
        }

        /* Shake Cost Indicator */
        .shake-cost {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 215, 0, 0.9);
            color: #000;
            padding: 15px 25px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 2px;
            z-index: 8001;
            animation: costBounce 0.5s ease-out;
        }

        @keyframes costBounce {
            0% { transform: translate(-50%, -50%) scale(0); opacity: 0; }
            50% { transform: translate(-50%, -50%) scale(1.3); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }

        /* Livestream System Styles */
        .livestream-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 15000;
            display: none;
        }

        .livestream-overlay.active {
            display: block;
        }

        .livestream-player {
            position: fixed;
            top: 20px;
            left: 20px;
            width: 300px;
            height: 200px;
            border-radius: 15px;
            overflow: hidden;
            border: 3px solid #ffd700;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.8);
            z-index: 15001;
        }

        .livestream-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .livestream-controls {
            position: fixed;
            top: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 15002;
        }

        .livestream-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(255, 0, 0, 0.9);
            border: 3px solid #fff;
            color: white;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(255, 0, 0, 0.4);
        }

        .livestream-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(255, 0, 0, 0.6);
        }

        .livestream-btn.live {
            background: rgba(0, 255, 0, 0.9);
            animation: livePulse 2s ease-in-out infinite;
        }

        @keyframes livePulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .livestream-info {
            position: fixed;
            top: 240px;
            left: 20px;
            background: rgba(0, 0, 0, 0.9);
            border: 1px solid rgba(255, 215, 0, 0.6);
            border-radius: 15px;
            padding: 15px;
            color: #ffd700;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            z-index: 15003;
            backdrop-filter: blur(20px);
        }

        .live-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
        }

        .live-dot {
            width: 8px;
            height: 8px;
            background: #ff0000;
            border-radius: 50%;
            animation: liveBlink 1s ease-in-out infinite;
        }

        @keyframes liveBlink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        /* Tipping Reactions System */
        .tipping-reactions {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 15px;
            z-index: 15004;
        }

        .tip-button {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 3px solid #fff;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: 700;
            color: white;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .tip-button:hover {
            transform: scale(1.1);
        }

        .tip-1 { background: linear-gradient(45deg, #ff6b6b, #ff8e8e); }
        .tip-5 { background: linear-gradient(45deg, #4ecdc4, #44a08d); }
        .tip-10 { background: linear-gradient(45deg, #45b7d1, #96c93d); }
        .tip-20 { background: linear-gradient(45deg, #f093fb, #f5576c); }
        .tip-50 { background: linear-gradient(45deg, #4facfe, #00f2fe); }

        .tip-keep {
            background: linear-gradient(45deg, #ffd700, #ffed4e);
            color: #000;
            font-size: 12px;
            text-align: center;
            line-height: 1.2;
        }

        /* High-Quality Effects */
        .fireworks-effect {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 20000;
        }

        .firework {
            position: absolute;
            width: 4px;
            height: 4px;
            border-radius: 50%;
            animation: fireworkExplode 3s ease-out forwards;
        }

        @keyframes fireworkExplode {
            0% {
                transform: scale(0);
                opacity: 1;
            }
            50% {
                transform: scale(1);
                opacity: 1;
            }
            100% {
                transform: scale(0);
                opacity: 0;
            }
        }

        .firework-trail {
            position: absolute;
            width: 2px;
            height: 2px;
            border-radius: 50%;
            animation: fireworkTrail 1s ease-out forwards;
        }

        @keyframes fireworkTrail {
            0% {
                transform: scale(1);
                opacity: 1;
            }
            100% {
                transform: scale(0);
                opacity: 0;
            }
        }

        .money-shower {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 20001;
        }

        .money-bill {
            position: absolute;
            width: 40px;
            height: 20px;
            background: linear-gradient(45deg, #4CAF50, #8BC34A);
            border-radius: 3px;
            animation: moneyFall 4s ease-out forwards;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 10px;
            font-weight: 700;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        @keyframes moneyFall {
            0% {
                transform: translateY(-100px) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(100vh) rotate(360deg);
                opacity: 0;
            }
        }

        .rainbow-flag {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 200px;
            height: 100px;
            background: linear-gradient(to right, 
                #ff0000, #ff8000, #ffff00, #80ff00, 
                #00ff00, #00ff80, #00ffff, #0080ff, 
                #0000ff, #8000ff, #ff00ff, #ff0080);
            border-radius: 10px;
            animation: rainbowWave 2s ease-in-out infinite;
            z-index: 20002;
            display: none;
        }

        @keyframes rainbowWave {
            0%, 100% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.1); }
        }

        .high-heels {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 60px;
            height: 60px;
            background: #ff0000;
            border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
            animation: heelsBounce 1s ease-in-out infinite;
            z-index: 20003;
            display: none;
        }

        .high-heels::before {
            content: '';
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 20px;
            height: 30px;
            background: #ff0000;
            border-radius: 50%;
        }

        @keyframes heelsBounce {
            0%, 100% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.2); }
        }

        /* Intensity Levels */
        .intensity-level-1 { animation-duration: 2s; }
        .intensity-level-2 { animation-duration: 1.5s; }
        .intensity-level-3 { animation-duration: 1s; }
        .intensity-level-4 { animation-duration: 0.8s; }
        .intensity-level-5 { animation-duration: 0.5s; }

        /* Name Display in Fireworks */
        .firework-name {
            position: absolute;
            color: #ffd700;
            font-size: 24px;
            font-weight: 700;
            text-shadow: 0 0 10px #ffd700;
            animation: nameGlow 2s ease-in-out infinite;
        }

        @keyframes nameGlow {
            0%, 100% { text-shadow: 0 0 10px #ffd700; }
            50% { text-shadow: 0 0 20px #ffd700, 0 0 30px #ffd700; }
        }

        .collision-indicator {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 215, 0, 0.9);
            color: #000;
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            z-index: 1500;
            animation: collisionPulse 0.5s ease-out;
        }

        @keyframes collisionPulse {
            0% { transform: translate(-50%, -50%) scale(0); opacity: 0; }
            50% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }

        /* Collision detection zone */
        .collision-zone {
            position: absolute;
            width: 40px;
            height: 40px;
            border: 2px dashed rgba(255, 215, 0, 0.5);
            border-radius: 50%;
            pointer-events: none;
            z-index: 10;
        }

        /* Floor Indicator */
        .floor-indicator {
            position: fixed;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            writing-mode: vertical-lr;
            font-size: 14px;
            color: gold;
            letter-spacing: 2px;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 215, 0, 0.3);
            border-radius: 12px;
            padding: 16px 8px;
            font-weight: 700;
            text-transform: uppercase;
            z-index: 1000;
            transition: all 0.3s ease;
        }

        /* Swipe indicators */
        .swipe-indicator {
            position: fixed;
            left: 50%;
            transform: translateX(-50%);
            color: rgba(255, 215, 0, 0.6);
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 2px;
            z-index: 1000;
            transition: all 0.3s ease;
            pointer-events: none;
        }

        .swipe-up {
            top: 20px;
        }

        .swipe-down {
            bottom: 20px;
        }

        /* Swipe hints with floating animation */
        .swipe-hint {
            animation: float 2s ease infinite;
        }

        @keyframes float {
            0%, 100% { 
                transform: translateX(-50%) translateY(0px);
                opacity: 0.6;
            }
            50% { 
                transform: translateX(-50%) translateY(-10px);
                opacity: 1;
            }
        }

        /* Joystick - repositioned */
        .joystick {
            position: fixed;
            right: 30px;
            bottom: 30px;
            width: 100px;
            height: 100px;
            background: radial-gradient(circle, rgba(255,255,255,0.1), rgba(255,255,255,0.02));
            border: 2px solid rgba(255, 215, 0, 0.3);
            border-radius: 50%;
            touch-action: none;
            z-index: 1000;
        }

        .joystick-knob {
            width: 35px;
            height: 35px;
            background: radial-gradient(circle, #ffd700, #ffed4e);
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 2px 10px rgba(0,0,0,0.5);
            transition: none;
        }
    </style>
</head>
<body>
    <div class="floor-container" id="floorContainer">
        <!-- ROOFTOP (swipe up) - Stars, exclusive -->
        <div class="floor floor-rooftop" id="floorRooftop" style="transform: translateY(-200%);">
            <div class="person" id="characterRooftop">
                <div class="shadow"></div>
                <div class="dot"></div>
            </div>
        </div>
        
        <!-- VIP FLOOR (swipe up) - Gold, tables -->
        <div class="floor floor-vip" id="floorVip" style="transform: translateY(-100%);">
            <div class="person" id="characterVip">
                <div class="shadow"></div>
                <div class="dot"></div>
            </div>
        </div>
        
        <!-- MAIN FLOOR (default) - Crowded, energy -->
        <div class="floor floor-main" id="floorMain">
    <div class="person" id="character">
        <div class="shadow"></div>
                <div class="dot"></div>
        </div>
        </div>
        
        <!-- BASEMENT (swipe down) - Underground vibes -->
        <div class="floor floor-basement" id="floorBasement" style="transform: translateY(100%);">
            <div class="person" id="characterBasement">
                <div class="shadow"></div>
                <div class="dot"></div>
        </div>
        </div>
    </div>
    
    <div class="pin-drop-modal">
        <h3>Drop Your Pin</h3>
        <input type="text" placeholder="What's happening here?" />
        <button class="drop-btn">DROP</button>
    </div>
    
        <div class="joystick" id="joystick">
            <div class="joystick-knob" id="knob"></div>
        </div>
    
    <div class="floor-indicator" id="floorIndicator">MAIN</div>
    <div class="swipe-indicator swipe-up" id="swipeUp">â†‘ SWIPE UP</div>
    <div class="swipe-indicator swipe-down" id="swipeDown">â†“ SWIPE DOWN</div>
    
    <div class="gyro-controls">
        <div class="calibrate-btn" id="calibrateBtn">Hold phone flat and tap to calibrate</div>
    </div>
    
    <div class="gyro-status" id="gyroStatus">Gyro: Disabled</div>
    
    <!-- Enhanced Live Video Chat Bubble -->
    <div class="chat-bubble" id="chatBubble">
        <div class="chat-bubble-header">
            <div class="chat-bubble-title">Live Video Chat</div>
            <button class="chat-bubble-close" id="closeChat">Ã—</button>
        </div>
        <div class="video-grid">
            <div class="video-container">
                <video class="live-video" id="localVideo" autoplay muted></video>
                <div class="video-overlay">YOU</div>
            </div>
            <div class="video-container">
                <video class="live-video" id="remoteVideo" autoplay></video>
                <div class="video-overlay">THEM</div>
            </div>
        </div>
        <div class="video-controls">
            <button class="video-btn" id="muteBtn" title="Mute/Unmute">ðŸ”‡</button>
            <button class="video-btn" id="flipBtn" title="Flip Camera">ðŸ”„</button>
            <button class="video-btn" id="endCallBtn" title="End Call">ðŸ“ž</button>
        </div>
    </div>
    
    <!-- AR Mode Overlay -->
    <div class="ar-overlay" id="arOverlay">
        <div class="ar-pin" style="top: 20%; left: 30%;"></div>
        <div class="ar-pin" style="top: 60%; left: 70%;"></div>
        <div class="ar-pin" style="top: 40%; left: 50%;"></div>
    </div>

    <!-- Voice Proximity Indicator -->
    <div class="voice-proximity" id="voiceProximity">
        ðŸ”Š Voice Proximity Active
    </div>

    <!-- Screen Recording Controls -->
    <div class="recording-controls">
        <button class="record-btn" id="recordBtn">ðŸ“¹</button>
    </div>
    <div class="recording-indicator" id="recordingIndicator">REC</div>

    <!-- Selfie Camera Modal -->
    <div class="selfie-modal" id="selfieModal">
        <div class="selfie-camera">
            <video class="selfie-preview" id="selfiePreview" autoplay muted></video>
            <button class="selfie-close" id="selfieClose">Ã—</button>
            <div class="selfie-controls">
                <button class="selfie-btn" id="flipCameraBtn">ðŸ”„</button>
                <button class="selfie-btn capture" id="captureSelfieBtn">ðŸ“¸</button>
                <button class="selfie-btn" id="retakeSelfieBtn">ðŸ”„</button>
            </div>
        </div>
    </div>

    <!-- Pin Drop with Selfie Modal -->
    <div class="pin-drop-with-selfie" id="pinDropWithSelfie">
        <div class="selfie-prompt">
            <h3>Drop Your Pin</h3>
            <p>Take a selfie to show your face on the floor</p>
        </div>
        <div class="selfie-options">
            <button class="selfie-option-btn" id="skipSelfieBtn">Skip</button>
            <button class="selfie-option-btn primary" id="takeSelfieBtn">ðŸ“¸ Take Selfie</button>
        </div>
    </div>

    <!-- WebXR AR Mode Overlay -->
    <div class="ar-xr-overlay" id="arXrOverlay">
        <!-- 3D Pins will be dynamically added here -->
        <!-- 3D Avatars will be dynamically added here -->
        <!-- Navigation arrows will be dynamically added here -->
        <!-- VIP area glows will be dynamically added here -->
        <div class="ar-floor-overlay"></div>
    </div>

    <!-- AR Status Indicator -->
    <div class="ar-status" id="arStatus">AR: Ready</div>

    <!-- AR Controls -->
    <div class="ar-controls">
        <button class="ar-control-btn" id="arToggleBtn">ðŸ¥½</button>
        <button class="ar-control-btn" id="arPinBtn">ðŸ“</button>
        <button class="ar-control-btn" id="arNavBtn">ðŸ§­</button>
        <button class="ar-control-btn" id="arVipBtn">ðŸ‘‘</button>
    </div>

    <!-- TensorFlow.js Face Detection -->
    <canvas class="face-detection-canvas" id="faceDetectionCanvas"></canvas>

    <!-- Shake Effects Overlay -->
    <div class="shake-effect-overlay" id="shakeEffectOverlay"></div>

    <!-- Proximity Voice Overlay -->
    <div class="proximity-voice-overlay" id="proximityVoiceOverlay">
        <div class="voice-indicator">
            <span>ðŸŽ¤</span>
            <div class="voice-level">
                <div class="voice-level-bar" id="voiceLevelBar"></div>
            </div>
        </div>
        <div>Proximity Voice Active</div>
    </div>

    <!-- Messages Extension -->
    <div class="messages-extension" id="messagesExtension">
        <div class="messages-header">
            <div class="messages-title">Sound Factory</div>
            <button class="messages-close" id="messagesClose">Ã—</button>
        </div>
        <!-- Messages content will be dynamically added -->
    </div>

    <!-- Small Corner Controls - User Choice -->
    <div class="corner-controls">
        <button class="corner-btn" id="arModeBtn" title="AR Mode">ðŸ¥½</button>
        <button class="corner-btn" id="cameraBtn" title="Camera">ðŸ“·</button>
        <button class="corner-btn" id="tiltControlBtn" title="Tilt Control">ðŸ“±</button>
        <button class="corner-btn" id="voiceBtn" title="Voice">ðŸŽ¤</button>
    </div>

    <!-- Livestream System -->
    <div class="livestream-overlay" id="livestreamOverlay">
        <div class="livestream-player">
            <video class="livestream-video" id="livestreamVideo" autoplay muted></video>
        </div>
        
        <div class="livestream-controls">
            <button class="livestream-btn" id="goLiveBtn">ðŸ“¹</button>
            <button class="livestream-btn" id="newMusicBtn">ðŸŽµ</button>
            <button class="livestream-btn" id="classicsBtn">ðŸŽ¶</button>
        </div>
        
        <div class="livestream-info">
            <div class="live-indicator">
                <div class="live-dot"></div>
                <span>LIVE</span>
            </div>
            <div>Sound Factory Live</div>
            <div id="viewerCount">0 viewers</div>
        </div>
        
        <div class="tipping-reactions">
            <button class="tip-button tip-1" data-amount="1">$1</button>
            <button class="tip-button tip-5" data-amount="5">$5</button>
            <button class="tip-button tip-10" data-amount="10">$10</button>
            <button class="tip-button tip-20" data-amount="20">$20</button>
            <button class="tip-button tip-50" data-amount="50">$50</button>
            <button class="tip-button tip-keep">Keep<br>Tipping</button>
        </div>
    </div>

    <!-- High-Quality Effects Containers -->
    <div class="fireworks-effect" id="fireworksEffect"></div>
    <div class="money-shower" id="moneyShower"></div>
    <div class="rainbow-flag" id="rainbowFlag"></div>
    <div class="high-heels" id="highHeels"></div>

    <script>
        const character = document.getElementById('character');
        const joystick = document.getElementById('joystick');
        const knob = document.getElementById('knob');
        const dropBtn = document.querySelector('.drop-btn');
        const pinInput = document.querySelector('input[type="text"]');
        const floorContainer = document.getElementById('floorContainer');
        const floorIndicator = document.getElementById('floorIndicator');
        const swipeUp = document.getElementById('swipeUp');
        const swipeDown = document.getElementById('swipeDown');
        const calibrateBtn = document.getElementById('calibrateBtn');
        const gyroStatus = document.getElementById('gyroStatus');
        const chatBubble = document.getElementById('chatBubble');
        const localVideo = document.getElementById('localVideo');
        const remoteVideo = document.getElementById('remoteVideo');
        const closeChat = document.getElementById('closeChat');
        const muteBtn = document.getElementById('muteBtn');
        const flipBtn = document.getElementById('flipBtn');
        const endCallBtn = document.getElementById('endCallBtn');
        const arOverlay = document.getElementById('arOverlay');
        const voiceProximity = document.getElementById('voiceProximity');
        const recordBtn = document.getElementById('recordBtn');
        const recordingIndicator = document.getElementById('recordingIndicator');
        const arXrOverlay = document.getElementById('arXrOverlay');
        const arStatus = document.getElementById('arStatus');
        const arToggleBtn = document.getElementById('arToggleBtn');
        const arPinBtn = document.getElementById('arPinBtn');
        const arNavBtn = document.getElementById('arNavBtn');
        const arVipBtn = document.getElementById('arVipBtn');
        const faceDetectionCanvas = document.getElementById('faceDetectionCanvas');
        const shakeEffectOverlay = document.getElementById('shakeEffectOverlay');
        const proximityVoiceOverlay = document.getElementById('proximityVoiceOverlay');
        const voiceLevelBar = document.getElementById('voiceLevelBar');
        const messagesExtension = document.getElementById('messagesExtension');
        const messagesClose = document.getElementById('messagesClose');
        const futureARBtn = document.getElementById('futureARBtn');
        const futureShakeBtn = document.getElementById('futureShakeBtn');
        const futureFaceBtn = document.getElementById('futureFaceBtn');
        const futureVoiceBtn = document.getElementById('futureVoiceBtn');
        const futureMessagesBtn = document.getElementById('futureMessagesBtn');
        const livestreamOverlay = document.getElementById('livestreamOverlay');
        const livestreamVideo = document.getElementById('livestreamVideo');
        const goLiveBtn = document.getElementById('goLiveBtn');
        const newMusicBtn = document.getElementById('newMusicBtn');
        const classicsBtn = document.getElementById('classicsBtn');
        const viewerCount = document.getElementById('viewerCount');
        const fireworksEffect = document.getElementById('fireworksEffect');
        const moneyShower = document.getElementById('moneyShower');
        const rainbowFlag = document.getElementById('rainbowFlag');
        const highHeels = document.getElementById('highHeels');
        
        let posX = window.innerWidth / 2;
        let posY = window.innerHeight / 2;
        let velocityX = 0;
        let velocityY = 0;
        let isDragging = false;
        let joystickX = 0;
        let joystickY = 0;
        
        // Floor navigation variables
        let startY = 0;
        let currentFloor = 2; // Start on main floor (index 2)
        let isTransitioning = false;
        let momentum = 0;
        let lastTouchY = 0;
        let touchStartTime = 0;
        
        // Gyro control variables
        let gyroEnabled = false;
        let gyroCalibrated = false;
        let baseBeta = 0; // Calibrated front/back tilt
        let baseGamma = 0; // Calibrated left/right tilt
        let gyroSensitivity = 0.5;
        let gyroDeadzone = 5; // Degrees of deadzone
        
        // Collision detection and live video variables
        let otherAvatars = [];
        let isInChat = false;
        let currentStream = null;
        let collisionDistance = 60; // pixels
        
        // Insane features variables
        let arMode = false;
        let isRecording = false;
        let mediaRecorder = null;
        let recordedChunks = [];
        let currentFilter = null;
        let shakeThreshold = 15;
        let lastShakeTime = 0;
        let voiceProximityActive = false;
        let peerConnection = null;
        
        // WebXR AR variables
        let xrSession = null;
        let xrReferenceSpace = null;
        let arPins = [];
        let arAvatars = [];
        let arNavArrows = [];
        let arVipAreas = [];
        let arModeActive = false;
        let arTrackingActive = false;
        
        // Future Nightlife Variables
        let faceDetectionActive = false;
        let faceModel = null;
        let faceStream = null;
        let currentFaceFilter = null;
        let shakeEffectsActive = false;
        let proximityVoiceActive = false;
        let spatialAudioContext = null;
        let voiceStream = null;
        let messagesActive = false;
        let shakeCost = 1; // $1 per shake
        let userBalance = 100; // Starting balance
        
        // Livestream System Variables
        let isLive = false;
        let livestreamActive = false;
        let currentViewers = 0;
        let totalTips = 0;
        let intensityLevel = 1;
        let tipButtons = [];
        let currentMusicMode = 'new'; // 'new' or 'classics'
        let livestreamStream = null;
        
        // Floor configuration
        const floors = [
            { id: 'floorRooftop', name: 'ROOFTOP', indicator: 'ROOF' },
            { id: 'floorVip', name: 'VIP FLOOR', indicator: 'VIP' },
            { id: 'floorMain', name: 'MAIN FLOOR', indicator: 'MAIN' },
            { id: 'floorBasement', name: 'BASEMENT', indicator: 'BASE' }
        ];
        
        // Audio context for sound effects
        let audioContext;
        let currentMusic;
        
        // Initialize audio
        function initAudio() {
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            } catch (e) {
                console.log('Audio not supported');
            }
        }
        
        // Haptic feedback
        function triggerHaptic() {
            if ('vibrate' in navigator) {
                navigator.vibrate([50, 30, 50]);
            }
        }
        
        // Sound effect on swipe
        function playSwipeSound() {
            if (!audioContext) return;
            
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
            oscillator.frequency.exponentialRampToValueAtTime(400, audioContext.currentTime + 0.1);
            
            gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.1);
        }
        
        // Floor change with smooth transitions
        function changeFloor(direction) {
            if (isTransitioning) return;
            
            isTransitioning = true;
            triggerHaptic();
            playSwipeSound();
            
            if (direction === 'up' && currentFloor > 0) {
                currentFloor--;
            } else if (direction === 'down' && currentFloor < floors.length - 1) {
                currentFloor++;
            } else {
                isTransitioning = false;
                return;
            }
            
            // Update floor indicator
            floorIndicator.textContent = floors[currentFloor].indicator;
            
            // Smooth transition
            const translateY = -currentFloor * 100;
            floorContainer.style.transform = `translateY(${translateY}%)`;
            
            // Add crowd to main floor
            if (currentFloor === 2) {
                addCrowdToMainFloor();
            }
            
            setTimeout(() => {
                isTransitioning = false;
            }, 500);
        }
        
        // Add crowd to main floor
        function addCrowdToMainFloor() {
            const mainFloor = document.getElementById('floorMain');
            const existingCrowd = mainFloor.querySelectorAll('.crowd-dot');
            existingCrowd.forEach(dot => dot.remove());
            
            // Add 15-20 crowd dots
            for (let i = 0; i < 18; i++) {
                const crowdDot = document.createElement('div');
                crowdDot.className = 'crowd-dot';
                crowdDot.style.left = Math.random() * 90 + 5 + '%';
                crowdDot.style.top = Math.random() * 80 + 10 + '%';
                crowdDot.style.animationDelay = Math.random() * 3 + 's';
                mainFloor.appendChild(crowdDot);
            }
        }
        
        // Touch event handlers
        addEventListener('touchstart', (e) => {
            startY = e.touches[0].clientY;
            touchStartTime = Date.now();
        });
        
        addEventListener('touchend', (e) => {
            let endY = e.changedTouches[0].clientY;
            let diff = startY - endY;
            let duration = Date.now() - touchStartTime;
            
            // Only trigger if swipe is fast enough and far enough
            if (duration < 300 && Math.abs(diff) > 50) {
                if (diff > 50) { // Swipe up
                    changeFloor('up');
                } else if (diff < -50) { // Swipe down
                    changeFloor('down');
                }
            }
        });
        
        // Gyro control functions
        function enableGyroControls() {
            if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                // iOS 13+ requires permission
                DeviceOrientationEvent.requestPermission()
                    .then(response => {
                        if (response === 'granted') {
                            setupGyroListener();
                        } else {
                            gyroStatus.textContent = 'Gyro: Permission Denied';
                        }
                    });
            } else {
                // Android and older iOS
                setupGyroListener();
            }
        }
        
        function setupGyroListener() {
            window.addEventListener('deviceorientation', handleGyroOrientation);
            gyroEnabled = true;
            gyroStatus.textContent = 'Gyro: Enabled';
        }
        
        function handleGyroOrientation(event) {
            if (!gyroEnabled || !gyroCalibrated) return;
            
            // Get current orientation relative to calibrated position
            const beta = event.beta - baseBeta; // Front/back tilt
            const gamma = event.gamma - baseGamma; // Left/right tilt
            
            // Apply deadzone
            const betaAdjusted = Math.abs(beta) > gyroDeadzone ? beta : 0;
            const gammaAdjusted = Math.abs(gamma) > gyroDeadzone ? gamma : 0;
            
            // Convert to movement (invert for natural feel)
            const moveX = -gammaAdjusted * gyroSensitivity;
            const moveY = betaAdjusted * gyroSensitivity;
            
            // Update joystick values for movement
            joystickX = Math.max(-1, Math.min(1, moveX / 30));
            joystickY = Math.max(-1, Math.min(1, moveY / 30));
            
            // Update joystick knob position
            const knobX = joystickX * 30;
            const knobY = joystickY * 30;
            knob.style.transform = `translate(calc(-50% + ${knobX}px), calc(-50% + ${knobY}px))`;
            
            // Add walking animation if moving
            if (Math.abs(joystickX) > 0.1 || Math.abs(joystickY) > 0.1) {
                if (!character.classList.contains('walking')) {
                    character.classList.add('walking');
                }
            } else {
                character.classList.remove('walking');
            }
        }
        
        function calibrateGyro() {
            calibrateBtn.classList.add('calibrating');
            calibrateBtn.textContent = 'Calibrating...';
            
            // Wait for stable reading
            let readings = [];
            let readingCount = 0;
            
            const calibrationInterval = setInterval(() => {
                if (readingCount < 10) {
                    readings.push({
                        beta: event.beta,
                        gamma: event.gamma
                    });
                    readingCount++;
                } else {
                    clearInterval(calibrationInterval);
                    
                    // Calculate average
                    baseBeta = readings.reduce((sum, r) => sum + r.beta, 0) / readings.length;
                    baseGamma = readings.reduce((sum, r) => sum + r.gamma, 0) / readings.length;
                    
                    gyroCalibrated = true;
                    calibrateBtn.classList.remove('calibrating');
                    calibrateBtn.textContent = 'Gyro: Ready';
                    gyroStatus.textContent = 'Gyro: Calibrated';
                }
            }, 100);
        }
        
        // Calibration button event
        calibrateBtn.addEventListener('click', () => {
            if (!gyroEnabled) {
                enableGyroControls();
            } else {
                calibrateGyro();
            }
        });
        
        // Collision detection and live video functions
        function createOtherAvatars() {
            // Create 3-5 other avatars on the floor
            for (let i = 0; i < 4; i++) {
                const otherAvatar = document.createElement('div');
                otherAvatar.className = 'person';
                otherAvatar.style.cssText = `
                    position: fixed;
                    width: 20px;
                    height: 20px;
                    left: ${Math.random() * (window.innerWidth - 40) + 20}px;
                    top: ${Math.random() * (window.innerHeight - 40) + 20}px;
                    pointer-events: none;
                    z-index: 50;
                `;
                
                otherAvatar.innerHTML = `
                    <div class="shadow"></div>
                    <div class="dot" style="background: radial-gradient(circle, #00ffff, #0088ff);"></div>
                `;
                
                document.body.appendChild(otherAvatar);
                otherAvatars.push({
                    element: otherAvatar,
                    x: parseFloat(otherAvatar.style.left),
                    y: parseFloat(otherAvatar.style.top),
                    id: `avatar_${i}`
                });
            }
        }
        
        function checkCollisions() {
            if (isInChat) return;
            
            otherAvatars.forEach(avatar => {
                const distance = Math.sqrt(
                    Math.pow(posX - avatar.x, 2) + Math.pow(posY - avatar.y, 2)
                );
                
                if (distance < collisionDistance) {
                    triggerCollision(avatar);
                }
            });
        }
        
        function triggerCollision(avatar) {
            // Show collision indicator
            const indicator = document.createElement('div');
            indicator.className = 'collision-indicator';
            indicator.textContent = 'AVATAR COLLISION!';
            document.body.appendChild(indicator);
            
            setTimeout(() => {
                indicator.remove();
            }, 2000);
            
            // Start live video chat
            startLiveVideoChat();
        }
        
        async function startLiveVideoChat() {
            if (isInChat) return;
            
            try {
                // Request camera and microphone access
                currentStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'user' }, 
                    audio: true 
                });
                
                // Show video in chat bubble
                liveVideo.srcObject = currentStream;
                
                // Show chat bubble
                chatBubble.classList.add('active');
                isInChat = true;
                
                // Haptic feedback
                if ('vibrate' in navigator) {
                    navigator.vibrate([100, 50, 100]);
                }
                
                // Play sound effect
                playSwipeSound();
                
            } catch (error) {
                console.log('Camera access denied:', error);
                // Show fallback message
                const indicator = document.createElement('div');
                indicator.className = 'collision-indicator';
                indicator.textContent = 'Camera access needed for live chat';
                document.body.appendChild(indicator);
                
                setTimeout(() => {
                    indicator.remove();
                }, 3000);
            }
        }
        
        function stopLiveVideoChat() {
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
                currentStream = null;
            }
            
            chatBubble.classList.remove('active');
            isInChat = false;
        }
        
        // Close chat button
        closeChat.addEventListener('click', stopLiveVideoChat);
        
        // Insane Features Implementation
        
        // 1. AR Mode: See pins in real world
        function toggleARMode() {
            arMode = !arMode;
            arOverlay.classList.toggle('active', arMode);
            
            if (arMode) {
                // Request camera permission for AR
                navigator.mediaDevices.getUserMedia({ video: true })
                    .then(stream => {
                        console.log('AR mode activated with camera access');
                        // In a real implementation, you'd use WebGL/Three.js for AR
                    })
                    .catch(error => {
                        console.log('Camera access denied for AR mode');
                        arMode = false;
                        arOverlay.classList.remove('active');
                    });
            }
        }
        
        // 2. Shake phone: Send confetti to everyone
        function initShakeDetection() {
            let lastX = 0, lastY = 0, lastZ = 0;
            
            if (window.DeviceMotionEvent) {
                window.addEventListener('devicemotion', (event) => {
                    const acceleration = event.accelerationIncludingGravity;
                    const x = acceleration.x;
                    const y = acceleration.y;
                    const z = acceleration.z;
                    
                    const deltaX = Math.abs(x - lastX);
                    const deltaY = Math.abs(y - lastY);
                    const deltaZ = Math.abs(z - lastZ);
                    
                    const shake = deltaX + deltaY + deltaZ;
                    
                    if (shake > shakeThreshold && Date.now() - lastShakeTime > 1000) {
                        triggerConfetti();
                        lastShakeTime = Date.now();
                    }
                    
                    lastX = x;
                    lastY = y;
                    lastZ = z;
                });
            }
        }
        
        function triggerConfetti() {
            // Show shake indicator
            const indicator = document.createElement('div');
            indicator.className = 'shake-indicator';
            indicator.textContent = 'ðŸŽ‰ CONFETTI BLAST! ðŸŽ‰';
            document.body.appendChild(indicator);
            
            setTimeout(() => indicator.remove(), 2000);
            
            // Create confetti particles
            for (let i = 0; i < 50; i++) {
                createConfettiParticle();
            }
            
            // Haptic feedback
            if ('vibrate' in navigator) {
                navigator.vibrate([200, 100, 200]);
            }
        }
        
        function createConfettiParticle() {
            const confetti = document.createElement('div');
            confetti.className = 'confetti';
            confetti.style.left = Math.random() * window.innerWidth + 'px';
            confetti.style.backgroundColor = `hsl(${Math.random() * 360}, 70%, 50%)`;
            confetti.style.transform = `rotate(${Math.random() * 360}deg)`;
            
            document.body.appendChild(confetti);
            
            setTimeout(() => confetti.remove(), 3000);
        }
        
        // 3. Face filters: Add VIP crown, sunglasses
        function applyFaceFilter(filterType) {
            // Remove existing filter
            if (currentFilter) {
                currentFilter.remove();
            }
            
            if (filterType === 'none') {
                currentFilter = null;
                return;
            }
            
            // Create filter element
            const filter = document.createElement('div');
            filter.className = 'face-filter';
            
            if (filterType === 'vip-crown') {
                const crown = document.createElement('div');
                crown.className = 'vip-crown';
                filter.appendChild(crown);
            } else if (filterType === 'sunglasses') {
                const glasses = document.createElement('div');
                glasses.className = 'sunglasses';
                filter.appendChild(glasses);
            }
            
            // Position filter on character
            filter.style.left = (posX - 20) + 'px';
            filter.style.top = (posY - 20) + 'px';
            
            document.body.appendChild(filter);
            currentFilter = filter;
        }
        
        // 4. Voice proximity: Hear people nearby
        function initVoiceProximity() {
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                navigator.mediaDevices.getUserMedia({ audio: true })
                    .then(stream => {
                        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                        const analyser = audioContext.createAnalyser();
                        const microphone = audioContext.createMediaStreamSource(stream);
                        
                        microphone.connect(analyser);
                        analyser.fftSize = 256;
                        
                        const bufferLength = analyser.frequencyBinCount;
                        const dataArray = new Uint8Array(bufferLength);
                        
                        function detectVoice() {
                            analyser.getByteFrequencyData(dataArray);
                            
                            let sum = 0;
                            for (let i = 0; i < bufferLength; i++) {
                                sum += dataArray[i];
                            }
                            
                            const average = sum / bufferLength;
                            
                            if (average > 30) { // Voice detected
                                voiceProximityActive = true;
                                voiceProximity.classList.add('active');
                            } else {
                                voiceProximityActive = false;
                                voiceProximity.classList.remove('active');
                            }
                            
                            requestAnimationFrame(detectVoice);
                        }
                        
                        detectVoice();
                    })
                    .catch(error => {
                        console.log('Microphone access denied for voice proximity');
                    });
            }
        }
        
        // 5. Screen recording: Save your night
        function initScreenRecording() {
            recordBtn.addEventListener('click', async () => {
                if (!isRecording) {
                    try {
                        const stream = await navigator.mediaDevices.getDisplayMedia({
                            video: true,
                            audio: true
                        });
                        
                        mediaRecorder = new MediaRecorder(stream);
                        recordedChunks = [];
                        
                        mediaRecorder.ondataavailable = (event) => {
                            if (event.data.size > 0) {
                                recordedChunks.push(event.data);
                            }
                        };
                        
                        mediaRecorder.onstop = () => {
                            const blob = new Blob(recordedChunks, { type: 'video/webm' });
                            const url = URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = `sound-factory-night-${Date.now()}.webm`;
                            a.click();
                            URL.revokeObjectURL(url);
                        };
                        
                        mediaRecorder.start();
                        isRecording = true;
                        recordBtn.classList.add('recording');
                        recordingIndicator.classList.add('active');
                        recordBtn.textContent = 'â¹ï¸';
                        
                    } catch (error) {
                        console.log('Screen recording not supported or denied');
                    }
                } else {
                    mediaRecorder.stop();
                    isRecording = false;
                    recordBtn.classList.remove('recording');
                    recordingIndicator.classList.remove('active');
                    recordBtn.textContent = 'ðŸ“¹';
                }
            });
        }
        
        // Enhanced collision detection with face filters
        function triggerCollision(avatar) {
            // Show collision indicator
            const indicator = document.createElement('div');
            indicator.className = 'collision-indicator';
            indicator.textContent = 'AVATAR COLLISION!';
            document.body.appendChild(indicator);
            
            setTimeout(() => {
                indicator.remove();
            }, 2000);
            
            // Apply random face filter
            const filters = ['vip-crown', 'sunglasses', 'none'];
            const randomFilter = filters[Math.floor(Math.random() * filters.length)];
            applyFaceFilter(randomFilter);
            
            // Start live video chat
            startLiveVideoChat();
        }
        
        // WebXR AR Implementation
        
        // Initialize WebXR AR
        async function initWebXR() {
            if (!navigator.xr) {
                console.log('WebXR not supported');
                arStatus.textContent = 'AR: Not Supported';
                arStatus.classList.add('lost');
                return false;
            }

            try {
                const supported = await navigator.xr.isSessionSupported('immersive-ar');
                if (!supported) {
                    console.log('AR not supported on this device');
                    arStatus.textContent = 'AR: Not Available';
                    arStatus.classList.add('lost');
                    return false;
                }

                arStatus.textContent = 'AR: Ready';
                arStatus.classList.remove('lost');
                return true;
            } catch (error) {
                console.log('WebXR initialization failed:', error);
                arStatus.textContent = 'AR: Error';
                arStatus.classList.add('lost');
                return false;
            }
        }

        // Start WebXR AR session
        async function startARSession() {
            try {
                xrSession = await navigator.xr.requestSession('immersive-ar', {
                    requiredFeatures: ['local'],
                    optionalFeatures: ['bounded-floor', 'hand-tracking']
                });

                xrSession.addEventListener('end', onXRSessionEnd);
                xrReferenceSpace = await xrSession.requestReferenceSpace('local');
                
                arModeActive = true;
                arXrOverlay.classList.add('active');
                arToggleBtn.classList.add('active');
                arStatus.textContent = 'AR: Active';
                arStatus.classList.add('tracking');

                // Start AR rendering loop
                xrSession.requestAnimationFrame(onXRFrame);
                
                // Initialize AR elements
                createARPins();
                createARAvatars();
                createARNavigation();
                createARVIPAreas();

            } catch (error) {
                console.log('Failed to start AR session:', error);
                arStatus.textContent = 'AR: Failed';
                arStatus.classList.add('lost');
            }
        }

        // End WebXR AR session
        function endARSession() {
            if (xrSession) {
                xrSession.end();
            }
        }

        // Handle XR session end
        function onXRSessionEnd() {
            xrSession = null;
            xrReferenceSpace = null;
            arModeActive = false;
            arXrOverlay.classList.remove('active');
            arToggleBtn.classList.remove('active');
            arStatus.textContent = 'AR: Ready';
            arStatus.classList.remove('tracking', 'lost');
            
            // Clear AR elements
            clearARElements();
        }

        // XR Frame rendering
        function onXRFrame(time, frame) {
            if (xrSession) {
                xrSession.requestAnimationFrame(onXRFrame);
                
                // Update AR elements based on device pose
                updateARElements(frame);
            }
        }

        // Create 3D floating pins in AR
        function createARPins() {
            // Clear existing pins
            arPins.forEach(pin => pin.remove());
            arPins = [];

            // Create sample pins at various locations
            const pinLocations = [
                { x: 20, y: 30, message: "VIP Table 1", user: "Alex" },
                { x: 80, y: 60, message: "Dance Floor", user: "Sarah" },
                { x: 60, y: 20, message: "Bar Area", user: "Mike" },
                { x: 30, y: 80, message: "Rooftop", user: "Emma" }
            ];

            pinLocations.forEach((location, index) => {
                const pin = document.createElement('div');
                pin.className = 'ar-pin-3d';
                pin.style.left = location.x + '%';
                pin.style.top = location.y + '%';
                pin.dataset.message = location.message;
                pin.dataset.user = location.user;
                
                // Add click handler for pin info
                pin.addEventListener('click', () => showPinInfo(pin));
                
                arXrOverlay.appendChild(pin);
                arPins.push(pin);
            });
        }

        // Create 3D avatars in AR
        function createARAvatars() {
            // Clear existing avatars
            arAvatars.forEach(avatar => avatar.remove());
            arAvatars = [];

            // Create sample avatars
            const avatarLocations = [
                { x: 25, y: 40, name: "Alex", online: true },
                { x: 70, y: 30, name: "Sarah", online: false },
                { x: 45, y: 70, name: "Mike", online: true }
            ];

            avatarLocations.forEach((location, index) => {
                const avatar = document.createElement('div');
                avatar.className = 'ar-avatar-3d';
                if (location.online) avatar.classList.add('online');
                avatar.style.left = location.x + '%';
                avatar.style.top = location.y + '%';
                avatar.dataset.name = location.name;
                
                // Create avatar image (placeholder)
                const img = document.createElement('div');
                img.style.width = '100%';
                img.style.height = '100%';
                img.style.background = `linear-gradient(45deg, #ffd700, #ffed4e)`;
                img.style.borderRadius = '50%';
                avatar.appendChild(img);
                
                // Add click handler for FaceTime
                avatar.addEventListener('click', () => startFaceTime(location.name));
                
                arXrOverlay.appendChild(avatar);
                arAvatars.push(avatar);
            });
        }

        // Create navigation arrows
        function createARNavigation() {
            // Clear existing arrows
            arNavArrows.forEach(arrow => arrow.remove());
            arNavArrows = [];

            // Create navigation arrows pointing to VIP areas
            const arrowLocations = [
                { x: 50, y: 20, direction: 'up', target: 'VIP Floor' },
                { x: 80, y: 50, direction: 'right', target: 'Bar' },
                { x: 20, y: 50, direction: 'left', target: 'Dance Floor' }
            ];

            arrowLocations.forEach((location, index) => {
                const arrow = document.createElement('div');
                arrow.className = `ar-nav-arrow ${location.direction}`;
                arrow.style.left = location.x + '%';
                arrow.style.top = location.y + '%';
                arrow.dataset.target = location.target;
                
                arXrOverlay.appendChild(arrow);
                arNavArrows.push(arrow);
            });
        }

        // Create VIP area glows
        function createARVIPAreas() {
            // Clear existing VIP areas
            arVipAreas.forEach(area => area.remove());
            arVipAreas = [];

            // Create VIP area glows
            const vipLocations = [
                { x: 10, y: 10, width: 30, height: 20, name: 'VIP Tables' },
                { x: 60, y: 10, width: 25, height: 15, name: 'VIP Lounge' }
            ];

            vipLocations.forEach((location, index) => {
                const area = document.createElement('div');
                area.className = 'ar-vip-glow';
                area.style.left = location.x + '%';
                area.style.top = location.y + '%';
                area.style.width = location.width + '%';
                area.style.height = location.height + '%';
                area.dataset.name = location.name;
                
                arXrOverlay.appendChild(area);
                arVipAreas.push(area);
            });
        }

        // Show pin information
        function showPinInfo(pin) {
            const info = document.createElement('div');
            info.className = 'ar-pin-info show';
            info.textContent = `${pin.dataset.user}: ${pin.dataset.message}`;
            info.style.left = (parseFloat(pin.style.left) + 5) + '%';
            info.style.top = (parseFloat(pin.style.top) - 10) + '%';
            
            arXrOverlay.appendChild(info);
            
            setTimeout(() => {
                info.remove();
            }, 3000);
        }

        // Start FaceTime with avatar
        function startFaceTime(name) {
            // In a real implementation, this would initiate a WebRTC call
            console.log(`Starting FaceTime with ${name}`);
            
            // Show FaceTime indicator
            const indicator = document.createElement('div');
            indicator.className = 'shake-indicator';
            indicator.textContent = `ðŸ“ž Calling ${name}...`;
            document.body.appendChild(indicator);
            
            setTimeout(() => indicator.remove(), 2000);
        }

        // Update AR elements based on device pose
        function updateARElements(frame) {
            // In a real WebXR implementation, you would:
            // 1. Get device pose from frame
            // 2. Update 3D positions based on world coordinates
            // 3. Handle occlusion with real-world objects
            // 4. Update lighting and shadows
            
            // For now, we'll simulate tracking
            arTrackingActive = true;
        }

        // Clear all AR elements
        function clearARElements() {
            arPins.forEach(pin => pin.remove());
            arAvatars.forEach(avatar => avatar.remove());
            arNavArrows.forEach(arrow => arrow.remove());
            arVipAreas.forEach(area => area.remove());
            
            arPins = [];
            arAvatars = [];
            arNavArrows = [];
            arVipAreas = [];
        }

        // AR Control event listeners
        arToggleBtn.addEventListener('click', async () => {
            if (!arModeActive) {
                const supported = await initWebXR();
                if (supported) {
                    await startARSession();
                }
            } else {
                endARSession();
            }
        });

        arPinBtn.addEventListener('click', () => {
            if (arModeActive) {
                createARPins();
            }
        });

        arNavBtn.addEventListener('click', () => {
            if (arModeActive) {
                createARNavigation();
            }
        });

        arVipBtn.addEventListener('click', () => {
            if (arModeActive) {
                createARVIPAreas();
            }
        });

        // FUTURE OF NIGHTLIFE IMPLEMENTATION
        
        // 1. TensorFlow.js Face Detection & Filters
        async function initFaceDetection() {
            try {
                // Load TensorFlow.js and face detection model
                const tf = await import('https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js');
                const faceDetection = await import('https://cdn.jsdelivr.net/npm/@tensorflow-models/face-detection@latest/dist/face-detection.min.js');
                
                faceModel = await faceDetection.createDetector(faceDetection.SupportedModels.MediaPipeFaceDetector, {
                    runtime: 'tfjs',
                    maxFaces: 1,
                    modelType: 'short'
                });
                
                console.log('Face detection model loaded');
                return true;
            } catch (error) {
                console.log('Face detection not available:', error);
                return false;
            }
        }
        
        async function startFaceDetection() {
            if (!faceModel) {
                const loaded = await initFaceDetection();
                if (!loaded) return;
            }
            
            try {
                faceStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'user' } 
                });
                
                const video = document.createElement('video');
                video.srcObject = faceStream;
                video.play();
                
                faceDetectionActive = true;
                futureFaceBtn.classList.add('active');
                
                // Start face detection loop
                detectFaces(video);
                
            } catch (error) {
                console.log('Camera access denied for face detection');
            }
        }
        
        async function detectFaces(video) {
            if (!faceDetectionActive) return;
            
            try {
                const faces = await faceModel.estimateFaces(video);
                
                if (faces.length > 0) {
                    const face = faces[0];
                    applyFaceFilter(face);
                }
                
                requestAnimationFrame(() => detectFaces(video));
            } catch (error) {
                console.log('Face detection error:', error);
            }
        }
        
        function applyFaceFilter(face) {
            // Remove existing filter
            if (currentFaceFilter) {
                currentFaceFilter.remove();
            }
            
            // Determine filter based on user status
            let filterType = 'none';
            if (userBalance > 500) filterType = 'vip-crown';
            else if (userBalance > 200) filterType = 'sunglasses';
            else if (userBalance > 100) filterType = 'fire-effect';
            
            if (filterType === 'none') return;
            
            // Create filter element
            const filter = document.createElement('div');
            filter.className = 'face-filter-overlay';
            
            const filterElement = document.createElement('div');
            filterElement.className = `${filterType}-filter`;
            filter.appendChild(filterElement);
            
            // Position filter on face
            const canvas = faceDetectionCanvas;
            const ctx = canvas.getContext('2d');
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            
            const x = face.boundingBox.xCenter * canvas.width;
            const y = face.boundingBox.yCenter * canvas.height;
            
            filter.style.left = (x - 40) + 'px';
            filter.style.top = (y - 40) + 'px';
            
            document.body.appendChild(filter);
            currentFaceFilter = filter;
        }
        
        // 2. Enhanced Shake Effects with Payment
        function initShakeEffects() {
            let lastX = 0, lastY = 0, lastZ = 0;
            
            if (window.DeviceMotionEvent) {
                window.addEventListener('devicemotion', (event) => {
                    const acceleration = event.accelerationIncludingGravity;
                    const x = acceleration.x;
                    const y = acceleration.y;
                    const z = acceleration.z;
                    
                    const deltaX = Math.abs(x - lastX);
                    const deltaY = Math.abs(y - lastY);
                    const deltaZ = Math.abs(z - lastZ);
                    
                    const shake = deltaX + deltaY + deltaZ;
                    
                    if (shake > shakeThreshold && Date.now() - lastShakeTime > 1000) {
                        triggerShakeEffect();
                        lastShakeTime = Date.now();
                    }
                    
                    lastX = x;
                    lastY = y;
                    lastZ = z;
                });
            }
        }
        
        function triggerShakeEffect() {
            // Check if user has enough balance
            if (userBalance < shakeCost) {
                showInsufficientFunds();
                return;
            }
            
            // Deduct cost
            userBalance -= shakeCost;
            updateBalance();
            
            // Show cost indicator
            showShakeCost();
            
            // Create champagne and confetti effects
            createChampagneEffect();
            createConfettiEffect();
            
            // Haptic feedback
            if ('vibrate' in navigator) {
                navigator.vibrate([200, 100, 200, 100, 200]);
            }
            
            // Send to all users (in real implementation)
            broadcastShakeEffect();
        }
        
        function showShakeCost() {
            const costIndicator = document.createElement('div');
            costIndicator.className = 'shake-cost';
            costIndicator.textContent = `ðŸ’° -$${shakeCost} SHAKE EFFECT!`;
            document.body.appendChild(costIndicator);
            
            setTimeout(() => costIndicator.remove(), 2000);
        }
        
        function createChampagneEffect() {
            for (let i = 0; i < 3; i++) {
                const bottle = document.createElement('div');
                bottle.className = 'champagne-bottle';
                bottle.style.left = (Math.random() * window.innerWidth) + 'px';
                bottle.style.top = (Math.random() * window.innerHeight * 0.5) + 'px';
                
                shakeEffectOverlay.appendChild(bottle);
                
                setTimeout(() => bottle.remove(), 2000);
            }
        }
        
        function createConfettiEffect() {
            for (let i = 0; i < 100; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti-particle';
                confetti.style.left = Math.random() * window.innerWidth + 'px';
                confetti.style.backgroundColor = `hsl(${Math.random() * 360}, 70%, 50%)`;
                confetti.style.transform = `rotate(${Math.random() * 360}deg)`;
                
                shakeEffectOverlay.appendChild(confetti);
                
                setTimeout(() => confetti.remove(), 3000);
            }
        }
        
        function broadcastShakeEffect() {
            // In real implementation, this would send to all connected users
            console.log('Broadcasting shake effect to all users');
        }
        
        function showInsufficientFunds() {
            const indicator = document.createElement('div');
            indicator.className = 'shake-indicator';
            indicator.textContent = 'ðŸ’° Insufficient Funds!';
            document.body.appendChild(indicator);
            
            setTimeout(() => indicator.remove(), 2000);
        }
        
        function updateBalance() {
            // Update balance display (in real implementation)
            console.log(`Balance: $${userBalance}`);
        }
        
        // 3. Proximity Voice with Spatial Audio
        async function initProximityVoice() {
            try {
                voiceStream = await navigator.mediaDevices.getUserMedia({ 
                    audio: { 
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true
                    } 
                });
                
                spatialAudioContext = new (window.AudioContext || window.webkitAudioContext)();
                const analyser = spatialAudioContext.createAnalyser();
                const microphone = spatialAudioContext.createMediaStreamSource(voiceStream);
                
                microphone.connect(analyser);
                analyser.fftSize = 256;
                
                proximityVoiceActive = true;
                proximityVoiceOverlay.style.display = 'block';
                futureVoiceBtn.classList.add('active');
                
                // Start voice level monitoring
                monitorVoiceLevel(analyser);
                
                // Start spatial audio processing
                processSpatialAudio();
                
            } catch (error) {
                console.log('Microphone access denied for proximity voice');
            }
        }
        
        function monitorVoiceLevel(analyser) {
            const bufferLength = analyser.frequencyBinCount;
            const dataArray = new Uint8Array(bufferLength);
            
            function updateLevel() {
                if (!proximityVoiceActive) return;
                
                analyser.getByteFrequencyData(dataArray);
                
                let sum = 0;
                for (let i = 0; i < bufferLength; i++) {
                    sum += dataArray[i];
                }
                
                const average = sum / bufferLength;
                const level = Math.min(100, (average / 128) * 100);
                
                voiceLevelBar.style.width = level + '%';
                
                requestAnimationFrame(updateLevel);
            }
            
            updateLevel();
        }
        
        function processSpatialAudio() {
            // In real implementation, this would:
            // 1. Calculate distance to other users
            // 2. Apply volume based on proximity
            // 3. Add left/right panning for spatial audio
            // 4. Apply room acoustics (reverb, echo)
            
            console.log('Processing spatial audio...');
        }
        
        // 4. Messages Extension Integration
        function initMessagesExtension() {
            messagesActive = true;
            messagesExtension.classList.add('active');
            futureMessagesBtn.classList.add('active');
            
            // Create Messages content
            const messagesContent = document.createElement('div');
            messagesContent.style.cssText = `
                padding: 80px 20px 20px;
                height: calc(100vh - 80px);
                overflow-y: auto;
            `;
            
            messagesContent.innerHTML = `
                <div style="text-align: center; color: #ffd700; margin-bottom: 30px;">
                    <h2>Sound Factory Messages</h2>
                    <p>Connect with friends on the floor</p>
                </div>
                <div style="background: rgba(255, 215, 0, 0.1); border: 1px solid rgba(255, 215, 0, 0.3); border-radius: 15px; padding: 20px; margin-bottom: 20px;">
                    <h3 style="color: #ffd700; margin: 0 0 10px 0;">ðŸŽ‰ Shake Effects</h3>
                    <p style="margin: 0; color: #fff;">Shake your phone to send confetti and champagne to everyone! Costs $1 per shake.</p>
                </div>
                <div style="background: rgba(255, 215, 0, 0.1); border: 1px solid rgba(255, 215, 0, 0.3); border-radius: 15px; padding: 20px; margin-bottom: 20px;">
                    <h3 style="color: #ffd700; margin: 0 0 10px 0;">ðŸ¥½ AR Mode</h3>
                    <p style="margin: 0; color: #fff;">See pins and avatars in the real world with WebXR AR.</p>
                </div>
                <div style="background: rgba(255, 215, 0, 0.1); border: 1px solid rgba(255, 215, 0, 0.3); border-radius: 15px; padding: 20px;">
                    <h3 style="color: #ffd700; margin: 0 0 10px 0;">ðŸŽ¤ Proximity Voice</h3>
                    <p style="margin: 0; color: #fff;">Hear people nearby with spatial audio and distance-based volume.</p>
                </div>
            `;
            
            messagesExtension.appendChild(messagesContent);
        }
        
        // Future Controls Event Listeners
        futureARBtn.addEventListener('click', async () => {
            if (!arModeActive) {
                const supported = await initWebXR();
                if (supported) {
                    await startARSession();
                    futureARBtn.classList.add('active');
                }
            } else {
                endARSession();
                futureARBtn.classList.remove('active');
            }
        });
        
        futureShakeBtn.addEventListener('click', () => {
            shakeEffectsActive = !shakeEffectsActive;
            if (shakeEffectsActive) {
                initShakeEffects();
                futureShakeBtn.classList.add('active');
            } else {
                futureShakeBtn.classList.remove('active');
            }
        });
        
        futureFaceBtn.addEventListener('click', async () => {
            if (!faceDetectionActive) {
                await startFaceDetection();
            } else {
                stopFaceDetection();
            }
        });
        
        futureVoiceBtn.addEventListener('click', async () => {
            if (!proximityVoiceActive) {
                await initProximityVoice();
            } else {
                stopProximityVoice();
            }
        });
        
        futureMessagesBtn.addEventListener('click', () => {
            if (!messagesActive) {
                initMessagesExtension();
            } else {
                messagesExtension.classList.remove('active');
                messagesActive = false;
                futureMessagesBtn.classList.remove('active');
            }
        });
        
        messagesClose.addEventListener('click', () => {
            messagesExtension.classList.remove('active');
            messagesActive = false;
            futureMessagesBtn.classList.remove('active');
        });
        
        function stopFaceDetection() {
            faceDetectionActive = false;
            if (faceStream) {
                faceStream.getTracks().forEach(track => track.stop());
            }
            if (currentFaceFilter) {
                currentFaceFilter.remove();
            }
            futureFaceBtn.classList.remove('active');
        }
        
        function stopProximityVoice() {
            proximityVoiceActive = false;
            if (voiceStream) {
                voiceStream.getTracks().forEach(track => track.stop());
            }
            proximityVoiceOverlay.style.display = 'none';
            futureVoiceBtn.classList.remove('active');
        }
        
        // LIVESTREAM SYSTEM IMPLEMENTATION
        
        // Initialize Livestream System
        function initLivestreamSystem() {
            // Get all tip buttons
            tipButtons = document.querySelectorAll('.tip-button');
            
            // Add event listeners for tip buttons
            tipButtons.forEach(button => {
                button.addEventListener('click', (e) => {
                    const amount = parseInt(e.target.dataset.amount) || 0;
                    if (amount > 0) {
                        processTip(amount);
                    } else if (e.target.classList.contains('tip-keep')) {
                        startKeepTipping();
                    }
                });
            });
            
            // Livestream control event listeners
            goLiveBtn.addEventListener('click', toggleLive);
            newMusicBtn.addEventListener('click', () => setMusicMode('new'));
            classicsBtn.addEventListener('click', () => setMusicMode('classics'));
            
            // Initialize viewer count
            updateViewerCount();
        }
        
        // Toggle Live Stream
        async function toggleLive() {
            if (!isLive) {
                await startLiveStream();
            } else {
                stopLiveStream();
            }
        }
        
        // Start Live Stream
        async function startLiveStream() {
            try {
                // Request camera and microphone access
                livestreamStream = await navigator.mediaDevices.getUserMedia({
                    video: { 
                        width: { ideal: 1280 },
                        height: { ideal: 720 },
                        facingMode: 'user'
                    },
                    audio: true
                });
                
                // Set video source
                livestreamVideo.srcObject = livestreamStream;
                
                // Show livestream overlay
                livestreamOverlay.classList.add('active');
                livestreamActive = true;
                isLive = true;
                
                // Update UI
                goLiveBtn.classList.add('live');
                goLiveBtn.textContent = 'â¹ï¸';
                
                // Start viewer simulation
                startViewerSimulation();
                
                // Initialize tip tracking
                totalTips = 0;
                intensityLevel = 1;
                
                console.log('Live stream started');
                
            } catch (error) {
                console.log('Failed to start live stream:', error);
                alert('Camera/microphone access required for live streaming');
            }
        }
        
        // Stop Live Stream
        function stopLiveStream() {
            if (livestreamStream) {
                livestreamStream.getTracks().forEach(track => track.stop());
            }
            
            livestreamOverlay.classList.remove('active');
            livestreamActive = false;
            isLive = false;
            
            // Update UI
            goLiveBtn.classList.remove('live');
            goLiveBtn.textContent = 'ðŸ“¹';
            
            // Stop viewer simulation
            currentViewers = 0;
            updateViewerCount();
            
            console.log('Live stream stopped');
        }
        
        // Set Music Mode
        function setMusicMode(mode) {
            currentMusicMode = mode;
            
            // Update button states
            newMusicBtn.classList.toggle('active', mode === 'new');
            classicsBtn.classList.toggle('active', mode === 'classics');
            
            // In real implementation, this would change the music
            console.log(`Music mode changed to: ${mode}`);
        }
        
        // Process Tip Payment
        async function processTip(amount) {
            // Check if user has sufficient balance
            if (userBalance < amount) {
                showInsufficientFunds();
                return;
            }
            
            // Deduct from balance
            userBalance -= amount;
            totalTips += amount;
            
            // Update intensity level based on total tips
            updateIntensityLevel();
            
            // Process payment through Stripe (in real implementation)
            await processStripePayment(amount);
            
            // Trigger effects based on amount and intensity
            triggerTipEffects(amount);
            
            // Send SMS notification (in real implementation)
            sendTipNotification(amount);
            
            // Update balance display
            updateBalance();
        }
        
        // Process Stripe Payment
        async function processStripePayment(amount) {
            try {
                // In real implementation, this would create a Stripe payment intent
                const response = await fetch('/api/create-payment-intent', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        amount: amount * 100, // Convert to cents
                        currency: 'usd',
                        description: `Tip for Sound Factory Live - $${amount}`
                    })
                });
                
                const { client_secret } = await response.json();
                
                // Confirm payment (in real implementation)
                console.log(`Payment processed: $${amount}`);
                
            } catch (error) {
                console.log('Payment processing failed:', error);
            }
        }
        
        // Send Tip Notification
        function sendTipNotification(amount) {
            // In real implementation, this would send SMS via Twilio
            console.log(`SMS sent: Tip of $${amount} received!`);
        }
        
        // Update Intensity Level
        function updateIntensityLevel() {
            if (totalTips >= 1000) intensityLevel = 5;
            else if (totalTips >= 500) intensityLevel = 4;
            else if (totalTips >= 200) intensityLevel = 3;
            else if (totalTips >= 100) intensityLevel = 2;
            else intensityLevel = 1;
            
            console.log(`Intensity level: ${intensityLevel}`);
        }
        
        // Trigger Tip Effects
        function triggerTipEffects(amount) {
            // Basic effects for any tip
            createMoneyShower(amount);
            
            // Special effects based on amount
            if (amount >= 50) {
                createFireworksWithName();
            } else if (amount >= 20) {
                showRainbowFlag();
            } else if (amount >= 10) {
                showHighHeels();
            }
            
            // Intensity-based effects
            if (intensityLevel >= 4) {
                createIntenseFireworks();
            }
            if (intensityLevel >= 5) {
                createUltimateEffect();
            }
        }
        
        // Create Money Shower
        function createMoneyShower(amount) {
            const billCount = Math.min(amount * 2, 50); // Max 50 bills
            
            for (let i = 0; i < billCount; i++) {
                const bill = document.createElement('div');
                bill.className = 'money-bill';
                bill.textContent = `$${amount}`;
                bill.style.left = Math.random() * window.innerWidth + 'px';
                bill.style.animationDelay = Math.random() * 2 + 's';
                
                moneyShower.appendChild(bill);
                
                setTimeout(() => bill.remove(), 4000);
            }
        }
        
        // Create Fireworks with Name
        function createFireworksWithName() {
            const fireworkCount = 20;
            const userName = "VIP User"; // In real implementation, get from user data
            
            for (let i = 0; i < fireworkCount; i++) {
                const firework = document.createElement('div');
                firework.className = 'firework';
                firework.style.left = Math.random() * window.innerWidth + 'px';
                firework.style.top = Math.random() * window.innerHeight + 'px';
                firework.style.backgroundColor = `hsl(${Math.random() * 360}, 70%, 50%)`;
                
                fireworksEffect.appendChild(firework);
                
                // Add name display
                const nameDisplay = document.createElement('div');
                nameDisplay.className = 'firework-name';
                nameDisplay.textContent = userName;
                nameDisplay.style.left = firework.style.left;
                nameDisplay.style.top = firework.style.top;
                
                fireworksEffect.appendChild(nameDisplay);
                
                setTimeout(() => {
                    firework.remove();
                    nameDisplay.remove();
                }, 3000);
            }
        }
        
        // Show Rainbow Flag
        function showRainbowFlag() {
            rainbowFlag.style.display = 'block';
            
            setTimeout(() => {
                rainbowFlag.style.display = 'none';
            }, 3000);
        }
        
        // Show High Heels
        function showHighHeels() {
            highHeels.style.display = 'block';
            
            setTimeout(() => {
                highHeels.style.display = 'none';
            }, 2000);
        }
        
        // Create Intense Fireworks
        function createIntenseFireworks() {
            const intenseCount = 50;
            
            for (let i = 0; i < intenseCount; i++) {
                setTimeout(() => {
                    const firework = document.createElement('div');
                    firework.className = 'firework intensity-level-5';
                    firework.style.left = Math.random() * window.innerWidth + 'px';
                    firework.style.top = Math.random() * window.innerHeight + 'px';
                    firework.style.backgroundColor = `hsl(${Math.random() * 360}, 100%, 50%)`;
                    
                    fireworksEffect.appendChild(firework);
                    
                    setTimeout(() => firework.remove(), 3000);
                }, i * 100);
            }
        }
        
        // Create Ultimate Effect
        function createUltimateEffect() {
            // Ultimate effect combines all previous effects
            createIntenseFireworks();
            createMoneyShower(100);
            showRainbowFlag();
            showHighHeels();
            
            // Add screen shake effect
            document.body.style.animation = 'screenShake 0.5s ease-in-out';
            setTimeout(() => {
                document.body.style.animation = '';
            }, 500);
        }
        
        // Start Keep Tipping Mode
        function startKeepTipping() {
            // In real implementation, this would enable continuous tipping
            console.log('Keep tipping mode activated');
            
            // Show keep tipping indicator
            const indicator = document.createElement('div');
            indicator.className = 'shake-indicator';
            indicator.textContent = 'ðŸ’° KEEP TIPPING MODE ACTIVE! ðŸ’°';
            document.body.appendChild(indicator);
            
            setTimeout(() => indicator.remove(), 3000);
        }
        
        // Start Viewer Simulation
        function startViewerSimulation() {
            const simulateViewers = () => {
                if (isLive) {
                    // Simulate viewer count changes
                    const change = Math.floor(Math.random() * 10) - 5;
                    currentViewers = Math.max(0, currentViewers + change);
                    updateViewerCount();
                    
                    setTimeout(simulateViewers, 2000);
                }
            };
            
            simulateViewers();
        }
        
        // Update Viewer Count
        function updateViewerCount() {
            viewerCount.textContent = `${currentViewers} viewers`;
        }
        
        // iOS-specific initialization
        function initIOSFeatures() {
            // Prevent iOS Safari bounce
            document.addEventListener('touchmove', function(e) {
                e.preventDefault();
            }, { passive: false });
            
            // Handle iOS orientation changes
            window.addEventListener('orientationchange', function() {
                setTimeout(() => {
                    // Recalculate positions after orientation change
                    posX = window.innerWidth / 2;
                    posY = window.innerHeight / 2;
                    character.style.left = posX + 'px';
                    character.style.top = posY + 'px';
                }, 100);
            });
            
            // iOS Safari viewport height fix
            function setViewportHeight() {
                const vh = window.innerHeight * 0.01;
                document.documentElement.style.setProperty('--vh', `${vh}px`);
            }
            
            setViewportHeight();
            window.addEventListener('resize', setViewportHeight);
            window.addEventListener('orientationchange', setViewportHeight);
            
            // iOS device motion permission
            if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
                DeviceMotionEvent.requestPermission().then(response => {
                    if (response === 'granted') {
                        console.log('Device motion permission granted');
                    }
                });
            }
            
            // iOS device orientation permission
            if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                DeviceOrientationEvent.requestPermission().then(response => {
                    if (response === 'granted') {
                        console.log('Device orientation permission granted');
                    }
                });
            }
        }
        
        // Initialize all insane features
        function initInsaneFeatures() {
            initIOSFeatures();
            initShakeDetection();
            initVoiceProximity();
            initScreenRecording();
            initWebXR();
            initLivestreamSystem();
            
            // Add AR toggle to gyro controls
            const arToggle = document.createElement('button');
            arToggle.textContent = 'AR';
            arToggle.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: rgba(0, 0, 0, 0.8);
                border: 1px solid rgba(255, 215, 0, 0.3);
                color: #ffd700;
                padding: 8px 16px;
                border-radius: 20px;
                cursor: pointer;
                font-size: 12px;
                font-weight: 600;
                text-transform: uppercase;
                letter-spacing: 1px;
                z-index: 1000;
            `;
            arToggle.addEventListener('click', toggleARMode);
            document.body.appendChild(arToggle);
        }
        
        // Initialize
        initAudio();
        addCrowdToMainFloor();
        createOtherAvatars();
        initInsaneFeatures();
        
        // Pin drop functionality
        dropBtn.addEventListener('click', () => {
            const message = pinInput.value.trim();
            if (message) {
                // Create pin at current position
                createPin(posX, posY, message);
                pinInput.value = '';
                
                // Show success feedback
                dropBtn.textContent = 'DROPPED!';
                dropBtn.style.background = 'linear-gradient(135deg, #00ff88, #00dd77)';
                setTimeout(() => {
                    dropBtn.textContent = 'DROP';
                    dropBtn.style.background = 'linear-gradient(135deg, #ffd700, #ffed4e)';
                }, 1000);
            }
        });
        
        // Create pin function
        function createPin(x, y, message) {
            const pin = document.createElement('div');
            pin.style.cssText = `
                position: fixed;
                left: ${x}px;
                top: ${y}px;
                width: 12px;
                height: 12px;
                background: radial-gradient(circle, #ffd700, #ffed4e);
                border-radius: 50%;
                box-shadow: 0 0 15px #ffd700;
                z-index: 50;
                transform: translate(-50%, -50%);
                animation: pinDrop 0.5s ease-out;
            `;
            
            pin.title = message;
            document.body.appendChild(pin);
            
            // Remove pin after 5 seconds
            setTimeout(() => {
                pin.style.animation = 'pinFadeOut 0.5s ease-out';
                setTimeout(() => pin.remove(), 500);
            }, 5000);
        }
        
        // Pin animations
        const style = document.createElement('style');
        style.textContent = `
            @keyframes pinDrop {
                0% { transform: translate(-50%, -50%) scale(0); opacity: 0; }
                50% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; }
                100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
            }
            @keyframes pinFadeOut {
                0% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
                100% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
            }
        `;
        document.head.appendChild(style);
        
        // Joystick controls
        function handleJoystickStart(e) {
            isDragging = true;
            handleJoystickMove(e);
        }
        
        function handleJoystickMove(e) {
            if (!isDragging) return;
            
            const rect = joystick.getBoundingClientRect();
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;
            
            let clientX, clientY;
            if (e.touches) {
                clientX = e.touches[0].clientX;
                clientY = e.touches[0].clientY;
            } else {
                clientX = e.clientX;
                clientY = e.clientY;
            }
            
            let deltaX = clientX - centerX;
            let deltaY = clientY - centerY;
            
            // Limit to circle
            const distance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);
            const maxDistance = rect.width / 2 - 20;
            
            if (distance > maxDistance) {
                deltaX = (deltaX / distance) * maxDistance;
                deltaY = (deltaY / distance) * maxDistance;
            }
            
            // Update knob position
            knob.style.transform = `translate(calc(-50% + ${deltaX}px), calc(-50% + ${deltaY}px))`;
            
            // Set velocity based on joystick position
            joystickX = deltaX / maxDistance;
            joystickY = deltaY / maxDistance;
            
            // Add or remove animation class
            if (Math.abs(joystickX) > 0.1 || Math.abs(joystickY) > 0.1) {
                if (!character.classList.contains('walking')) {
                    character.classList.add('walking');
                }
            } else {
                character.classList.remove('walking');
            }
        }
        
        function handleJoystickEnd() {
            isDragging = false;
            knob.style.transform = 'translate(-50%, -50%)';
            joystickX = 0;
            joystickY = 0;
            character.classList.remove('walking');
        }
        
        // Touch events
        joystick.addEventListener('touchstart', handleJoystickStart);
        joystick.addEventListener('touchmove', handleJoystickMove);
        joystick.addEventListener('touchend', handleJoystickEnd);
        
        // Mouse events
        joystick.addEventListener('mousedown', handleJoystickStart);
        document.addEventListener('mousemove', handleJoystickMove);
        document.addEventListener('mouseup', handleJoystickEnd);
        
        // Animation loop
        function animate() {
            // Update velocity based on joystick
            const speed = 4;
            velocityX = joystickX * speed;
            velocityY = joystickY * speed;
            
            // Update position
            posX += velocityX;
            posY += velocityY;
            
            // Keep on screen
            posX = Math.max(20, Math.min(window.innerWidth - 20, posX));
            posY = Math.max(30, Math.min(window.innerHeight - 30, posY));
            
            // Update character position
            character.style.left = posX + 'px';
            character.style.top = posY + 'px';
            
        // Update face filter position if active
        if (currentFilter) {
            currentFilter.style.left = (posX - 20) + 'px';
            currentFilter.style.top = (posY - 20) + 'px';
        }
            
            // Check for collisions with other avatars
            checkCollisions();
            
            requestAnimationFrame(animate);
        }
        
        animate();
    </script>
</body>
</html>