<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sound Factory - The Floor</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #000;
            color: #fff;
            font-family: -apple-system, system-ui, sans-serif;
            overflow: hidden;
            position: relative;
        }

        /* SMS Login Modal */
        .sms-login {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.98);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .sms-login.hidden {
            display: none;
        }

        .login-content {
            background: linear-gradient(135deg, #111, #1a0033);
            border: 2px solid #FFD700;
            border-radius: 20px;
            padding: 40px;
            max-width: 400px;
            width: 90%;
            text-align: center;
        }

        .login-title {
            font-size: 28px;
            font-weight: 700;
            background: linear-gradient(135deg, #FFD700, #FF6B35);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 20px;
        }

        .login-input {
            width: 100%;
            padding: 15px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            color: #fff;
            font-size: 16px;
            margin-bottom: 15px;
            text-align: center;
        }

        .login-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #FFD700, #FF6B35);
            color: #000;
            border: none;
            border-radius: 8px;
            font-weight: 700;
            cursor: pointer;
            font-size: 16px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Main Floor */
        #mainFloor {
            width: 100vw;
            height: 100vh;
            position: relative;
            background: radial-gradient(ellipse at center, #1a0033 0%, #000 100%);
        }

        #mainFloor.drop-mode {
            cursor: crosshair;
        }

        #mainFloor.find-mode {
            cursor: default;
        }

        /* Grid Pattern */
        #mainFloor::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: 
                linear-gradient(rgba(255,215,0,0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255,215,0,0.03) 1px, transparent 1px);
            background-size: 50px 50px;
            pointer-events: none;
        }

        /* Header */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(0,0,0,0.95);
            backdrop-filter: blur(10px);
            padding: 15px 20px;
            z-index: 1000;
            border-bottom: 1px solid rgba(255,215,0,0.2);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 18px;
            font-weight: 800;
            letter-spacing: 1px;
            background: linear-gradient(135deg, #FFD700, #FF6B35);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* Mode Toggle */
        .mode-toggle {
            display: flex;
            background: rgba(255,255,255,0.1);
            border-radius: 30px;
            padding: 3px;
            gap: 5px;
        }

        .mode-btn {
            padding: 10px 25px;
            background: transparent;
            border: none;
            border-radius: 25px;
            color: #888;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .mode-btn.active {
            background: linear-gradient(135deg, #FFD700, #FF6B35);
            color: #000;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .pin-counter {
            background: rgba(255,215,0,0.2);
            border: 1px solid rgba(255,215,0,0.3);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 13px;
            color: #FFD700;
            font-weight: 600;
        }

        /* Avatar (The Guy) */
        .avatar {
            position: absolute;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid #FFD700;
            background-size: cover;
            background-position: center;
            transition: transform 0.5s ease;
            cursor: pointer;
            z-index: 100;
        }

        .avatar::after {
            content: attr(data-initials);
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 14px;
            font-weight: 700;
            color: #fff;
            text-shadow: 0 0 5px rgba(0,0,0,0.8);
        }

        .avatar.walking {
            animation: walk 0.5s infinite alternate;
        }

        @keyframes walk {
            0% { transform: scale(1) rotate(-5deg); }
            100% { transform: scale(1.1) rotate(5deg); }
        }

        .avatar-glow {
            box-shadow: 0 0 20px rgba(255,215,0,0.6);
        }

        /* Pin */
        .pin {
            position: absolute;
            width: 30px;
            height: 40px;
            cursor: pointer;
            transform: translate(-50%, -100%);
            animation: dropIn 0.5s ease;
            z-index: 50;
        }

        @keyframes dropIn {
            0% {
                transform: translate(-50%, -200%) scale(0);
                opacity: 0;
            }
            100% {
                transform: translate(-50%, -100%) scale(1);
                opacity: 1;
            }
        }

        .pin-marker {
            width: 30px;
            height: 40px;
            background: linear-gradient(135deg, #FFD700, #FF6B35);
            border-radius: 50% 50% 50% 0;
            transform: rotate(-45deg);
            box-shadow: 0 0 10px rgba(255,215,0,0.5);
        }

        .pin-initials {
            position: absolute;
            top: 8px;
            left: 50%;
            transform: translateX(-50%) rotate(45deg);
            font-size: 10px;
            font-weight: 700;
            color: #000;
        }

        /* Hover Card */
        .hover-card {
            position: absolute;
            background: rgba(0,0,0,0.95);
            border: 1px solid #FFD700;
            border-radius: 12px;
            padding: 15px;
            min-width: 250px;
            transform: translate(-50%, -100%) translateY(-10px);
            z-index: 500;
            display: none;
        }

        .hover-card.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            0% { opacity: 0; transform: translate(-50%, -100%) translateY(-20px); }
            100% { opacity: 1; transform: translate(-50%, -100%) translateY(-10px); }
        }

        .hover-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .hover-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-size: cover;
            background-position: center;
            border: 2px solid #FFD700;
        }

        .hover-name {
            font-size: 16px;
            font-weight: 600;
            color: #FFD700;
        }

        .hover-story {
            color: #aaa;
            font-size: 13px;
            line-height: 1.5;
            margin-bottom: 10px;
        }

        .hover-actions {
            display: flex;
            gap: 10px;
        }

        .hover-btn {
            flex: 1;
            padding: 6px 12px;
            background: rgba(255,215,0,0.2);
            border: 1px solid rgba(255,215,0,0.3);
            border-radius: 6px;
            color: #FFD700;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .hover-btn:hover {
            background: rgba(255,215,0,0.3);
        }

        /* Chat Box */
        .chat-box {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 350px;
            max-height: 500px;
            background: rgba(0,0,0,0.95);
            border: 2px solid #FFD700;
            border-radius: 12px;
            display: none;
            z-index: 2000;
        }

        .chat-box.active {
            display: block;
        }

        .chat-header {
            background: linear-gradient(135deg, rgba(255,215,0,0.2), rgba(255,107,53,0.2));
            padding: 15px;
            border-bottom: 1px solid rgba(255,215,0,0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-participants {
            display: flex;
            gap: -10px;
        }

        .chat-participant {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 2px solid #000;
            background-size: cover;
            background-position: center;
        }

        .chat-close {
            background: rgba(255,26,120,0.2);
            border: 1px solid rgba(255,26,120,0.3);
            color: #ff1a78;
            padding: 5px 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
        }

        .chat-messages {
            height: 300px;
            overflow-y: auto;
            padding: 15px;
        }

        .chat-message {
            margin-bottom: 15px;
        }

        .message-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 5px;
        }

        .message-avatar {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background-size: cover;
        }

        .message-name {
            font-size: 12px;
            color: #FFD700;
            font-weight: 600;
        }

        .message-text {
            background: rgba(255,255,255,0.05);
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 13px;
            margin-left: 28px;
        }

        .chat-input-area {
            padding: 15px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        .chat-input {
            width: 100%;
            padding: 10px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 6px;
            color: #fff;
            font-size: 13px;
        }

        /* Join Request Modal */
        .join-request {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.95);
            border: 2px solid #9400D3;
            border-radius: 12px;
            padding: 20px;
            z-index: 3000;
            display: none;
        }

        .join-request.active {
            display: block;
        }

        .request-text {
            color: #aaa;
            margin-bottom: 15px;
        }

        .request-user {
            color: #9400D3;
            font-weight: 600;
        }

        .request-actions {
            display: flex;
            gap: 10px;
        }

        .request-btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
        }

        .request-btn.accept {
            background: linear-gradient(135deg, #9400D3, #FF00FF);
            color: #fff;
        }

        .request-btn.deny {
            background: rgba(255,26,120,0.2);
            border: 1px solid rgba(255,26,120,0.3);
            color: #ff1a78;
        }

        /* Instructions */
        .instructions {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(0,0,0,0.9);
            border: 1px solid rgba(255,215,0,0.3);
            border-radius: 8px;
            padding: 15px;
            max-width: 300px;
            font-size: 12px;
            color: #888;
            z-index: 100;
        }

        .instructions h3 {
            color: #FFD700;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .instructions p {
            margin-bottom: 5px;
        }

        .mode-indicator {
            color: #00ff88;
            font-weight: 600;
        }

        /* Character Selection */
        .character-select {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.95);
            border: 2px solid #FFD700;
            border-radius: 20px;
            padding: 30px;
            z-index: 5000;
            display: none;
            text-align: center;
        }

        .character-select.active {
            display: block;
        }

        .character-title {
            font-size: 24px;
            font-weight: 700;
            color: #FFD700;
            margin-bottom: 20px;
        }

        .character-options {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .character-option {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.3s;
        }

        .character-option:hover {
            border-color: #FFD700;
            transform: scale(1.1);
        }

        .character-option.selected {
            border-color: #FFD700;
            box-shadow: 0 0 20px rgba(255,215,0,0.5);
        }

        .character-confirm {
            padding: 12px 30px;
            background: linear-gradient(135deg, #FFD700, #FF6B35);
            color: #000;
            border: none;
            border-radius: 8px;
            font-weight: 700;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <!-- SMS Login -->
    <div class="sms-login" id="smsLogin">
        <div class="login-content">
            <h2 class="login-title">Enter The Floor</h2>
            <p style="color: #888; margin-bottom: 20px;">Login with your phone to drop pins</p>
            <input type="text" class="login-input" id="userName" placeholder="Your Name / Initials">
            <input type="tel" class="login-input" id="userPhone" placeholder="Phone Number">
            <button class="login-btn" onclick="loginUser()">Enter The Floor</button>
        </div>
    </div>

    <!-- Character Selection -->
    <div class="character-select" id="characterSelect">
        <h2 class="character-title">Choose Your Guy</h2>
        <div class="character-options">
            <div class="character-option" style="background: linear-gradient(135deg, #FFD700, #FF6B35);" data-avatar="1"></div>
            <div class="character-option" style="background: linear-gradient(135deg, #00ff88, #00cc66);" data-avatar="2"></div>
            <div class="character-option" style="background: linear-gradient(135deg, #ff1a78, #ff0066);" data-avatar="3"></div>
            <div class="character-option" style="background: linear-gradient(135deg, #9400D3, #FF00FF);" data-avatar="4"></div>
            <div class="character-option" style="background: linear-gradient(135deg, #00CED1, #4169E1);" data-avatar="5"></div>
            <div class="character-option" style="background: linear-gradient(135deg, #FFB6C1, #FF69B4);" data-avatar="6"></div>
            <div class="character-option" style="background: linear-gradient(135deg, #32CD32, #228B22);" data-avatar="7"></div>
            <div class="character-option" style="background: linear-gradient(135deg, #FF4500, #DC143C);" data-avatar="8"></div>
        </div>
        <button class="character-confirm" onclick="confirmCharacter()">Confirm Selection</button>
    </div>

    <!-- Main Floor -->
    <div id="mainFloor" class="drop-mode">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <div class="logo">SOUND FACTORY FLOOR</div>
                
                <!-- Mode Toggle -->
                <div class="mode-toggle">
                    <button class="mode-btn active" onclick="setMode('drop')">DROP</button>
                    <button class="mode-btn" onclick="setMode('find')">FIND</button>
                </div>
                
                <div class="user-info">
                    <span id="userDisplay" style="color: #aaa;">-</span>
                    <div class="pin-counter" id="pinCounter">3 Pins Left</div>
                </div>
            </div>
        </header>

        <!-- Instructions -->
        <div class="instructions">
            <h3>How To Play</h3>
            <p>Current Mode: <span class="mode-indicator" id="modeIndicator">DROP</span></p>
            <p>üìç DROP: Click to drop pins (3 max)</p>
            <p>üîç FIND: Walk around and explore</p>
            <p>üë• When guys meet, you can chat</p>
            <p>üí¨ Third person can request to join</p>
            <p>‚ù§Ô∏è Like and share pin stories</p>
        </div>
    </div>

    <!-- Hover Card Template -->
    <div class="hover-card" id="hoverCard">
        <div class="hover-header">
            <div class="hover-avatar" id="hoverAvatar"></div>
            <div>
                <div class="hover-name" id="hoverName">-</div>
            </div>
        </div>
        <div class="hover-story" id="hoverStory">-</div>
        <div class="hover-actions">
            <button class="hover-btn" onclick="likePin()">‚ù§Ô∏è Like</button>
            <button class="hover-btn" onclick="sharePin()">üì§ Share</button>
            <button class="hover-btn" onclick="commentPin()">üí¨ Comment</button>
        </div>
    </div>

    <!-- Chat Box -->
    <div class="chat-box" id="chatBox">
        <div class="chat-header">
            <div class="chat-participants" id="chatParticipants">
                <!-- Participant avatars -->
            </div>
            <button class="chat-close" onclick="closeChat()">Close</button>
        </div>
        <div class="chat-messages" id="chatMessages">
            <!-- Messages appear here -->
        </div>
        <div class="chat-input-area">
            <input type="text" class="chat-input" id="chatInput" placeholder="Type a message..." onkeypress="sendMessage(event)">
        </div>
    </div>

    <!-- Join Request Modal -->
    <div class="join-request" id="joinRequest">
        <p class="request-text">
            <span class="request-user" id="requestUser">User</span> wants to join the chat
        </p>
        <div class="request-actions">
            <button class="request-btn accept" onclick="acceptJoin()">Let Them In</button>
            <button class="request-btn deny" onclick="denyJoin()">Be Shady</button>
        </div>
    </div>

    <script>
        // User data
        let currentUser = {
            name: '',
            initials: '',
            phone: '',
            avatar: null,
            pinsLeft: 3,
            pins: [],
            guy: null
        };

        // Current mode
        let currentMode = 'drop';
        let movementInterval = null;

        // All users on the floor
        let usersOnFloor = new Map();
        let activeChats = new Map();
        let selectedCharacter = null;

        // Set mode
        function setMode(mode) {
            currentMode = mode;
            
            // Update UI
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Update floor class
            const floor = document.getElementById('mainFloor');
            floor.classList.remove('drop-mode', 'find-mode');
            floor.classList.add(`${mode}-mode`);
            
            // Update indicator
            document.getElementById('modeIndicator').textContent = mode.toUpperCase();
            
            // Control avatar movement
            if (mode === 'find') {
                // Start movement in find mode
                if (currentUser.guy && !movementInterval) {
                    startAvatarMovement(currentUser.guy);
                }
            } else {
                // Stop movement in drop mode
                if (movementInterval) {
                    clearInterval(movementInterval);
                    movementInterval = null;
                }
            }
        }

        // Login
        function loginUser() {
            const name = document.getElementById('userName').value;
            const phone = document.getElementById('userPhone').value;
            
            if (!name || !phone) {
                alert('Please enter your name and phone');
                return;
            }
            
            // Create initials
            const initials = name.split(' ').map(n => n[0]).join('').toUpperCase();
            
            currentUser.name = name;
            currentUser.initials = initials;
            currentUser.phone = phone.replace(/\D/g, '');
            
            // Hide login
            document.getElementById('smsLogin').classList.add('hidden');
            
            // Show character selection
            document.getElementById('characterSelect').classList.add('active');
        }

        // Character selection
        document.querySelectorAll('.character-option').forEach(option => {
            option.addEventListener('click', function() {
                document.querySelectorAll('.character-option').forEach(o => o.classList.remove('selected'));
                this.classList.add('selected');
                selectedCharacter = this.getAttribute('data-avatar');
            });
        });

        function confirmCharacter() {
            if (!selectedCharacter) {
                alert('Please select your guy');
                return;
            }
            
            currentUser.avatar = selectedCharacter;
            
            // Hide character select
            document.getElementById('characterSelect').classList.remove('active');
            
            // Initialize floor
            initializeFloor();
        }

        function initializeFloor() {
            // Update UI
            document.getElementById('userDisplay').textContent = `${currentUser.name} (${currentUser.initials})`;
            document.getElementById('pinCounter').textContent = `${currentUser.pinsLeft} Pins Left`;
            
            // Create user's guy (avatar)
            createAvatar(currentUser);
            
            // Enable pin dropping
            document.getElementById('mainFloor').addEventListener('click', handleFloorClick);
            
            // Simulate other users
            setTimeout(addOtherUsers, 2000);
        }

        function handleFloorClick(event) {
            // Only drop pins in drop mode
            if (currentMode !== 'drop') return;
            if (event.target.id !== 'mainFloor') return;
            
            dropPin(event);
        }

        function createAvatar(user) {
            const avatar = document.createElement('div');
            avatar.className = 'avatar';
            avatar.id = `avatar-${user.phone}`;
            avatar.setAttribute('data-initials', user.initials);
            avatar.setAttribute('data-user', user.phone);
            
            // Set avatar color based on selection
            const colors = [
                'linear-gradient(135deg, #FFD700, #FF6B35)',
                'linear-gradient(135deg, #00ff88, #00cc66)',
                'linear-gradient(135deg, #ff1a78, #ff0066)',
                'linear-gradient(135deg, #9400D3, #FF00FF)',
                'linear-gradient(135deg, #00CED1, #4169E1)',
                'linear-gradient(135deg, #FFB6C1, #FF69B4)',
                'linear-gradient(135deg, #32CD32, #228B22)',
                'linear-gradient(135deg, #FF4500, #DC143C)'
            ];
            
            avatar.style.background = colors[parseInt(user.avatar) - 1];
            
            // Random starting position
            avatar.style.left = Math.random() * (window.innerWidth - 100) + 50 + 'px';
            avatar.style.top = Math.random() * (window.innerHeight - 200) + 100 + 'px';
            
            document.getElementById('mainFloor').appendChild(avatar);
            
            user.guy = avatar;
            usersOnFloor.set(user.phone, user);
        }

        function startAvatarMovement(avatar) {
            movementInterval = setInterval(() => {
                if (!avatar || currentMode !== 'find') return;
                
                avatar.classList.add('walking');
                
                const currentX = parseInt(avatar.style.left);
                const currentY = parseInt(avatar.style.top);
                
                const newX = currentX + (Math.random() - 0.5) * 50;
                const newY = currentY + (Math.random() - 0.5) * 50;
                
                // Keep within bounds
                avatar.style.left = Math.max(50, Math.min(window.innerWidth - 50, newX)) + 'px';
                avatar.style.top = Math.max(100, Math.min(window.innerHeight - 50, newY)) + 'px';
                
                setTimeout(() => avatar.classList.remove('walking'), 500);
                
                // Check for collisions
                checkAvatarCollisions();
            }, 3000);
        }

        function dropPin(event) {
            if (currentUser.pinsLeft <= 0) {
                alert('You have no pins left!');
                return;
            }
            
            const story = prompt('Tell your story for this pin:');
            if (!story) return;
            
            const pin = document.createElement('div');
            pin.className = 'pin';
            pin.style.left = event.clientX + 'px';
            pin.style.top = event.clientY + 'px';
            pin.setAttribute('data-story', story);
            pin.setAttribute('data-user', currentUser.phone);
            pin.setAttribute('data-name', currentUser.name);
            
            const marker = document.createElement('div');
            marker.className = 'pin-marker';
            
            const initials = document.createElement('div');
            initials.className = 'pin-initials';
            initials.textContent = currentUser.initials;
            
            marker.appendChild(initials);
            pin.appendChild(marker);
            
            document.getElementById('mainFloor').appendChild(pin);
            
            currentUser.pins.push({
                x: event.clientX,
                y: event.clientY,
                story: story
            });
            
            currentUser.pinsLeft--;
            document.getElementById('pinCounter').textContent = `${currentUser.pinsLeft} Pins Left`;
            
            // Add hover events
            pin.addEventListener('mouseenter', showPinHover);
            pin.addEventListener('mouseleave', hidePinHover);
        }

        function showPinHover(event) {
            const pin = event.currentTarget;
            const card = document.getElementById('hoverCard');
            
            const story = pin.getAttribute('data-story');
            const name = pin.getAttribute('data-name');
            const user = pin.getAttribute('data-user');
            
            document.getElementById('hoverName').textContent = name;
            document.getElementById('hoverStory').textContent = story;
            
            // Position card above pin
            card.style.left = pin.style.left;
            card.style.top = (parseInt(pin.style.top) - 10) + 'px';
            card.classList.add('active');
        }

        function hidePinHover() {
            document.getElementById('hoverCard').classList.remove('active');
        }

        function checkAvatarCollisions() {
            const avatars = document.querySelectorAll('.avatar');
            
            avatars.forEach((avatar1, i) => {
                avatars.forEach((avatar2, j) => {
                    if (i >= j) return;
                    
                    const rect1 = avatar1.getBoundingClientRect();
                    const rect2 = avatar2.getBoundingClientRect();
                    
                    const distance = Math.sqrt(
                        Math.pow(rect1.left - rect2.left, 2) + 
                        Math.pow(rect1.top - rect2.top, 2)
                    );
                    
                    if (distance < 60) {
                        // Avatars are close - initiate chat
                        const user1 = avatar1.getAttribute('data-user');
                        const user2 = avatar2.getAttribute('data-user');
                        
                        if (!activeChats.has(`${user1}-${user2}`)) {
                            initiateChat(user1, user2);
                        }
                    }
                });
            });
        }

        function initiateChat(user1, user2) {
            if (user1 === currentUser.phone || user2 === currentUser.phone) {
                const otherUser = user1 === currentUser.phone ? user2 : user1;
                
                // Show chat box
                const chatBox = document.getElementById('chatBox');
                chatBox.classList.add('active');
                
                // Add participants
                const participantsDiv = document.getElementById('chatParticipants');
                participantsDiv.innerHTML = `
                    <div class="chat-participant" style="background: ${getAvatarColor(currentUser.avatar)}"></div>
                    <div class="chat-participant" style="background: ${getAvatarColor('2')}"></div>
                `;
                
                // Add initial message
                const messages = document.getElementById('chatMessages');
                messages.innerHTML = `
                    <div class="chat-message">
                        <div class="message-text" style="text-align: center; color: #FFD700;">
                            Your guys met on the floor! Start chatting...
                        </div>
                    </div>
                `;
                
                activeChats.set(`${user1}-${user2}`, true);
                
                // Simulate third person wanting to join after 5 seconds
                setTimeout(() => {
                    if (chatBox.classList.contains('active')) {
                        showJoinRequest();
                    }
                }, 5000);
            }
        }

        function showJoinRequest() {
            const modal = document.getElementById('joinRequest');
            document.getElementById('requestUser').textContent = 'DJ Mike';
            modal.classList.add('active');
        }

        function acceptJoin() {
            document.getElementById('joinRequest').classList.remove('active');
            
            // Add third participant
            const participantsDiv = document.getElementById('chatParticipants');
            const newParticipant = document.createElement('div');
            newParticipant.className = 'chat-participant';
            newParticipant.style.background = 'linear-gradient(135deg, #9400D3, #FF00FF)';
            participantsDiv.appendChild(newParticipant);
            
            // Add join message
            addChatMessage('System', 'DJ Mike joined the chat', true);
        }

        function denyJoin() {
            document.getElementById('joinRequest').classList.remove('active');
            addChatMessage('System', 'Join request denied', true);
        }

        function sendMessage(event) {
            if (event.key === 'Enter') {
                const input = document.getElementById('chatInput');
                const message = input.value.trim();
                
                if (message) {
                    addChatMessage(currentUser.name, message);
                    input.value = '';
                }
            }
        }

        function addChatMessage(sender, text, isSystem = false) {
            const messages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'chat-message';
            
            if (isSystem) {
                messageDiv.innerHTML = `
                    <div class="message-text" style="text-align: center; color: #888; font-style: italic;">
                        ${text}
                    </div>
                `;
            } else {
                messageDiv.innerHTML = `
                    <div class="message-header">
                        <div class="message-avatar" style="background: ${getAvatarColor(currentUser.avatar)}"></div>
                        <div class="message-name">${sender}</div>
                    </div>
                    <div class="message-text">${text}</div>
                `;
            }
            
            messages.appendChild(messageDiv);
            messages.scrollTop = messages.scrollHeight;
        }

        function closeChat() {
            document.getElementById('chatBox').classList.remove('active');
        }

        function getAvatarColor(avatarId) {
            const colors = [
                'linear-gradient(135deg, #FFD700, #FF6B35)',
                'linear-gradient(135deg, #00ff88, #00cc66)',
                'linear-gradient(135deg, #ff1a78, #ff0066)',
                'linear-gradient(135deg, #9400D3, #FF00FF)',
                'linear-gradient(135deg, #00CED1, #4169E1)',
                'linear-gradient(135deg, #FFB6C1, #FF69B4)',
                'linear-gradient(135deg, #32CD32, #228B22)',
                'linear-gradient(135deg, #FF4500, #DC143C)'
            ];
            return colors[parseInt(avatarId) - 1] || colors[0];
        }

        function likePin() {
            alert('Pin liked! ‚ù§Ô∏è');
        }

        function sharePin() {
            alert('Pin shared! üì§');
        }

        function commentPin() {
            const comment = prompt('Add your comment:');
            if (comment) {
                alert('Comment added! üí¨');
            }
        }

        // Add other users (simulated)
        function addOtherUsers() {
            const otherUsers = [
                { name: 'DJ Mike', initials: 'DM', phone: '1234567890', avatar: '2' },
                { name: 'Sarah C', initials: 'SC', phone: '0987654321', avatar: '3' },
                { name: 'Alex W', initials: 'AW', phone: '1111111111', avatar: '4' }
            ];
            
            otherUsers.forEach(user => {
                createAvatar(user);
                
                // Only move in find mode
                if (currentMode === 'find') {
                    startAvatarMovement(user.guy);
                }
                
                // Drop some random pins
                if (Math.random() > 0.5) {
                    const pin = document.createElement('div');
                    pin.className = 'pin';
                    pin.style.left = Math.random() * window.innerWidth + 'px';
                    pin.style.top = Math.random() * (window.innerHeight - 200) + 200 + 'px';
                    pin.setAttribute('data-story', 'Great vibes tonight!');
                    pin.setAttribute('data-user', user.phone);
                    pin.setAttribute('data-name', user.name);
                    
                    const marker = document.createElement('div');
                    marker.className = 'pin-marker';
                    
                    const initials = document.createElement('div');
                    initials.className = 'pin-initials';
                    initials.textContent = user.initials;
                    
                    marker.appendChild(initials);
                    pin.appendChild(marker);
                    
                    document.getElementById('mainFloor').appendChild(pin);
                    
                    pin.addEventListener('mouseenter', showPinHover);
                    pin.addEventListener('mouseleave', hidePinHover);
                }
            });
        }

        // Phone formatting
        document.getElementById('userPhone').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length >= 6) {
                value = `(${value.slice(0,3)}) ${value.slice(3,6)}-${value.slice(6,10)}`;
            } else if (value.length >= 3) {
                value = `(${value.slice(0,3)}) ${value.slice(3)}`;
            }
            e.target.value = value;
        });
    </script>
</body>
</html>
