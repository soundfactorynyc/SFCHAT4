<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Promo Admin</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background:#0b0b0b; color:#eaeaea; margin:0; padding:24px; }
    h1 { font-size:20px; margin:0 0 16px; }
    form { display:grid; gap:12px; max-width:680px; background:#121212; padding:16px; border-radius:10px; border:1px solid #222; }
    label { display:block; font-size:13px; color:#bdbdbd; }
    input, textarea, select { width:100%; padding:10px; background:#1a1a1a; color:#eee; border:1px solid #2a2a2a; border-radius:8px; }
    button { background:#1f6feb; color:#fff; border:none; padding:10px 14px; border-radius:8px; cursor:pointer; }
    button.secondary { background:#2a2a2a; }
    .row { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
  .list { margin-top:24px; }
  .panel { background:#121212; padding:16px; border-radius:10px; border:1px solid #222; margin-bottom:16px; }
  .toggle { display:flex; align-items:center; gap:8px; }
    table { width:100%; border-collapse: collapse; }
    th, td { padding:8px 10px; border-bottom:1px solid #222; font-size:13px; }
    th { text-align:left; color:#bdbdbd; }
    .note { color:#9aa0a6; font-size:12px; }
  </style>
  <script>
    async function submitForm(e){
      e.preventDefault();
      const form = e.target;
      const data = {
        platform: form.platform.value,
        caption: form.caption.value,
        videoUrl: form.videoUrl.value || null,
        scheduled_for: form.scheduled_for.value
      };
      const headers = { 'Content-Type': 'application/json' };
      const token = localStorage.getItem('PROMO_ADMIN_TOKEN');
      if (token) headers['Authorization'] = 'Bearer ' + token;
      const res = await fetch('/.netlify/functions/queue-promo', { method:'POST', headers, body: JSON.stringify(data) });
      const json = await res.json();
      if (!res.ok) { alert('Error: ' + (json.error||res.status)); return; }
      alert('Queued! ID: ' + json?.post?.id);
      form.reset();
      loadList();
    }
    async function loadList(){
      const res = await fetch('/.netlify/functions/queue-promo');
      const json = await res.json();
      const tbody = document.querySelector('#list tbody');
      tbody.innerHTML='';
      (json.posts||[]).forEach(p=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${p.id}</td><td>${p.platform}</td><td>${p.caption?.slice(0,60)||''}</td><td>${p.video_url? 'yes':'no'}</td><td>${new Date(p.scheduled_for).toLocaleString()}</td><td>${p.status}</td>`;
        tbody.appendChild(tr);
      })
    }
    function saveToken(){
      const v = prompt('Enter Admin Token (optional)');
      if (v != null) localStorage.setItem('PROMO_ADMIN_TOKEN', v.trim());
    }
    async function loadAccounts(){
      const res = await fetch('/.netlify/functions/admin-accounts');
      const json = await res.json();
      const tbody = document.querySelector('#acctList tbody');
      const select = document.querySelector('#accountSelect');
      tbody.innerHTML='';
      // reset select (keep (auto))
      select.innerHTML = '<option value="">(auto)</option>';
      (json.accounts||[]).forEach(a=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${a.id}</td><td>${a.platform}</td><td>${a.label}</td><td>${a.is_active?'yes':'no'}</td><td><button onclick="deleteAccount(${a.id})">Delete</button></td>`;
        tbody.appendChild(tr);
        if (a.platform === 'tiktok') {
          const opt = document.createElement('option');
          opt.value = a.id; opt.textContent = `${a.label} (#${a.id})`;
          select.appendChild(opt);
        }
      });
    }
    async function saveAccount(e){
      e.preventDefault();
      const f = e.target;
      let creds;
      try { creds = JSON.parse(f.credentials.value); } catch { alert('Credentials must be valid JSON'); return false; }
      const body = { platform: f.platform.value, label: f.label.value, is_active: !!f.is_active.checked, credentials: creds };
      const headers = { 'Content-Type': 'application/json' };
      const token = localStorage.getItem('PROMO_ADMIN_TOKEN');
      if (token) headers['Authorization'] = 'Bearer ' + token;
      const res = await fetch('/.netlify/functions/admin-accounts', { method:'POST', headers, body: JSON.stringify(body) });
      const json = await res.json();
      if (!res.ok) { alert('Error: ' + (json.error||res.status)); return false; }
      f.reset();
      loadAccounts();
      return false;
    }
    async function deleteAccount(id){
      if (!confirm('Delete account #' + id + '?')) return;
      const headers = { 'Content-Type': 'application/json' };
      const token = localStorage.getItem('PROMO_ADMIN_TOKEN');
      if (token) headers['Authorization'] = 'Bearer ' + token;
      const res = await fetch('/.netlify/functions/admin-accounts', { method:'DELETE', headers, body: JSON.stringify({ id }) });
      const json = await res.json().catch(()=>({}));
      if (!res.ok) { alert('Error: ' + (json.error||res.status)); return; }
      loadAccounts();
    }
    async function loadSettings(){
      const res = await fetch('/.netlify/functions/admin-settings');
      const json = await res.json();
      const safe = json.settings?.SAFE_MODE?.enabled ?? null;
      if (safe !== null) document.querySelector('#safeMode').checked = !!safe;
    }
    async function saveSettings(){
      const headers = { 'Content-Type': 'application/json' };
      const token = localStorage.getItem('PROMO_ADMIN_TOKEN');
      if (token) headers['Authorization'] = 'Bearer ' + token;
      const payload = { SAFE_MODE: { enabled: document.querySelector('#safeMode').checked } };
      const res = await fetch('/.netlify/functions/admin-settings', { method:'POST', headers, body: JSON.stringify(payload) });
      if (!res.ok) { const j = await res.json().catch(()=>({})); alert('Save failed: ' + (j.error||res.status)); return; }
      alert('Settings saved');
    }
    window.addEventListener('DOMContentLoaded', ()=>{ loadSettings(); loadAccounts(); loadList(); });
  </script>
 </head>
 <body>
  <h1>Promo Admin</h1>
  <p class="note">Schedule in UTC. TikTok requires a videoUrl when going live.</p>
  <p><button class="secondary" onclick="saveToken()">Set Admin Token</button></p>
  <div class="panel">
    <h2>Global Settings</h2>
    <label class="toggle">
      <input type="checkbox" id="safeMode" />
      SAFE_MODE (simulate posting)
    </label>
    <div style="margin-top:10px"><button onclick="saveSettings()">Save Settings</button></div>
  </div>
  <div class="panel">
    <h2>Accounts</h2>
    <form id="acctForm" onsubmit="return saveAccount(event)">
      <div class="row">
        <div>
          <label>Platform</label>
          <select name="platform">
            <option value="tiktok">TikTok</option>
          </select>
        </div>
        <div>
          <label>Label</label>
          <input name="label" placeholder="Main TikTok" required />
        </div>
      </div>
      <label>Credentials (JSON)</label>
      <textarea name="credentials" rows="4" placeholder='{"access_token":"...","business_account_id":"..."}' required></textarea>
      <label><input type="checkbox" name="is_active" checked /> Active</label>
      <div style="margin-top:10px"><button type="submit">Save Account</button></div>
    </form>
    <div class="list">
      <table id="acctList"><thead><tr><th>ID</th><th>Platform</th><th>Label</th><th>Active</th><th>Actions</th></tr></thead><tbody></tbody></table>
    </div>
  </div>
  <form onsubmit="submitForm(event)">
    <div class="row">
      <div>
        <label>Platform</label>
        <select name="platform">
          <option value="tiktok">TikTok</option>
          <option value="instagram" disabled>Instagram (soon)</option>
          <option value="facebook" disabled>Facebook (soon)</option>
          <option value="twitter" disabled>X/Twitter (soon)</option>
          <option value="whatsapp" disabled>WhatsApp (soon)</option>
        </select>
      </div>
      <div>
        <label>Scheduled For (ISO, UTC)</label>
        <input type="datetime-local" name="scheduled_for" required />
      </div>
    </div>
    <div>
      <label>Account</label>
      <select name="account_id" id="accountSelect"><option value="">(auto)</option></select>
    </div>
    <label>Caption</label>
    <textarea name="caption" rows="4" placeholder="Your promo caption" required></textarea>
    <label>Video URL (public, MP4)</label>
    <input name="videoUrl" placeholder="https://.../promo.mp4" />
    <button type="submit">Queue Promo</button>
  </form>

  <div class="list">
    <h2>Scheduled Posts</h2>
    <table id="list">
      <thead><tr><th>ID</th><th>Platform</th><th>Caption</th><th>Video</th><th>Scheduled</th><th>Status</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>
    <p class="note" style="margin-top:20px">
      Shortcuts: 
      <a href="/promo-monitor.html" style="color:#8ab4f8">Promo Monitor</a> Â·
      <a href="/invites.html" style="color:#8ab4f8">Invites Hub</a>
    </p>
 </body>
 </html>
