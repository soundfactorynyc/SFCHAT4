<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Instagram Data Tools</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 24px; }
    header { display:flex; align-items:center; gap:12px; }
    h1 { margin:0; font-size: 22px; }
    .muted { color:#6b7280; font-size:12px; }
    fieldset { border:1px solid #e5e7eb; padding:16px; border-radius:8px; margin:16px 0; }
    legend { padding:0 8px; color:#374151; }
    table { width:100%; border-collapse: collapse; margin-top: 8px; }
    th, td { border:1px solid #e5e7eb; padding:6px 8px; font-size: 13px; }
    th { background:#f9fafb; text-align:left; }
    button { background:#111827; border:none; color:white; padding:8px 12px; border-radius:6px; cursor:pointer; }
    .row { display:flex; gap:12px; align-items: end; flex-wrap: wrap; }
    .row > * { flex:1; min-width: 240px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, monospace; }
  </style>
</head>
<body>
  <header>
    <h1>Instagram Data Tools</h1>
    <a href="/site-map.html" class="muted">Site Map</a>
  </header>

  <fieldset>
    <legend>Upload JSON files</legend>
    <div class="row">
      <div>
        <label>Followers JSON (followers_*.json)
          <input id="followersInput" type="file" accept="application/json,.json" multiple />
        </label>
      </div>
      <div>
        <label>Liked Posts JSON (liked_posts.json)
          <input id="likedPostsInput" type="file" accept="application/json,.json" />
        </label>
      </div>
      <div>
        <label>Liked Comments JSON (liked_comments.json)
          <input id="likedCommentsInput" type="file" accept="application/json,.json" />
        </label>
      </div>
      <div>
        <label>Ads Viewed JSON (ads_viewed.json)
          <input id="adsViewedInput" type="file" accept="application/json,.json" />
        </label>
      </div>
    </div>
  </fieldset>

  <fieldset>
    <legend>Followers</legend>
    <div class="row">
      <button id="btnFollowersCSV">Export Followers CSV</button>
      <button id="btnFollowersDM">Export DM CSV (username,name)</button>
    </div>
    <table id="tblFollowers"><thead><tr><th>Username</th><th>Name</th><th>Followed At</th></tr></thead><tbody></tbody></table>
  </fieldset>

  <fieldset>
    <legend>Liked Posts</legend>
    <div><button id="btnLikedPostsCSV">Export CSV</button></div>
    <table id="tblLikedPosts"><thead><tr><th>Author</th><th>Permalink</th><th>Time</th></tr></thead><tbody></tbody></table>
  </fieldset>

  <fieldset>
    <legend>Liked Comments</legend>
    <div><button id="btnLikedCommentsCSV">Export CSV</button></div>
    <table id="tblLikedComments"><thead><tr><th>Author</th><th>Text</th><th>Time</th></tr></thead><tbody></tbody></table>
  </fieldset>

  <fieldset>
    <legend>Ads Viewed</legend>
    <div><button id="btnAdsViewedCSV">Export CSV</button></div>
    <table id="tblAdsViewed"><thead><tr><th>Author</th><th>Time</th></tr></thead><tbody></tbody></table>
  </fieldset>

  <script>
    const $ = sel => document.querySelector(sel);

    const followers = [];
    let likedPosts = [];
    let likedComments = [];
    let adsViewed = [];

    function toCSV(rows, headers) {
      const h = headers.join(',');
      const body = rows.map(r => headers.map(k => JSON.stringify(r[k] ?? '')).join(',')).join('\n');
      return h + '\n' + body;
    }
    function downloadCSV(rows, headers, filename) {
      const csv = toCSV(rows, headers);
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      a.click();
      URL.revokeObjectURL(url);
    }

    function renderFollowers() {
      const tbody = $('#tblFollowers tbody');
      tbody.innerHTML = followers.slice(0,2000).map(f => `<tr><td>${f.username||''}</td><td>${f.name||''}</td><td>${f.followed_at||''}</td></tr>`).join('');
    }

    function renderLikedPosts() {
      const tbody = $('#tblLikedPosts tbody');
      tbody.innerHTML = likedPosts.slice(0,2000).map(p => `<tr><td>${p.author||''}</td><td>${p.permalink||''}</td><td>${p.time||''}</td></tr>`).join('');
    }

    function renderLikedComments() {
      const tbody = $('#tblLikedComments tbody');
      tbody.innerHTML = likedComments.slice(0,2000).map(c => `<tr><td>${c.author||''}</td><td>${c.text||''}</td><td>${c.time||''}</td></tr>`).join('');
    }

    function renderAdsViewed() {
      const tbody = $('#tblAdsViewed tbody');
      tbody.innerHTML = adsViewed.slice(0,2000).map(a => `<tr><td>${a.author||''}</td><td>${a.time||''}</td></tr>`).join('');
    }

    async function handleFollowersFiles(files) {
      followers.length = 0;
      for (const file of files) {
        const text = await file.text();
        let json; try { json = JSON.parse(text); } catch { continue; }
        // Infer shape: Typical IG export has an array of objects with string_map_data holding username, etc.
        // We can't rely on a single format, so extract known patterns.
        const arr = Array.isArray(json) ? json : (json.followers || json.data || json.items || []);
        for (const row of (arr||[])) {
          // Pattern 1: { string_list_data: [{ value: "username", href: "https://instagram.com/...", timestamp: 123 }] }
          if (Array.isArray(row.string_list_data) && row.string_list_data.length) {
            const s = row.string_list_data[0];
            followers.push({ username: s.value || '', name: row.title || '', followed_at: s.timestamp ? new Date(s.timestamp*1000).toISOString() : '' });
            continue;
          }
          // Pattern 2: { string_map_data: { Username: { value }, Name: { value }, Time: { timestamp } } }
          if (row.string_map_data) {
            const sm = row.string_map_data;
            const username = (sm.Username && (sm.Username.value || sm.Username.href || '')) || (sm.username?.value) || '';
            const name = (sm.Name && sm.Name.value) || '';
            const ts = (sm.Time && (sm.Time.timestamp || sm.Time.value)) || '';
            const followed_at = ts ? new Date(Number(ts)*1000).toISOString() : '';
            followers.push({ username, name, followed_at });
            continue;
          }
        }
      }
      renderFollowers();
    }

    async function handleSingleFile(inputEl, setter) {
      const file = inputEl.files[0]; if (!file) return;
      const text = await file.text();
      let json; try { json = JSON.parse(text); } catch { alert('Invalid JSON'); return; }
      setter(json);
    }

    $('#followersInput').addEventListener('change', (e) => handleFollowersFiles(e.target.files));

    $('#likedPostsInput').addEventListener('change', () => handleSingleFile($('#likedPostsInput'), (json) => {
      // liked_posts.json: often { likes_media_likes: [ { title, string_list_data: [{ href, value, timestamp }] } ... ] }
      const arr = json.likes_media_likes || [];
      likedPosts = arr.map(it => {
        const s = Array.isArray(it.string_list_data) ? it.string_list_data[0] : null;
        const author = (it.title || '').split(' on Instagram: ')[0] || '';
        const permalink = s?.href || '';
        const time = s?.timestamp ? new Date(s.timestamp*1000).toISOString() : '';
        return { author, permalink, time };
      }).filter(r => r.author || r.permalink || r.time);
      renderLikedPosts();
    }));

    $('#likedCommentsInput').addEventListener('change', () => handleSingleFile($('#likedCommentsInput'), (json) => {
      // liked_comments.json: shape similar to { likes_comment_likes: [ { string_map_data: { Author: {value}, Comment: {value}, Time: {timestamp} } } ] }
      const arr = json.likes_comment_likes || json.likes_comments || [];
      likedComments = (arr||[]).map(it => {
        const m = it.string_map_data || {};
        const author = m.Author?.value || '';
        const text = m.Comment?.value || m.Text?.value || '';
        const ts = m.Time?.timestamp || m.Time?.value || '';
        const time = ts ? new Date(Number(ts)*1000).toISOString() : '';
        return { author, text, time };
      }).filter(r => r.author || r.text || r.time);
      renderLikedComments();
    }));

    $('#adsViewedInput').addEventListener('change', () => handleSingleFile($('#adsViewedInput'), (json) => {
      const arr = json.impressions_history_ads_seen || [];
      adsViewed = arr.map(it => {
        const m = it.string_map_data || {};
        const author = m.Author?.value || '';
        const ts = m.Time?.timestamp || m.Time?.value || '';
        const time = ts ? new Date(Number(ts)*1000).toISOString() : '';
        return { author, time };
      }).filter(r => r.author || r.time);
      renderAdsViewed();
    }));

    // Export buttons
    $('#btnFollowersCSV').addEventListener('click', () => downloadCSV(followers, ['username','name','followed_at'], 'followers.csv'));
    $('#btnFollowersDM').addEventListener('click', () => downloadCSV(followers.map(f => ({ username: f.username, name: f.name })), ['username','name'], 'followers_dm.csv'));
    $('#btnLikedPostsCSV').addEventListener('click', () => downloadCSV(likedPosts, ['author','permalink','time'], 'liked_posts.csv'));
    $('#btnLikedCommentsCSV').addEventListener('click', () => downloadCSV(likedComments, ['author','text','time'], 'liked_comments.csv'));
    $('#btnAdsViewedCSV').addEventListener('click', () => downloadCSV(adsViewed, ['author','time'], 'ads_viewed.csv'));
  </script>
</body>
</html>
