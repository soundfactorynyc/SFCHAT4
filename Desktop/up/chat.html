<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>Premium Bottom Chat Overlay v2.0</title>
<style>
/* 
DELTA SUMMARY v2.0:
- Added localStorage persistence for all toggle settings
- Exposed window.ChatOverlayAPI with onSend, decorateChip, onToggle hooks
- Enhanced typing indicator with morphing animation
- Optimized particle system with object pooling (better performance)
- Added fade-in animation for initial load
- Improved suggestion rendering performance
- Added API event dispatching for plugin integration
*/

/* ---------- CSS VARIABLES / THEME ---------- */
:root{
  --bg: rgba(10,10,12,.72);
  --bg-2: rgba(16,16,20,.55);
  --stroke: rgba(255,255,255,.08);
  --glow: 0 0 32px rgba(180,200,255,.25);
  --text: #e9edf3;
  --muted: #a9b2c0;
  --accent: #7aa6ff;
  --accent-2: #9b7bff;
  --good: #5ee089;
  --warn: #ffd166;
  --bad:  #ff6b6b;
  --chip: rgba(255,255,255,.08);
  --chip-2: rgba(255,255,255,.14);
  --blur-1: saturate(1.1) blur(10px);
  --blur-2: brightness(1.05) blur(20px);
  --radius: 16px;
  --bezier-elastic: cubic-bezier(.2,.75,.2,1.2);
  --bezier-smooth: cubic-bezier(.22,.61,.36,1);
  --shadow: 0 10px 30px rgba(0,0,0,.35);
}
/* ---------- GLOBAL ---------- */
*{box-sizing:border-box}
html,body{background:#000;height:100%;margin:0;color:var(--text);font:400 14px/1.25 ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue","Noto Sans",Arial,"Apple Color Emoji","Segoe UI Emoji"}
/* ---------- BOTTOM OVERLAY (only visible UI) ---------- */
.chat-overlay{
  position:fixed;left:0;right:0;bottom:0;z-index:9999;
  padding:10px clamp(10px,2vw,24px);
  display:grid;grid-template-columns: 1fr auto;gap:10px;
  pointer-events:none;
  opacity:0;animation:fadeIn .4s var(--bezier-smooth) forwards;
}
@keyframes fadeIn{to{opacity:1}}
.chat-shell{
  pointer-events:auto;
  display:grid;grid-template-columns: 48px 1fr auto;gap:10px;
  align-items:center;
  background:linear-gradient(180deg, var(--bg), var(--bg-2));
  border:1px solid var(--stroke);
  border-bottom:1px solid rgba(255,255,255,.18);
  border-radius: calc(var(--radius) + 6px);
  padding:10px;
  -webkit-backdrop-filter: var(--blur-1);
  backdrop-filter: var(--blur-1);
  box-shadow: var(--shadow), var(--glow);
}
.chat-shell::after{
  content:"";position:absolute;inset:auto 0 -10px 0;height:30px;filter:blur(12px);
  background: radial-gradient(60% 40% at 50% 0%, rgba(120,140,255,.18), transparent 70%);
  pointer-events:none;
}
.avatar{
  position:relative;width:48px;height:48px;border-radius:14px;overflow:hidden;
  background: radial-gradient(120% 120% at 0% 100%, #1c2030, #0e1118);
  border:1px solid var(--stroke);
}
.avatar::after{
  content:"";position:absolute;inset:-20% -20% auto auto;width:120%;height:140%;
  background: conic-gradient(from 180deg at 50% 50%, rgba(120,140,255,.25), transparent 30%, rgba(160,120,255,.25), transparent 60%, rgba(120,140,255,.25));
  filter: blur(18px);opacity:.35;mix-blend:screen;animation:spin 9s linear infinite;
}
.status-dot{
  position:absolute;right:6px;bottom:6px;width:10px;height:10px;border-radius:50%;
  background:var(--good);box-shadow:0 0 14px rgba(94,224,137,.7), inset 0 0 6px rgba(255,255,255,.2);
  border:2px solid rgba(0,0,0,.6);
}
@keyframes spin{to{transform:rotate(360deg)}}
/* ---------- INPUT ---------- */
.input-wrap{
  position:relative;display:grid;grid-template-columns:1fr auto;gap:8px;align-items:end;
  background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
  border:1px solid var(--stroke);border-radius:14px;padding:8px;
  -webkit-backdrop-filter: var(--blur-2); backdrop-filter: var(--blur-2);
}
textarea.input{
  resize:none;overflow:hidden;max-height:38px;min-height:20px;
  background:transparent;border:0;color:var(--text);outline:none;padding:6px 8px 0 8px;
  font:500 14px/1.35 "Inter",-apple-system,system-ui,Segoe UI,Roboto,Arial;
  caret-color:var(--accent);
}
.controls{display:flex;align-items:center;gap:10px}
.btn{
  appearance:none;border:0;cursor:pointer;outline:none;
  padding:10px 14px;border-radius:12px;
  background:linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.06));
  border:1px solid var(--stroke);color:var(--text);
  transition:transform .2s var(--bezier-smooth), opacity .2s var(--bezier-smooth);
}
.btn:active{transform:scale(.98)}
.send-btn{font-weight:700}
.char-wrap{position:absolute;right:8px;bottom:8px;width:120px;height:4px;border-radius:6px;background:rgba(255,255,255,.08);overflow:hidden}
.char-bar{height:100%;width:0%;background:linear-gradient(90deg, var(--good), var(--warn), var(--bad));transition:width .16s linear}
.suggestions{
  position:absolute;left:8px;bottom:calc(100% + 8px);min-width:200px;max-width:min(60vw,480px);
  background:linear-gradient(180deg, rgba(20,22,28,.95), rgba(16,18,24,.9));
  border:1px solid var(--stroke);border-radius:12px;overflow:hidden;
  transform-origin: left bottom;opacity:0;transform: translateY(6px) scale(.98);
  pointer-events:none;transition: all .22s var(--bezier-smooth);
  -webkit-backdrop-filter: var(--blur-1); backdrop-filter: var(--blur-1);
}
.suggestions.active{opacity:1;transform: translateY(0) scale(1);pointer-events:auto}
.suggestion{padding:10px 12px;color:var(--muted);cursor:pointer}
.suggestion:hover{background:rgba(255,255,255,.06);color:var(--text)}
.typing-indicator{
  position:absolute;left:12px;bottom:8px;display:flex;gap:4px;align-items:center;opacity:.8
}
.typing-dot{
  width:6px;height:6px;border-radius:50%;background:var(--accent);
  filter:drop-shadow(0 0 6px rgba(122,166,255,.7));animation:td 1.2s ease-in-out infinite;
  transform-origin:center;
}
.typing-dot:nth-child(2){animation-delay:.15s}.typing-dot:nth-child(3){animation-delay:.3s}
@keyframes td{
  0%,60%,100%{transform:translateY(0) scale(1)}
  30%{transform:translateY(-4px) scale(1.2)}
}
/* ---------- TOOLBAR & SETTINGS ---------- */
.toolbar{
  display:flex;gap:8px;align-items:center;justify-content:flex-end
}
.tool{
  width:40px;height:40px;border-radius:12px;border:1px solid var(--stroke);
  background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
  display:grid;place-items:center;cursor:pointer;transition:transform .2s var(--bezier-smooth)
}
.tool:active{transform:scale(.96)}
.settings-panel{
  position:fixed;right:12px;bottom:74px;width:min(360px,92vw);
  background:linear-gradient(180deg, rgba(24,26,34,.92), rgba(18,20,28,.9));
  border:1px solid var(--stroke);border-radius:14px;padding:12px;display:none;gap:10px;
  -webkit-backdrop-filter: var(--blur-1); backdrop-filter: var(--blur-1);
  box-shadow: var(--shadow);
}
.settings-panel.active{display:grid;animation:pop .2s var(--bezier-elastic)}
@keyframes pop{from{opacity:0;transform:translateY(6px) scale(.98)}to{opacity:1;transform:none}}
.row{display:flex;align-items:center;justify-content:space-between;gap:10px}
.switch{accent-color:var(--accent)}
/* ---------- MESSAGE TRACK (single-line) ---------- */
.track-wrap{
  position:fixed;left:0;right:0;bottom:64px;pointer-events:none;
}
.track{
  position:relative;height:42px;overflow:visible;contain:layout paint style;
}
.msg{
  position:absolute;bottom:0;left:100%;transform:translate3d(0,0,0);
  padding:8px 12px;border-radius:999px;border:1px solid var(--stroke);
  background:linear-gradient(180deg, var(--chip), var(--chip-2));
  color:var(--text);white-space:nowrap;font-weight:600;user-select:none;
  box-shadow:0 6px 18px rgba(0,0,0,.35);
  will-change: transform, opacity;
}
.msg[data-tone="pos"]{border-color:rgba(94,224,137,.4);box-shadow:0 6px 22px rgba(94,224,137,.18)}
.msg[data-tone="neg"]{border-color:rgba(255,107,107,.35);box-shadow:0 6px 22px rgba(255,107,107,.16)}
/* ---------- CANVAS (particles + waveform) ---------- */
#fx{position:fixed;left:0;right:0;bottom:0;height:120px;pointer-events:none;mix-blend:screen;opacity:.9}
/* ---------- ACCESSIBILITY HIDDEN ---------- */
.sr{position:absolute;width:1px;height:1px;clip:rect(0 0 0 0);clip-path:inset(50%);overflow:hidden;white-space:nowrap}
@media (max-width:480px){
  .chat-shell{grid-template-columns:40px 1fr auto}
  .avatar{width:40px;height:40px}
  .track{height:36px}
}
</style>
</head>
<body>
<!-- bottom-only UI -->
<canvas id="fx" aria-hidden="true"></canvas>

<div class="track-wrap" aria-live="polite" aria-atomic="false">
  <div class="track" id="track"></div>
</div>

<div class="chat-overlay" role="group" aria-label="Live chat composer">
  <div class="chat-shell" aria-live="off">
    <div class="avatar" aria-hidden="true"><span class="status-dot" id="statusDot" title="Connected"></span></div>

    <div class="input-wrap" aria-label="Message input">
      <div class="typing-indicator" id="typing" aria-hidden="true">
        <span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-dot"></span>
      </div>
      <textarea id="input" class="input" rows="1" maxlength="280" aria-label="Type your message" placeholder="Say something magical‚Ä¶" autocomplete="off"></textarea>
      <div class="controls">
        <button class="btn send-btn" id="send" aria-label="Send message (Enter)">Send</button>
      </div>
      <div class="char-wrap"><div class="char-bar" id="charBar"></div></div>
      <div class="suggestions" id="suggestions" role="listbox" aria-label="Suggestions"></div>
    </div>

    <div class="toolbar" aria-label="Tools">
      <button class="tool" id="toggleSettings" aria-expanded="false" aria-controls="settings" title="Settings">‚öôÔ∏è</button>
      <button class="tool" id="mic" title="Sound Viz">üéôÔ∏è</button>
      <button class="tool" id="quality" title="Connection quality">üì∂</button>
    </div>
  </div>
</div>

<div class="settings-panel" id="settings" role="dialog" aria-modal="false" aria-label="Overlay settings">
  <div class="row"><span>High FX Mode</span><input type="checkbox" id="fxMode" class="switch"/></div>
  <div class="row"><span>Particle Trails</span><input type="checkbox" id="trailMode" class="switch"/></div>
  <div class="row"><span>Sentiment Tint</span><input type="checkbox" id="sentMode" class="switch"/></div>
  <div class="row"><span>Autocomplete</span><input type="checkbox" id="autoMode" class="switch"/></div>
</div>

<script>
(()=>{"use strict";

/** ---------------- Utils ---------------- */
const clamp=(v,min,max)=>Math.min(max,Math.max(min,v));
const lerp=(a,b,t)=>a+(b-a)*t;
const now=()=>performance.now();
const rnd=(a=1,b=0)=>Math.random()*(b-a)+a;
const badWords=/\b(fuck|shit|bitch|asshole|cunt|dick|prick)\b/ig;

/** Simple sentiment (lexicon-lite) */
const POS=["love","great","fire","awesome","amazing","yes","good","win","wow","üî•","üíñ","üéâ"];
const NEG=["hate","bad","angry","ugly","no","trash","fail","ugh","wtf","üíÄ","ü§¨","üëé"];
const sentiment=(t)=>{
  const s=t.toLowerCase();
  let score=0;
  POS.forEach(w=>{if(s.includes(w))score++});
  NEG.forEach(w=>{if(s.includes(w))score--});
  return score>0?"pos":score<0?"neg":"neu";
};
/** Profanity filter (soft) */
const sanitize=(t)=>t.replace(badWords,m=>m[0]+"‚Äß".repeat(Math.max(1,m.length-1)));

/** Predictive suggestions (context-aware-ish) */
const suggest = (t)=>{
  const base=[
    "üî• That drop was unreal",
    "Crowd is losing it right now",
    "Turn it up just a little",
    "Where my OGs at?",
    "This mix goes hard",
    "Request: classic SF anthem",
    "Vibes are immaculate ‚ú®",
  ];
  const s=t.trim().toLowerCase();
  if(!s) return base.slice(0,4);
  const pool=[];
  if(s.includes("where")) pool.push("Main floor is packed","Basement is spooky tonight");
  if(s.includes("drop")) pool.push("Next drop incoming‚Ä¶ hold tight","Build it, then smash it!");
  if(s.includes("sound")) pool.push("Sound is perfect here","Crank the subs!");
  if(!pool.length) pool.push(...base);
  return pool.slice(0,4);
};

/** ---------------- Storage & Settings Persistence ---------------- */
const STORAGE_KEY = "chatOverlaySettings";
const defaultSettings = {fxMode:true, trailMode:true, sentMode:true, autoMode:true};
let settings = {...defaultSettings};

function loadSettings(){
  try{
    const saved = localStorage.getItem(STORAGE_KEY);
    if(saved) settings = {...defaultSettings, ...JSON.parse(saved)};
  }catch(e){ console.warn("Failed to load settings",e); }
}
function saveSettings(){
  try{
    localStorage.setItem(STORAGE_KEY, JSON.stringify(settings));
  }catch(e){ console.warn("Failed to save settings",e); }
}

/** ---------------- Plugin API ---------------- */
const callbacks = { onSend:[], decorateChip:[], onToggle:[] };
window.ChatOverlayAPI = {
  onSend(cb){ callbacks.onSend.push(cb); },
  decorateChip(cb){ callbacks.decorateChip.push(cb); },
  onToggle(cb){ callbacks.onToggle.push(cb); },
  getSettings(){ return {...settings}; },
  sendMessage(text,tone="neu"){ if(text) addChip(sanitize(text).slice(0,280), tone); },
  _dispatch(event, data){ 
    callbacks[event]?.forEach(cb=>{ try{cb(data);}catch(e){console.error(`API callback error:`,e);} });
  }
};

/** ---------------- DOM ---------------- */
const input = document.getElementById("input");
const sendBtn = document.getElementById("send");
const charBar = document.getElementById("charBar");
const suggBox = document.getElementById("suggestions");
const typing = document.getElementById("typing");
const track = document.getElementById("track");
const fxCanvas = document.getElementById("fx");
const ctx = fxCanvas.getContext("2d",{alpha:true,desynchronized:true});
const toggleSettings = document.getElementById("toggleSettings");
const settingsPanel = document.getElementById("settings");
const statusDot = document.getElementById("statusDot");

const fxMode = document.getElementById("fxMode");
const trailMode = document.getElementById("trailMode");
const sentMode = document.getElementById("sentMode");
const autoMode = document.getElementById("autoMode");

/** ---------------- Resize / DPR ---------------- */
let W=0,H=0, DPR=1;
function resize(){
  const rect = fxCanvas.getBoundingClientRect();
  W = Math.max(320, innerWidth);
  H = rect.height || 120;
  DPR = clamp(Math.round(devicePixelRatio||1),1,3);
  fxCanvas.width = W*DPR; fxCanvas.height = H*DPR;
  fxCanvas.style.height = H+"px"; fxCanvas.style.width = "100%";
  ctx.setTransform(DPR,0,0,DPR,0,0);
}
addEventListener("resize",()=>{resize()}); resize();

/** ---------------- Particle System with Object Pooling ---------------- */
const particles=[];
const particlePool=[];
const MAX_PARTICLES=150;

function getParticle(){
  return particlePool.pop() || {x:0,y:0,vx:0,vy:0,life:0,born:0,size:0,color:"",trail:[]};
}
function recycleParticle(p){
  p.trail.length=0;
  if(particlePool.length<50) particlePool.push(p);
}
function spawnBurst(x,y,color,count=16,vel=1.2){
  count = Math.min(count, MAX_PARTICLES - particles.length);
  for(let i=0;i<count;i++){
    const p = getParticle();
    const angle = i/count*2*Math.PI+rnd(0,.8);
    Object.assign(p,{
      x, y, vx: Math.cos(angle)*rnd(.6,1.6)*vel,
      vy: Math.sin(angle)*rnd(.6,1.6)*vel - rnd(.3,1.2),
      life: rnd(600,1200), born: now(), size: rnd(1.5,3.6), color
    });
    p.trail.length=0;
    particles.push(p);
  }
}
function stepParticles(dt){
  const g=0.0018*dt;
  for(let i=particles.length-1;i>=0;i--){
    const p=particles[i];
    if(settings.trailMode){
      p.trail.length>22 && p.trail.shift();
      p.trail.push({x:p.x,y:p.y, t: now()});
    }
    p.vy += g;
    p.x += p.vx*dt*.06;
    p.y += p.vy*dt*.06;
    if(now()-p.born>p.life){
      recycleParticle(particles.splice(i,1)[0]);
    }
  }
}
function drawParticles(){
  if(!settings.fxMode){ctx.clearRect(0,0,W,H);return;}
  ctx.clearRect(0,0,W,H);
  for(const p of particles){
    const age = (now()-p.born)/p.life;
    const alpha = 1-Math.min(1,age);
    if(settings.trailMode && p.trail.length>1){
      ctx.globalAlpha = Math.max(0,alpha*.6);
      ctx.beginPath();
      for(let i=p.trail.length-1;i>=0;i--){
        const tr=p.trail[i];
        ctx.lineTo(tr.x, tr.y);
      }
      ctx.strokeStyle = p.color; ctx.lineWidth = 1.2; ctx.stroke();
    }
    ctx.globalAlpha = Math.max(0,alpha);
    ctx.beginPath();
    ctx.arc(p.x,p.y,p.size,0,Math.PI*2);
    ctx.fillStyle = p.color; ctx.fill();
  }
  ctx.globalAlpha=1;
}

/** ---------------- Message Track Physics ---------------- */
const styles=["spiral","wave","bounce","twist","fade","explode","morph"];
const chips=[];
function addChip(text,tone="neu"){
  // API hook: decorateChip
  let finalText = text;
  let finalTone = tone;
  window.ChatOverlayAPI._dispatch("decorateChip", {text:finalText, tone:finalTone, modify:(t,tn)=>{finalText=t;finalTone=tn;}});
  
  const el=document.createElement("div");
  el.className="msg"; el.textContent=finalText; el.setAttribute("data-tone",finalTone);
  track.appendChild(el);
  const speed = rnd(0.22,0.36);
  const style = styles[Math.floor(rnd(0,styles.length))];
  const rot = rnd(15,45)*(Math.random()<.5?-1:1);
  const amp = rnd(8,18);
  const born = now();
  const y0 = 0;
  const chip = {el, x: innerWidth + rnd(0,60), y: y0, vx: -speed, vy:0, rot, amp, style, born, tone:finalTone, removed:false, text:finalText};
  chips.push(chip);
  
  // launch particles
  const rect = el.getBoundingClientRect();
  spawnBurst(clamp(rect.left+rect.width/2, 0, innerWidth), rnd(10, H-10), finalTone==="pos"?"#5ee089":finalTone==="neg"?"#ff6b6b":"#9fb3ff", 18, 1.4);
  
  // API hook: onSend
  window.ChatOverlayAPI._dispatch("onSend", {text:finalText, tone:finalTone, chip});
}
function stepChips(dt){
  for(let i=chips.length-1;i>=0;i--){
    const c=chips[i];
    c.x += c.vx*dt*60;
    const t=(now()-c.born)/1000;
    let offY=0, r=0, s=1;
    switch(c.style){
      case "spiral": offY = Math.sin(t*3.2)*c.amp * (1/(1+.4*t)); r = c.rot*Math.sin(t*2); break;
      case "wave": offY = Math.sin(t*6.0)*c.amp; r = c.rot*.2*Math.sin(t*4); break;
      case "bounce": offY = Math.abs(Math.sin(t*5))*c.amp; r = c.rot*.15; break;
      case "twist": r = c.rot*Math.sin(t*5.4); offY = Math.cos(t*7)*c.amp*.6; break;
      case "fade": offY = 0; r = 0; s = Math.max(.85,1 - t*.08); break;
      case "explode": offY = Math.sin(t*10)*c.amp*(1/(1+t)); r = c.rot*(1/(1+.6*t)); break;
      case "morph": offY = Math.sin(t*4)*c.amp*(1/(1+.2*t)); r=c.rot*.3*Math.cos(t*3);
    }
    c.el.style.transform = `translate3d(${c.x}px, ${offY}px, 0) rotate(${r}deg) scale(${s})`;
    const life = 5_000;
    const age = now()-c.born;
    c.el.style.opacity = String(1 - Math.min(1, age/life));
    if(c.x < - (c.el.offsetWidth+40) || age>life){ c.removed=true; c.el.remove(); chips.splice(i,1); }
  }
}

/** ---------------- Autocomplete & UI ---------------- */
let lastInputTs=0, typingOn=false, suggSel=-1;
let morphPhase=0;
function updateChar(){
  const pct = (input.value.length/280)*100;
  charBar.style.width = pct+"%";
}
function autoResize(){
  input.style.height = "auto";
  input.style.height = Math.min(input.scrollHeight, 38) + "px";
}
function renderSuggestions(){
  if(!settings.autoMode){suggBox.classList.remove("active");return;}
  const list = suggest(input.value);
  const html = list.map((s,i)=>`<div role="option" class="suggestion" data-i="${i}">${s}</div>`).join("");
  if(suggBox.innerHTML !== html) suggBox.innerHTML = html;
  suggSel=-1;
  if(list.length){suggBox.classList.add("active");} else {suggBox.classList.remove("active");}
}
suggBox.addEventListener("mousedown",(e)=>{
  const it=e.target.closest(".suggestion"); if(!it) return;
  input.value = (input.value.trim()+" "+it.textContent).trim().slice(0,280);
  updateChar(); autoResize(); suggBox.classList.remove("active"); input.focus();
});

/** ---------------- Send Logic ---------------- */
function analyzeTone(t){ return settings.sentMode ? sentiment(t) : "neu"; }
function send(){
  const raw = input.value.replace(/\s+/g," ").trim();
  if(!raw) return;
  const safe = sanitize(raw).slice(0,280);
  const tone = analyzeTone(safe);
  addChip(safe, tone);
  input.value=""; updateChar(); autoResize(); renderSuggestions();
}
sendBtn.addEventListener("click", send);
input.addEventListener("keydown",(e)=>{
  if(e.key==="Enter" && !e.shiftKey){ e.preventDefault(); send(); }
  if(e.key==="ArrowDown" && suggBox.classList.contains("active")){
    const items=[...suggBox.children]; suggSel = (suggSel+1)%items.length; items.forEach((n,i)=>n.style.background=i===suggSel?"rgba(255,255,255,.08)":"" );
  }
  if(e.key==="ArrowUp" && suggBox.classList.contains("active")){
    const items=[...suggBox.children]; suggSel = (suggSel-1+items.length)%items.length; items.forEach((n,i)=>n.style.background=i===suggSel?"rgba(255,255,255,.08)":"" );
  }
  if(e.key==="Tab" && suggBox.classList.contains("active")){
    e.preventDefault();
    const it=suggBox.children[suggSel>=0?suggSel:0]; if(it){ input.value=(input.value.trim()+" "+it.textContent).trim().slice(0,280); updateChar(); autoResize(); suggBox.classList.remove("active");}
  }
});
input.addEventListener("input",()=>{
  updateChar(); autoResize(); renderSuggestions();
  lastInputTs = now();
  if(!typingOn){ typingOn=true; typing.style.opacity=1; }
});

/** ---------------- Enhanced Typing Indicator ---------------- */
setInterval(()=>{
  if(typingOn && now()-lastInputTs>600){ typingOn=false; typing.style.opacity=.0; }
  if(typingOn){
    morphPhase += 0.1;
    const dots = typing.querySelectorAll(".typing-dot");
    dots.forEach((d,i)=>{
      const morph = Math.sin(morphPhase + i*0.5)*0.15 + 1;
      d.style.transform = `scale(${morph})`;
    });
  }
}, 50);

/** ---------------- Settings & Persistence ---------------- */
function initSettings(){
  loadSettings();
  fxMode.checked = settings.fxMode;
  trailMode.checked = settings.trailMode;
  sentMode.checked = settings.sentMode;
  autoMode.checked = settings.autoMode;
  
  // attach listeners
  [fxMode,trailMode,sentMode,autoMode].forEach(el=>{
    el.addEventListener("change",()=>{
      const key = el.id;
      settings[key] = el.checked;
      saveSettings();
      window.ChatOverlayAPI._dispatch("onToggle", {setting:key, value:el.checked});
    });
  });
}

toggleSettings.addEventListener("click",()=>{
  const open=!settingsPanel.classList.contains("active");
  settingsPanel.classList.toggle("active",open);
  toggleSettings.setAttribute("aria-expanded", String(open));
});
document.getElementById("quality").addEventListener("click",()=>{
  statusDot.animate([{transform:"scale(1)"},{transform:"scale(1.3)"}],{duration:250,iterations:2});
});
document.getElementById("mic").addEventListener("click",()=>{
  spawnBurst(rnd(40,W-40), rnd(20,H-20), "#9fb3ff", 24, 2.0);
});

/** ---------------- Main Loop ---------------- */
let last = now();
function frame(){
  const t=now(); const dt = t-last; last=t;
  stepParticles(dt);
  stepChips(dt);
  drawParticles();
  requestAnimationFrame(frame);
}
requestAnimationFrame(frame);

/** ---------------- Init & Demo ---------------- */
initSettings();
setTimeout(()=>addChip("Welcome to the stream ‚ú®","pos"), 400);
setTimeout(()=>addChip("Keep it respectful in chat","neu"), 1200);

/** ---------------- Accessibility: SR announce ---------------- */
const sr = document.createElement("div"); sr.className="sr"; sr.setAttribute("aria-live","polite"); document.body.appendChild(sr);
const announce=(msg)=>{ sr.textContent=msg; };
const origAdd = addChip;
addChip = function(text,tone){ origAdd(text,tone); announce("Message sent: "+text); };

})();</script>
</body>
</html>