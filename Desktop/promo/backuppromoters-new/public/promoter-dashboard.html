<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Team Member Dashboard - Sound Factory</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #000;
            color: #fff;
            line-height: 1.6;
        }
        
        .hero {
            background: linear-gradient(135deg, #1a0000 0%, #0a0000 50%, #1a0a00 100%);
            padding: 40px 20px;
            text-align: center;
            border-bottom: 3px solid #ff6600;
        }
        
        .hero img {
            width: 100px;
            height: 100px;
            margin-bottom: 15px;
            filter: drop-shadow(0 0 20px rgba(255, 100, 0, 0.6));
        }
        
        .hero h1 {
            font-size: clamp(28px, 6vw, 48px);
            color: #ff6600;
            text-shadow: 0 0 30px rgba(255, 100, 0, 0.8);
            margin-bottom: 8px;
        }
        
        .hero p {
            font-size: clamp(14px, 2.5vw, 18px);
            color: #ccc;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 40px 20px;
        }
        
        .welcome-section {
            background: rgba(255, 100, 0, 0.05);
            border: 2px solid rgba(255, 100, 0, 0.3);
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .welcome-section h2 {
            color: #ff6600;
            font-size: 28px;
            margin-bottom: 15px;
        }
        
        .welcome-section p {
            color: #ccc;
            font-size: 16px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }
        
        .stat-card {
            background: rgba(10, 10, 10, 0.9);
            border: 2px solid rgba(255, 100, 0, 0.4);
            border-radius: 16px;
            padding: 25px;
            text-align: center;
            transition: all 0.3s;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            border-color: #ff6600;
            box-shadow: 0 10px 30px rgba(255, 100, 0, 0.4);
        }
        
        .stat-card .icon {
            font-size: 36px;
            margin-bottom: 10px;
        }
        
        .stat-card .value {
            font-size: 42px;
            font-weight: 900;
            color: #00ff88;
            margin-bottom: 8px;
        }
        
        .stat-card .label {
            color: #ccc;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .link-section {
            background: rgba(0, 255, 136, 0.05);
            border: 2px solid rgba(0, 255, 136, 0.3);
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 30px;
        }
        
        .link-section h3 {
            color: #00ff88;
            font-size: 24px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .link-box {
            display: flex;
            gap: 10px;
            align-items: center;
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid #00ff88;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .link-box input {
            flex: 1;
            background: transparent;
            border: none;
            color: #fff;
            font-size: 14px;
            font-family: 'Courier New', monospace;
            outline: none;
        }
        
        .link-box button {
            padding: 10px 24px;
            background: linear-gradient(135deg, #00ff88, #00cc70);
            border: none;
            border-radius: 8px;
            color: #000;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .link-box button:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 20px rgba(0, 255, 136, 0.4);
        }
        
        .breakdown-section {
            margin-top: 40px;
        }
        
        .breakdown-section h3 {
            color: #ff6600;
            font-size: 32px;
            margin-bottom: 25px;
            text-align: center;
            text-shadow: 0 0 20px rgba(255, 100, 0, 0.6);
        }
        
        .breakdown-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
        }
        
        .breakdown-card {
            background: rgba(10, 10, 10, 0.9);
            border: 2px solid rgba(255, 100, 0, 0.3);
            border-radius: 16px;
            padding: 25px;
        }
        
        .breakdown-card h4 {
            color: #ff6600;
            font-size: 20px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .breakdown-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .breakdown-item:last-child {
            border-bottom: none;
        }
        
        .breakdown-item .label {
            color: #ccc;
            font-size: 14px;
        }
        
        .breakdown-item .value {
            color: #00ff88;
            font-weight: 700;
            font-size: 16px;
        }
        
        .tips-section {
            background: rgba(139, 0, 139, 0.1);
            border: 2px solid rgba(139, 0, 139, 0.4);
            border-radius: 16px;
            padding: 30px;
            margin-top: 40px;
        }
        
        .tips-section h3 {
            color: #8b008b;
            font-size: 24px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .tips-section ul {
            list-style: none;
            color: #ccc;
        }
        
        .tips-section li {
            padding: 10px 0;
            padding-left: 30px;
            position: relative;
        }
        
        .tips-section li:before {
            content: '✨';
            position: absolute;
            left: 0;
        }
        
        .refresh-info {
            text-align: center;
            color: #666;
            font-size: 13px;
            margin-top: 30px;
        }
        
        @media (max-width: 768px) {
            .stats-grid { grid-template-columns: 1fr; }
            .breakdown-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <!-- Login Required Overlay -->
    <div id="loginRequired" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: #000; z-index: 9999; overflow-y: auto;">
        <div style="max-width: 1200px; margin: 0 auto; padding: 40px 20px; text-align: center;">
            <img src="/sf-logo.png" alt="Sound Factory" style="width: 100px; height: 100px; margin-bottom: 30px; filter: drop-shadow(0 0 20px rgba(255, 100, 0, 0.6));">
            <h1 style="color: #ff6600; font-size: 36px; margin-bottom: 16px;">🔒 Team Member Dashboard</h1>
            <p style="color: #ccc; font-size: 18px; margin-bottom: 40px;">SMS Login Required to Access</p>
            
            <!-- Dashboard Preview Image -->
            <div style="background: rgba(255, 100, 0, 0.1); border: 2px solid rgba(255, 100, 0, 0.3); border-radius: 16px; padding: 40px; margin-bottom: 40px;">
                <h2 style="color: #ff6600; margin-bottom: 20px;">📊 Preview: What You'll See Inside</h2>
                <p style="color: #999; margin-bottom: 30px;">This is what your dashboard looks like after you log in:</p>
                
                <!-- Preview placeholder - you can replace with actual screenshot -->
                <div style="background: #0a0a0a; border: 1px solid #333; border-radius: 12px; padding: 60px 20px; color: #666; font-size: 14px;">
                    <div style="margin-bottom: 30px;">
                        <div style="color: #ff6600; font-size: 48px; font-weight: 700; margin-bottom: 10px;">📈</div>
                        <div style="color: #ccc; font-size: 18px; margin-bottom: 20px;">Your Stats Dashboard</div>
                        <div style="color: #666;">• Track ticket sales in real-time</div>
                        <div style="color: #666;">• View your commission earnings</div>
                        <div style="color: #666;">• Access your unique referral link</div>
                        <div style="color: #666;">• Monitor your performance tier</div>
                    </div>
                </div>
            </div>
            
            <a href="/promoter-login.html" style="display: inline-block; padding: 16px 48px; background: linear-gradient(135deg, #ff6600 0%, #ff9933 100%); color: #fff; text-decoration: none; border-radius: 8px; font-size: 18px; font-weight: 700; margin-bottom: 20px;">
                Login with SMS →
            </a>
            
            <div style="margin-top: 20px;">
                <a href="/promoter-signup.html" style="color: #ff6600; text-decoration: none;">Don't have an account? Sign up</a>
            </div>
        </div>
    </div>
    
    <!-- Actual Dashboard (hidden until logged in) -->
    <div id="actualDashboard" style="display: none;">
    <div class="hero">
        <img src="/sf-logo.png" alt="Sound Factory">
        <h1>Team Member Dashboard</h1>
        <p>Track Your Performance & Earnings</p>
    </div>

    <div class="container">
        <!-- Welcome Section -->
        <div class="welcome-section">
            <h2>Welcome, <span id="memberName">Team Member</span>! 🎉</h2>
            <p id="memberCode">Your Code: Loading...</p>
        </div>

        <!-- Stats Grid -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="icon">🎫</div>
                <div class="value" id="ticketsSold">0</div>
                <div class="label">Tickets Sold</div>
            </div>
            
            <div class="stat-card">
                <div class="icon">🍾</div>
                <div class="value" id="tablesSold">0</div>
                <div class="label">Tables Sold</div>
            </div>
            
            <div class="stat-card">
                <div class="icon">👥</div>
                <div class="value" id="totalCustomers">0</div>
                <div class="label">Total Customers</div>
            </div>
            
            <div class="stat-card">
                <div class="icon">💰</div>
                <div class="value">$<span id="totalCommission">0.00</span></div>
                <div class="label">Total Earned</div>
            </div>
        </div>

        <!-- Referral Link Section -->
        <div class="link-section">
            <h3>🔗 Your Referral Link</h3>
            <div class="link-box">
                <input type="text" id="referralLink" readonly value="Loading...">
                <button onclick="copyLink()">📋 Copy</button>
            </div>
            <p style="text-align: center; color: #999; font-size: 14px; margin-top: 10px;">
                Share on Instagram, Twitter, WhatsApp, SMS & more
            </p>
        </div>

        <!-- Sales Breakdown -->
        <div class="breakdown-section">
            <h3>📊 Sales Breakdown</h3>
            
            <div class="breakdown-grid">
                <!-- Ticket Sales -->
                <div class="breakdown-card">
                    <h4>🎫 Ticket Sales</h4>
                    <div class="breakdown-item">
                        <span class="label">Member Tickets ($50)</span>
                        <span class="value" id="memberTickets">0</span>
                    </div>
                    <div class="breakdown-item">
                        <span class="label">Commission per Ticket</span>
                        <span class="value">$10</span>
                    </div>
                    <div class="breakdown-item">
                        <span class="label">Total from Tickets</span>
                        <span class="value">$<span id="ticketCommission">0.00</span></span>
                    </div>
                </div>

                <!-- Table Sales -->
                <div class="breakdown-card">
                    <h4>🍾 VIP Table Sales</h4>
                    <div class="breakdown-item">
                        <span class="label">Tables Sold</span>
                        <span class="value" id="tablesCount">0</span>
                    </div>
                    <div class="breakdown-item">
                        <span class="label">Table Revenue</span>
                        <span class="value">$<span id="tableRevenue">0.00</span></span>
                    </div>
                    <div class="breakdown-item">
                        <span class="label">Commission (20%)</span>
                        <span class="value">$<span id="tableCommission">0.00</span></span>
                    </div>
                </div>

                <!-- Performance -->
                <div class="breakdown-card">
                    <h4>🏆 Performance</h4>
                    <div class="breakdown-item">
                        <span class="label">Conversion Rate</span>
                        <span class="value"><span id="conversionRate">0</span>%</span>
                    </div>
                    <div class="breakdown-item">
                        <span class="label">Average Sale</span>
                        <span class="value">$<span id="avgSale">0.00</span></span>
                    </div>
                    <div class="breakdown-item">
                        <span class="label">Current Tier</span>
                        <span class="value" id="currentTier">Starter</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tips Section -->
        <div class="tips-section">
            <h3>💡 Maximize Your Earnings</h3>
            <ul>
                <li>Share your link on Instagram Stories with a swipe-up or link sticker</li>
                <li>Post in WhatsApp groups and send direct messages to friends</li>
                <li>Create TikTok or Reels content about the event with your link in bio</li>
                <li>Email your list or text your contacts with the exclusive offer</li>
                <li>Sell 50+ tickets/month to unlock Gold Tier ($12 per ticket!)</li>
                <li>VIP tables earn you 20% commission - that's up to $480 per table!</li>
            </ul>
        </div>

        <div class="refresh-info">
            🔄 Dashboard auto-refreshes every 30 seconds | Last updated: <span id="lastUpdate">--:--</span>
        </div>
    </div>

    <script>
        // Get promo code from URL
        const urlParams = new URLSearchParams(window.location.search);
        const promoCode = urlParams.get('code') || urlParams.get('promo');
        
        if (!promoCode) {
            alert('No promo code in URL. Example: ?code=SFABC123');
            location.href = 'promoter-signup.html';
        }

        // Update last update time
        function updateTime() {
            const now = new Date();
            document.getElementById('lastUpdate').textContent = now.toLocaleTimeString();
        }

        // Copy link function
        function copyLink() {
            const link = document.getElementById('referralLink');
            link.select();
            navigator.clipboard.writeText(link.value);
            
            const btn = event.target;
            const originalText = btn.textContent;
            btn.textContent = '✅ Copied!';
            setTimeout(() => {
                btn.textContent = originalText;
            }, 2000);
        }

        // Load dashboard data
        async function loadDashboard() {
            try {
                const response = await fetch(`/api/promoter/${promoCode}`);
                const data = await response.json();
                
                if (data.error) {
                    alert(data.error);
                    return;
                }
                
                // Update basic info
                document.getElementById('memberName').textContent = data.name || 'Team Member';
                document.getElementById('memberCode').textContent = `Your Code: ${promoCode}`;
                
                // Update stats
                document.getElementById('ticketsSold').textContent = data.ticketsSold || 0;
                document.getElementById('tablesSold').textContent = data.tablesSold || 0;
                document.getElementById('totalCustomers').textContent = (data.ticketsSold || 0) + (data.tablesSold || 0);
                document.getElementById('totalCommission').textContent = data.commissionEarned || '0.00';
                
                // Update ticket breakdown
                document.getElementById('memberTickets').textContent = data.ticketsSold || 0;
                const ticketComm = (data.ticketsSold || 0) * 10;
                document.getElementById('ticketCommission').textContent = ticketComm.toFixed(2);
                
                // Update table breakdown
                document.getElementById('tablesCount').textContent = data.tablesSold || 0;
                document.getElementById('tableRevenue').textContent = data.tableRevenue || '0.00';
                document.getElementById('tableCommission').textContent = data.tableCommission || '0.00';
                
                // Update performance metrics
                const totalSales = (data.ticketsSold || 0) + (data.tablesSold || 0);
                const conversionRate = data.pageViews > 0 ? ((totalSales / data.pageViews) * 100).toFixed(1) : 0;
                document.getElementById('conversionRate').textContent = conversionRate;
                
                const avgSale = totalSales > 0 ? (parseFloat(data.commissionEarned || 0) / totalSales * 5).toFixed(2) : '0.00';
                document.getElementById('avgSale').textContent = avgSale;
                
                // Determine tier
                const tickets = data.ticketsSold || 0;
                let tier = 'Starter';
                if (tickets >= 100) tier = '💎 Platinum';
                else if (tickets >= 51) tier = '🌟 Gold';
                document.getElementById('currentTier').textContent = tier;
                
                // Update referral link with promo code and name
                const baseUrl = window.location.origin;
                const encodedName = encodeURIComponent(data.name);
                const referralLink = `${baseUrl}/team-tickets-tables.html?promo=${promoCode}&name=${encodedName}`;
                document.getElementById('referralLink').value = referralLink;
                
                // Update time
                updateTime();
                
            } catch (error) {
                console.error('Error loading dashboard:', error);
            }
        }

        // Initial load
        loadDashboard();
        
        // Auto-refresh every 30 seconds
        setInterval(loadDashboard, 30000);
    </script>
    </div>
    <!-- End actualDashboard -->
    
    <!-- Session Check Script -->
    <script>
        // Check for valid session on page load
        async function checkSession() {
            const sessionToken = localStorage.getItem('sf_session_token');
            
            if (!sessionToken) {
                // No session - show login required
                document.getElementById('loginRequired').style.display = 'block';
                document.getElementById('actualDashboard').style.display = 'none';
                return;
            }
            
            try {
                // Validate session with backend
                const response = await fetch('/.netlify/functions/validate-session', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sessionToken })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.valid) {
                        // Valid session - show actual dashboard
                        document.getElementById('loginRequired').style.display = 'none';
                        document.getElementById('actualDashboard').style.display = 'block';
                        return;
                    }
                }
                
                // Invalid or expired session
                localStorage.removeItem('sf_session_token');
                localStorage.removeItem('sf_promo_code');
                document.getElementById('loginRequired').style.display = 'block';
                document.getElementById('actualDashboard').style.display = 'none';
                
            } catch (error) {
                console.error('Session check error:', error);
                document.getElementById('loginRequired').style.display = 'block';
                document.getElementById('actualDashboard').style.display = 'none';
            }
        }
        
        // Run session check immediately
        checkSession();
    </script>
</body>
</html>
