<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Team Login - Sound Factory</title>
<meta name="color-scheme" content="dark" />
<style>
:root{
  --bg:#000;
  --surface:#0a0a0a;
  --border:rgba(255,255,255,0.08);
  --text:#fff;
  --muted:#999;
  --accent:#fff;
}
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;margin:0;padding:0}
body{
  background:#000;
  color:#fff;
  font-family:-apple-system,BlinkMacSystemFont,"SF Pro Display","Segoe UI",Roboto,Helvetica,Arial,sans-serif;
  display:flex;
  align-items:center;
  justify-content:center;
  min-height:100vh;
  padding:20px;
}

.container{
  width:100%;
  max-width:400px;
  animation:fadeIn 0.4s ease;
}

@keyframes fadeIn{
  from{opacity:0;transform:translateY(10px)}
  to{opacity:1;transform:translateY(0)}
}

/* Header */
.header{
  text-align:center;
  margin-bottom:32px;
}

.logo-wrapper{
  margin:0 auto 24px;
  display:flex;
  justify-content:center;
}

.logo{
  width:72px;
  height:72px;
  object-fit:contain;
}

h1{
  font-size:28px;
  font-weight:700;
  margin-bottom:8px;
  letter-spacing:-0.5px;
}

.subtitle{
  color:#999;
  font-size:15px;
}

/* Main Card */
.main-card{
  background:#0a0a0a;
  border:1px solid var(--border);
  border-radius:16px;
  padding:32px;
  backdrop-filter:blur(20px);
}

/* Status Messages */
.status-message{
  background:rgba(76,175,80,0.1);
  border:1px solid rgba(76,175,80,0.2);
  color:#4CAF50;
  padding:12px;
  border-radius:8px;
  font-size:13px;
  margin-bottom:20px;
  text-align:center;
  line-height:1.5;
}

.status-message.warning{
  background:rgba(255,193,7,0.1);
  border:1px solid rgba(255,193,7,0.2);
  color:#FFC107;
}

/* Form */
.form-group{
  margin-bottom:20px;
}

label{
  display:block;
  font-size:12px;
  font-weight:600;
  margin-bottom:8px;
  color:#aaa;
  text-transform:uppercase;
  letter-spacing:0.5px;
}

input{
  width:100%;
  padding:12px 14px;
  border-radius:8px;
  background:#000;
  border:1px solid var(--border);
  color:#fff;
  font-size:15px;
  transition:all 0.2s;
}

input:focus{
  outline:none;
  border-color:rgba(255,255,255,0.3);
  background:#050505;
}

input::placeholder{
  color:#555;
}

/* Verification Code Input */
.code-input-group{
  display:flex;
  gap:8px;
  justify-content:center;
  margin:24px 0;
}

.code-input{
  width:48px;
  height:56px;
  text-align:center;
  font-size:24px;
  font-weight:600;
  border-radius:8px;
  background:#000;
  border:1px solid var(--border);
  color:#fff;
  transition:all 0.2s;
}

.code-input:focus{
  border-color:rgba(255,255,255,0.5);
  background:#050505;
}

/* Buttons */
.btn{
  width:100%;
  padding:14px;
  border-radius:8px;
  background:#fff;
  color:#000;
  border:none;
  font-size:15px;
  font-weight:600;
  cursor:pointer;
  transition:all 0.2s;
  margin-bottom:12px;
}

.btn:hover:not(:disabled){
  background:#f0f0f0;
  transform:translateY(-1px);
}

.btn:disabled{
  opacity:0.5;
  cursor:not-allowed;
}

.btn-secondary{
  background:transparent;
  color:#fff;
  border:1px solid var(--border);
}

.btn-secondary:hover{
  background:rgba(255,255,255,0.05);
}

.btn-text{
  background:transparent;
  border:none;
  color:#666;
  font-size:13px;
  padding:8px;
  text-decoration:none;
  display:inline-block;
  transition:color 0.2s;
}

.btn-text:hover{
  color:#fff;
}

/* Loading */
.loading{
  display:inline-block;
  width:14px;
  height:14px;
  border:2px solid #000;
  border-radius:50%;
  border-top-color:transparent;
  animation:spin 0.8s linear infinite;
  margin-right:8px;
}

@keyframes spin{
  to{transform:rotate(360deg)}
}

/* Messages */
.error{
  background:rgba(255,0,0,0.1);
  border:1px solid rgba(255,0,0,0.2);
  color:#ff6b6b;
  padding:10px;
  border-radius:6px;
  font-size:13px;
  margin-top:12px;
  text-align:center;
}

.info-text{
  color:#666;
  font-size:13px;
  text-align:center;
  margin:16px 0;
}

/* Footer */
.footer-links{
  text-align:center;
  margin-top:24px;
  padding-top:24px;
  border-top:1px solid var(--border);
}

.footer-links a{
  color:#666;
  text-decoration:none;
  font-size:13px;
  transition:color 0.2s;
  display:block;
  margin-bottom:8px;
}

.footer-links a:hover{
  color:#fff;
}

/* Steps */
.step{
  display:none;
}

.step.active{
  display:block;
  animation:slideIn 0.3s ease;
}

@keyframes slideIn{
  from{opacity:0;transform:translateX(10px)}
  to{opacity:1;transform:translateX(0)}
}

/* Timer */
.timer{
  color:#666;
  font-size:12px;
  text-align:center;
  margin-top:12px;
}

.timer.warning{
  color:#FFC107;
}

@media (max-width:480px){
  .container{
    max-width:100%;
  }
  .main-card{
    padding:24px;
  }
  h1{
    font-size:24px;
  }
}
</style>
</head>
<body>

<div class="container">
  <!-- Header -->
  <div class="header">
    <div class="logo-wrapper">
      <img src="sf-logo.png" alt="Sound Factory" class="logo" />
    </div>
    <h1>Team Login</h1>
    <p class="subtitle">Access your promoter dashboard</p>
  </div>

  <!-- Main Card -->
  <div class="main-card">
    <!-- Status Message (if coming from signup) -->
    <div id="statusMessage" class="status-message" style="display:none;"></div>

    <!-- Step 1: Phone Number -->
    <div id="step1" class="step active">
      <form id="phoneForm">
        <div class="form-group">
          <label for="phone">Phone Number</label>
          <input 
            type="tel" 
            id="phone" 
            name="phone" 
            placeholder="(929) 362-9534" 
            required 
            autocomplete="tel"
          />
        </div>
        
        <button type="submit" class="btn" id="sendCodeBtn">
          Send Verification Code
        </button>
      </form>
      
      <div class="footer-links">
        <a href="index.html">Don't have an account? Sign up</a>
      </div>
    </div>

    <!-- Step 2: Verification Code -->
    <div id="step2" class="step">
      <div class="info-text">
        We sent a 6-digit code to <span id="phoneDisplay"></span>
      </div>
      
      <div class="code-input-group">
        <input type="text" class="code-input" maxlength="1" pattern="[0-9]" />
        <input type="text" class="code-input" maxlength="1" pattern="[0-9]" />
        <input type="text" class="code-input" maxlength="1" pattern="[0-9]" />
        <input type="text" class="code-input" maxlength="1" pattern="[0-9]" />
        <input type="text" class="code-input" maxlength="1" pattern="[0-9]" />
        <input type="text" class="code-input" maxlength="1" pattern="[0-9]" />
      </div>
      
      <button class="btn" id="verifyBtn" onclick="verifyCode()">
        Verify Code
      </button>
      
      <button class="btn btn-secondary" onclick="backToPhone()">
        Use Different Number
      </button>
      
      <div class="timer" id="timer"></div>
      <button class="btn-text" id="resendBtn" style="display:none;" onclick="resendCode()">
        Resend Code
      </button>
    </div>
  </div>
</div>

<script>
// Check for URL parameters
const params = new URLSearchParams(window.location.search);
if (params.get('registered') === 'true') {
  const message = document.getElementById('statusMessage');
  message.textContent = 'Account created! Complete Stripe setup, then you can log in.';
  message.style.display = 'block';
}
if (params.get('approved') === 'true') {
  const message = document.getElementById('statusMessage');
  message.textContent = 'Your account has been approved! You can now log in.';
  message.style.display = 'block';
}

// Phone formatting
document.getElementById('phone').addEventListener('input', (e) => {
  let value = e.target.value.replace(/\D/g, '');
  if (value.length > 0) {
    if (value.length <= 3) {
      value = `(${value}`;
    } else if (value.length <= 6) {
      value = `(${value.slice(0, 3)}) ${value.slice(3)}`;
    } else if (value.length <= 10) {
      value = `(${value.slice(0, 3)}) ${value.slice(3, 6)}-${value.slice(6)}`;
    }
  }
  e.target.value = value;
});

// Code input handling
const codeInputs = document.querySelectorAll('.code-input');
codeInputs.forEach((input, index) => {
  input.addEventListener('input', (e) => {
    if (e.target.value && index < codeInputs.length - 1) {
      codeInputs[index + 1].focus();
    }
    checkCodeComplete();
  });
  
  input.addEventListener('keydown', (e) => {
    if (e.key === 'Backspace' && !e.target.value && index > 0) {
      codeInputs[index - 1].focus();
    }
  });
  
  input.addEventListener('paste', (e) => {
    e.preventDefault();
    const pastedData = e.clipboardData.getData('text').replace(/\D/g, '').slice(0, 6);
    for (let i = 0; i < pastedData.length; i++) {
      if (codeInputs[i]) {
        codeInputs[i].value = pastedData[i];
      }
    }
    checkCodeComplete();
  });
});

function checkCodeComplete() {
  const code = Array.from(codeInputs).map(i => i.value).join('');
  if (code.length === 6) {
    verifyCode();
  }
}

// Timer
let timerInterval;
let resendTimer = 60;

function startTimer() {
  resendTimer = 60;
  const timerEl = document.getElementById('timer');
  const resendBtn = document.getElementById('resendBtn');
  
  resendBtn.style.display = 'none';
  timerEl.style.display = 'block';
  
  timerInterval = setInterval(() => {
    resendTimer--;
    if (resendTimer <= 0) {
      clearInterval(timerInterval);
      timerEl.style.display = 'none';
      resendBtn.style.display = 'block';
    } else {
      timerEl.textContent = `Resend code in ${resendTimer}s`;
      if (resendTimer <= 10) {
        timerEl.classList.add('warning');
      }
    }
  }, 1000);
}

// Form submission
document.getElementById('phoneForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  await sendCode();
});

async function sendCode() {
  const phone = document.getElementById('phone').value;
  const btn = document.getElementById('sendCodeBtn');
  
  btn.disabled = true;
  btn.innerHTML = '<span class="loading"></span>Sending...';
  
  try {
    const response = await fetch('/.netlify/functions/send-sms-code', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ phone })
    });
    
    const data = await response.json();
    
    if (response.ok && data.success) {
      // Show verification step
      document.getElementById('step1').classList.remove('active');
      document.getElementById('step2').classList.add('active');
      document.getElementById('phoneDisplay').textContent = phone;
      
      // Store phone for verification
      sessionStorage.setItem('login_phone', phone);
      
      // Start timer
      startTimer();
      
      // Focus first code input
      codeInputs[0].focus();
    } else {
      throw new Error(data.error || 'Failed to send code');
    }
  } catch (error) {
    showError(error.message);
  } finally {
    btn.disabled = false;
    btn.innerHTML = 'Send Verification Code';
  }
}

async function verifyCode() {
  const code = Array.from(codeInputs).map(i => i.value).join('');
  if (code.length !== 6) return;
  
  const btn = document.getElementById('verifyBtn');
  const phone = sessionStorage.getItem('login_phone');
  
  btn.disabled = true;
  btn.innerHTML = '<span class="loading"></span>Verifying...';
  
  try {
    const response = await fetch('/.netlify/functions/verify-sms-code', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ phone, code })
    });
    
    const data = await response.json();
    
    if (response.ok && data.success) {
      // Store session
      localStorage.setItem('promoter_session', data.sessionToken);
      localStorage.setItem('promoter_data', JSON.stringify({
        name: data.name,
        email: data.email,
        promo_code: data.promoCode,
        promoter_id: data.promoterId
      }));
      
      // Redirect to dashboard
      window.location.href = 'promoter-dashboard.html';
    } else {
      throw new Error(data.error || 'Invalid code');
    }
  } catch (error) {
    showError(error.message);
    // Clear code inputs
    codeInputs.forEach(input => input.value = '');
    codeInputs[0].focus();
  } finally {
    btn.disabled = false;
    btn.innerHTML = 'Verify Code';
  }
}

async function resendCode() {
  await sendCode();
}

function backToPhone() {
  document.getElementById('step2').classList.remove('active');
  document.getElementById('step1').classList.add('active');
  clearInterval(timerInterval);
  codeInputs.forEach(input => input.value = '');
}

function showError(message) {
  const existing = document.querySelector('.error');
  if (existing) existing.remove();
  
  const error = document.createElement('div');
  error.className = 'error';
  error.textContent = message;
  document.querySelector('.step.active').appendChild(error);
  
  setTimeout(() => error.remove(), 5000);
}
</script>

</body>
</html>