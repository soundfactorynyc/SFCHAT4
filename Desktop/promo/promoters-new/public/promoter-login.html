<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Team Member Login - Sound Factory NYC</title>
<meta name="color-scheme" content="dark" />
<style>
:root{
  --bg:#000000;
  --surface:#0a0a0a;
  --border:#333333;
  --text:#ffffff;
  --muted:#999999;
}
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;margin:0;padding:0}
body{
  background:#000000;
  color:#ffffff;
  font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text","Helvetica Neue",Helvetica,Arial,sans-serif;
  -webkit-font-smoothing:antialiased;
  display:flex;
  align-items:center;
  justify-content:center;
  min-height:100vh;
  padding:20px;
}

.container{
  width:100%;
  max-width:480px;
  animation:fadeIn 0.6s ease;
}

@keyframes fadeIn{
  from{opacity:0;transform:translateY(10px)}
  to{opacity:1;transform:translateY(0)}
}

.header{
  text-align:center;
  margin-bottom:40px;
}

.logo-wrapper{
  margin:0 auto 20px;
  height:100px;
  display:flex;
  justify-content:center;
  align-items:center;
}

.logo{
  height:80px;
  width:auto;
}

.brand-text{
  font-size:11px;
  text-transform:uppercase;
  letter-spacing:2.5px;
  color:#999999;
  margin-bottom:8px;
  font-weight:700;
}

h1{
  font-size:18px;
  font-weight:700;
  margin-bottom:8px;
  letter-spacing:0.3px;
  color:#F0F0F0;
  text-transform:uppercase;
}

.subtitle{
  color:#999999;
  font-size:12px;
  font-weight:400;
  letter-spacing:0.2px;
}

.main-card{
  background:#0a0a0a;
  border:0.5px solid rgba(255,255,255,0.15);
  border-radius:2px;
  padding:32px 24px;
}

.form-group{
  margin-bottom:20px;
}

label{
  display:block;
  font-size:11px;
  font-weight:700;
  margin-bottom:6px;
  color:#cccccc;
  text-transform:uppercase;
  letter-spacing:2px;
}

input{
  width:100%;
  padding:8px 12px;
  border-radius:2px;
  background:rgba(255,255,255,0.05);
  border:0.5px solid rgba(255,255,255,0.15);
  color:#F0F0F0;
  font-size:12px;
  height:28px;
  transition:all 0.2s;
}

input:focus{
  outline:none;
  border-color:rgba(255,255,255,0.4);
  background:rgba(255,255,255,0.08);
}

.btn{
  width:100%;
  height:32px;
  border-radius:2px;
  background:#111111;
  color:#ffffff;
  border:1px solid #222222;
  font-size:11px;
  font-weight:700;
  cursor:pointer;
  transition:all 0.2s;
  text-transform:uppercase;
  letter-spacing:1.5px;
}

.btn:hover:not(:disabled){
  background:#1a1a1a;
  border-color:#333333;
}

.btn:disabled{
  opacity:0.3;
  cursor:not-allowed;
}

.btn-secondary{
  background:transparent;
  color:#F0F0F0;
  border:1px solid rgba(255,255,255,0.15);
  margin-top:8px;
  height:28px;
}

.btn-secondary:hover{
  background:rgba(255,255,255,0.05);
  border-color:rgba(255,255,255,0.3);
}

.error{
  background:rgba(255,0,0,0.05);
  border:1px solid rgba(255,0,0,0.1);
  color:#ff6b6b;
  padding:12px;
  border-radius:2px;
  font-size:11px;
  margin-top:12px;
  text-align:center;
  text-transform:uppercase;
  letter-spacing:1px;
}

.success{
  background:rgba(76,175,80,0.05);
  border:1px solid rgba(76,175,80,0.1);
  color:#4caf50;
  padding:12px;
  border-radius:2px;
  font-size:11px;
  margin-bottom:16px;
  text-align:center;
  text-transform:uppercase;
  letter-spacing:1px;
}

.loading{
  display:inline-block;
  width:14px;
  height:14px;
  border:2px solid #fff;
  border-radius:50%;
  border-top-color:transparent;
  animation:spin 0.8s linear infinite;
  margin-right:8px;
}

@keyframes spin{
  to{transform:rotate(360deg)}
}

.divider{
  text-align:center;
  margin:24px 0;
  position:relative;
}

.divider:before{
  content:'';
  position:absolute;
  top:50%;
  left:0;
  right:0;
  height:1px;
  background:rgba(255,255,255,0.1);
}

.divider span{
  background:#0a0a0a;
  padding:0 12px;
  position:relative;
  font-size:11px;
  color:#666;
  text-transform:uppercase;
  letter-spacing:1px;
}

.info-box{
  background:rgba(255,255,255,0.02);
  border:0.5px solid rgba(255,255,255,0.15);
  border-radius:2px;
  padding:16px;
  margin-bottom:16px;
  font-size:12px;
  color:#F0F0F0;
  line-height:1.5;
  letter-spacing:0.2px;
}

.footer-links{
  text-align:center;
  margin-top:24px;
  padding-top:24px;
  border-top:1px solid #333333;
}

.footer-links a{
  color:#ffffff;
  text-decoration:none;
  font-size:11px;
  font-weight:600;
  transition:color 0.2s;
  text-transform:uppercase;
  letter-spacing:1px;
}

.footer-links a:hover{
  color:#cccccc;
}

#verifySection{
  display:none;
}
</style>
</head>
<body>

<div class="container">
  <!-- Header -->
  <div class="header">
    <div class="logo-wrapper">
      <img src="sf-logo.png" alt="Sound Factory" class="logo" />
    </div>
    <div class="brand-text">SOUND FACTORY NYC</div>
    <h1>TEAM MEMBER LOGIN</h1>
    <p class="subtitle">Enter your phone number</p>
  </div>

  <!-- Main Card -->
  <div class="main-card">
    <!-- Success Message (if registered) -->
    <div id="registeredMessage" class="success" style="display:none;">
      ✓ REGISTRATION COMPLETE - LOGIN TO ACCESS YOUR DASHBOARD
    </div>

    <!-- Info Box -->
    <div class="info-box">
      Secure SMS verification. Your phone number must be registered in our system.
    </div>

    <!-- Phone Input Section -->
    <div id="phoneSection">
      <form id="phoneForm">
        <div class="form-group">
          <label for="phone">MOBILE NUMBER</label>
          <input 
            type="tel" 
            id="phone" 
            name="phone" 
            placeholder="+1 (555) 123-4567" 
            required 
          />
        </div>

        <button type="submit" class="btn" id="sendCodeBtn">
          SEND VERIFICATION CODE
        </button>
      </form>
    </div>

    <!-- Code Verification Section -->
    <div id="verifySection">
      <div class="info-box" style="background:rgba(76,175,80,0.05);border-color:rgba(76,175,80,0.2);">
        Code sent! Check your phone for a 6-digit verification code.
      </div>

      <form id="verifyForm">
        <div class="form-group">
          <label for="code">VERIFICATION CODE</label>
          <input 
            type="text" 
            id="code" 
            name="code" 
            placeholder="123456" 
            maxlength="6" 
            required 
            autocomplete="one-time-code"
          />
        </div>

        <button type="submit" class="btn" id="verifyBtn">
          VERIFY & LOGIN
        </button>

        <button type="button" class="btn btn-secondary" onclick="backToPhone()">
          USE DIFFERENT NUMBER
        </button>
      </form>
    </div>

    <!-- Error Display -->
    <div id="errorDisplay"></div>

    <!-- Divider -->
    <div class="divider">
      <span>OR</span>
    </div>

    <!-- Footer Links -->
    <div class="footer-links">
      <a href="index.html">← NEW TO THE PROGRAM? SIGN UP</a>
    </div>
  </div>
</div>

<script>
// Check for registered parameter
const urlParams = new URLSearchParams(window.location.search);
if (urlParams.get('registered') === 'true') {
  document.getElementById('registeredMessage').style.display = 'block';
}

// Phone form submission
document.getElementById('phoneForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  
  const sendBtn = document.getElementById('sendCodeBtn');
  const phone = document.getElementById('phone').value.trim();
  
  // Format phone to E.164
  let formattedPhone = phone.replace(/\D/g, '');
  if (!formattedPhone.startsWith('1') && formattedPhone.length === 10) {
    formattedPhone = '1' + formattedPhone;
  }
  formattedPhone = '+' + formattedPhone;
  
  sendBtn.disabled = true;
  sendBtn.innerHTML = '<span class="loading"></span>SENDING...';
  clearError();
  
  try {
    const response = await fetch('/.netlify/functions/send-sms-code', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ phone: formattedPhone })
    });
    
    const data = await response.json();
    
    if (!response.ok) {
      throw new Error(data.error || 'Failed to send code');
    }
    
    // Store phone for verification
    sessionStorage.setItem('login_phone', formattedPhone);
    
    // Show verification section
    document.getElementById('phoneSection').style.display = 'none';
    document.getElementById('verifySection').style.display = 'block';
    document.getElementById('code').focus();
    
  } catch (error) {
    showError(error.message);
    sendBtn.disabled = false;
    sendBtn.innerHTML = 'SEND VERIFICATION CODE';
  }
});

// Verify form submission
document.getElementById('verifyForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  
  const verifyBtn = document.getElementById('verifyBtn');
  const code = document.getElementById('code').value.trim();
  const phone = sessionStorage.getItem('login_phone');
  
  if (!phone) {
    showError('Session expired. Please start over.');
    backToPhone();
    return;
  }
  
  verifyBtn.disabled = true;
  verifyBtn.innerHTML = '<span class="loading"></span>VERIFYING...';
  clearError();
  
  try {
    const response = await fetch('/.netlify/functions/verify-sms-code', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ phone, code })
    });
    
    const data = await response.json();
    
    if (!response.ok) {
      throw new Error(data.error || 'Verification failed');
    }
    
    // Store session
    localStorage.setItem('promoter_session', JSON.stringify({
      token: data.sessionToken || data.token,
      promoter: data.promoter,
      expiresAt: data.expiresAt
    }));
    
    // Clear temp storage
    sessionStorage.removeItem('login_phone');
    
    // Redirect to dashboard
    window.location.href = 'promoter-dashboard.html';
    
  } catch (error) {
    showError(error.message);
    verifyBtn.disabled = false;
    verifyBtn.innerHTML = 'VERIFY & LOGIN';
  }
});

function backToPhone() {
  document.getElementById('phoneSection').style.display = 'block';
  document.getElementById('verifySection').style.display = 'none';
  document.getElementById('code').value = '';
  sessionStorage.removeItem('login_phone');
  clearError();
}

function showError(message) {
  const errorDiv = document.getElementById('errorDisplay');
  errorDiv.className = 'error';
  errorDiv.textContent = message;
}

function clearError() {
  document.getElementById('errorDisplay').textContent = '';
  document.getElementById('errorDisplay').className = '';
}

// Phone formatting
document.getElementById('phone').addEventListener('input', (e) => {
  let value = e.target.value.replace(/\D/g, '');
  if (value.startsWith('1')) value = value.substring(1);
  
  if (value.length > 0) {
    if (value.length <= 3) {
      value = `(${value}`;
    } else if (value.length <= 6) {
      value = `(${value.slice(0, 3)}) ${value.slice(3)}`;
    } else if (value.length <= 10) {
      value = `(${value.slice(0, 3)}) ${value.slice(3, 6)}-${value.slice(6)}`;
    }
  }
  e.target.value = value;
});

// Code input - auto-uppercase and numbers only
document.getElementById('code').addEventListener('input', (e) => {
  e.target.value = e.target.value.replace(/[^0-9]/g, '').slice(0, 6);
});
</script>

</body>
</html>