<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sound Factory NYC</title>
    <!-- Load environment variables from Netlify -->
    <script src="/netlify-env-inject.js"></script>
    <!-- HLS.js for livestream -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@300;400;500;600;700;900&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --shine-white: #ffffff;
            --shine-silver: #c0c0c0;
            --bg-black: #000000;
            --bg-deep: #0a0a0a;
            --accent-pink: #ff0066;
            --accent-cyan: #00ffff;
            --glass: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
        }

        body {
            background: var(--bg-black);
            color: var(--shine-white);
            font-family: 'Inter', -apple-system, sans-serif;
            overflow: hidden;
            height: 100vh;
            position: relative;
            touch-action: none;
            user-select: none;
        }

        /* Reaction Canvas */
        #reaction-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 999;
        }

        /* Chrome Background */
        .chrome-bg {
            position: fixed;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            z-index: 0;
            background: 
                radial-gradient(circle at 20% 80%, rgba(255, 255, 255, 0.03) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 255, 255, 0.02) 0%, transparent 50%),
                linear-gradient(135deg, #000000 0%, #0a0a0a 50%, #000000 100%);
        }

        /* Header */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            padding: 15px 20px;
            background: linear-gradient(180deg, rgba(0,0,0,0.95) 0%, rgba(0,0,0,0.8) 100%);
            border-bottom: 1px solid var(--glass-border);
            box-shadow: 0 0 30px rgba(255, 255, 255, 0.05);
            z-index: 1000;
            backdrop-filter: blur(20px);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1400px;
            margin: 0 auto;
        }

        .logo {
            font-family: 'Bebas Neue', sans-serif;
            font-size: clamp(20px, 4vw, 32px);
            background: linear-gradient(135deg, #ffffff 0%, #888888 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: 4px;
        }

        .header-buttons {
            display: flex;
            gap: 10px;
        }

        .header-btn {
            padding: 8px 20px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.15), rgba(255, 255, 255, 0.05));
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .header-btn:hover {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.25), rgba(255, 255, 255, 0.1));
            transform: translateY(-1px);
        }

        /* Universal Social Login Grid (DISABLED) */
        /* Social login styles removed */

        /* SMS Login Modal */
        .sms-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(10px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            animation: fadeIn 0.3s ease-out;
        }

        .sms-modal-overlay.active {
            display: flex;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .sms-modal {
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.98), rgba(10, 10, 10, 0.98));
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 24px;
            padding: 40px 32px;
            max-width: 420px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5), 0 0 100px rgba(255, 0, 102, 0.3);
            text-align: center;
            position: relative;
            animation: slideUp 0.4s ease-out;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .sms-modal-title {
            font-size: 32px;
            font-weight: 700;
            background: linear-gradient(135deg, #ffffff, #888888);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 12px;
        }

        .sms-modal-subtitle {
            color: #999;
            font-size: 16px;
            margin-bottom: 32px;
        }

        .sms-input {
            width: 100%;
            padding: 16px 20px;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            color: white;
            font-size: 18px;
            text-align: center;
            margin-bottom: 16px;
            transition: all 0.3s;
            font-weight: 500;
            letter-spacing: 2px;
        }

        .sms-input:focus {
            outline: none;
            border-color: #ff0066;
            background: rgba(255, 0, 102, 0.05);
            box-shadow: 0 0 0 4px rgba(255, 0, 102, 0.1);
        }

        .sms-input::placeholder {
            color: #666;
            letter-spacing: normal;
        }

        .sms-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #ff0066, #ff3399);
            border: none;
            border-radius: 12px;
            color: white;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 12px;
        }

        .sms-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 0, 102, 0.4);
        }

        .sms-btn:disabled {
            background: rgba(255, 255, 255, 0.1);
            cursor: not-allowed;
            opacity: 0.5;
        }

        .sms-btn.secondary {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .sms-status {
            padding: 12px;
            border-radius: 8px;
            font-size: 14px;
            margin-top: 16px;
            display: none;
        }

        .sms-status.success {
            background: rgba(0, 255, 136, 0.1);
            color: #00ff88;
            border: 1px solid rgba(0, 255, 136, 0.2);
        }

        .sms-status.error {
            background: rgba(255, 0, 102, 0.1);
            color: #ff0066;
            border: 1px solid rgba(255, 0, 102, 0.2);
        }

        .sms-status.info {
            background: rgba(0, 191, 255, 0.1);
            color: #00bfff;
            border: 1px solid rgba(0, 191, 255, 0.2);
        }

        .sms-loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-right: 8px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .sms-phone-display {
            background: rgba(255, 0, 102, 0.1);
            border: 1px solid rgba(255, 0, 102, 0.2);
            border-radius: 8px;
            padding: 12px;
            font-weight: 600;
            color: #ff0066;
            margin-bottom: 20px;
            font-size: 18px;
            letter-spacing: 1px;
        }

        .sms-icon {
            font-size: 64px;
            margin-bottom: 20px;
            animation: bounce 2s ease infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        /* Tooltip System */
        .tooltip-trigger {
            position: relative;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .tooltip-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 16px;
            height: 16px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            font-size: 11px;
            color: #888;
            cursor: help;
            transition: all 0.3s;
        }

        .tooltip-icon:hover {
            background: rgba(255, 0, 102, 0.2);
            border-color: #ff0066;
            color: #ff0066;
            transform: scale(1.1);
        }

        .tooltip {
            position: absolute;
            background: linear-gradient(135deg, #1a1a1a, #0a0a0a);
            border: 1px solid rgba(255, 0, 102, 0.3);
            border-radius: 12px;
            padding: 12px 16px;
            color: white;
            font-size: 13px;
            line-height: 1.4;
            white-space: nowrap;
            pointer-events: none;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s ease;
            z-index: 10000;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.8), 0 0 20px rgba(255, 0, 102, 0.2);
            max-width: 250px;
            white-space: normal;
        }

        .tooltip-trigger:hover .tooltip {
            opacity: 1;
            visibility: visible;
            transform: translateY(-5px);
        }

        .tooltip.bottom {
            top: calc(100% + 8px);
            left: 50%;
            transform: translateX(-50%);
        }

        .tooltip.top {
            bottom: calc(100% + 8px);
            left: 50%;
            transform: translateX(-50%);
        }

        .tooltip.right {
            left: calc(100% + 8px);
            top: 50%;
            transform: translateY(-50%);
        }

        .tooltip.left {
            right: calc(100% + 8px);
            top: 50%;
            transform: translateY(-50%);
        }

        .tooltip-trigger:hover .tooltip.bottom {
            transform: translateX(-50%) translateY(0);
        }

        .tooltip-trigger:hover .tooltip.top {
            transform: translateX(-50%) translateY(0);
        }

        .tooltip-trigger:hover .tooltip.right {
            transform: translateY(-50%) translateX(0);
        }

        .tooltip-trigger:hover .tooltip.left {
            transform: translateY(-50%) translateX(0);
        }

        .tooltip-emoji {
            font-size: 16px;
            margin-right: 6px;
        }

        .tooltip-title {
            font-weight: 700;
            margin-bottom: 4px;
            color: #ff0066;
        }





        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* BLUEPRINT VIEW */
        .blueprint-view {
            position: fixed;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            background: #0a0a0a;
        }

        .blueprint-bg {
            position: absolute;
            width: 100%;
            height: 100%;
            /* Use the actual Sound Factory blueprint image */
            background-image: url('https://i.imgur.com/YourBlueprintImage.jpg'); /* Replace with your blueprint URL */
            background-size: cover;
            background-position: center;
            opacity: 0.35;
            filter: brightness(0.5) contrast(1.3);
            /* Fallback gradient if image doesn't load */
            background: linear-gradient(45deg, #1a1a2e 0%, #0f0f1e 50%, #1a1a2e 100%),
                        radial-gradient(circle at 30% 40%, rgba(255,0,102,0.1) 0%, transparent 50%),
                        radial-gradient(circle at 70% 60%, rgba(0,255,136,0.1) 0%, transparent 50%);
        }

        /* Character System - YOUR EXACT WALKING CHARACTER */
        .person {
            position: fixed;
            width: 24px;
            height: 36px;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
            z-index: 100;
            cursor: pointer;
        }

        .person.clickable {
            pointer-events: auto;
        }

        .head {
            position: absolute;
            width: 8px;
            height: 8px;
            background: radial-gradient(circle at 40% 40%, #f4d1ae, #c4936d);
            border-radius: 50%;
            left: 8px;
            top: 2px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.4);
            z-index: 20;
        }

        .torso {
            position: absolute;
            width: 14px;
            height: 11px;
            background: linear-gradient(180deg, #333, #222);
            border-radius: 30% 30% 50% 50%;
            left: 5px;
            top: 9px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.5);
            z-index: 10;
        }

        .arm-left-upper {
            position: absolute;
            width: 3px;
            height: 5px;
            background: linear-gradient(180deg, #333, #2a2a2a);
            left: 2px;
            top: 10px;
            transform-origin: center top;
            border-radius: 1px;
            z-index: 9;
        }

        .arm-left-lower {
            position: absolute;
            width: 2px;
            height: 5px;
            background: linear-gradient(180deg, #2a2a2a, #222);
            left: 0px;
            top: 4px;
            transform-origin: center top;
            border-radius: 0 0 1px 1px;
        }

        .arm-right-upper {
            position: absolute;
            width: 3px;
            height: 5px;
            background: linear-gradient(180deg, #333, #2a2a2a);
            right: 2px;
            top: 10px;
            transform-origin: center top;
            border-radius: 1px;
            z-index: 9;
        }

        .arm-right-lower {
            position: absolute;
            width: 2px;
            height: 5px;
            background: linear-gradient(180deg, #2a2a2a, #222);
            right: 0px;
            top: 4px;
            transform-origin: center top;
            border-radius: 0 0 1px 1px;
        }

        .leg-left-upper {
            position: absolute;
            width: 3px;
            height: 6px;
            background: linear-gradient(180deg, #222, #1a1a1a);
            left: 6px;
            top: 19px;
            transform-origin: center top;
            border-radius: 1px;
            z-index: 8;
        }

        .leg-left-lower {
            position: absolute;
            width: 2px;
            height: 6px;
            background: linear-gradient(180deg, #1a1a1a, #111);
            left: 0.5px;
            top: 5px;
            transform-origin: center top;
            border-radius: 0 0 2px 2px;
        }

        .leg-right-upper {
            position: absolute;
            width: 3px;
            height: 6px;
            background: linear-gradient(180deg, #222, #1a1a1a);
            right: 6px;
            top: 19px;
            transform-origin: center top;
            border-radius: 1px;
            z-index: 8;
        }

        .leg-right-lower {
            position: absolute;
            width: 2px;
            height: 6px;
            background: linear-gradient(180deg, #1a1a1a, #111);
            right: 0.5px;
            top: 5px;
            transform-origin: center top;
            border-radius: 0 0 2px 2px;
        }

        .shadow {
            position: absolute;
            width: 18px;
            height: 7px;
            background: radial-gradient(ellipse, rgba(0,0,0,0.3), transparent);
            left: 3px;
            top: 29px;
            border-radius: 50%;
            z-index: -1;
        }

        /* Walking animations */
        .person.walking .arm-left-upper { animation: armUpperSwingLeft 0.6s ease-in-out infinite; }
        .person.walking .arm-left-lower { animation: armLowerSwingLeft 0.6s ease-in-out infinite; }
        .person.walking .arm-right-upper { animation: armUpperSwingRight 0.6s ease-in-out infinite; }
        .person.walking .arm-right-lower { animation: armLowerSwingRight 0.6s ease-in-out infinite; }
        .person.walking .leg-left-upper { animation: legUpperStepLeft 0.6s ease-in-out infinite; }
        .person.walking .leg-left-lower { animation: legLowerStepLeft 0.6s ease-in-out infinite; }
        .person.walking .leg-right-upper { animation: legUpperStepRight 0.6s ease-in-out infinite; }
        .person.walking .leg-right-lower { animation: legLowerStepRight 0.6s ease-in-out infinite; }

        @keyframes armUpperSwingLeft { 0%, 100% { transform: rotate(-25deg); } 50% { transform: rotate(25deg); } }
        @keyframes armLowerSwingLeft { 0%, 100% { transform: rotate(-10deg); } 50% { transform: rotate(15deg); } }
        @keyframes armUpperSwingRight { 0%, 100% { transform: rotate(25deg); } 50% { transform: rotate(-25deg); } }
        @keyframes armLowerSwingRight { 0%, 100% { transform: rotate(15deg); } 50% { transform: rotate(-10deg); } }
        @keyframes legUpperStepLeft { 0%, 100% { transform: rotate(-15deg); } 25% { transform: rotate(20deg) translateY(-2px); } 50% { transform: rotate(-15deg); } }
        @keyframes legLowerStepLeft { 0%, 100% { transform: rotate(0deg); } 25% { transform: rotate(-30deg); } 50% { transform: rotate(0deg); } }
        @keyframes legUpperStepRight { 0%, 100% { transform: rotate(-15deg); } 50% { transform: rotate(-15deg); } 75% { transform: rotate(20deg) translateY(-2px); } }
        @keyframes legLowerStepRight { 0%, 100% { transform: rotate(0deg); } 50% { transform: rotate(0deg); } 75% { transform: rotate(-30deg); } }

        /* Character colors for different users */
        .person.user-me .torso { background: linear-gradient(180deg, #ff0066, #cc0033); }
        .person.user-1 .torso { background: linear-gradient(180deg, #00ff88, #00cc66); }
        .person.user-2 .torso { background: linear-gradient(180deg, #ffcc00, #ff9900); }
        .person.user-3 .torso { background: linear-gradient(180deg, #9933ff, #6600cc); }
        .person.user-4 .torso { background: linear-gradient(180deg, #0099ff, #0066cc); }

        /* Status indicator */
        .person .status-dot {
            position: absolute;
            bottom: -5px;
            right: 5px;
            width: 8px;
            height: 8px;
            background: #00ff88;
            border-radius: 50%;
            border: 2px solid #000;
            animation: statusPulse 1s infinite;
        }

        @keyframes statusPulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.8; }
        }

        /* Collision glow effect */
        .person.colliding {
            filter: drop-shadow(0 0 20px #ff0066);
        }

        /* PIN SYSTEM */
        .pin {
            position: absolute;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            cursor: pointer;
            pointer-events: auto;
            animation: dropIn 0.5s ease;
            box-shadow: 0 0 8px currentColor, 0 0 16px currentColor;
            opacity: 0.9;
            z-index: 50;
        }

        @keyframes dropIn {
            from { transform: translate(-50%, -50%) scale(0); opacity: 0; }
            to { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }

        /* Floor Buttons */
        .floor-buttons {
            position: fixed;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 500;
        }

        .floor-btn {
            width: 35px;
            height: 35px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            color: rgba(255, 255, 255, 0.6);
            font-size: 11px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            transform: scale(1);
        }

        .floor-btn:hover {
            transform: scale(1.15);
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.2), rgba(255, 255, 255, 0.1));
            border-color: rgba(255, 255, 255, 0.4);
            color: rgba(255, 255, 255, 0.9);
        }

        .floor-btn.active {
            background: linear-gradient(135deg, var(--accent-pink), rgba(255, 0, 102, 0.7));
            border-color: var(--accent-pink);
            color: white;
            transform: scale(1.1);
            box-shadow: 0 0 15px rgba(255, 0, 102, 0.5);
        }

        .floor-btn.active:hover {
            transform: scale(1.2);
        }

        /* Joystick */
        .joystick {
            position: fixed;
            right: 20px;
            bottom: 140px;
            width: 100px;
            height: 100px;
            background: radial-gradient(circle, rgba(0,0,0,0.7), rgba(0,0,0,0.35));
            border: 2px solid rgba(255,255,255,0.12);
            border-radius: 50%;
            touch-action: none;
            z-index: 200;
            box-shadow: 0 0 20px rgba(0,0,0,0.6), inset 0 0 10px rgba(255,255,255,0.05);
        }

        .joystick-knob {
            width: 35px;
            height: 35px;
            background: #000;
            border: 2px solid rgba(255,255,255,0.25);
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 2px 10px rgba(0,0,0,0.6), 0 0 10px rgba(255,255,255,0.08);
        }

        /* New character animation modes */
        .person.runway .head {
            animation: runwayHeadTilt 0.8s ease-in-out infinite;
        }
        .person.runway .torso {
            animation: runwayTorsoSwivel 0.8s ease-in-out infinite;
        }
        .person.runway .arm-left-upper {
            animation: runwayArmLeftUpper 0.8s ease-in-out infinite;
        }
        .person.runway .arm-left-lower {
            animation: runwayArmLeftLower 0.8s ease-in-out infinite;
        }
        .person.runway .arm-right-upper {
            animation: runwayArmRightUpper 0.8s ease-in-out infinite;
        }
        .person.runway .arm-right-lower {
            animation: runwayArmRightLower 0.8s ease-in-out infinite;
        }
        .person.runway .leg-left-upper {
            animation: runwayLegLeftUpper 0.8s ease-in-out infinite;
        }
        .person.runway .leg-right-upper {
            animation: runwayLegRightUpper 0.8s ease-in-out infinite;
        }

        /* Breakdancing animation */
        .person.breakdance {
            animation: breakdanceSpin 2s ease-in-out infinite;
        }
        .person.breakdance .arm-left-upper {
            animation: breakArmLeftUpper 0.3s ease-in-out infinite;
        }
        .person.breakdance .arm-right-upper {
            animation: breakArmRightUpper 0.3s ease-in-out infinite;
        }
        .person.breakdance .leg-left-upper {
            animation: breakLegLeftUpper 0.4s ease-in-out infinite;
        }
        .person.breakdance .leg-right-upper {
            animation: breakLegRightUpper 0.4s ease-in-out infinite;
        }

        /* Runway keyframes - exaggerated and fierce */
        @keyframes runwayHeadTilt {
            0%, 100% { transform: rotate(-5deg) translateX(2px); }
            50% { transform: rotate(5deg) translateX(-2px); }
        }
        @keyframes runwayTorsoSwivel {
            0%, 100% { transform: rotate(-8deg) scaleX(1.05); }
            50% { transform: rotate(8deg) scaleX(1.05); }
        }
        @keyframes runwayArmLeftUpper {
            0%, 100% { transform: rotate(-60deg) translateX(3px); }
            50% { transform: rotate(45deg) translateX(-2px); }
        }
        @keyframes runwayArmLeftLower {
            0%, 100% { transform: rotate(-45deg); }
            50% { transform: rotate(30deg); }
        }
        @keyframes runwayArmRightUpper {
            0%, 100% { transform: rotate(60deg) translateX(-3px); }
            50% { transform: rotate(-45deg) translateX(2px); }
        }
        @keyframes runwayArmRightLower {
            0%, 100% { transform: rotate(45deg); }
            50% { transform: rotate(-30deg); }
        }
        @keyframes runwayLegLeftUpper {
            0%, 100% { transform: rotate(-10deg) translateX(3px); }
            25% { transform: rotate(35deg) translateY(-3px) translateX(-2px); }
            50% { transform: rotate(-10deg) translateX(3px); }
        }
        @keyframes runwayLegRightUpper {
            0%, 100% { transform: rotate(-10deg) translateX(-3px); }
            50% { transform: rotate(-10deg) translateX(-3px); }
            75% { transform: rotate(35deg) translateY(-3px) translateX(2px); }
        }

        /* Breakdance keyframes */
        @keyframes breakdanceSpin {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            25% { transform: translate(-50%, -50%) rotate(180deg) scale(0.9); }
            50% { transform: translate(-50%, -50%) rotate(360deg) scale(1); }
            75% { transform: translate(-50%, -50%) rotate(540deg) scale(0.9); }
            100% { transform: translate(-50%, -50%) rotate(720deg); }
        }
        @keyframes breakArmLeftUpper {
            0%, 100% { transform: rotate(-90deg) translateX(5px); }
            50% { transform: rotate(90deg) translateX(-5px); }
        }
        @keyframes breakArmRightUpper {
            0%, 100% { transform: rotate(90deg) translateX(-5px); }
            50% { transform: rotate(-90deg) translateX(5px); }
        }
        @keyframes breakLegLeftUpper {
            0%, 100% { transform: rotate(-45deg) translateX(3px); }
            50% { transform: rotate(45deg) translateX(-3px); }
        }
        @keyframes breakLegRightUpper {
            0%, 100% { transform: rotate(45deg) translateX(-3px); }
            50% { transform: rotate(-45deg) translateX(3px); }
        }



        /* MODE TOGGLE */
        .mode-toggle {
            position: fixed;
            bottom: 130px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 3px;
            display: flex;
            gap: 3px;
            z-index: 1001;
        }

        .mode-btn {
            padding: 4px 8px;
            background: transparent;
            border: none;
            color: rgba(255,255,255,0.5);
            font-size: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            border-radius: 15px;
            display: flex;
            align-items: center;
            gap: 3px;
        }

        .mode-btn.active {
            background: linear-gradient(135deg, #ff0066, #ff3399);
            color: white;
        }

        /* BOOK STUDIO & BUY BUTTONS */
        .action-buttons {
            position: fixed;
            bottom: 300px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 300;
        }

        .action-btn {
            padding: 12px 20px;
            background: linear-gradient(135deg, #ff0066, #ff3399);
            border: none;
            border-radius: 25px;
            color: white;
            font-weight: 700;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 4px 15px rgba(255,0,102,0.4);
        }

        .action-btn.studio {
            background: linear-gradient(135deg, #00ff88, #00cc66);
            box-shadow: 0 4px 15px rgba(0,255,136,0.4);
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255,0,102,0.6);
        }

        /* HOVER PROFILE CARD */
        .profile-hover {
            position: fixed;
            background: rgba(20, 20, 20, 0.98);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 15px;
            color: white;
            z-index: 3000;
            box-shadow: 0 20px 60px rgba(0,0,0,0.8);
            border: 1px solid rgba(255,255,255,0.1);
            width: 320px;
            pointer-events: auto;
            display: none;
            animation: fadeIn 0.2s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }

        .profile-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 15px;
            padding-bottom: 12px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .profile-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ff0066, #ff3399);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .profile-info {
            flex: 1;
        }

        .profile-name {
            font-size: 16px;
            font-weight: bold;
            color: white;
        }

        .profile-status {
            font-size: 12px;
            color: #00ff88;
        }

        .social-actions {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 12px;
        }

        .social-btn {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            padding: 10px;
            border-radius: 10px;
            color: white;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            font-size: 11px;
        }

        .social-btn:hover {
            background: rgba(255,0,102,0.2);
            border-color: #ff0066;
            transform: translateY(-2px);
        }

        .social-btn.primary {
            background: linear-gradient(135deg, #ff0066, #ff3399);
            border: none;
            grid-column: span 2;
        }

        .social-btn span {
            display: block;
            font-size: 16px;
            margin-bottom: 3px;
        }

        /* Pin popup */
        .pin-popup {
            position: fixed;
            background: rgba(20, 20, 20, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 15px;
            color: white;
            z-index: 3000;
            box-shadow: 0 10px 40px rgba(0,0,0,0.8);
            border: 1px solid rgba(255,255,255,0.1);
            display: none;
            width: 280px;
        }

        .pin-type-btn {
            aspect-ratio: 1;
            border-radius: 8px;
            border: 1px solid;
            background: transparent;
            color: white;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .pin-type-btn:hover {
            transform: scale(1.1);
        }


        /* Grid Overlays */
        .grid-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.98);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            z-index: 9000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .grid-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .grid-container {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            grid-template-rows: repeat(8, 1fr);
            gap: 5px;
            width: min(90vw, 90vh);
            height: min(90vw, 90vh);
            padding: 10px;
            /* subtle stripes */
            background: 
                repeating-linear-gradient(
                    45deg,
                    rgba(255,255,255,0.03) 0px,
                    rgba(255,255,255,0.03) 10px,
                    rgba(255,255,255,0.06) 10px,
                    rgba(255,255,255,0.06) 20px
                );
            border-radius: 12px;
        }

        .grid-button {
            background: #000000;
            color: #ffffff;
            border: 1px solid #333333;
            border-radius: 8px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2px;
            text-align: center;
            word-wrap: break-word;
            transition: all 0.2s;
        }

        .grid-button:hover {
            background: #1a1a1a;
            transform: scale(1.05);
        }

        .grid-button.effect-active {
            background: linear-gradient(135deg, #ff0066, #ff3399) !important;
            color: #fff !important;
            box-shadow: 0 0 20px rgba(255, 0, 102, 0.8) !important;
        }

        /* Three Black Buttons */
        .main-button {
            position: fixed;
            left: 15px;
            background: #000000;
            color: #ffffff;
            border: 1px solid #333333;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

    .button-top { top: 80px; }
    .button-middle { top: 50%; transform: translateY(-50%); }
    .button-bottom { bottom: 26px; left: 2px; }

        .close-button {
            position: absolute;
            top: 20px;
            right: 20px;
            background: #000000;
            color: #ffffff;
            border: 1px solid #333333;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 24px;
            z-index: 9001;
        }

        /* Chat Effect Animations */
        @keyframes waveEffect {
            0% { bottom: 270px; transform: translateX(-20px) rotate(-5deg); opacity: 0; }
            25% { transform: translateX(20px) rotate(5deg); opacity: 1; }
            50% { transform: translateX(-20px) rotate(-5deg); }
            75% { transform: translateX(20px) rotate(5deg); opacity: 1; }
            100% { bottom: 450px; transform: translateX(0) rotate(0); opacity: 0; }
        }
        
        @keyframes spiralEffect {
            0% { bottom: 270px; transform: rotate(0deg) scale(0.5); opacity: 0; }
            50% { transform: rotate(720deg) scale(1.2); opacity: 1; }
            100% { bottom: 450px; transform: rotate(1440deg) scale(0.5); opacity: 0; }
        }
        
        @keyframes explodeEffect {
            0% { bottom: 270px; transform: scale(1); opacity: 1; }
            50% { transform: scale(2); opacity: 1; }
            60% { transform: scale(0.5); }
            100% { bottom: 450px; transform: scale(0); opacity: 0; }
        }
        
        @keyframes fireworkEffect {
            0% { bottom: 270px; transform: scale(0.5); opacity: 0; }
            40% { transform: scale(1.5); opacity: 1; }
            60% { transform: scale(1.8) rotate(180deg); }
            100% { bottom: 450px; transform: scale(0) rotate(360deg); opacity: 0; }
        }

        @media (max-width: 768px) {
            .joystick { width: 100px; height: 100px; }
            .action-buttons { bottom: 100px; }
        }

        /* ============ LIVE STREAM STYLES ============ */
        .sf-live-stream-container {
            position: fixed;
            top: 80px;
            left: 20px;
            width: 400px;
            max-width: calc(100vw - 40px);
            background: #000;
            display: none;
            opacity: 0;
            transform: scale(0.9);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 10000;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(255, 0, 0, 0.4);
        }
        
        .sf-live-stream-container.is-live {
            display: block;
            opacity: 1;
            transform: scale(1);
        }
        
        .sf-live-stream-container.minimized {
            width: 280px;
        }
        
        .stream-header {
            background: linear-gradient(135deg, #ff0000, #cc0000);
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
        }
        
        .live-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 700;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .live-dot {
            width: 8px;
            height: 8px;
            background: white;
            border-radius: 50%;
            animation: pulseDot 1.5s infinite;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
        }
        
        @keyframes pulseDot {
            0%, 100% { 
                opacity: 1; 
                transform: scale(1);
            }
            50% { 
                opacity: 0.6; 
                transform: scale(1.2);
            }
        }
        
        .viewer-count {
            font-size: 11px;
            opacity: 0.9;
        }
        
        .minimize-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        
        .minimize-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }
        
        .video-container {
            position: relative;
            width: 100%;
            aspect-ratio: 16 / 9;
            background: #000;
            overflow: hidden;
        }
        
        #stream-video {
            width: 100%;
            height: 100%;
            display: block;
            background: #000;
        }
        
        .stream-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        
        .play-button {
            width: 60px;
            height: 60px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            color: #000;
            transition: transform 0.2s;
        }
        
        .play-button:hover {
            transform: scale(1.1);
            background: white;
        }
        
        /* Floating Live Button */
        .floating-live-button {
            display: none;
            position: fixed;
            bottom: 80px;
            right: 20px;
            background: linear-gradient(135deg, #ff0000, #ff4444);
            color: white;
            padding: 12px 20px;
            border-radius: 30px;
            cursor: pointer;
            z-index: 9999;
            box-shadow: 0 4px 15px rgba(255, 0, 0, 0.4);
            animation: floatPulse 2s infinite;
            font-weight: 700;
            border: 2px solid white;
            align-items: center;
            gap: 8px;
            font-size: 13px;
        }
        
        .floating-live-button.show {
            display: flex;
        }
        
        @keyframes floatPulse {
            0%, 100% { transform: translateY(0) scale(1); }
            50% { transform: translateY(-5px) scale(1.05); }
        }

    </style>
</head>
<body>
        <!-- Supabase Client (for realtime presence) -->
        <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Chrome Background -->
    <div class="chrome-bg"></div>

    <!-- Header -->
    <div class="header">
        <div class="header-content">
            <div class="logo">SOUND FACTORY</div>
            <div class="header-buttons">
                <button class="header-btn" onclick="buyTickets()">TICKETS</button>
                <button class="header-btn" onclick="buyTables()">TABLES</button>
                <button class="header-btn" id="btnPairController" onclick="openControllerPairing()">PAIR</button>
            </div>
        </div>
    </div>

    <!-- SMS Verification Popup Modal -->
    <div id="sms-modal" class="sms-modal-overlay active">
        <div class="sms-modal">
            <div class="sms-icon">📱</div>
            <h1 class="sms-modal-title">SMS Verification</h1>
            
            <!-- Step 1: Phone Number Input -->
            <div id="phone-step" class="step active">
                <h2 style="font-size: 18px; margin-bottom: 15px;">Enter Your Phone Number</h2>
                <form id="phone-form">
                    <div class="input-group">
                        <label for="phone-number" style="display: block; margin-bottom: 8px; font-size: 14px;">Phone Number (with country code):</label>
                        <input 
                            type="tel" 
                            id="phone-number" 
                            placeholder="+1234567890" 
                            required
                            pattern="^\+[1-9]\d{1,14}$"
                            class="sms-input"
                        >
                        <small style="display: block; margin-top: 5px; color: #999; font-size: 12px;">Include country code (e.g., +1 for US)</small>
                    </div>
                    <button type="submit" id="send-btn" class="sms-btn">Send Verification Code</button>
                </form>
            </div>

            <!-- Step 2: Verification Code Input -->
            <div id="verify-step" class="step" style="display: none;">
                <h2 style="font-size: 18px; margin-bottom: 15px;">Enter Verification Code</h2>
                <p style="margin-bottom: 20px;">We sent a verification code to <span id="sent-to-number" style="color: #ff0066; font-weight: 700;"></span></p>
                <form id="verify-form">
                    <div class="input-group">
                        <label for="verification-code" style="display: block; margin-bottom: 8px; font-size: 14px;">Verification Code:</label>
                        <input 
                            type="text" 
                            id="verification-code" 
                            placeholder="123456" 
                            required
                            maxlength="6"
                            pattern="[0-9]{4,8}"
                            class="sms-input"
                        >
                    </div>
                    <div class="button-group" style="display: flex; gap: 10px; margin-top: 15px;">
                        <button type="submit" id="verify-btn" class="sms-btn">Verify Code</button>
                        <button type="button" id="back-btn" class="sms-btn secondary">Back</button>
                    </div>
                </form>
                <button type="button" id="resend-btn" class="link-btn" style="margin-top: 15px; background: none; border: none; color: #00ff88; cursor: pointer; text-decoration: underline;">Resend Code</button>
            </div>

            <!-- Step 3: Success Message -->
            <div id="success-step" class="step" style="display: none;">
                <h2 style="font-size: 24px; margin-bottom: 15px;">✅ Verification Successful!</h2>
                <p style="margin-bottom: 20px;">Your phone number has been verified successfully.</p>
                <button type="button" id="continue-btn" class="sms-btn">Continue to Site</button>
            </div>

            <!-- Loading and Error Messages -->
            <div id="loading" class="hidden" style="display: none; text-align: center; padding: 20px;">
                <div class="spinner" style="display: inline-block; width: 40px; height: 40px; border: 4px solid rgba(255,255,255,0.3); border-top-color: #ff0066; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                <p style="margin-top: 10px;">Processing...</p>
            </div>

            <div id="error-message" class="error hidden" style="display: none; background: rgba(255,0,102,0.1); border: 1px solid #ff0066; padding: 12px; border-radius: 8px; margin-top: 15px; position: relative;">
                <p id="error-text" style="margin: 0; color: #ff0066;"></p>
                <button type="button" id="close-error" style="position: absolute; top: 5px; right: 10px; background: none; border: none; color: #ff0066; font-size: 20px; cursor: pointer;">×</button>
            </div>
        </div>
    </div>

    <!-- Universal Social Login Grid (DISABLED) -->
    <!-- <div id="social-login-grid" class="social-login-grid" style="display: none;">
        Social login grid removed
    </div> -->

    <!-- Tooltips will be inline with elements -->







    <!-- Blueprint View -->
    <div class="blueprint-view">
        <div class="blueprint-bg"></div>
        
        <!-- BASEMENT Floor -->
        <div class="floor-svg" id="floor-b" style="position: absolute; width: 100%; height: 100%; display: none; align-items: center; justify-content: center; opacity: 0.3; pointer-events: none;">
            <svg viewBox="0 0 400 520" preserveAspectRatio="xMidYMid meet" style="width: 90%; height: 90%; max-width: 800px;">
                <defs>
                    <filter id="basementGlow">
                        <feGaussianBlur stdDeviation="2" result="coloredBlur"/>
                        <feMerge>
                            <feMergeNode in="coloredBlur"/>
                            <feMergeNode in="SourceGraphic"/>
                        </feMerge>
                    </filter>
                </defs>
                
                <rect width="400" height="520" fill="#000"/>
                <rect x="5" y="5" width="390" height="510" fill="none" stroke="#333" stroke-width="2" filter="url(#basementGlow)"/>
                <rect x="10" y="10" width="380" height="500" fill="#050505" stroke="#222" stroke-width="1"/>
                <rect x="30" y="30" width="340" height="460" fill="none" stroke="#444" stroke-width="2"/>
                
                <rect x="180" y="35" width="140" height="45" fill="#000" stroke="#555" stroke-width="2"/>
                <rect x="35" y="35" width="60" height="80" fill="#000" stroke="#555" stroke-width="2"/>
                <rect x="35" y="120" width="60" height="60" fill="#000" stroke="#555" stroke-width="2"/>
                <rect x="35" y="320" width="60" height="60" fill="#000" stroke="#555" stroke-width="2"/>
                <rect x="35" y="385" width="60" height="100" fill="#000" stroke="#555" stroke-width="2"/>
                
                <rect x="110" y="100" width="180" height="320" fill="none" stroke="#333" stroke-width="1" stroke-dasharray="5,5" opacity="0.5"/>
                
                <rect x="305" y="120" width="60" height="60" fill="#000" stroke="#555" stroke-width="2"/>
                <rect x="305" y="185" width="60" height="60" fill="#000" stroke="#555" stroke-width="2"/>
                <rect x="305" y="250" width="60" height="60" fill="#000" stroke="#555" stroke-width="2"/>
                <rect x="305" y="315" width="60" height="60" fill="#000" stroke="#555" stroke-width="2"/>
                <rect x="305" y="380" width="60" height="60" fill="#000" stroke="#555" stroke-width="2"/>
                
                <rect x="120" y="440" width="160" height="45" fill="#000" stroke="#555" stroke-width="2"/>
                <path d="M180,485 L180,475 L220,475 L220,485" stroke="#666" stroke-width="2" fill="none" stroke-dasharray="2,2"/>
            </svg>
        </div>

        <!-- MAIN Floor (default visible) -->
        <div class="floor-svg" id="floor-mf" style="position: absolute; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; opacity: 0.3; pointer-events: none;">
            <svg viewBox="0 0 400 520" preserveAspectRatio="xMidYMid meet" style="width: 90%; height: 90%; max-width: 800px;">
                <defs>
                    <linearGradient id="perimeterGrad1" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style="stop-color:#333;stop-opacity:1" />
                        <stop offset="50%" style="stop-color:#666;stop-opacity:1" />
                        <stop offset="100%" style="stop-color:#333;stop-opacity:1" />
                    </linearGradient>
                    <filter id="glow">
                        <feGaussianBlur stdDeviation="3" result="coloredBlur"/>
                        <feMerge>
                            <feMergeNode in="coloredBlur"/>
                            <feMergeNode in="SourceGraphic"/>
                        </feMerge>
                    </filter>
                </defs>
                
                <rect width="400" height="520" fill="#000"/>
                <rect x="5" y="5" width="390" height="510" fill="none" stroke="url(#perimeterGrad1)" stroke-width="3" filter="url(#glow)"/>
                <rect x="10" y="10" width="380" height="500" fill="#050505" stroke="#444" stroke-width="2"/>
                
                <rect x="100" y="20" width="95" height="65" fill="#0a0a0a" stroke="#555" stroke-width="2"/>
                <rect x="205" y="20" width="95" height="65" fill="#0a0a0a" stroke="#555" stroke-width="2"/>
                
                <rect x="45" y="30" width="40" height="45" fill="#000" stroke="#555" stroke-width="2"/>
                <rect x="315" y="30" width="40" height="45" fill="#000" stroke="#555" stroke-width="2"/>
                
                <rect x="20" y="110" width="45" height="350" fill="#000" stroke="#555" stroke-width="2"/>
                
                <g opacity="0.9" filter="url(#glow)">
                    <rect x="90" y="140" width="35" height="35" fill="#000" stroke="#444" stroke-width="2" rx="2"/>
                    <rect x="182" y="140" width="35" height="35" fill="#000" stroke="#444" stroke-width="2" rx="2"/>
                    <rect x="275" y="140" width="35" height="35" fill="#000" stroke="#444" stroke-width="2" rx="2"/>
                    
                    <rect x="90" y="210" width="35" height="35" fill="#000" stroke="#444" stroke-width="2" rx="2"/>
                    <rect x="182" y="210" width="35" height="35" fill="#000" stroke="#444" stroke-width="2" rx="2"/>
                    <rect x="275" y="210" width="35" height="35" fill="#000" stroke="#444" stroke-width="2" rx="2"/>
                    
                    <rect x="90" y="280" width="35" height="35" fill="#000" stroke="#444" stroke-width="2" rx="2"/>
                    <rect x="182" y="280" width="35" height="35" fill="#000" stroke="#444" stroke-width="2" rx="2"/>
                    <rect x="275" y="280" width="35" height="35" fill="#000" stroke="#444" stroke-width="2" rx="2"/>
                    
                    <rect x="90" y="350" width="35" height="35" fill="#000" stroke="#444" stroke-width="2" rx="2"/>
                    <rect x="182" y="350" width="35" height="35" fill="#000" stroke="#444" stroke-width="2" rx="2"/>
                    <rect x="275" y="350" width="35" height="35" fill="#000" stroke="#444" stroke-width="2" rx="2"/>
                </g>
                
                <rect x="100" y="420" width="200" height="50" fill="#000" stroke="#666" stroke-width="2"/>
                
                <g stroke="#666" stroke-width="2" fill="none">
                    <path d="M100,505 L100,485 L120,485 L120,505" stroke-dasharray="2,2"/>
                    <path d="M190,505 L190,485 L210,485 L210,505" stroke-dasharray="2,2"/>
                    <path d="M280,505 L280,485 L300,485 L300,505" stroke-dasharray="2,2"/>
                </g>
            </svg>
        </div>

        <!-- MEZZANINE Floor -->
        <div class="floor-svg" id="floor-mz" style="position: absolute; width: 100%; height: 100%; display: none; align-items: center; justify-content: center; opacity: 0.3; pointer-events: none;">
            <svg viewBox="0 0 400 520" preserveAspectRatio="xMidYMid meet" style="width: 90%; height: 90%; max-width: 800px;">
                <rect width="400" height="520" fill="#000"/>
                <rect x="5" y="5" width="390" height="510" fill="none" stroke="#555" stroke-width="3"/>
                <rect x="10" y="10" width="380" height="500" fill="#050505" stroke="#555" stroke-width="2"/>
                
                <rect x="35" y="35" width="330" height="450" fill="#0a0a0a" stroke="#666" stroke-width="3"/>
                
                <rect x="100" y="100" width="200" height="250" fill="#000" stroke="#444" stroke-width="2"/>
                <text x="200" y="225" font-family="Arial" font-size="11" fill="#666" text-anchor="middle" opacity="0.8">
                    OPEN TO BELOW
                </text>
                
                <rect x="175" y="45" width="50" height="50" fill="#0f0f0f" stroke="#777" stroke-width="2"/>
                <rect x="175" y="425" width="50" height="50" fill="#0f0f0f" stroke="#777" stroke-width="2"/>
                <rect x="250" y="170" width="50" height="70" fill="#0f0f0f" stroke="#666" stroke-width="2"/>
                <rect x="320" y="45" width="35" height="35" fill="#1a0000" stroke="#aa3333" stroke-width="2" opacity="0.8"/>
                
                <rect x="45" y="130" width="45" height="30" fill="none" stroke="#555" stroke-width="2" rx="2"/>
                <rect x="45" y="170" width="45" height="30" fill="none" stroke="#555" stroke-width="2" rx="2"/>
                <rect x="45" y="210" width="45" height="30" fill="none" stroke="#555" stroke-width="2" rx="2"/>
                <rect x="45" y="250" width="45" height="30" fill="none" stroke="#555" stroke-width="2" rx="2"/>
                <rect x="45" y="290" width="45" height="30" fill="none" stroke="#555" stroke-width="2" rx="2"/>
                
                <rect x="310" y="130" width="45" height="30" fill="none" stroke="#555" stroke-width="2" rx="2"/>
                <rect x="310" y="170" width="45" height="30" fill="none" stroke="#555" stroke-width="2" rx="2"/>
                <rect x="310" y="210" width="45" height="30" fill="none" stroke="#555" stroke-width="2" rx="2"/>
                <rect x="310" y="250" width="45" height="30" fill="none" stroke="#555" stroke-width="2" rx="2"/>
                <rect x="310" y="290" width="45" height="30" fill="none" stroke="#555" stroke-width="2" rx="2"/>
            </svg>
        </div>

        <!-- SECOND Floor -->
        <div class="floor-svg" id="floor-2f" style="position: absolute; width: 100%; height: 100%; display: none; align-items: center; justify-content: center; opacity: 0.3; pointer-events: none;">
            <svg viewBox="0 0 400 520" preserveAspectRatio="xMidYMid meet" style="width: 90%; height: 90%; max-width: 800px;">
                <rect width="400" height="520" fill="#000"/>
                <rect x="5" y="5" width="390" height="510" fill="none" stroke="#888" stroke-width="4"/>
                <rect x="10" y="10" width="380" height="500" fill="#000" stroke="#666" stroke-width="3"/>
                
                <rect x="30" y="30" width="140" height="100" fill="#000" stroke="#666" stroke-width="2"/>
                <rect x="30" y="30" width="140" height="35" fill="#0a0a0a" stroke="#555" stroke-width="1"/>
                <rect x="30" y="65" width="70" height="65" fill="none" stroke="#444" stroke-width="1"/>
                <rect x="100" y="65" width="70" height="65" fill="none" stroke="#444" stroke-width="1"/>
                
                <rect x="170" y="50" width="60" height="80" fill="#0a0a0a" stroke="#777" stroke-width="2"/>
                <rect x="230" y="50" width="60" height="80" fill="#0a0a0a" stroke="#777" stroke-width="2"/>
                
                <rect x="290" y="30" width="80" height="100" fill="#000" stroke="#666" stroke-width="2"/>
                
                <rect x="30" y="150" width="60" height="300" fill="#000" stroke="#666" stroke-width="2"/>
                
                <rect x="120" y="180" width="160" height="160" fill="none" stroke="#555" stroke-width="2" stroke-dasharray="4,4"/>
                <text x="200" y="260" font-family="Arial" font-size="11" fill="#666" text-anchor="middle" opacity="0.8">
                    OPEN SPACE
                </text>
                
                <circle cx="105" cy="165" r="8" fill="#000" stroke="#666" stroke-width="2"/>
                <circle cx="105" cy="220" r="8" fill="#000" stroke="#666" stroke-width="2"/>
                <circle cx="105" cy="275" r="8" fill="#000" stroke="#666" stroke-width="2"/>
                <circle cx="105" cy="330" r="8" fill="#000" stroke="#666" stroke-width="2"/>
                
                <circle cx="295" cy="165" r="8" fill="#000" stroke="#666" stroke-width="2"/>
                <circle cx="295" cy="220" r="8" fill="#000" stroke="#666" stroke-width="2"/>
                <circle cx="295" cy="275" r="8" fill="#000" stroke="#666" stroke-width="2"/>
                <circle cx="295" cy="330" r="8" fill="#000" stroke="#666" stroke-width="2"/>
                
                <rect x="310" y="180" width="60" height="160" fill="#000" stroke="#666" stroke-width="2"/>
                <rect x="120" y="390" width="160" height="80" fill="#0a0a0a" stroke="#777" stroke-width="2"/>
                <rect x="310" y="410" width="60" height="60" fill="#000" stroke="#666" stroke-width="2"/>
            </svg>
        </div>

        <!-- THIRD Floor -->
        <div class="floor-svg" id="floor-3f" style="position: absolute; width: 100%; height: 100%; display: none; align-items: center; justify-content: center; opacity: 0.3; pointer-events: none;">
            <svg viewBox="0 0 400 520" preserveAspectRatio="xMidYMid meet" style="width: 90%; height: 90%; max-width: 800px;">
                <rect width="400" height="520" fill="#000"/>
                <rect x="5" y="5" width="390" height="510" fill="none" stroke="#555" stroke-width="3"/>
                <rect x="10" y="10" width="380" height="500" fill="#050505" stroke="#444" stroke-width="2"/>
                
                <rect x="30" y="30" width="340" height="460" fill="none" stroke="#666" stroke-width="2"/>
                
                <rect x="100" y="140" width="200" height="180" fill="#000" stroke="#555" stroke-width="2"/>
                
                <rect x="150" y="35" width="100" height="80" fill="#000" stroke="#666" stroke-width="2"/>
                <path d="M170,70 Q200,60 230,70" fill="none" stroke="#555" stroke-width="2"/>
                <path d="M170,90 Q200,80 230,90" fill="none" stroke="#555" stroke-width="2"/>
                
                <rect x="35" y="35" width="60" height="80" fill="#000" stroke="#555" stroke-width="2"/>
                <rect x="35" y="180" width="60" height="80" fill="#000" stroke="#555" stroke-width="2"/>
                <rect x="35" y="350" width="60" height="80" fill="#000" stroke="#555" stroke-width="2"/>
                
                <rect x="305" y="35" width="60" height="80" fill="#000" stroke="#555" stroke-width="2"/>
                <rect x="305" y="180" width="60" height="80" fill="#000" stroke="#555" stroke-width="2"/>
                <rect x="305" y="350" width="60" height="80" fill="#000" stroke="#555" stroke-width="2"/>
                
                <rect x="120" y="390" width="160" height="80" fill="#000" stroke="#666" stroke-width="2"/>
                
                <rect x="35" y="440" width="40" height="40" fill="#000" stroke="#555" stroke-width="2"/>
                <rect x="325" y="440" width="40" height="40" fill="#000" stroke="#555" stroke-width="2"/>
                
                <path d="M180,485 L180,475 L220,475 L220,485" stroke="#666" stroke-width="2" fill="none" stroke-dasharray="2,2"/>
            </svg>
        </div>

        <!-- Joystick Character -->
    <div class="person clickable" id="myCharacter">
            <div class="shadow"></div>
            <div class="leg-left-upper">
                <div class="leg-left-lower"></div>
            </div>
            <div class="leg-right-upper">
                <div class="leg-right-lower"></div>
            </div>
            <div class="torso"></div>
            <div class="arm-left-upper">
                <div class="arm-left-lower"></div>
            </div>
            <div class="arm-right-upper">
                <div class="arm-right-lower"></div>
            </div>
            <div class="head"></div>
        </div>

        <!-- Second Character (Auto-moving for hover testing) -->
    <div class="person user-2 clickable" id="otherCharacter" style="left: 300px; top: 200px;">
            <div class="shadow"></div>
            <div class="leg-left-upper">
                <div class="leg-left-lower"></div>
            </div>
            <div class="leg-right-upper">
                <div class="leg-right-lower"></div>
            </div>
            <div class="torso"></div>
            <div class="arm-left-upper">
                <div class="arm-left-lower"></div>
            </div>
            <div class="arm-right-upper">
                <div class="arm-right-lower"></div>
            </div>
            <div class="head"></div>
        </div>

        <!-- Pin Overlay -->
        <div id="pinOverlay" style="position: absolute; width: 100%; height: 100%;"></div>
    </div>

    <!-- Floor Buttons -->
    <div class="floor-buttons">
        <button class="floor-btn" onclick="changeFloor('3F')">3F</button>
        <button class="floor-btn" onclick="changeFloor('2F')">2F</button>
        <button class="floor-btn" onclick="changeFloor('MZ')">MZ</button>
        <button class="floor-btn active" onclick="changeFloor('MF')">MF</button>
        <button class="floor-btn" onclick="changeFloor('B')">B</button>
    </div>

      <!-- Reaction Boxes Layer -->
      <div id="reactionLayer" style="position: fixed; inset: 0; pointer-events: none; z-index: 1100;"></div>
      
      <!-- Livestream Player -->
      <div id="sf-live-stream" class="sf-live-stream-container">
          <div class="stream-header">
              <div class="live-indicator">
                  <span class="live-dot"></span>
                  <span class="live-text">LIVE FROM SOUND FACTORY</span>
              </div>
              <div class="viewer-count">
                  <span id="viewer-count">0</span> watching
              </div>
              <button class="minimize-btn" onclick="toggleStreamSize()">−</button>
          </div>
          <div class="video-container">
              <video id="stream-video" playsinline controls></video>
              <div class="stream-overlay" id="stream-overlay">
                  <div class="play-button" onclick="playStream()">▶</div>
              </div>
          </div>
      </div>
      
      <!-- Floating Live Button -->
      <div id="floatingLiveBtn" class="floating-live-button" onclick="scrollToStream()">
          <span class="live-dot"></span>
          <span>WATCH LIVE</span>
      </div>
      
      <!-- Remote Control Pairing Modal -->
    <div id="pairModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.85); z-index:10050; align-items:center; justify-content:center;">
        <div style="width:min(92vw,420px); background:#111; border:1px solid rgba(255,255,255,0.1); border-radius:16px; padding:18px; color:#fff; box-shadow:0 20px 60px rgba(0,0,0,0.6);">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <div style="font-size:16px; font-weight:700;">Pair Mobile Controller</div>
                <button onclick="closePairModal()" style="background:none; border:none; color:#ff0066; font-weight:700; cursor:pointer;">✕</button>
            </div>
            <div id="pairDetails" style="font-size:13px; color:#ccc; margin-bottom:12px;">Generating code...</div>
            <div id="pairCode" style="font-size:36px; letter-spacing:6px; text-align:center; margin:10px 0; font-weight:800; color:#00ff88;">----</div>
            <div id="pairLinkWrap" style="word-break:break-all; font-size:12px; background:#0a0a0a; border:1px solid rgba(255,255,255,0.08); border-radius:8px; padding:10px; color:#bbb;"></div>
            <div style="display:flex; gap:8px; margin-top:12px;">
                <button id="copyPairLink" style="flex:1; padding:10px; background:#00ff88; color:#000; border:none; border-radius:10px; font-weight:800; cursor:pointer;">Copy Link</button>
                <button id="openPairLink" style="flex:1; padding:10px; background:rgba(255,255,255,0.1); color:#fff; border:1px solid rgba(255,255,255,0.2); border-radius:10px; cursor:pointer;">Open</button>
            </div>
        </div>
    </div>

    <!-- Joystick -->
    <div class="joystick" id="joystick">
        <div class="joystick-knob" id="knob"></div>
    </div>
    

    


    <!-- Mode Toggle -->
    <div class="mode-toggle">
        <button class="mode-btn active" data-mode="explore">🔍 Explore</button>
        <button class="mode-btn" data-mode="drop">📍 Drop Pin</button>
    </div>

    <!-- Pin Counter -->
    <div id="pinCounterChip" style="position: fixed; top: 70px; right: 20px; background: rgba(0,0,0,0.8); backdrop-filter: blur(10px); color: white; padding: 6px 10px; border-radius: 14px; font-size: 11px; z-index: 1200;">
        Pins: <span id="pinCount">0</span>/5
    </div>



    <!-- Reaction Canvas -->
    <canvas id="reaction-canvas"></canvas>
    
    <!-- Bottom Layout - Fixed Position -->
    <div class="bottom-layout" style="position: fixed; bottom: 0; left: 0; right: 0; background: rgba(0, 0, 0, 0.95); backdrop-filter: blur(20px); border-top: 1px solid rgba(255, 255, 255, 0.1); z-index: 1000; padding: 15px;">
        <!-- Reaction Controls Row -->
        <div class="reaction-controls" id="reaction-controls" style="display: flex; gap: 4px; flex-wrap: wrap; justify-content: center; padding: 8px 0; max-width: 600px; margin: 0 auto;">
        <!-- Emoji Reactions -->
        <button class="reaction-btn" id="btn-love" style="min-width: 32px; height: 32px; border-radius: 8px; border: none; font-size: 16px; cursor: pointer; transition: all 0.3s; background: linear-gradient(145deg, #2a2a2a 0%, #0a0a0a 50%, #1a1a1a 100%); box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.1), inset 0 -1px 0 rgba(0, 0, 0, 0.5), 0 2px 4px rgba(0, 0, 0, 0.8);">❤️</button>
        <button class="reaction-btn" id="btn-fire" style="min-width: 32px; height: 32px; border-radius: 8px; border: none; font-size: 16px; cursor: pointer; transition: all 0.3s; background: linear-gradient(145deg, #2a2a2a 0%, #0a0a0a 50%, #1a1a1a 100%); box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.1), inset 0 -1px 0 rgba(0, 0, 0, 0.5), 0 2px 4px rgba(0, 0, 0, 0.8);">🔥</button>
        <button class="reaction-btn" id="btn-laugh" style="min-width: 32px; height: 32px; border-radius: 8px; border: none; font-size: 16px; cursor: pointer; transition: all 0.3s; background: linear-gradient(145deg, #2a2a2a 0%, #0a0a0a 50%, #1a1a1a 100%); box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.1), inset 0 -1px 0 rgba(0, 0, 0, 0.5), 0 2px 4px rgba(0, 0, 0, 0.8);">😂</button>
        <button class="reaction-btn" id="btn-party" style="min-width: 32px; height: 32px; border-radius: 8px; border: none; font-size: 16px; cursor: pointer; transition: all 0.3s; background: linear-gradient(145deg, #2a2a2a 0%, #0a0a0a 50%, #1a1a1a 100%); box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.1), inset 0 -1px 0 rgba(0, 0, 0, 0.5), 0 2px 4px rgba(0, 0, 0, 0.8);">🎉</button>
        
        <!-- Special Reactions -->
        <button class="reaction-btn" id="btn-heel" style="min-width: 32px; height: 32px; border-radius: 8px; border: none; font-size: 16px; cursor: pointer; transition: all 0.3s; background: linear-gradient(145deg, #2a2a2a 0%, #0a0a0a 50%, #1a1a1a 100%); box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.1), inset 0 -1px 0 rgba(0, 0, 0, 0.5), 0 2px 4px rgba(0, 0, 0, 0.8);">👠</button>
        <button class="reaction-btn" id="btn-pride" style="min-width: 32px; height: 32px; border-radius: 8px; border: none; font-size: 16px; cursor: pointer; transition: all 0.3s; background: linear-gradient(145deg, #2a2a2a 0%, #0a0a0a 50%, #1a1a1a 100%); box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.1), inset 0 -1px 0 rgba(0, 0, 0, 0.5), 0 2px 4px rgba(0, 0, 0, 0.8);">🏳️‍🌈</button>
        
        <!-- Text Reactions -->
        <button class="reaction-btn text" id="btn-sf" style="min-width: 32px; height: 32px; border-radius: 8px; border: none; padding: 0 8px; color: #999; font-weight: bold; font-size: 11px; cursor: pointer; transition: all 0.3s; background: linear-gradient(145deg, #2a2a2a 0%, #0a0a0a 50%, #1a1a1a 100%); box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.1), inset 0 -1px 0 rgba(0, 0, 0, 0.5), 0 2px 4px rgba(0, 0, 0, 0.8);">SF</button>
        
        <!-- Money Reactions -->
        <button class="reaction-btn money" id="btn-money1" style="min-width: 32px; height: 32px; border-radius: 8px; border: none; padding: 0 8px; color: #888; font-weight: bold; font-size: 11px; cursor: pointer; transition: all 0.3s; background: linear-gradient(145deg, #2a2a2a 0%, #0a0a0a 50%, #1a1a1a 100%); box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.1), inset 0 -1px 0 rgba(0, 0, 0, 0.5), 0 2px 4px rgba(0, 0, 0, 0.8);">$1</button>
        <button class="reaction-btn money" id="btn-money5" style="min-width: 32px; height: 32px; border-radius: 8px; border: none; padding: 0 8px; color: #888; font-weight: bold; font-size: 11px; cursor: pointer; transition: all 0.3s; background: linear-gradient(145deg, #2a2a2a 0%, #0a0a0a 50%, #1a1a1a 100%); box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.1), inset 0 -1px 0 rgba(0, 0, 0, 0.5), 0 2px 4px rgba(0, 0, 0, 0.8);">$5</button>
            <button class="reaction-btn money" id="btn-money10" style="min-width: 32px; height: 32px; border-radius: 8px; border: none; padding: 0 8px; color: #888; font-weight: bold; font-size: 11px; cursor: pointer; transition: all 0.3s; background: linear-gradient(145deg, #2a2a2a 0%, #0a0a0a 50%, #1a1a1a 100%); box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.1), inset 0 -1px 0 rgba(0, 0, 0, 0.5), 0 2px 4px rgba(0, 0, 0, 0.8);">$10</button>
        </div>
        
        <!-- Chat Input Row -->
        <div class="chat-input-row" style="display: flex; gap: 10px; justify-content: center; align-items: center; padding: 8px 0;">
            <input type="text" id="chatInputBottom" placeholder="Type a message..." style="width: 400px; max-width: 60vw; padding: 12px 20px; background: rgba(255, 255, 255, 0.08); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 25px; color: white; outline: none;" onkeypress="if(event.key==='Enter') sendBottomMessage()">
            <button id="send-button" onclick="sendBottomMessage()" style="padding: 12px 24px; background: linear-gradient(135deg, #ff0066, #ff3399); border: none; border-radius: 25px; color: white; cursor: pointer; font-weight: 700; white-space: nowrap;">Send</button>
        </div>
    </div>


    <!-- TOP GRID OVERLAY - Numbers -->
    <!-- Three Black Buttons -->
    <button class="main-button button-top" onclick="toggleGrid('top')">+</button>
    <button class="main-button button-middle" onclick="toggleGrid('middle')">+</button>
    <button class="main-button button-bottom" onclick="toggleGrid('bottom')">+</button>

    <!-- Top Grid -->
    <div class="grid-overlay" id="grid-top">
        <button class="close-button" onclick="closeGrid('top')">×</button>
        <div class="grid-container" id="grid-top-container"></div>
    </div>

    <!-- Middle Grid -->
    <div class="grid-overlay" id="grid-middle">
        <button class="close-button" onclick="closeGrid('middle')">×</button>
        <div class="grid-container" id="grid-middle-container"></div>
    </div>

    <!-- Bottom Grid - 64 CHAT EFFECTS -->
    <div class="grid-overlay" id="grid-bottom">
        <button class="close-button" onclick="closeGrid('bottom')">×</button>
        <div class="grid-container" id="grid-bottom-container"></div>
    </div>

    <!-- HOVER PROFILE CARD -->
    <div class="profile-hover" id="profileHover">
        <div class="profile-header">
            <div class="profile-avatar" id="hoverAvatar">👤</div>
            <div class="profile-info">
                <div class="profile-name" id="hoverName">Party Person</div>
                <div class="profile-status">🟢 At the venue</div>
            </div>
        </div>
        
        <div class="social-actions">
            <button class="social-btn" onclick="sendDrink()">
                <span>🍹</span>
                Buy Drink
            </button>
            <button class="social-btn" onclick="inviteToTable()">
                <span>🍾</span>
                Table Invite
            </button>
            <button class="social-btn" onclick="giftTicket()">
                <span>🎟️</span>
                Gift Ticket
            </button>
            <button class="social-btn primary" onclick="startChat()">
                <span>💬</span>
                Start Chat
            </button>
            <button class="social-btn" onclick="startVideo()">
                <span>📹</span>
                Video
            </button>
        </div>
        
        <!-- Fun Actions -->
        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; margin-bottom: 10px;">
            <button onclick="sendVibe('fire')" style="background: rgba(255,0,102,0.2); border: 1px solid rgba(255,0,102,0.3); padding: 8px; border-radius: 8px; color: white; cursor: pointer; font-size: 16px;">🔥</button>
            <button onclick="sendVibe('heart')" style="background: rgba(255,0,102,0.2); border: 1px solid rgba(255,0,102,0.3); padding: 8px; border-radius: 8px; color: white; cursor: pointer; font-size: 16px;">❤️</button>
            <button onclick="sendVibe('dance')" style="background: rgba(255,0,102,0.2); border: 1px solid rgba(255,0,102,0.3); padding: 8px; border-radius: 8px; color: white; cursor: pointer; font-size: 16px;">💃</button>
            <button onclick="sendVibe('cheers')" style="background: rgba(255,0,102,0.2); border: 1px solid rgba(255,0,102,0.3); padding: 8px; border-radius: 8px; color: white; cursor: pointer; font-size: 16px;">🥂</button>
        </div>
        
        <!-- Special Actions -->
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 6px;">
            <button onclick="challengeDance()" style="background: linear-gradient(135deg, #9933ff, #6600cc); border: none; padding: 10px; border-radius: 10px; color: white; cursor: pointer; font-size: 11px; font-weight: bold;">⚡ Dance Battle</button>
            <button onclick="soulSync()" style="background: linear-gradient(45deg, #ff0066, #00ff88, #ffcc00); border: none; padding: 10px; border-radius: 10px; color: white; cursor: pointer; font-size: 11px; font-weight: bold;">🧬 Soul Sync</button>
        </div>
    </div>

    <!-- Pin Popup -->
    <div class="pin-popup" id="pinPopup">
        <h3 style="margin: 0 0 10px 0; font-size: 14px; color: #ff0066;">Drop Your Pin</h3>
        <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 6px; margin-bottom: 10px;">
            <button class="pin-type-btn" data-type="memory" data-color="#0066ff" style="border-color: #0066ff;">📸</button>
            <button class="pin-type-btn" data-type="song" data-color="#ffcc00" style="border-color: #ffcc00;">🎵</button>
            <button class="pin-type-btn" data-type="moment" data-color="#ff0066" style="border-color: #ff0066;">🔥</button>
            <button class="pin-type-btn" data-type="dream" data-color="#00ff88" style="border-color: #00ff88;">💭</button>
            <button class="pin-type-btn" data-type="promo" data-color="#9933ff" style="border-color: #9933ff;">🎉</button>
        </div>
        
        <!-- IMAGE UPLOAD SECTION -->
        <div style="margin-bottom: 10px;">
            <label for="pinImage" style="display: block; width: 100%; padding: 20px; background: rgba(255,255,255,0.05); border: 2px dashed rgba(255,255,255,0.2); border-radius: 8px; text-align: center; cursor: pointer; transition: all 0.3s;">
                <div id="imagePreview" style="display: none; margin-bottom: 10px;">
                    <img id="previewImg" style="max-width: 100%; max-height: 150px; border-radius: 8px;">
                </div>
                <span id="uploadText">📷 Add Photo</span>
                <input type="file" id="pinImage" accept="image/*" style="display: none;" onchange="previewImage(this)">
            </label>
        </div>
        
        <input type="text" id="pinCaption" placeholder="What's happening?" style="width: 100%; padding: 8px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: white; margin-bottom: 10px;">
        
        <div style="display: flex; gap: 8px;">
            <button onclick="closePopup()" style="flex: 1; padding: 8px; background: rgba(255,255,255,0.1); border: none; border-radius: 8px; color: white; cursor: pointer;">Cancel</button>
            <button onclick="dropPin()" style="flex: 1; padding: 8px; background: linear-gradient(135deg, #ff0066, #ff3399); border: none; border-radius: 8px; color: white; cursor: pointer;">Drop</button>
        </div>
    </div>

    <!-- GROUP CHAT BUBBLE -->
    <div style="position: fixed; background: rgba(30, 30, 30, 0.98); backdrop-filter: blur(20px); border-radius: 20px; padding: 15px; color: white; z-index: 4000; box-shadow: 0 20px 60px rgba(0,0,0,0.8); border: 2px solid #00ff88; width: 300px; max-height: 400px; display: none; bottom: 350px; right: 20px;" id="groupChat">
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid rgba(255,255,255,0.1);">
            <div style="display: flex; gap: -10px;" id="groupMembers">
                <div style="width: 30px; height: 30px; border-radius: 50%; border: 2px solid #000; background: #ff0066; display: flex; align-items: center; justify-content: center; font-size: 12px;">👤</div>
                <div style="width: 30px; height: 30px; border-radius: 50%; border: 2px solid #000; background: #00ff88; display: flex; align-items: center; justify-content: center; font-size: 12px;">👤</div>
            </div>
            <div style="display: flex; gap: 8px;">
                <button onclick="inviteToGroup()" style="background: none; border: none; color: #00ff88; cursor: pointer;">➕ Invite</button>
                <button onclick="closeGroupChat()" style="background: none; border: none; color: #ff0066; cursor: pointer;">✕</button>
            </div>
        </div>
        
        <div style="max-height: 200px; overflow-y: auto; margin-bottom: 10px;" id="chatMessages">
            <div style="background: rgba(255,255,255,0.05); padding: 8px; border-radius: 10px; margin-bottom: 5px; font-size: 12px;">
                <strong>You:</strong> This DJ is fire! 🔥
            </div>
            <div style="background: rgba(255,255,255,0.05); padding: 8px; border-radius: 10px; margin-bottom: 5px; font-size: 12px;">
                <strong>Alex:</strong> Let's meet at the bar!
            </div>
        </div>
        
        <div style="display: flex; gap: 8px;">
            <input type="text" placeholder="Type a message..." id="groupChatInput" style="flex: 1; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); padding: 8px; border-radius: 20px; color: white; font-size: 12px;" onkeypress="if(event.key==='Enter') sendGroupMessage()">
            <button onclick="sendGroupMessage()" style="background: #00ff88; border: none; padding: 8px 15px; border-radius: 20px; color: #000; font-weight: bold; cursor: pointer;">Send</button>
        </div>
    </div>






    <script>
        // State
        let currentMode = 'explore';
        let pins = [];
        let onlineUsers = [];
        let myPosition = { x: window.innerWidth / 2, y: window.innerHeight / 2 };
    let isDragging = false;
    // Remote controller: default to viewer/host; set to true on phone controller
    let CONTROLLER_MODE = false;
    let selectedType = null;
    let selectedColor = null;
    let pendingPosition = null;
    let selectedImage = null; // previewed image data URL

         const RC = { sb: null, channel: null, room: null, role: null, lastSend: 0 };
         
         // Multi-user presence system
         const otherUsers = new Map(); // Store other users' characters
         let myUserId = 'user_' + Math.random().toString(36).substr(2, 9);
         let presenceChannel = null;
     </script>
 
     <script>
     const myCharacter = document.getElementById('myCharacter');
    const joystick = document.getElementById('joystick');
    const knob = document.getElementById('knob');
    // Show joystick UI alongside finger/mouse drag controls
    // (leave visible by default)
        
        // Character animation variables
        let posX = window.innerWidth / 2;
        let posY = window.innerHeight / 2;
        let velocityX = 0;
        let velocityY = 0;
        let characterMode = 'walking';
        let joystickX = 0;
        let joystickY = 0;







        // Mode switching for character animations
        setTimeout(() => {
            const characterModeButtons = document.querySelectorAll('.mode-btn[data-mode="walking"], .mode-btn[data-mode="runway"], .mode-btn[data-mode="breakdance"]');
            characterModeButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    // Remove active from character mode buttons only
                    characterModeButtons.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    
                    // Remove all character mode classes
                    if (myCharacter) {
                        myCharacter.classList.remove('walking', 'runway', 'breakdance');
                        characterMode = btn.dataset.mode;
                        
                        // Add new mode class if moving
                        if (velocityX !== 0 || velocityY !== 0) {
                            myCharacter.classList.add(characterMode);
                        }
                    }
                });
            });
        }, 100);
        
        // Joystick controls with enhanced character animations (legacy - kept for keyboard fallback)
        function handleJoystickStart(e) {
            isDragging = true;
            handleJoystickMove(e);
            if (CONTROLLER_MODE && RC.channel) {
                sendRC(0, 0);
            }
        }
        // ===== Remote Control helpers =====
        function initRemoteControl() {
            try {
                const usp = new URLSearchParams(window.location.search);
                const SUPABASE_URL = window.SUPABASE_URL;
                const SUPABASE_ANON = window.SUPABASE_ANON_KEY;
                const sbAvailable = Boolean(window.supabase && SUPABASE_URL && !SUPABASE_URL.includes('%%'));
                if (!sbAvailable) {
                    // Hide pair button if we can't use realtime
                    const b = document.getElementById('btnPairController');
                    if (b) b.style.display = 'none';
                    console.log('⚠️ Supabase not configured - realtime features disabled');
                    return;
                }

                RC.sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON, { realtime: { params: { eventsPerSecond: 20 } } });

                const isController = usp.get('controller') === '1';
                const room = usp.get('room');

                if (isController && room) {
                    CONTROLLER_MODE = true;
                    RC.role = 'controller';
                    // Simplify UI for controller
                    const header = document.querySelector('.header');
                    if (header) header.style.display = 'none';
                    // Join the specified room immediately
                    joinRC(room);
                }

                // Initialize multi-user presence (optional; behind separate flag further below)
                initMultiUserPresence();
            } catch (e) { console.warn('Remote control init error', e); }
        }
         
         // Multi-user presence system
         function initMultiUserPresence() {
             if (!RC.sb) return;
             
             console.log('🎭 Initializing multi-user presence...');
             
             // Create or join the main club room
             presenceChannel = RC.sb.channel('club_main_floor', {
                 config: { presence: { key: myUserId } }
             });
             
             // Track when users join
             presenceChannel.on('presence', { event: 'join' }, ({ key, newPresences }) => {
                 newPresences.forEach(presence => {
                     if (presence.user_id !== myUserId) {
                         console.log('👋 User joined:', presence.user_id);
                         createOtherUserCharacter(presence.user_id, presence.x || 300, presence.y || 200);
                         showToast(`👋 ${presence.name || 'Someone'} joined!`);
                     }
                 });
             });
             
             // Track when users leave
             presenceChannel.on('presence', { event: 'leave' }, ({ key, leftPresences }) => {
                 leftPresences.forEach(presence => {
                     console.log('👋 User left:', presence.user_id);
                     removeOtherUserCharacter(presence.user_id);
                 });
             });
             
             // Track movement updates
             presenceChannel.on('broadcast', { event: 'user_moved' }, ({ payload }) => {
                 if (payload.user_id !== myUserId) {
                     updateOtherUserPosition(payload.user_id, payload.x, payload.y, payload.flip);
                 }
             });
             
             // Subscribe and announce presence
             presenceChannel.subscribe(async (status) => {
                 if (status === 'SUBSCRIBED') {
                     console.log('✅ Connected to multi-user room!');
                     
                     // Get current character position
                     const charRect = myCharacter.getBoundingClientRect();
                     
                     // Track this user's presence
                     await presenceChannel.track({
                         user_id: myUserId,
                         name: 'User ' + myUserId.slice(-4),
                         x: charRect.left,
                         y: charRect.top,
                         online_at: new Date().toISOString()
                     });
                     
                     showToast('🌐 Connected! You can now see other users');
                 }
             });
             
             // Broadcast position updates periodically
             setInterval(() => {
                 broadcastMyPosition();
             }, 100); // 10 times per second
         }
         
         // Create another user's character element
         function createOtherUserCharacter(userId, x, y) {
             if (otherUsers.has(userId)) return; // Already exists
             
             const char = document.createElement('div');
             char.className = 'person other-user';
             char.id = 'user_' + userId;
             char.style.position = 'fixed';
             char.style.left = x + 'px';
             char.style.top = y + 'px';
             char.style.transition = 'all 0.1s linear';
             char.style.opacity = '0.8';
             
             // Add shadow
             const shadow = document.createElement('div');
             shadow.className = 'shadow';
             char.appendChild(shadow);
             
             // Add name label
             const label = document.createElement('div');
             label.style.position = 'absolute';
             label.style.bottom = '-20px';
             label.style.left = '50%';
             label.style.transform = 'translateX(-50%)';
             label.style.fontSize = '10px';
             label.style.color = '#00ff88';
             label.style.textShadow = '0 0 5px #000';
             label.style.whiteSpace = 'nowrap';
             label.textContent = 'User ' + userId.slice(-4);
             char.appendChild(label);
             
             document.querySelector('.blueprint-view').appendChild(char);
             otherUsers.set(userId, { element: char, x, y });
             
             console.log('✅ Created character for user:', userId);
         }
         
         // Update another user's position
         function updateOtherUserPosition(userId, x, y, flip) {
             const user = otherUsers.get(userId);
             if (!user) {
                 createOtherUserCharacter(userId, x, y);
                 return;
             }
             
             user.element.style.left = x + 'px';
             user.element.style.top = y + 'px';
             
             // Handle flip
             if (flip !== undefined) {
                 user.element.style.transform = flip ? 'scaleX(-1)' : 'scaleX(1)';
             }
             
             // Add walking class if moved significantly
             const dx = Math.abs(x - user.x);
             const dy = Math.abs(y - user.y);
             if (dx > 2 || dy > 2) {
                 user.element.classList.add('walking');
             } else {
                 user.element.classList.remove('walking');
             }
             
             user.x = x;
             user.y = y;
         }
         
         // Remove a user's character
         function removeOtherUserCharacter(userId) {
             const user = otherUsers.get(userId);
             if (user && user.element) {
                 user.element.remove();
                 otherUsers.delete(userId);
                 showToast(`👋 User ${userId.slice(-4)} left`);
             }
         }
         
         // Broadcast my current position to other users
         function broadcastMyPosition() {
             if (!presenceChannel) return;
             
             const charRect = myCharacter.getBoundingClientRect();
             const isFlipped = myCharacter.style.transform.includes('scaleX(-1)');
             
             presenceChannel.send({
                 type: 'broadcast',
                 event: 'user_moved',
                 payload: {
                     user_id: myUserId,
                     x: charRect.left,
                     y: charRect.top,
                     flip: isFlipped
                 }
             });
         }

        function joinRC(room) {
            if (!RC.sb) return;
            try {
                if (RC.channel) {
                    try { RC.sb.removeChannel(RC.channel); } catch (_) {}
                }
                RC.room = room;
                RC.channel = RC.sb.channel(`rc:${room}`);

                // Host receives controller input and drives local character
                RC.channel.on('broadcast', { event: 'move' }, ({ payload }) => {
                    if (RC.role === 'controller') return; // controllers don't apply incoming moves
                    const { dx = 0, dy = 0 } = payload || {};
                    // Clamp values just in case
                    const ndx = Math.max(-1, Math.min(1, Number(dx)));
                    const ndy = Math.max(-1, Math.min(1, Number(dy)));
                    joystickX = ndx;
                    joystickY = ndy;
                    // Visual knob feedback
                    if (joystick && knob) {
                        const rect = joystick.getBoundingClientRect();
                        const maxDistance = rect.width / 2 - 20;
                        const px = ndx * maxDistance;
                        const py = ndy * maxDistance;
                        knob.style.transform = `translate(calc(-50% + ${px}px), calc(-50% + ${py}px))`;
                    }
                    // Animate character based on movement
                    if (Math.abs(joystickX) > 0.1 || Math.abs(joystickY) > 0.1) {
                        if (!myCharacter.classList.contains(characterMode)) {
                            myCharacter.classList.add(characterMode);
                        }
                    } else {
                        myCharacter.classList.remove('walking', 'runway', 'breakdance');
                    }
                });

                RC.channel.subscribe((status) => {
                    if (status === 'SUBSCRIBED') {
                        console.log(`🔗 Joined RC room ${room} as ${RC.role || 'host'}`);
                    }
                });
            } catch (e) { console.warn('joinRC error', e); }
        }

        function sendRC(dx, dy) {
            const now = Date.now();
            if (!RC.channel) return;
            if (now - RC.lastSend < 50) return; // throttle ~20 fps
            RC.lastSend = now;
            try {
                RC.channel.send({ type: 'broadcast', event: 'move', payload: { dx, dy, t: now } });
            } catch (e) { /* ignore */ }
        }

        function openControllerPairing() {
            if (!window.supabase || !window.SUPABASE_URL || window.SUPABASE_URL.includes('%%')) {
                showToast('⚠️ Realtime not configured. Add SUPABASE_URL and SUPABASE_ANON_KEY in Netlify.');
                return;
            }
            const code = Math.random().toString(36).slice(2, 6).toUpperCase();
            RC.role = 'host';
            joinRC(code);

            const origin = window.location.origin + window.location.pathname;
            const link = `${origin}?controller=1&room=${encodeURIComponent(code)}`;
            const modal = document.getElementById('pairModal');
            const codeEl = document.getElementById('pairCode');
            const wrap = document.getElementById('pairLinkWrap');
            const details = document.getElementById('pairDetails');
            const copyBtn = document.getElementById('copyPairLink');
            const openBtn = document.getElementById('openPairLink');

            if (details) details.textContent = 'Open this link on your phone to control the avatar:';
            if (codeEl) codeEl.textContent = code;
            if (wrap) wrap.textContent = link;
            if (copyBtn) copyBtn.onclick = () => { navigator.clipboard.writeText(link).then(() => showToast('🔗 Link copied')); };
            if (openBtn) openBtn.onclick = () => { window.open(link, '_blank'); };
            if (modal) modal.style.display = 'flex';
        }
    function closePairModal(){ const m = document.getElementById('pairModal'); if (m) m.style.display = 'none'; }

    // Initialize remote control mode early
    initRemoteControl();
        
        function handleJoystickMove(e) {
            if (!isDragging) return;
            
            const rect = joystick.getBoundingClientRect();
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;
            
            let clientX, clientY;
            if (e.touches) {
                clientX = e.touches[0].clientX;
                clientY = e.touches[0].clientY;
            } else {
                clientX = e.clientX;
                clientY = e.clientY;
            }
            
            let deltaX = clientX - centerX;
            let deltaY = clientY - centerY;
            
            // Limit to circle
            const distance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);
            const maxDistance = rect.width / 2 - 20;
            
            if (distance > maxDistance) {
                deltaX = (deltaX / distance) * maxDistance;
                deltaY = (deltaY / distance) * maxDistance;
            }
            
            // Update knob position
            knob.style.transform = `translate(calc(-50% + ${deltaX}px), calc(-50% + ${deltaY}px))`;
            
            // Set velocity based on joystick position
            joystickX = deltaX / maxDistance;
            joystickY = deltaY / maxDistance;
            if (CONTROLLER_MODE && RC.channel) {
                sendRC(joystickX, joystickY);
            }
            
            // Add or remove animation class
            if (Math.abs(joystickX) > 0.1 || Math.abs(joystickY) > 0.1) {
                if (!myCharacter.classList.contains(characterMode)) {
                    myCharacter.classList.add(characterMode);
                }
            } else {
                myCharacter.classList.remove('walking', 'runway', 'breakdance');
            }
        }
        
        function handleJoystickEnd() {
            isDragging = false;
            knob.style.transform = 'translate(-50%, -50%)';
            joystickX = 0;
            joystickY = 0;
            myCharacter.classList.remove('walking', 'runway', 'breakdance');
            if (CONTROLLER_MODE && RC.channel) {
                sendRC(0, 0);
            }
        }
        
        // Touch events
        joystick.addEventListener('touchstart', handleJoystickStart);
        joystick.addEventListener('touchmove', handleJoystickMove);
        joystick.addEventListener('touchend', handleJoystickEnd);
        
        // Mouse events
        joystick.addEventListener('mousedown', handleJoystickStart);
        document.addEventListener('mousemove', handleJoystickMove);
        document.addEventListener('mouseup', handleJoystickEnd);

        // =========================
        // Finger/Mouse Drag Movement
        // =========================
        (function setupFingerMovement(){
            const stage = document.querySelector('.blueprint-view');
            if (!stage || !myCharacter) return;

            let fingerDragging = false;

            function isOverUI(target){
                return (
                    target.closest('.bottom-layout') ||
                    target.closest('.profile-hover') ||
                    target.closest('.pin-popup') ||
                    target.closest('.grid-overlay.active') ||
                    target.closest('#groupChat') ||
                    target.closest('.toast')
                );
            }

            function getPoint(e){
                let x, y;
                if (e.touches && e.touches[0]){
                    x = e.touches[0].clientX;
                    y = e.touches[0].clientY;
                } else {
                    x = e.clientX;
                    y = e.clientY;
                }
                return { x, y };
            }

            function clampX(x){
                return Math.max(20, Math.min(window.innerWidth - 20, x));
            }
            function clampY(y){
                // keep clear of bottom UI
                return Math.max(30, Math.min(window.innerHeight - 150, y));
            }

            function onFingerStart(e){
                if (currentMode === 'drop') return; // preserve tap-to-drop behavior
                if (isOverUI(e.target)) return;
                fingerDragging = true;
                const p = getPoint(e);
                // Start moving immediately
                posX = clampX(p.x);
                posY = clampY(p.y);
                myCharacter.style.left = posX + 'px';
                myCharacter.style.top = posY + 'px';
                // Show movement animation for current character mode
                if (!myCharacter.classList.contains(characterMode)) {
                    myCharacter.classList.add(characterMode);
                }
                // Prevent page scroll on touch
                if (e.cancelable) e.preventDefault();
            }

            function onFingerMove(e){
                if (!fingerDragging) return;
                const p = getPoint(e);
                const newX = clampX(p.x);
                const newY = clampY(p.y);
                // Compute direction for rotation
                const dx = newX - posX;
                const dy = newY - posY;
                posX = newX;
                posY = newY;
                myCharacter.style.left = posX + 'px';
                myCharacter.style.top = posY + 'px';
                if ((Math.abs(dx) + Math.abs(dy)) > 0.1 && characterMode !== 'breakdance'){
                    const angle = Math.atan2(dy, dx) * (180/Math.PI) + 90;
                    myCharacter.style.transform = `translate(-50%, -50%) rotate(${angle}deg)`;
                }
                if (e.cancelable) e.preventDefault();
            }

            function onFingerEnd(){
                if (!fingerDragging) return;
                fingerDragging = false;
                myCharacter.classList.remove('walking', 'runway', 'breakdance');
            }

            // Touch events
            stage.addEventListener('touchstart', onFingerStart, { passive: false });
            document.addEventListener('touchmove', onFingerMove, { passive: false });
            document.addEventListener('touchend', onFingerEnd);
            // Mouse events
            stage.addEventListener('mousedown', onFingerStart);
            document.addEventListener('mousemove', onFingerMove);
            document.addEventListener('mouseup', onFingerEnd);
        })();
        
        // Keyboard controls for iPhone/mobile and desktop
        const keysPressed = {};
        document.addEventListener('keydown', (e) => {
            keysPressed[e.key.toLowerCase()] = true;
            
            // Update joystick position based on keys
            let newX = 0, newY = 0;
            if (keysPressed['w'] || keysPressed['arrowup']) newY = -1;
            if (keysPressed['s'] || keysPressed['arrowdown']) newY = 1;
            if (keysPressed['a'] || keysPressed['arrowleft']) newX = -1;
            if (keysPressed['d'] || keysPressed['arrowright']) newX = 1;
            
            if (newX !== 0 || newY !== 0) {
                joystickX = newX;
                joystickY = newY;
                myCharacter.classList.add('walking');
                
                // Move knob to show keyboard input
                const knob = document.querySelector('.joystick-knob');
                knob.style.transform = `translate(-50%, -50%) translate(${newX * 30}px, ${newY * 30}px)`;
            }
        });
        
        document.addEventListener('keyup', (e) => {
            keysPressed[e.key.toLowerCase()] = false;
            
            // Check if any movement keys are still pressed
            const stillMoving = keysPressed['w'] || keysPressed['s'] || keysPressed['a'] || keysPressed['d'] ||
                              keysPressed['arrowup'] || keysPressed['arrowdown'] || keysPressed['arrowleft'] || keysPressed['arrowright'];
            
            if (!stillMoving) {
                joystickX = 0;
                joystickY = 0;
                myCharacter.classList.remove('walking', 'runway', 'breakdance');
                
                // Reset knob position
                const knob = document.querySelector('.joystick-knob');
                knob.style.transform = 'translate(-50%, -50%)';
            }
        });
        
        // Animation loop
        function animate() {
            if (!myCharacter) return;
            
            // Update velocity based on joystick
            const speed = characterMode === 'runway' ? 3 : characterMode === 'breakdance' ? 2 : 4;
            velocityX = joystickX * speed;
            velocityY = joystickY * speed;
            
            // Update position
            posX += velocityX;
            posY += velocityY;
            
            // Keep on screen and avoid chat area at bottom
            posX = Math.max(20, Math.min(window.innerWidth - 20, posX));
            posY = Math.max(30, Math.min(window.innerHeight - 150, posY));
            
            // Update character position
            myCharacter.style.left = posX + 'px';
            myCharacter.style.top = posY + 'px';
            
            // Update myPosition for other systems
            myPosition.x = posX;
            myPosition.y = posY;
            
            // Rotate character based on movement direction
            if (Math.abs(velocityX) > 0.1 || Math.abs(velocityY) > 0.1) {
                const angle = Math.atan2(velocityY, velocityX) * (180 / Math.PI) + 90;
                if (characterMode !== 'breakdance') {
                    myCharacter.style.transform = `translate(-50%, -50%) rotate(${angle}deg)`;
                }
            }
            
            requestAnimationFrame(animate);
        }
        
        // Initialize character position
        if (myCharacter) {
            posX = myPosition.x;
            posY = myPosition.y;
            myCharacter.style.left = posX + 'px';
            myCharacter.style.top = posY + 'px';
        }
        
        // Start animation loop
        animate();

        // Mode toggle (Explore / Drop)
        document.querySelectorAll('.mode-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                currentMode = btn.dataset.mode;
                document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                // No live mode; two modes only
            });
        });

        // Click to drop pin
        document.querySelector('.blueprint-view').addEventListener('click', (e) => {
            if (currentMode !== 'drop') return;
            if (e.target.classList.contains('person')) return;
            if (pins.length >= 5) {
                showToast('Max 5 pins! Delete one first.');
                return;
            }

            pendingPosition = { x: e.clientX, y: e.clientY };
            const popup = document.getElementById('pinPopup');
            popup.style.display = 'block';
            popup.style.left = Math.min(e.clientX - 140, window.innerWidth - 300) + 'px';
            popup.style.top = Math.min(e.clientY - 100, window.innerHeight - 250) + 'px';
        });

        // Pin type selection
        document.querySelectorAll('.pin-type-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.pin-type-btn').forEach(b => {
                    b.style.transform = 'scale(1)';
                    b.style.boxShadow = 'none';
                });
                btn.style.transform = 'scale(1.1)';
                btn.style.boxShadow = '0 0 15px ' + btn.dataset.color;
                selectedType = btn.dataset.type;
                selectedColor = btn.dataset.color;
            });
        });

        function closePopup() {
            document.getElementById('pinPopup').style.display = 'none';
            document.getElementById('pinCaption').value = '';
            document.getElementById('imagePreview').style.display = 'none';
            document.getElementById('uploadText').textContent = '📷 Add Photo';
            document.getElementById('pinImage').value = '';
            selectedType = null;
            selectedColor = null;
            selectedImage = null;
        }

        // Preview uploaded image
        function previewImage(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const imgEl = document.getElementById('previewImg');
                    const prevWrap = document.getElementById('imagePreview');
                    if (imgEl && prevWrap) {
                        imgEl.src = e.target.result;
                        prevWrap.style.display = 'block';
                    }
                    const label = document.getElementById('uploadText');
                    if (label) label.textContent = '✅ Photo Added';
                    selectedImage = e.target.result;
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function dropPin() {
            if (!selectedType) return showToast('Select a pin type!');

            const caption = document.getElementById('pinCaption').value;
            const pin = document.createElement('div');
            pin.className = 'pin';
            pin.style.left = pendingPosition.x + 'px';
            pin.style.top = pendingPosition.y + 'px';
            pin.style.background = selectedColor;
            pin.style.color = selectedColor;
            pin.dataset.caption = caption;
            pin.dataset.type = selectedType;
            
            // Add photo indicator if image was uploaded
            if (selectedImage) {
                pin.dataset.image = selectedImage;
                pin.style.width = '12px';
                pin.style.height = '12px';
                pin.innerHTML = '<span style="position: absolute; top: -18px; left: -5px; font-size: 10px;">📷</span>';
            }

            attachPinHandlers(pin);
            // Hover info on pins using the rich card
            pin.addEventListener('mouseenter', (e)=>{
                const title = pin.dataset.caption || `${pin.dataset.type} pin`;
                showProfileHoverNear(pin, { name: title, avatar: '📍' });
            });
            pin.addEventListener('mouseleave', ()=>{
                setTimeout(()=>{
                    const hover = document.getElementById('profileHover');
                    if (!hover.matches(':hover')) hideProfileHoverCard();
                }, 120);
            });

            document.getElementById('pinOverlay').appendChild(pin);
            pins.push(pin);
            const pc = document.getElementById('pinCount');
            if (pc) pc.textContent = pins.length;
            closePopup();
            showToast(selectedImage ? '📷 Photo pin dropped!' : '📍 Pin dropped!');
        }

        // Add handlers for pin interactions (view/delete)
        function attachPinHandlers(pin){
            // View on click
            pin.addEventListener('click', (e) => {
                e.stopPropagation();
                if (pin.dataset.image) {
                    showPinImage(pin);
                } else {
                    const title = pin.dataset.caption || `${pin.dataset.type} pin`;
                    showToast(`📍 ${title}`);
                }
            });
            // Delete on double-click (desktop)
            pin.addEventListener('dblclick', (e) => {
                e.stopPropagation();
                if (confirm('Delete this pin?')) deletePin(pin);
            });
            // Right-click context to delete
            pin.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                e.stopPropagation();
                if (confirm('Delete this pin?')) deletePin(pin);
            });
            // Long-press (mobile) to delete
            let holdTimer;
            pin.addEventListener('touchstart', (e) => {
                holdTimer = setTimeout(() => {
                    if (confirm('Delete this pin?')) deletePin(pin);
                }, 600);
            });
            pin.addEventListener('touchend', () => clearTimeout(holdTimer));
            pin.addEventListener('touchmove', () => clearTimeout(holdTimer));
        }

        function deletePin(pin){
            try { pin.remove(); } catch(_){}
            const idx = pins.indexOf(pin);
            if (idx > -1) pins.splice(idx, 1);
            const pc = document.getElementById('pinCount');
            if (pc) pc.textContent = pins.length;
            showToast('🗑️ Pin deleted');
        }

        // Show pin image in modal
        function showPinImage(pin) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.9);
                z-index: 5000;
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
            `;
            
            const img = document.createElement('img');
            img.src = pin.dataset.image;
            img.style.cssText = `
                max-width: 90%;
                max-height: 90%;
                border-radius: 10px;
                box-shadow: 0 0 30px rgba(255,0,102,0.5);
            `;
            
            const caption = document.createElement('div');
            caption.textContent = pin.dataset.caption || '';
            caption.style.cssText = `
                position: absolute;
                bottom: 30px;
                left: 50%;
                transform: translateX(-50%);
                color: white;
                padding: 10px 20px;
                background: rgba(0,0,0,0.8);
                border-radius: 20px;
                font-size: 14px;
            `;
            
            modal.appendChild(img);
            if (pin.dataset.caption) modal.appendChild(caption);
            
            modal.onclick = () => modal.remove();
            document.body.appendChild(modal);
        }

        function changeFloor(floor) {
            // Hide all floor backgrounds
            const floors = document.querySelectorAll('.floor-svg');
            floors.forEach(f => f.style.display = 'none');
            
            // Show selected floor
            const selectedFloor = document.getElementById('floor-' + floor.toLowerCase());
            if (selectedFloor) {
                selectedFloor.style.display = 'block';
            }
            
            // Update button states
            document.querySelectorAll('.floor-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            showToast(`Moving to floor ${floor}`);
        }

        // Social Actions
        function sendDrink() {
            showToast('🍹 Drink sent!');
            document.getElementById('profileHover').style.display = 'none';
        }

        function inviteToTable() {
            showToast('🍾 Table invite sent!');
            document.getElementById('profileHover').style.display = 'none';
        }

        function giftTicket() {
            showToast('🎟️ Ticket gifted!');
            document.getElementById('profileHover').style.display = 'none';
        }

        function startChat() {
            showToast('💬 Chat started!');
            document.getElementById('profileHover').style.display = 'none';
        }

        function startVideo() {
            showToast('📹 Video call starting...');
            document.getElementById('profileHover').style.display = 'none';
        }

        function sendVibe(type) {
            const vibes = {
                fire: '🔥 Fire vibes sent!',
                heart: '❤️ Love sent!',
                dance: '💃 Dance request sent!',
                cheers: '🥂 Cheers sent!'
            };
            showToast(vibes[type]);
        }

        function challengeDance() {
            showToast('⚡ Dance battle challenge sent!');
            document.getElementById('profileHover').style.display = 'none';
        }

        function soulSync() {
            showToast('🧬 Soul Sync initiated! Hold phones together...');
            document.getElementById('profileHover').style.display = 'none';
        }

        // STRIPE INTEGRATION - Reading from Netlify Environment Variables
        // Keys are loaded from netlify-env-inject.js (populated at build time)
        const STRIPE_PUBLISHABLE_KEY = window.STRIPE_PUBLISHABLE_KEY;
        
        // Product/Price IDs from Netlify environment variables
        const STRIPE_PRODUCTS = {
            ticket: window.STRIPE_PRICE_TICKET,
            vipTicket: window.STRIPE_PRICE_VIP_TICKET,
            table: window.STRIPE_PRICE_TABLE,
            drink: window.STRIPE_PRICE_DRINK,
            bottleService: window.STRIPE_PRICE_BOTTLE
        };
        
        // Validate Stripe configuration
        if (!STRIPE_PUBLISHABLE_KEY || STRIPE_PUBLISHABLE_KEY.includes('%%')) {
            console.warn('⚠️ Stripe keys not configured. Add environment variables in Netlify.');
        }

        // Hover actions config: read from Netlify env or fall back to defaults
        const HOVER_PURCHASE_LINKS = {
            TICKET_PAGE: window.HOVER_TICKET_PAGE || 'https://soundfactorynyc.com/tickets',
            DRINK_10: window.HOVER_DRINK_10 || '',
            TABLE_100: window.HOVER_TABLE_100 || ''
        };

        // Book Studio (Opens booking system)
        function bookStudio() {
            // Option 1: Stripe Payment Link for studio booking
            window.open('https://buy.stripe.com/YOUR_STUDIO_BOOKING_LINK', '_blank');
            
            // Option 2: Custom booking page
            // window.location.href = '/studio-booking';
            
            showToast('📹 Opening studio booking...');
        }

        // HELP MODAL FUNCTIONS
        function openHelp() {
            document.getElementById('helpModal').classList.add('active');
            localStorage.setItem('sf_help_shown', 'true');
        }

        function closeHelp() {
            document.getElementById('helpModal').classList.remove('active');
        }

        // Show help on first visit
        window.addEventListener('load', () => {
            const hasSeenHelp = localStorage.getItem('sf_help_shown');
            if (!hasSeenHelp) {
                // Show help automatically after 2 seconds on first visit
                setTimeout(() => {
                    openHelp();
                }, 2000);
            }
        });

        // Close help modal with ESC key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeHelp();
            }
        });

        // Close help modal when clicking outside
        document.getElementById('helpModal')?.addEventListener('click', (e) => {
            if (e.target.id === 'helpModal') {
                closeHelp();
            }
        });

        // Buy Tickets - Stripe Checkout
        async function buyTickets() {
            // Option 1: Direct link to ticket page
            if (HOVER_PURCHASE_LINKS.TICKET_PAGE) {
                window.open(HOVER_PURCHASE_LINKS.TICKET_PAGE, '_blank');
            } else {
                showToast('🎫 Ticket page not configured');
            }
            
            // Option 2: Create checkout session (requires backend)
            /*
            try {
                const response = await fetch('/api/create-checkout', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        priceId: STRIPE_PRODUCTS.ticket,
                        quantity: 1,
                        mode: 'payment'
                    })
                });
                const { url } = await response.json();
                window.location.href = url;
            } catch (error) {
                console.error('Stripe error:', error);
                showToast('❌ Payment system error. Please try again.');
            }
            */
            
            showToast('🎟️ Opening ticket purchase...');
        }

        // Buy Tables - VIP Table Service
        async function buyTables() {
            // Use environment variable or default Stripe Payment Link
            const tableLink = window.STRIPE_TABLE_LINK || 'https://buy.stripe.com/test_dR62bD46gcQP3U4000';
            
            if (!tableLink || tableLink.includes('%%')) {
                showToast('❗ Table booking not configured. Contact venue.');
                return;
            }
            
            // Open Stripe payment link for table reservation
            window.open(tableLink, '_blank');
            showToast('🍾 Opening table reservation...');
        }

        // Send Virtual Drink (In-app purchase)
        async function sendDrink() {
            const recipientName = document.getElementById('hoverName')?.textContent || 'guest';
            const link = HOVER_PURCHASE_LINKS.DRINK_10;
            if (!link || link.includes('test_DRINK_10_LINK')) {
                showToast('❗ Stripe $10 drink link not configured');
            } else {
                window.open(link, '_blank');
                showToast(`🍹 $10 drink for ${recipientName} — opening Stripe...`);
            }
            document.getElementById('profileHover').style.display = 'none';
        }

        // Gift Ticket to User
        async function giftTicket() {
            // Per request: go to the ticket page (not Stripe gift flow)
            const url = HOVER_PURCHASE_LINKS.TICKET_PAGE;
            if (!url || url.includes('soundfactorynyc.com/tickets') === false) {
                // If not configured, fallback to generic buyTickets()
                try { await buyTickets(); } catch(_) {}
            } else {
                window.open(url, '_blank');
            }
            showToast('🎟️ Opening ticket page...');
            document.getElementById('profileHover').style.display = 'none';
        }

        // Bottle Service Purchase
        async function buyBottleService() {
            const bottleOptions = [
                { name: 'Premium Vodka', price: '$300', link: 'YOUR_VODKA_LINK' },
                { name: 'Champagne', price: '$500', link: 'YOUR_CHAMPAGNE_LINK' },
                { name: 'Tequila Package', price: '$400', link: 'YOUR_TEQUILA_LINK' }
            ];
            
            // Create selection modal
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: linear-gradient(135deg, #1a1a1a, #2a1a2a);
                border: 2px solid #ff0066;
                border-radius: 20px;
                padding: 30px;
                z-index: 9999;
                text-align: center;
                color: white;
            `;
            
            modal.innerHTML = `
                <h2 style="color: #ff0066; margin-bottom: 20px;">🍾 Bottle Service</h2>
                ${bottleOptions.map(bottle => `
                    <button onclick="window.open('https://buy.stripe.com/${bottle.link}', '_blank'); this.parentElement.remove();" 
                            style="display: block; width: 100%; padding: 15px; margin: 10px 0; background: rgba(255,0,102,0.2); 
                                   border: 1px solid #ff0066; border-radius: 10px; color: white; cursor: pointer;">
                        ${bottle.name} - ${bottle.price}
                    </button>
                `).join('')}
                <button onclick="this.parentElement.remove()" 
                        style="margin-top: 20px; padding: 10px 20px; background: rgba(255,255,255,0.1); 
                               border: 1px solid rgba(255,255,255,0.3); border-radius: 10px; color: white; cursor: pointer;">
                    Cancel
                </button>
            `;
            
            document.body.appendChild(modal);
        }

        // Invite to Table (with payment split option)
        function inviteToTable() {
            const recipientName = document.getElementById('hoverName')?.textContent || 'guest';
            const link = HOVER_PURCHASE_LINKS.TABLE_100;
            if (!link || link.includes('test_TABLE_100_LINK')) {
                showToast('❗ Stripe $100 table invite link not configured');
            } else {
                window.open(link, '_blank');
                showToast(`🍾 $100 table invite for ${recipientName} — opening Stripe...`);
            }
            document.getElementById('profileHover').style.display = 'none';
        }

        // Handle Stripe Webhook Events (Backend example)
        /*
        // This would be on your Node.js/Python backend:
        app.post('/stripe-webhook', async (req, res) => {
            const event = req.body;
            
            switch (event.type) {
                case 'checkout.session.completed':
                    // Handle successful payment
                    const session = event.data.object;
                    
                    // Grant access to event
                    if (session.metadata.type === 'ticket') {
                        // Add ticket to user account
                        await grantTicketAccess(session.customer_email);
                    }
                    
                    // Send confirmation
                    if (session.metadata.type === 'gift') {
                        // Send gift to recipient
                        await sendGiftNotification(session.metadata.recipient);
                    }
                    break;
                    
                case 'payment_intent.succeeded':
                    // Handle successful payment intent
                    console.log('Payment successful!');
                    break;
            }
            
            res.json({ received: true });
        });
        */

        // Create Stripe Products (Run once in Stripe Dashboard or via API)
        /*
        async function createStripeProducts() {
            // This is what you'd run once to set up your products:
            
            // Event Ticket
            const ticket = await stripe.products.create({
                name: 'Sound Factory NYC - General Admission',
                description: 'Entry to the hottest venue in NYC',
                images: ['https://soundfactory.com/ticket.jpg'],
            });
            
            const ticketPrice = await stripe.prices.create({
                product: ticket.id,
                unit_amount: 6000, // $60.00
                currency: 'usd',
            });
            
            // VIP Table
            const table = await stripe.products.create({
                name: 'VIP Table Reservation',
                description: 'Reserved table with bottle service',
            });
            
            const tablePrice = await stripe.prices.create({
                product: table.id,
                unit_amount: 50000, // $500.00
                currency: 'usd',
            });
            
            // Virtual Drink
            const drink = await stripe.products.create({
                name: 'Send a Virtual Drink',
                description: 'Buy someone a drink at the venue',
            });
            
            const drinkPrice = await stripe.prices.create({
                product: drink.id,
                unit_amount: 1000, // $10.00
                currency: 'usd',
            });
            
            console.log('Products created:', { ticketPrice, tablePrice, drinkPrice });
        }
        */

        // Toast notification
        function showToast(message) {
            const existing = document.querySelector('.toast');
            if (existing) existing.remove();

            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => toast.remove(), 3000);
        }

        // Group Chat Functions
        function inviteToGroup() {
            showToast('➕ Invite sent!');
        }

        function closeGroupChat() {
            document.getElementById('groupChat').style.display = 'none';
        }

        function sendGroupMessage() {
            const input = document.getElementById('groupChatInput');
            if (!input.value) return;
            
            const messages = document.getElementById('chatMessages');
            messages.innerHTML += `
                <div style="background: rgba(255,255,255,0.05); padding: 8px; border-radius: 10px; margin-bottom: 5px; font-size: 12px;">
                    <strong>You:</strong> ${input.value}
                </div>
            `;
            input.value = '';
            messages.scrollTop = messages.scrollHeight;
        }

        // Bottom Chat Functions
        function sendBottomMessage() {
            const input = document.getElementById('chatInputBottom');
            if (!input || !input.value.trim()) return;
            
            const message = input.value.trim();
            
            // FIXED: Apply ALL active chat effects to the message
            if (activeChatEffects.length > 0) {
                console.log('📤 Sending message with effects:', message, activeChatEffects);
                
                // Create visual feedback for each active effect
                activeChatEffects.forEach(effectNum => {
                    const animClass = chatEffectAnimations[effectNum] || 'waveEffect';
                    applyVisualEffect(message, animClass);
                });
                
                showToast(`💬 Message sent with ${activeChatEffects.length} effect(s)! ${activeChatEffects.map(n => '✨').join('')}`);
            } else {
                console.log('📤 Sending plain message:', message);
                showToast('💬 Message sent!');
            }
            
            input.value = '';
        }
        
        // Apply visual chat effect
        function applyVisualEffect(message, animClass) {
            const chatBox = document.createElement('div');
            chatBox.textContent = message;
            chatBox.style.cssText = `
                position: fixed;
                left: 50%;
                bottom: 270px;
                transform: translateX(-50%);
                background: linear-gradient(135deg, #ff0066, #ff3399);
                color: white;
                padding: 15px 30px;
                border-radius: 25px;
                font-weight: 700;
                font-size: 18px;
                box-shadow: 0 10px 40px rgba(255, 0, 102, 0.5);
                z-index: 10000;
                pointer-events: none;
                animation: ${animClass} 2s ease-out forwards;
            `;
            document.body.appendChild(chatBox);
            
            // Remove after animation
            setTimeout(() => chatBox.remove(), 2000);
        }

        // Walk mode buttons - simplified
        document.addEventListener('DOMContentLoaded', function() {
            // Check if walk buttons exist before trying to access them
            const walkButtons = document.querySelectorAll('.walk-btn');
            if (walkButtons.length > 0) {
                walkButtons.forEach(btn => {
                    btn.addEventListener('click', function() {
                        const mode = this.dataset.mode;
                        walkButtons.forEach(b => {
                            b.style.background = 'rgba(255,255,255,0.1)';
                        });
                        this.style.background = 'linear-gradient(135deg, #ff0066, #ff3399)';
                        showToast(`${mode.charAt(0).toUpperCase() + mode.slice(1)} mode activated!`);
                    });
                });
                
                // Set walking as default if it exists
                const walkingBtn = document.querySelector('.walk-btn[data-mode="walking"]');
                if (walkingBtn) {
                    walkingBtn.style.background = 'linear-gradient(135deg, #ff0066, #ff3399)';
                }
            }
        });

        // Show group chat when users collide
        function showGroupChatOnCollision() {
            document.getElementById('groupChat').style.display = 'block';
        }

        // GRID SYSTEM FUNCTIONS
        let activeChatEffects = []; // CHANGED: Array to hold multiple active effects
        const reactionBoxes = [];
        const chatEffectAnimations = {
            1: 'waveEffect', 2: 'spiralEffect', 3: 'explodeEffect', 4: 'fireworkEffect',
            5: 'waveEffect', 6: 'spiralEffect', 7: 'explodeEffect', 8: 'fireworkEffect'
        };

        function toggleGrid(position) {
            const grid = document.getElementById(`grid-${position}`);
            if (!grid) return;

            const wasActive = grid.classList.contains('active');

            // Close all grids first so only one can be open at a time
            ['top', 'middle', 'bottom'].forEach(pos => {
                const el = document.getElementById(`grid-${pos}`);
                if (el) el.classList.remove('active');
            });

            // If the clicked one wasn't active, open it; if it was, leave all closed
            if (!wasActive) {
                grid.classList.add('active');
            }
        }

        function closeGrid(position) {
            document.getElementById(`grid-${position}`).classList.remove('active');
        }

        function handleChatEffect(number, button, effectName) {
            // FIXED: Allow multiple selections - toggle on/off
            const index = activeChatEffects.indexOf(number);
            
            if (index > -1) {
                // Effect is active - turn it OFF
                activeChatEffects.splice(index, 1);
                button.classList.remove('effect-active');
                showToast(`❌ ${effectName} deactivated`);
            } else {
                // Effect is NOT active - turn it ON
                activeChatEffects.push(number);
                button.classList.add('effect-active');
                showToast(`✅ ${effectName} activated! (${activeChatEffects.length} effects active)`);
            }
            
            console.log('Active chat effects:', activeChatEffects);
        }

        // Create a draggable reaction box and add to layer
        function spawnReactionBox(label){
            const layer = document.getElementById('reactionLayer');
            if (!layer) return;
            const box = document.createElement('div');
            box.className = 'reaction-box';
            box.textContent = label;
            box.style.cssText = `
                position: absolute;
                left: ${20 + Math.random()*80}px;
                top: ${window.innerHeight - 200 + Math.random()*40}px;
                background: rgba(255,255,255,0.06);
                border: 1px solid rgba(255,255,255,0.15);
                color: #fff;
                padding: 10px 12px;
                border-radius: 10px;
                font-size: 12px;
                box-shadow: 0 6px 20px rgba(0,0,0,0.5);
                pointer-events: auto;
                user-select: none;
            `;

            layer.appendChild(box);
            reactionBoxes.push(box);
            makeBoxDraggable(box);
            // Intro pulse
            box.animate([
                { transform: 'scale(0.8)', opacity: 0 },
                { transform: 'scale(1.05)', opacity: 1 },
                { transform: 'scale(1)', opacity: 1 }
            ], { duration: 300, easing: 'ease-out' });
        }

        function makeBoxDraggable(el){
            let dragging = false, offX = 0, offY = 0;
            const onDown = (e)=>{
                dragging = true;
                const r = el.getBoundingClientRect();
                const {x,y} = getPointer(e);
                offX = x - r.left; offY = y - r.top;
                if (e.cancelable) e.preventDefault();
            };
            const onMove = (e)=>{
                if (!dragging) return;
                const {x,y} = getPointer(e);
                const nx = clamp(0, window.innerWidth - el.offsetWidth, x - offX);
                const ny = clamp(60, window.innerHeight - el.offsetHeight - 80, y - offY);
                el.style.left = nx + 'px';
                el.style.top = ny + 'px';
                if (e.cancelable) e.preventDefault();
            };
            const onUp = ()=>{
                if (!dragging) return;
                dragging = false;
                // Check collisions with other boxes
                for (const other of reactionBoxes){
                    if (other === el) continue;
                    if (boxesCollide(el, other)){
                        mergeBoxes(el, other);
                        break;
                    }
                }
            };
            el.addEventListener('mousedown', onDown);
            document.addEventListener('mousemove', onMove);
            document.addEventListener('mouseup', onUp);
            el.addEventListener('touchstart', onDown, { passive:false });
            document.addEventListener('touchmove', onMove, { passive:false });
            document.addEventListener('touchend', onUp);
        }

        function getPointer(e){
            return e.touches && e.touches[0] ? { x: e.touches[0].clientX, y: e.touches[0].clientY } : { x: e.clientX, y: e.clientY };
        }
        function clamp(min, max, val){ return Math.max(min, Math.min(max, val)); }
        function boxesCollide(a,b){
            const ra = a.getBoundingClientRect();
            const rb = b.getBoundingClientRect();
            return !(ra.right < rb.left || ra.left > rb.right || ra.bottom < rb.top || ra.top > rb.bottom);
        }
        function mergeBoxes(a,b){
            // Pulse
            a.animate([
                { transform:'scale(1)' },
                { transform:'scale(1.1)' },
                { transform:'scale(1)' }
            ], { duration: 250 });
            // Combine labels (simple)
            a.textContent = `${a.textContent} + ${b.textContent}`;
            // Remove b
            const idx = reactionBoxes.indexOf(b);
            if (idx>-1) reactionBoxes.splice(idx,1);
            b.remove();
        }

        // Initialize all grids
        function initializeGrids() {
            // Top grid - Numbers
            const topGrid = document.getElementById('grid-top-container');
            for (let i = 1; i <= 64; i++) {
                const btn = document.createElement('button');
                btn.className = 'grid-button';
                btn.textContent = i;
                topGrid.appendChild(btn);
            }

            // Middle grid - Reactions + Camera
            const middleGrid = document.getElementById('grid-middle-container');
            const reactions = [
                '🔥 Fire', '❤️ Heart', '💰 Money', '🎉 Party',
                '⚡ Lightning', '⭐ Stars', '💎 Diamond', '👑 Crown',
                '🚀 Rocket', '🌈 Rainbow', '🏆 Trophy', '💎 Gems',
                '🎆 Fireworks', '✨ Magic', '🕺 Dance', '🎵 Music',
                '🪙 Coins', '🔮 Crystal', '🔦 Laser', '💥 Explosion',
                '🌸 Bloom', '☀️ Sunshine', '🌙 Moon', '🌌 Galaxy',
                '☄️ Comet', '🌌 Aurora', '🌋 Volcano', '🌪️ Tornado',
                '❄️ Snow', '⛈️ Storm', '📤 Upload', '🎭 Mix'
            ];
            const cameraEffects = [
                '🕰️ Age', '📱 Dual', '🌀 Warp', '👻 Holo',
                '👥 Clone', '👻 Ghost', '🔍 Size', '🌍 Grav',
                '🌀 Portal', '🔢 Matrix', '💡 Neon', '✨ Burst',
                '🪞 Mirror', '⏸️ Freeze', '🦋 Shift', '⚡ Aura',
                '🌌 Dim', '💧 Liquid', '💎 Crystal', '👤 Shadow',
                '⚡ Speed', '🧲 Magnet', '⚛️ Quantum', '🌙 Dream',
                '📺 Glitch', '🌟 Cosmic', '🔥 Element', '🛤️ Memory',
                '🔮 Future', '👤 Para', '♾️ Loop', '✏️ Edit'
            ];
            
            reactions.forEach(r => {
                const btn = document.createElement('button');
                btn.className = 'grid-button';
                btn.innerHTML = r;
                btn.onclick = ()=>{ spawnReactionBox(r); closeGrid('middle'); };
                middleGrid.appendChild(btn);
            });
            
            cameraEffects.forEach(c => {
                const btn = document.createElement('button');
                btn.className = 'grid-button';
                btn.innerHTML = c;
                btn.onclick = ()=>{ spawnReactionBox(c); closeGrid('middle'); };
                middleGrid.appendChild(btn);
            });

            // Bottom grid - 64 Chat Effects
            const bottomGrid = document.getElementById('grid-bottom-container');
            const chatEffects = [
                '🌊 Wave', '🌀 Spiral', '💥 Explode', '🎆 Firework',
                '⚡ Lightning', '🌈 Rainbow', '🔥 Fire', '❄️ Freeze',
                '🌪️ Tornado', '💎 Crystal', '🌊 Tsunami', '🎭 Morph',
                '🔮 Mystical', '💫 Warp', '🌟 Sparkle', '🎪 Bounce',
                '😈 Savage', '🤖 Robot', '👽 Alien', '🧙 Wizard',
                '🏴‍☠️ Pirate', '👑 Royal', '🎭 Drama', '🚀 Future',
                '🧬 Quantum', '🎵 Musical', '🌴 Chill', '⚡ Hype',
                '🧠 Genius', '💀 Dark', '🦄 Unicorn', '🎰 Random',
                '✨ Particles', '🎬 Matrix', '🌌 Galaxy', '💾 Glitch',
                '🔊 Bass', '💿 Vinyl', '🎚️ Mixer', '🎧 Beats',
                '📡 Radar', '🌐 Cyber', '🏮 Neon', '💡 Strobe',
                '🎨 Paint', '🌸 Bloom', '⚔️ Slash', '🎯 Target',
                '🎮 Game', '🏆 Score', '💰 Coins', '🎲 Dice',
                '🗳️ Vote', '🎯 Quest', '👥 Multi', '🔗 Chain',
                '⏱️ Timer', '🎪 Party', '🎭 Emoji', '🎸 Rock',
                '🕺 Dance', '🌟 VIP', '🔒 Secret', '♾️ Infinite'
            ];
            
            chatEffects.forEach((effect, i) => {
                const btn = document.createElement('button');
                btn.className = 'grid-button';
                btn.innerHTML = effect;
                btn.onclick = () => handleChatEffect(i + 1, btn, effect); // FIXED: Pass effect name
                bottomGrid.appendChild(btn);
            });
        }

        // Duplicate function removed - using the first one above

        // Initialize when DOM is ready
        window.addEventListener('DOMContentLoaded', initializeGrids);

        // Simple collision: show group chat when characters get close
        (function initSimpleCollision(){
            const me = document.getElementById('myCharacter');
            const other = document.getElementById('otherCharacter');
            if (!me || !other) return;
            let shown = false;
            setInterval(()=>{
                const mx = me.getBoundingClientRect();
                const ox = other.getBoundingClientRect();
                const dx = (mx.left+mx.width/2)-(ox.left+ox.width/2);
                const dy = (mx.top+mx.height/2)-(ox.top+ox.height/2);
                const dist = Math.hypot(dx,dy);
                if (dist < 60 && !shown){
                    shown = true;
                    showGroupChatOnCollision();
                    setTimeout(()=>{ shown = false; }, 5000);
                }
            }, 300);
        })();

        // ==============================
        // Bottom Reaction Buttons Wiring (ReactionSystem)
        // ==============================
        document.addEventListener('DOMContentLoaded', () => {
            class ReactionSystem {
                constructor(canvasId) {
                    this.canvas = document.getElementById(canvasId);
                    if (!this.canvas) return;
                    this.ctx = this.canvas.getContext('2d');
                    this.reactions = [];
                    this.particles = [];
                    this.scaleFactor = 0.6;
                    this.resizeCanvas();
                    window.addEventListener('resize', () => this.resizeCanvas());
                    this.animate();
                }
                resizeCanvas(){
                    this.canvas.width = window.innerWidth;
                    this.canvas.height = window.innerHeight;
                }
                triggerReaction(type, data={}){
                    const x = data.x ?? (window.innerWidth/2);
                    const y = data.y ?? (window.innerHeight - 100);
                    if (type === 'money') return this.createMoneyReaction(x,y,data.amount||1);
                    if (type === 'heel') return this.createHeelReaction(x,y);
                    if (type === 'pride') return this.createPrideReaction(x,y);
                    if (type === 'text') return this.createTextReaction(x,y,data.text||'WERK');
                    if (type === 'emoji') return this.createEmojiReaction(x,y,data.emoji||'❤️', data.emojiType||'love');
                }
                createEmojiReaction(x,y,emoji,type){
                    this.reactions.push({ x,y, vx:(Math.random()-0.5)*10, vy:-20-Math.random()*10, emoji, type, size:30*this.scaleFactor, opacity:1, gravity:0.5 });
                    for(let i=0;i<5;i++) this.particles.push({ x,y, vx:(Math.random()-0.5)*5, vy:(Math.random()-0.5)*5, size:Math.random()*3+1, color:this.getReactionColor(type), life:1, decay:0.02 });
                }
                createMoneyReaction(x,y,amount){
                    this.reactions.push({ x,y, vx:(Math.random()-0.5)*8, vy:-25-Math.random()*10, amount, type:'money', size:40*this.scaleFactor, opacity:1, rotation:0, rotationSpeed:(Math.random()-0.5)*0.3, gravity:0.6 });
                    for(let i=0;i<10;i++) this.particles.push({ x,y, vx:(Math.random()-0.5)*10, vy:(Math.random()-0.5)*10, size:Math.random()*4+2, color:'#FFD700', life:1, decay:0.015, sparkle:true });
                }
                createTextReaction(x,y,text){
                    this.reactions.push({ x,y, vx:(Math.random()-0.5)*12, vy:-22-Math.random()*8, text, type:'text', size:25*this.scaleFactor, opacity:1, rotation:0, rotationSpeed:(Math.random()-0.5)*0.2, gravity:0.5, color:this.getTextColor(text) });
                }
                createHeelReaction(x,y){
                    this.reactions.push({ x,y, vx:(Math.random()-0.5)*15, vy:-25-Math.random()*10, type:'heel', size:35*this.scaleFactor, opacity:1, rotation:0, rotationSpeed:(Math.random()-0.5)*0.4, gravity:0.5 });
                    for(let i=0;i<8;i++) this.particles.push({ x,y, vx:(Math.random()-0.5)*8, vy:(Math.random()-0.5)*8, size:Math.random()*3+1, color:'#ff1493', life:1, decay:0.02, sparkle:true });
                }
                createPrideReaction(x,y){
                    this.reactions.push({ x,y, vx:(Math.random()-0.5)*10, vy:-20-Math.random()*10, type:'pride', size:40*this.scaleFactor, opacity:1, rotation:0, rotationSpeed:(Math.random()-0.5)*0.15, gravity:0.5 });
                    const cols=['#e40303','#ff8c00','#ffed00','#008026','#004cff','#750787'];
                    cols.forEach(c=>this.particles.push({ x,y, vx:(Math.random()-0.5)*6, vy:(Math.random()-0.5)*6, size:Math.random()*4+2, color:c, life:1, decay:0.018 }));
                }
                getReactionColor(type){
                    const colors={ love:'#ff006e', fire:'#ff6b35', laugh:'#ffbe0b', party:'#8338ec' };
                    return colors[type]||'#ffffff';
                }
                getTextColor(text){
                    const colors={ 'WERK':'#ff00ff', 'SF':'#00ffff', 'JP':'#ffd700' };
                    return colors[text]||'#ffffff';
                }
                draw(){
                    this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height);
                    // particles
                    for(let i=this.particles.length-1;i>=0;i--){
                        const p=this.particles[i];
                        if(p.life<=0){ this.particles.splice(i,1); continue; }
                        this.ctx.save(); this.ctx.globalAlpha=p.life;
                        if(p.sparkle){ const s=p.size*(1+Math.sin(Date.now()*0.01)*0.3); this.ctx.fillStyle=p.color; this.drawStar(p.x,p.y,4,s,s/2); }
                        else{ this.ctx.beginPath(); this.ctx.arc(p.x,p.y,p.size,0,Math.PI*2); this.ctx.fillStyle=p.color; this.ctx.fill(); }
                        this.ctx.restore(); p.x+=p.vx; p.y+=p.vy; p.vy+=0.3; p.life-=p.decay;
                    }
                    // reactions
                    for(let i=this.reactions.length-1;i>=0;i--){
                        const r=this.reactions[i];
                        if(r.opacity<=0 || r.y>this.canvas.height){ this.reactions.splice(i,1); continue; }
                        this.ctx.save(); this.ctx.translate(r.x,r.y); this.ctx.rotate(r.rotation||0); this.ctx.globalAlpha=r.opacity;
                        if(r.type==='money'){
                            const g=this.ctx.createLinearGradient(-r.size/2,0,r.size/2,0); g.addColorStop(0,'#85bb65'); g.addColorStop(0.5,'#a5d6a7'); g.addColorStop(1,'#85bb65');
                            this.ctx.fillStyle=g; this.ctx.fillRect(-r.size/2,-r.size/4,r.size,r.size/2);
                            this.ctx.fillStyle='#2a5434'; this.ctx.font=`bold ${r.size/3}px Arial`; this.ctx.textAlign='center'; this.ctx.textBaseline='middle'; this.ctx.fillText(`$${r.amount}`,0,0);
                            r.rotation += r.rotationSpeed;
                        } else if (r.type==='heel'){
                            this.ctx.font=`${r.size}px Arial`; this.ctx.textAlign='center'; this.ctx.textBaseline='middle'; this.ctx.fillText('👠',0,0); r.rotation+=r.rotationSpeed;
                        } else if (r.type==='pride'){
                            this.ctx.font=`${r.size}px Arial`; this.ctx.textAlign='center'; this.ctx.textBaseline='middle'; this.ctx.fillText('🏳️‍🌈',0,0); r.rotation+=r.rotationSpeed;
                        } else if (r.type==='text'){
                            this.ctx.fillStyle=r.color; this.ctx.font=`bold ${r.size}px Arial`; this.ctx.textAlign='center'; this.ctx.textBaseline='middle'; this.ctx.shadowBlur=10; this.ctx.shadowColor=r.color; this.ctx.fillText(r.text,0,0); r.rotation+=r.rotationSpeed;
                        } else {
                            this.ctx.font=`${r.size}px Arial`; this.ctx.textAlign='center'; this.ctx.textBaseline='middle'; this.ctx.fillText(r.emoji,0,0);
                        }
                        this.ctx.restore(); r.x+=r.vx; r.y+=r.vy; r.vy+=r.gravity; r.vx*=0.99;
                        if (r.y < r.size) r.vy = Math.abs(r.vy) * 0.5;
                        if (r.x < r.size || r.x > this.canvas.width - r.size) r.vx = -r.vx * 0.8;
                    }
                }
                drawStar(x,y,spikes,outer,inner){
                    let rot=Math.PI/2*3; const step=Math.PI/spikes; this.ctx.beginPath(); this.ctx.moveTo(x, y-outer);
                    for(let i=0;i<spikes;i++){ this.ctx.lineTo(x+Math.cos(rot)*outer, y+Math.sin(rot)*outer); rot+=step; this.ctx.lineTo(x+Math.cos(rot)*inner, y+Math.sin(rot)*inner); rot+=step; }
                    this.ctx.lineTo(x, y-outer); this.ctx.closePath(); this.ctx.fill();
                }
                animate(){ this.draw(); requestAnimationFrame(()=>this.animate()); }
            }

            const reactions = new ReactionSystem('reaction-canvas');
            const handler = (type, payload) => (e) => {
                reactions.triggerReaction(type, { x: e.clientX, y: e.clientY, ...payload });
            };

            const binds = [
                ['btn-love', handler('emoji', { emoji: '❤️', emojiType: 'love' })],
                ['btn-fire', handler('emoji', { emoji: '🔥', emojiType: 'fire' })],
                ['btn-laugh', handler('emoji', { emoji: '😂', emojiType: 'laugh' })],
                ['btn-party', handler('emoji', { emoji: '🎉', emojiType: 'party' })],
                ['btn-heel', handler('heel')],
                ['btn-pride', handler('pride')],
                ['btn-sf', handler('text', { text: 'SF' })],
                ['btn-money1', (e)=> handleMoneyTip(1, e, reactions)],
                ['btn-money5', (e)=> handleMoneyTip(5, e, reactions)],
                ['btn-money10', (e)=> handleMoneyTip(10, e, reactions)],
            ];
            binds.forEach(([id, fn]) => { const el = document.getElementById(id); if (el) el.addEventListener('click', fn); });
        });

        // ==============================
        // Stripe Tipping Flow for Money
        // ==============================
        const MONEY_LINKS = {
            1: window.STRIPE_TIP_LINK_1 || '',
            5: window.STRIPE_TIP_LINK_5 || '',
            10: window.STRIPE_TIP_LINK_10 || ''
        };

        function handleMoneyTip(amount, e, reactions){
            const coords = { x: e.clientX, y: e.clientY };
            const onboarded = localStorage.getItem('sf_tip_onboarded') === '1';
            if (!onboarded){
                showTipOnboarding(amount, coords, reactions);
                return;
            }
            // Already onboarded: animate immediately and show quick confirm to pay
            reactions.triggerReaction('money', { x: coords.x, y: coords.y, amount });
            showTipConfirm(amount, coords);
        }

        function showTipOnboarding(amount, coords, reactions){
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 10050;
                display: flex; align-items: center; justify-content: center; padding: 20px;`;
            const box = document.createElement('div');
            box.style.cssText = `
                width: min(90vw, 360px); background: #141414; border: 1px solid rgba(255,255,255,0.1);
                border-radius: 16px; padding: 16px; color: #fff; box-shadow: 0 20px 60px rgba(0,0,0,0.6);`;
            box.innerHTML = `
                <div style="font-weight: 700; margin-bottom: 8px; font-size: 16px;">Enable Tips</div>
                <div style="font-size: 12px; color: #bbb; margin-bottom: 12px;">Open Stripe to send your first $${amount} tip. After that, you can keep tipping with one tap.</div>
                <div style="display:flex; gap:8px;">
                    <button id="tip-pay" style="flex:1; padding:10px; background:#00ff88; border:none; border-radius:10px; color:#000; font-weight:700; cursor:pointer;">Pay $${amount}</button>
                    <button id="tip-done" style="flex:1; padding:10px; background:rgba(255,255,255,0.1); border:1px solid rgba(255,255,255,0.2); border-radius:10px; color:#fff; cursor:pointer;">Done</button>
                </div>`;
            modal.appendChild(box);
            document.body.appendChild(modal);

            const link = MONEY_LINKS[amount];
            document.getElementById('tip-pay').onclick = ()=>{
                if (!link) { showToast('Stripe link not configured'); return; }
                window.open(link, '_blank');
            };
            document.getElementById('tip-done').onclick = ()=>{
                localStorage.setItem('sf_tip_onboarded','1');
                try { document.body.removeChild(modal); } catch(_){}
                if (reactions) reactions.triggerReaction('money', { x: coords.x, y: coords.y, amount });
                showTipConfirm(amount, coords);
            };
        }

        function showTipConfirm(amount, coords){
            const pill = document.createElement('div');
            pill.style.cssText = `
                position: fixed; left: ${Math.min(window.innerWidth-200, Math.max(20, coords.x-60))}px; top: ${Math.max(60, coords.y-60)}px;
                background: rgba(0,0,0,0.9); color:#fff; border:1px solid rgba(255,255,255,0.2); border-radius: 20px; padding: 8px 12px; z-index: 10060;
                display:flex; align-items:center; gap:8px; box-shadow: 0 10px 30px rgba(0,0,0,0.6);`;
            pill.innerHTML = `<span>Tip $${amount} now?</span>`;
            const btn = document.createElement('button');
            btn.textContent = 'Pay';
            btn.style.cssText = 'background:#00ff88; color:#000; border:none; padding:6px 10px; border-radius:14px; font-weight:700; cursor:pointer;';
            pill.appendChild(btn);
            document.body.appendChild(pill);
            const link = MONEY_LINKS[amount];
            btn.onclick = ()=>{
                if (!link) { showToast('Stripe link not configured'); return; }
                window.open(link, '_blank');
                try { pill.remove(); } catch(_){}
            };
            // Auto-hide after 4s
            setTimeout(()=>{ try { pill.remove(); } catch(_){} }, 4000);
        }

        function burstEmoji(emoji, count=14){
            const origin = getBottomOrigin();
            for (let i=0;i<count;i++){
                createFloatingParticle({
                    content: emoji,
                    x: origin.x + rand(-80,80),
                    y: origin.y + rand(-10,10),
                    color: '#fff',
                    driftX: rand(-60,60),
                    rise: rand(160,280),
                    scaleFrom: 0.6,
                    scaleTo: 1.2,
                    duration: rand(900,1400)
                });
            }
        }

        function burstPride(count=18){
            const colors = ['🟥','🟧','🟨','🟩','🟦','🟪'];
            const origin = getBottomOrigin();
            for (let i=0;i<count;i++){
                const c = colors[i % colors.length];
                createFloatingParticle({
                    content: c,
                    x: origin.x + rand(-90,90),
                    y: origin.y + rand(-10,10),
                    driftX: rand(-70,70),
                    rise: rand(160,300),
                    scaleFrom: 0.7,
                    scaleTo: 1.1,
                    duration: rand(950,1400)
                });
            }
        }

        function floatText(text){
            const origin = getBottomOrigin();
            createFloatingParticle({
                content: text,
                x: origin.x,
                y: origin.y,
                className: 'sf-chip',
                rise: 220,
                driftX: 0,
                scaleFrom: 0.9,
                scaleTo: 1.1,
                duration: 1200
            });
        }

        function burstMoney(mult=1){
            const origin = getBottomOrigin();
            const bills = Math.min(24, 6 * mult);
            for (let i=0;i<bills;i++){
                createFloatingParticle({
                    content: '💵',
                    x: origin.x + rand(-120,120),
                    y: origin.y + rand(-10,10),
                    driftX: rand(-80,80),
                    rise: rand(180,320),
                    rotate: rand(-180,180),
                    scaleFrom: 0.7,
                    scaleTo: 1.3,
                    duration: rand(1000,1600)
                });
            }
        }

        function getBottomOrigin(){
            const bar = document.querySelector('.bottom-layout');
            if (bar){
                const r = bar.getBoundingClientRect();
                return { x: r.left + r.width/2, y: r.top + 10 };
            }
            return { x: window.innerWidth/2, y: window.innerHeight - 90 };
        }

        function createFloatingParticle(opts){
            const el = document.createElement('div');
            el.textContent = opts.content;
            if (opts.className) el.className = opts.className;
            el.style.cssText = `
                position: fixed;
                left: ${opts.x}px;
                top: ${opts.y}px;
                transform: translate(-50%, -50%) scale(${opts.scaleFrom ?? 1});
                color: ${opts.color || '#fff'};
                font-size: 24px;
                z-index: 1200;
                pointer-events: none;
                text-shadow: 0 2px 6px rgba(0,0,0,0.6);
            `;
            document.body.appendChild(el);
            const toX = (opts.x + (opts.driftX ?? 0));
            const toY = (opts.y - (opts.rise ?? 200));
            const rot = opts.rotate || 0;
            const duration = opts.duration || 1200;
            el.animate([
                { transform: `translate(-50%, -50%) scale(${opts.scaleFrom ?? 1}) rotate(0deg)`, opacity: 0 },
                { transform: `translate(-50%, -50%) scale(${(opts.scaleTo ?? 1)}) rotate(${rot/2}deg)`, opacity: 1 },
                { transform: `translate(${toX - opts.x - 50}%, ${toY - opts.y - 50}%) scale(${opts.scaleTo ?? 1}) rotate(${rot}deg)`, opacity: 0 }
            ], { duration, easing: 'ease-out' }).onfinish = ()=> el.remove();
        }

        function rand(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }

        // Click away to close hover (ignore clicks inside card or on characters/pins)
        document.addEventListener('click', (e) => {
            if (
                !e.target.closest('.profile-hover') &&
                !e.target.closest('.person') &&
                !e.target.closest('.pin')
            ) {
                hideProfileHoverCard();
            }
        });

        // Initialize

        
        // Welcome message
        setTimeout(() => {
            showToast('🎉 Welcome to Sound Factory NYC!');
        }, 1000);

        // Simulate activity
        setInterval(() => {
            const messages = [
                '🔥 DJ just dropped a banger!',
                '📸 Someone tagged this moment',
                '💃 Dance floor is heating up!',
                '🎉 VIP table popping bottles!'
            ];
            if (Math.random() > 0.7) {
                showToast(messages[Math.floor(Math.random() * messages.length)]);
            }
        }, 15000);

        // AUTO-MOVING SECOND CHARACTER FOR HOVER TESTING
        const otherCharacter = document.getElementById('otherCharacter');
        let otherPosX = 300;
        let otherPosY = 200;
        let otherVelX = 1;
        let otherVelY = 0.5;

        // Utility: position and show the rich profile-hover near an element
        function showProfileHoverNear(el, opts = {}) {
            const hover = document.getElementById('profileHover');
            if (!hover || !el) return;

            // Content
            const nameEl = document.getElementById('hoverName');
            if (nameEl && opts.name) nameEl.textContent = opts.name;
            const avatarEl = document.getElementById('hoverAvatar');
            if (avatarEl && opts.avatar !== undefined) avatarEl.textContent = opts.avatar; // simple emoji/text avatar

            hover.style.display = 'block';

            // Positioning with clamping
            const rect = el.getBoundingClientRect();
            const hoverRect = hover.getBoundingClientRect();
            const vw = window.innerWidth;
            const vh = window.innerHeight;
            let left = rect.right + 12;
            let top = rect.top;
            // If off right edge, place on left
            if (left + hoverRect.width > vw - 10) left = rect.left - hoverRect.width - 12;
            // Clamp to viewport
            left = Math.max(10, Math.min(vw - hoverRect.width - 10, left));
            // Prefer below, but clamp
            if (top + hoverRect.height > vh - 10) top = rect.bottom - hoverRect.height;
            top = Math.max(10, Math.min(vh - hoverRect.height - 10, top));
            hover.style.left = left + 'px';
            hover.style.top = top + 'px';
        }

        function hideProfileHoverCard() {
            const hover = document.getElementById('profileHover');
            if (hover) hover.style.display = 'none';
        }

        // Bind hover interactions to characters using the rich profile-hover
        function bindHoverToCharacter(character, name, avatar = '👤') {
            if (!character) return;

            const onEnter = () => {
                character.style.filter = 'drop-shadow(0 0 20px #ff0066)';
                showProfileHoverNear(character, { name, avatar });
            };
            const onLeave = () => {
                character.style.filter = 'none';
                // small delay so you can move into the card without flicker
                setTimeout(() => {
                    // If mouse isn't over the card, hide it
                    const hover = document.getElementById('profileHover');
                    if (!hover.matches(':hover')) hideProfileHoverCard();
                }, 150);
            };
            character.addEventListener('mouseenter', onEnter);
            character.addEventListener('mouseleave', onLeave);
            // Touch: tap to toggle
            character.addEventListener('touchstart', (e) => {
                e.preventDefault();
                if (document.getElementById('profileHover').style.display === 'block') hideProfileHoverCard();
                else showProfileHoverNear(character, { name, avatar });
            }, { passive: false });
        }

        // Attach hover bindings after DOM is ready
        setTimeout(() => {
            const meChar = document.getElementById('myCharacter');
            const otherChar = document.getElementById('otherCharacter');
            if (meChar) bindHoverToCharacter(meChar, 'You', '🟣');
            if (otherChar) bindHoverToCharacter(otherChar, 'DJ Alex', '🎧');
        }, 300);

        // Add bounce animation CSS
        const style = document.createElement('style');
        style.textContent = `
            @keyframes bounce {
                0%, 100% { transform: scale(1) translateY(0); }
                50% { transform: scale(1.1) translateY(-10px); }
            }
        `;
        document.head.appendChild(style);

        // ==============================
        // Backend API Configuration
        // ==============================
        const BACKEND_API = 'https://sound-factory-backend-rvkrljar.fly.dev';
        const SUPABASE_URL = 'https://jpnyc.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpwbnljIiwicm9sZSI6ImFub24iLCJpYXQiOjE2OTQwMDAwMDAsImV4cCI6MTg1MTc2NjQwMH0.placeholder';
        
        // Backend API Helper Functions
        async function apiCall(endpoint, method = 'GET', body = null) {
            const options = {
                method,
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                }
            };
            
            if (body) {
                options.body = JSON.stringify(body);
            }
            
            try {
                const response = await fetch(`${BACKEND_API}${endpoint}`, options);
                if (!response.ok) {
                    throw new Error(`API Error: ${response.statusText}`);
                }
                return await response.json();
            } catch (error) {
                console.error('API call failed:', error);
                throw error;
            }
        }
        
        // User Management API
        async function createUser(phone, name) {
            return await apiCall('/api/users', 'POST', {
                user_id: myUserId,
                phone: phone,
                name: name || `User ${myUserId.slice(-4)}`,
                x: posX,
                y: posY
            });
        }
        
        async function updateUserPosition(userId, x, y) {
            return await apiCall(`/api/users/${userId}/position`, 'PUT', { x, y });
        }
        
        // Pin Management API
        async function createPinAPI(pinData) {
            return await apiCall('/api/pins', 'POST', {
                user_id: myUserId,
                pin_type: pinData.type,
                x: pinData.x,
                y: pinData.y,
                caption: pinData.caption,
                photo_url: pinData.photo_url,
                floor: currentFloor || 'MF'
            });
        }
        
        async function getAllPins() {
            return await apiCall('/api/pins', 'GET');
        }
        
        // Chat/Message API
        async function sendMessageAPI(message, recipients) {
            return await apiCall('/api/messages', 'POST', {
                from_user_id: myUserId,
                to_user_ids: recipients,
                content: message,
                chat_id: null // Will be created if needed
            });
        }
        
        async function createChatAPI(userIds) {
            return await apiCall('/api/chats', 'POST', {
                user_ids: userIds
            });
        }
        
        // Purchase API (for tips, gifts, etc)
        async function createPurchaseAPI(toUserId, amount, itemType) {
            return await apiCall('/api/purchases', 'POST', {
                from_user_id: myUserId,
                to_user_id: toUserId,
                amount: amount,
                item_type: itemType,
                stripe_payment_id: null // Will be filled after Stripe payment
            });
        }
        
        // ==============================
        // Supabase Realtime Presence
        // ==============================
        (function initPresence(){
            // Use actual Supabase credentials
            if (!window.supabase || !SUPABASE_URL) {
                console.warn('⚠️ Supabase not configured.');
                return;
            }

            const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
                realtime: { params: { eventsPerSecond: 10 } }
            });

            // Basic identity (replace with your real auth user when available)
            const userId = localStorage.getItem('sf_user_id') || `temp_${Math.random().toString(36).slice(2,8)}`;
            localStorage.setItem('sf_user_id', userId);
            const display = localStorage.getItem('sf_display') || 'Guest';
            const color = '#ff0066';

            // Determine floor from active button
            function getActiveFloor(){
                const btn = document.querySelector('.floor-btn.active');
                return btn ? btn.textContent.trim() : 'MF';
            }

            // Presence channel per floor
            let channel = null;
            function joinPresence(){
                const floor = getActiveFloor();
                if (channel) { try { sb.removeChannel(channel); } catch(_){} }
                channel = sb.channel(`presence:floor:${floor}`, { config: { presence: { key: userId } } });

                channel.on('presence', { event: 'sync' }, () => {
                    const state = channel.presenceState();
                    renderRemoteAvatars(state);
                });
                channel.on('presence', { event: 'join' }, () => {
                    const state = channel.presenceState();
                    renderRemoteAvatars(state);
                });
                channel.on('presence', { event: 'leave' }, () => {
                    const state = channel.presenceState();
                    renderRemoteAvatars(state);
                });

                channel.subscribe(async (status) => {
                    if (status === 'SUBSCRIBED') {
                        pushMyState();
                    }
                });
            }

            function pushMyState(){
                if (!channel) return;
                const payload = {
                    userId,
                    display,
                    color,
                    x: posX,
                    y: posY,
                    ts: Date.now()
                };
                try { channel.track(payload); } catch(_){ }
            }

            // Throttle presence updates
            let lastPush = 0;
            function maybePush(){
                const now = Date.now();
                if (now - lastPush > 150) { // ~6-7 fps updates
                    lastPush = now;
                    pushMyState();
                }
            }

            // Hook into movement to broadcast
            const origAnimate = animate;
            animate = function(){
                origAnimate();
                maybePush();
            }

            // Re-join presence when floor changes
            const origChangeFloor = changeFloor;
            changeFloor = function(floor){
                origChangeFloor.call(this, floor);
                setTimeout(joinPresence, 200);
            }

            // Render remote users
            function renderRemoteAvatars(state){
                // Flatten presence state to a list of latest metas per key
                const entries = Object.entries(state || {});
                const others = entries.map(([key, metas]) => metas?.[0]).filter(m => m && m.userId !== userId);
                const container = document.querySelector('.blueprint-view');
                if (!container) return;

                // Keep a set of seen IDs to remove stale DOM nodes
                const seen = new Set();
                others.forEach(m => {
                    const id = `remote-${m.userId}`;
                    seen.add(id);
                    let el = document.getElementById(id);
                    if (!el){
                        el = document.createElement('div');
                        el.id = id;
                        el.className = 'person user-3 clickable';
                        el.innerHTML = `
                            <div class="shadow"></div>
                            <div class="leg-left-upper"><div class="leg-left-lower"></div></div>
                            <div class="leg-right-upper"><div class="leg-right-lower"></div></div>
                            <div class="torso"></div>
                            <div class="arm-left-upper"><div class="arm-left-lower"></div></div>
                            <div class="arm-right-upper"><div class="arm-right-lower"></div></div>
                            <div class="head"></div>`;
                        el.style.transform = 'translate(-50%, -50%)';
                        container.appendChild(el);
                    }
                    // Smooth position (simple lerp)
                    const r = el.getBoundingClientRect();
                    const ex = parseFloat(el.style.left) || 0;
                    const ey = parseFloat(el.style.top) || 0;
                    const nx = m.x;
                    const ny = m.y;
                    const sx = ex + (nx - ex) * 0.35;
                    const sy = ey + (ny - ey) * 0.35;
                    el.style.left = sx + 'px';
                    el.style.top = sy + 'px';
                });

                // Remove any stale remote avatars
                document.querySelectorAll('[id^="remote-"]').forEach(el => {
                    if (!seen.has(el.id)) el.remove();
                });
            }

            // Initial join
            joinPresence();

            // Cleanup on unload
            window.addEventListener('beforeunload', () => {
                try { if (channel) sb.removeChannel(channel); } catch(_){}
            });
        })();

        // ============ LIVESTREAM CONTROLLER ============
        let livestreamHLS = null;
        let isStreamLive = false;

        function playStream() {
            const video = document.getElementById('stream-video');
            const overlay = document.getElementById('stream-overlay');
            video.play();
            overlay.style.display = 'none';
        }

        function toggleStreamSize() {
            const container = document.getElementById('sf-live-stream');
            container.classList.toggle('minimized');
        }

        function scrollToStream() {
            const container = document.getElementById('sf-live-stream');
            container.scrollIntoView({ behavior: 'smooth' });
            container.classList.remove('minimized');
        }

        function initLivestream(streamUrl) {
            if (!streamUrl) return;
            
            const container = document.getElementById('sf-live-stream');
            const video = document.getElementById('stream-video');
            const overlay = document.getElementById('stream-overlay');

            // Show container
            container.classList.add('is-live');
            isStreamLive = true;

            // Initialize HLS
            if (Hls.isSupported()) {
                livestreamHLS = new Hls({
                    debug: false,
                    enableWorker: true,
                    lowLatencyMode: true,
                    backBufferLength: 90,
                    maxBufferLength: 10,
                });

                livestreamHLS.loadSource(streamUrl);
                livestreamHLS.attachMedia(video);

                livestreamHLS.on(Hls.Events.MANIFEST_PARSED, () => {
                    // Try autoplay muted
                    video.muted = true;
                    video.play().then(() => {
                        overlay.style.display = 'none';
                        showToast('🔴 Live stream started!');
                    }).catch(() => {
                        // Show play button
                        overlay.style.display = 'flex';
                    });
                });

                livestreamHLS.on(Hls.Events.ERROR, (event, data) => {
                    if (data.fatal) {
                        console.error('HLS error:', data);
                        switch(data.type) {
                            case Hls.ErrorTypes.NETWORK_ERROR:
                                livestreamHLS.startLoad();
                                break;
                            case Hls.ErrorTypes.MEDIA_ERROR:
                                livestreamHLS.recoverMediaError();
                                break;
                            default:
                                stopLivestream();
                                break;
                        }
                    }
                });
            } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                // iOS Safari native HLS
                video.src = streamUrl;
                video.addEventListener('loadedmetadata', () => {
                    video.muted = true;
                    video.play().then(() => {
                        overlay.style.display = 'none';
                        showToast('🔴 Live stream started!');
                    }).catch(() => {
                        overlay.style.display = 'flex';
                    });
                });
            }
        }

        function stopLivestream() {
            isStreamLive = false;
            const container = document.getElementById('sf-live-stream');
            container.classList.remove('is-live');
            
            if (livestreamHLS) {
                livestreamHLS.destroy();
                livestreamHLS = null;
            }
            
            const video = document.getElementById('stream-video');
            video.pause();
            video.src = '';
        }

        // Listen for admin livestream control
        function initStreamListener() {
            if (!RC.sb) return;
            
            const streamChannel = RC.sb.channel('livestream_control');
            
            streamChannel.on('broadcast', { event: 'stream_status' }, ({ payload }) => {
                console.log('📡 Stream status update:', payload);
                
                if (payload.isLive && payload.streamUrl) {
                    initLivestream(payload.streamUrl);
                } else {
                    stopLivestream();
                }
            });
            
            streamChannel.subscribe((status) => {
                if (status === 'SUBSCRIBED') {
                    console.log('✅ Listening for livestream control from admin');
                }
            });
        }
        
        // Initialize stream listener after Supabase is ready
        if (RC.sb) {
            setTimeout(() => initStreamListener(), 1000);
        }
        
        // ==============================
        // WebSocket Integration for Real-Time Updates
        // ==============================
        let ws = null;
        let wsReconnectAttempts = 0;
        const MAX_RECONNECT_ATTEMPTS = 5;
        
        function initWebSocket() {
            // Convert HTTP URL to WebSocket URL
            const wsUrl = BACKEND_API.replace('https://', 'wss://').replace('http://', 'ws://') + '/ws';
            
            try {
                ws = new WebSocket(wsUrl);
                
                ws.onopen = () => {
                    console.log('✅ WebSocket connected');
                    wsReconnectAttempts = 0;
                    
                    // Send initial presence
                    sendWSMessage({
                        type: 'presence',
                        user_id: myUserId,
                        x: posX,
                        y: posY,
                        floor: 'MF'
                    });
                };
                
                ws.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        handleWSMessage(data);
                    } catch (error) {
                        console.error('WebSocket message parse error:', error);
                    }
                };
                
                ws.onerror = (error) => {
                    console.error('WebSocket error:', error);
                };
                
                ws.onclose = () => {
                    console.log('WebSocket disconnected');
                    
                    // Attempt reconnection with exponential backoff
                    if (wsReconnectAttempts < MAX_RECONNECT_ATTEMPTS) {
                        wsReconnectAttempts++;
                        const delay = Math.min(1000 * Math.pow(2, wsReconnectAttempts), 30000);
                        console.log(`Reconnecting in ${delay}ms...`);
                        setTimeout(initWebSocket, delay);
                    }
                };
            } catch (error) {
                console.error('WebSocket initialization error:', error);
            }
        }
        
        function sendWSMessage(message) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify(message));
            }
        }
        
        function handleWSMessage(data) {
            switch (data.type) {
                case 'user_moved':
                    // Update other user's position
                    updateOtherUserPosition(data.user_id, data.x, data.y);
                    break;
                    
                case 'pin_created':
                    // New pin was created by another user
                    renderRemotePin(data.pin);
                    showToast('📍 New pin dropped nearby!');
                    break;
                    
                case 'new_message':
                    // New chat message received
                    addChatMessage(data.message.from_user_id, data.message.content);
                    break;
                    
                case 'purchase_received':
                    // Someone sent you a tip/gift
                    showToast(`💰 You received $${data.purchase.amount} ${data.purchase.item_type}!`);
                    break;
                    
                default:
                    console.log('Unknown WebSocket message type:', data.type);
            }
        }
        
        function renderRemotePin(pinData) {
            const pin = document.createElement('div');
            pin.className = 'pin';
            pin.style.left = pinData.x + 'px';
            pin.style.top = pinData.y + 'px';
            pin.style.background = getPinColor(pinData.pin_type);
            pin.style.color = getPinColor(pinData.pin_type);
            pin.dataset.caption = pinData.caption;
            pin.dataset.type = pinData.pin_type;
            
            if (pinData.photo_url) {
                pin.dataset.image = pinData.photo_url;
                pin.style.width = '12px';
                pin.style.height = '12px';
                pin.innerHTML = '<span style="position: absolute; top: -18px; left: -5px; font-size: 10px;">📷</span>';
            }
            
            attachPinHandlers(pin);
            document.getElementById('pinOverlay').appendChild(pin);
            pins.push(pin);
        }
        
        function getPinColor(pinType) {
            const colors = {
                memory: '#0066ff',
                song: '#ffcc00',
                moment: '#ff0066',
                dream: '#00ff88',
                promo: '#9933ff'
            };
            return colors[pinType] || '#ffffff';
        }
        
        // Initialize WebSocket connection
        // setTimeout(() => initWebSocket(), 2000); // DISABLED - Enable when backend WebSocket is ready
        
        // Send position updates via WebSocket periodically
        setInterval(() => {
            if (ws && ws.readyState === WebSocket.OPEN) {
                sendWSMessage({
                    type: 'position_update',
                    user_id: myUserId,
                    x: posX,
                    y: posY,
                    floor: 'MF'
                });
            }
        }, 200); // 5 times per second

    </script>

    <!-- SMS Library -->
    <script src="js/sms.js"></script>
    
    <!-- SMS Authentication - Multi-Step Version -->
    <script>
        // Multi-step SMS Modal Handler
        document.addEventListener('DOMContentLoaded', function() {
            const modal = document.getElementById('sms-modal');
            if (!modal) {
                console.warn('SMS modal not found');
                return;
            }

            // Check if user is already authenticated
            const session = localStorage.getItem('sf_user_session');
            if (session) {
                const userData = JSON.parse(session);
                console.log('✅ User authenticated:', userData.phone);
                modal.classList.remove('active');
                return;
            }

            const phoneForm = document.getElementById('phone-form');
            const verifyForm = document.getElementById('verify-form');
            const backBtn = document.getElementById('back-btn');
            const resendBtn = document.getElementById('resend-btn');
            const continueBtn = document.getElementById('continue-btn');
            const closeErrorBtn = document.getElementById('close-error');
            
            const phoneStep = document.getElementById('phone-step');
            const verifyStep = document.getElementById('verify-step');
            const successStep = document.getElementById('success-step');
            const loading = document.getElementById('loading');
            const errorMessage = document.getElementById('error-message');
            const errorText = document.getElementById('error-text');
            
            let currentPhone = '';
            
            // Show error message
            function showError(message) {
                errorText.textContent = message;
                errorMessage.style.display = 'block';
                loading.style.display = 'none';
            }
            
            // Hide error message
            function hideError() {
                errorMessage.style.display = 'none';
            }
            
            // Show loading
            function showLoading() {
                loading.style.display = 'block';
                hideError();
            }
            
            // Hide loading
            function hideLoading() {
                loading.style.display = 'none';
            }
            
            // Step 1: Send verification code
            if (phoneForm) {
                phoneForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    const phoneInput = document.getElementById('phone-number');
                    currentPhone = phoneInput.value.trim();
                    
                    // Auto-format phone number
                    if (!currentPhone.startsWith('+')) {
                        const digits = currentPhone.replace(/\D/g, '');
                        if (digits.length === 10) {
                            currentPhone = '+1' + digits;
                        } else if (digits.length === 11 && digits.startsWith('1')) {
                            currentPhone = '+' + digits;
                        } else {
                            currentPhone = '+1' + digits;
                        }
                    }
                    
                    if (!currentPhone) {
                        showError('Please enter a phone number');
                        return;
                    }
                    
                    showLoading();
                    
                    try {
                        // Call your SMS API here
                        const response = await fetch('/.netlify/functions/send-code', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ phone: currentPhone })
                        });
                        
                        const data = await response.json();
                        
                        if (response.ok || data.success) {
                            hideLoading();
                            phoneStep.style.display = 'none';
                            verifyStep.style.display = 'block';
                            document.getElementById('sent-to-number').textContent = currentPhone;
                            
                            // Show demo code if available
                            if (data.demo_code) {
                                console.log('📱 Demo code:', data.demo_code);
                                showError(`Demo code: ${data.demo_code}`);
                            }
                        } else {
                            showError(data.message || data.error || 'Failed to send code');
                        }
                    } catch (error) {
                        showError('Network error. Please try again.');
                        console.error('SMS send error:', error);
                    }
                });
            }
            
            // Step 2: Verify code
            if (verifyForm) {
                verifyForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    const codeInput = document.getElementById('verification-code');
                    const code = codeInput.value.trim();
                    
                    if (!code) {
                        showError('Please enter verification code');
                        return;
                    }
                    
                    showLoading();
                    
                    try {
                        // Call your verification API here
                        const response = await fetch('/.netlify/functions/verify-code', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ phone: currentPhone, code: code })
                        });
                        
                        const data = await response.json();
                        
                        if (response.ok || data.success || data.ok) {
                            hideLoading();
                            verifyStep.style.display = 'none';
                            successStep.style.display = 'block';
                            
                            // Save session
                            const sessionData = {
                                phone: currentPhone,
                                verified: true,
                                timestamp: Date.now(),
                                sessionToken: data.token || 'demo_token_' + Date.now()
                            };
                            localStorage.setItem('sf_user_session', JSON.stringify(sessionData));
                            
                            // Auto-close after 2 seconds
                            setTimeout(function() {
                                modal.classList.remove('active');
                            }, 2000);
                        } else {
                            showError(data.message || data.error || 'Invalid verification code');
                        }
                    } catch (error) {
                        showError('Network error. Please try again.');
                        console.error('SMS verify error:', error);
                    }
                });
            }
            
            // Back button
            if (backBtn) {
                backBtn.addEventListener('click', function() {
                    verifyStep.style.display = 'none';
                    phoneStep.style.display = 'block';
                    hideError();
                });
            }
            
            // Resend code
            if (resendBtn) {
                resendBtn.addEventListener('click', async function() {
                    showLoading();
                    try {
                        const response = await fetch('/.netlify/functions/send-code', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ phone: currentPhone })
                        });
                        
                        const data = await response.json();
                        hideLoading();
                        
                        if (response.ok || data.success) {
                            showError('✅ Code resent successfully!');
                            if (data.demo_code) {
                                console.log('📱 Demo code:', data.demo_code);
                            }
                            setTimeout(hideError, 3000);
                        } else {
                            showError('Failed to resend code');
                        }
                    } catch (error) {
                        showError('Network error. Please try again.');
                        console.error('SMS resend error:', error);
                    }
                });
            }
            
            // Continue button
            if (continueBtn) {
                continueBtn.addEventListener('click', function() {
                    modal.classList.remove('active');
                });
            }
            
            // Close error button
            if (closeErrorBtn) {
                closeErrorBtn.addEventListener('click', hideError);
            }
        });
    </script>
</body>
</html>
